<?php class Kiba_model extends CI_Model {function __construct(){parent::__construct(); } var $table = 'Ta_KIB_A'; function getInfoKIB($kd_prov,$kd_kab,$kd_bidang,$kd_unit,$kd_sub,$kd_upb,$kd_aset1,$kd_aset2,$kd_aset3,$kd_aset4,$kd_aset5,$no_register){$query = $this->db->get_where($this->table, array('Kd_Prov' => $kd_prov,'Kd_Kab_Kota' => $kd_kab,'Kd_Bidang' => $kd_bidang,'Kd_Unit' => $kd_unit, 'Kd_Sub' => $kd_sub,'Kd_UPB' => $kd_upb,'Kd_Aset1' => $kd_aset1,'Kd_Aset2' => $kd_aset2,'Kd_Aset3' => $kd_aset3, 'Kd_Aset4' => $kd_aset4,'Kd_Aset5' => $kd_aset5,'No_Register' => $no_register), 1)->row(); return $query; } function get_page($limit, $offset, $where, $like){if($offset == 0  or !isset($offset)){$first = 1; $last  = $limit; }else{$first = $offset+1; $last  = $first + ($limit -1); } $sql ="SELECT  * FROM  (SELECT     Ref_UPB.Nm_UPB,a.*,Ref_Rek_Aset5.Nm_Aset5, (SELECT TOP 1 Status FROM Ta_KIBAHapus h WHERE	a.Kd_Prov = h.Kd_Prov AND a.Kd_Kab_Kota = h.Kd_Kab_Kota AND a.Kd_Bidang = h.Kd_Bidang AND a.Kd_Unit = h.Kd_Unit AND a.Kd_Sub = h.Kd_Sub AND a.Kd_UPB = h.Kd_UPB AND a.Kd_Aset1 = h.Kd_Aset1 AND a.Kd_Aset2 = h.Kd_Aset2 AND a.Kd_Aset3 = h.Kd_Aset3 AND a.Kd_Aset4 = h.Kd_Aset4 AND a.Kd_Aset5 = h.Kd_Aset5 AND a.No_Register = h.No_Register ORDER BY Tgl_UP DESC ) AS Penghapusan, ROW_NUMBER() OVER (ORDER BY a.Log_entry DESC) AS no_urut		FROM  Ta_KIB_A a INNER JOIN Ref_Rek_Aset5 ON a.Kd_Aset1=Ref_Rek_Aset5.Kd_Aset1 AND a.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND a.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND a.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND a.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 LEFT JOIN Ref_UPB ON a.Kd_Bidang=Ref_UPB.Kd_Bidang AND a.Kd_Unit=Ref_UPB.Kd_Unit AND a.Kd_Sub=Ref_UPB.Kd_Sub AND a.Kd_UPB=Ref_UPB.Kd_UPB WHERE $where $like AND a.Kd_Aset1 = '1') AS a WHERE no_urut BETWEEN $first AND $last  ORDER BY no_urut ASC"; return $this->db->query($sql); } /* count kib b total page */ function count_kib($where, $like) {$sql = "SELECT COUNT(*) as Jumlah, SUM(Harga) as Total FROM Ta_KIB_A a INNER JOIN Ref_Rek_Aset5 ON a.Kd_Aset1=Ref_Rek_Aset5.Kd_Aset1 AND a.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND a.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND a.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND a.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 WHERE 1=1 "; $sql .= "AND $where "; $sql .= "$like "; $sql .= "AND a.Kd_Aset1 = '1'"; return  $this->db->query($sql)->row(); } /** * Tampilkan total harga kib b */ function total_kib($where, $like) {$query= "SELECT   SUM(Harga) AS Harga FROM  Ta_KIB_A INNER JOIN Ref_Rek_Aset5 ON Ta_KIB_A.Kd_Aset1=Ref_Rek_Aset5.Kd_Aset1 AND Ta_KIB_A.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_KIB_A.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_KIB_A.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_KIB_A.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5  WHERE $where $like AND Ta_KIB_A.Kd_Aset1 = '1'"; $sql = $this->db->query($query); foreach ($sql->result() as $row) {$result = $row->Harga; } return $result; } /** * Menampilkan semua data kib b */ function laporan_kib($bidang='',$unit='',$sub='',$upb='',$tahunawal,$tahunakhir,$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $thn   =  $this->session->userdata('tahun_anggaran'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; $where .= "AND (a.Kd_UPB = $kupb)"; } $tgl_pembukuan 	= " AND Tgl_Pembukuan ".$like; $tgl_dokumen 	= " AND Tgl_Dokumen <= '".$tahunakhir."'"; $query = "SELECT a.Nm_Aset5,COUNT(a.No_register) as jumlah_register,MIN(a.No_register) as min_register, MAX(a.No_register) as max_register, a.Kd_Prov, a.Kd_Kab_Kota, a.Kd_Bidang, a.Kd_Unit, a.Kd_Sub, a.Kd_UPB, a.Kd_Aset1, a.Kd_Aset2, a.Kd_Aset3, a.Kd_Aset4, a.Kd_Aset5, a.Kd_Pemilik,DATENAME(yyyy,a.Tgl_Perolehan) as Tahun, a.Luas_M2, a.Alamat, a.Hak_Tanah, a.Sertifikat_Tanggal,a.Sertifikat_Nomor, a.Penggunaan,a.Asal_usul,COUNT(*) as Jumlah, SUM(LastHarga) as  Harga, a.Keterangan FROM (SELECT *,((Harga + ISNULL(Koreksi_Tambah, 0) ) - ISNULL(Koreksi_Kurang, 0) ) as LastHarga FROM (SELECT n.Nm_Aset5, a1.*, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_KIB_A a1 INNER JOIN Ref_Rek_Aset5 n ON a1.Kd_Aset1 = n.Kd_Aset1 AND a1.Kd_Aset2 = n.Kd_Aset2 AND a1.Kd_Aset3 = n.Kd_Aset3 AND a1.Kd_Aset4 = n.Kd_Aset4 AND a1.Kd_Aset5 = n.Kd_Aset5 WHERE NOT EXISTS (SELECT 1 FROM   Ta_KIBAHapus d INNER JOIN Ta_Penghapusan e ON d.No_SK=e.No_SK WHERE a1.Kd_Bidang=d.Kd_Bidang AND a1.Kd_Unit=d.Kd_Unit AND a1.Kd_Sub=d.Kd_Sub AND a1.Kd_UPB=d.Kd_UPB AND a1.Kd_Aset1=d.Kd_Aset1 AND a1.Kd_Aset2=d.Kd_Aset2 AND a1.Kd_Aset3=d.Kd_Aset3 AND a1.Kd_Aset4=d.Kd_Aset4 AND a1.Kd_Aset5=d.Kd_Aset5 AND a1.No_Register=d.No_Register AND YEAR(e.Tgl_SK) <= '{$thn}') AND NOT EXISTS (SELECT 1 FROM   Ta_KIBAR e WHERE a1.Kd_Bidang=e.Kd_Bidang AND a1.Kd_Unit=e.Kd_Unit AND a1.Kd_Sub=e.Kd_Sub AND a1.Kd_UPB=e.Kd_UPB AND a1.Kd_Aset1=e.Kd_Aset1 AND a1.Kd_Aset2=e.Kd_Aset2 AND a1.Kd_Aset3=e.Kd_Aset3 AND a1.Kd_Aset4=e.Kd_Aset4 AND a1.Kd_Aset5=e.Kd_Aset5 AND a1.No_Register=e.No_Register  AND Kd_Riwayat IN (3,19) AND YEAR(e.Tgl_Dokumen) <= '{$thn}') ) as x ) as a WHERE 1=1 $where $tgl_pembukuan GROUP BY a.Kd_Prov, a.Kd_Kab_Kota, a.Kd_Bidang, a.Kd_Unit, a.Kd_Sub, a.Kd_UPB, a.Kd_Aset1, a.Kd_Aset2, a.Kd_Aset3, a.Kd_Aset4, a.Kd_Aset5, a.No_Register, a.Kd_Pemilik,a.Tgl_Perolehan, a.Luas_M2, a.Alamat, a.Hak_Tanah, a.Sertifikat_Tanggal,a.Sertifikat_Nomor, a.Penggunaan,a.Asal_usul,a.Keterangan,a.Nm_Aset5 ORDER BY  a.Kd_Aset1, a.Kd_Aset2, a.Kd_Aset3,a.Kd_Aset4, a.Kd_Aset5"; return $this->db->query($query); } /** * Menampilkan data kib A Mutasi */ function mutasi($bidang,$unit,$sub,$upb,$tahunawal,$tahunakhir,$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $thn   =  $this->session->userdata('tahun_anggaran'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; $where .= "AND (a.Kd_UPB = $kupb)"; } $tgl_pembukuan 	= " AND Tgl_Pembukuan ".$like; $tgl_dokumen 	= " AND Tgl_Dokumen <= '".$tahunakhir."'"; $query = "SELECT n.Nm_Aset5, COUNT (a.No_register) AS jumlah_register, MIN (a.No_register) AS min_register, MAX (a.No_register) AS max_register, a.Kd_Prov, a.Kd_Kab_Kota, a.Kd_Bidang, a.Kd_Unit, a.Kd_Sub, a.Kd_UPB, a.Kd_Aset1, a.Kd_Aset2, a.Kd_Aset3, a.Kd_Aset4, a.Kd_Aset5, a.Kd_Pemilik,DATENAME(yyyy,a.Tgl_Perolehan) as Tahun, a.Luas_M2, a.Alamat, a.Hak_Tanah, a.Sertifikat_Tanggal,a.Sertifikat_Nomor, a.Penggunaan, a.Asal_usul, COUNT (CASE WHEN a.Kd_Riwayat IN (3, 7, 23) THEN a.Harga END ) AS Jumlah_Kurang, COUNT (CASE WHEN Kd_Riwayat is null OR Kd_Riwayat IN (2, 21) THEN a.Harga END ) AS Jumlah_Tambah, SUM (CASE WHEN a.Kd_Riwayat IN (3, 7, 23) THEN a.Harga END ) AS Mutasi_Kurang, SUM (CASE WHEN Kd_Riwayat is null OR Kd_Riwayat IN (2, 21) THEN a.Harga END ) AS Mutasi_Tambah, a.Keterangan FROM (SELECT null as Kd_Riwayat,Kd_Prov,Kd_Kab_Kota,Kd_Bidang,Kd_Unit,Kd_Sub,Kd_UPB,Kd_Aset1,Kd_Aset2,Kd_Aset3,Kd_Aset4,Kd_Aset5,No_Register,Kd_Pemilik,Tgl_Perolehan,Tgl_Pembukuan, Luas_M2, Alamat, Hak_Tanah, Sertifikat_Tanggal,Sertifikat_Nomor, Penggunaan,Asal_usul,Harga,Keterangan FROM Ta_KIB_A UNION ALL SELECT Kd_Riwayat,Kd_Prov,Kd_Kab_Kota,Kd_Bidang,Kd_Unit,Kd_Sub,Kd_UPB,Kd_Aset1,Kd_Aset2,Kd_Aset3,Kd_Aset4,Kd_Aset5,No_Register,Kd_Pemilik,Tgl_Perolehan,Tgl_Dokumen as Tgl_Pembukuan, Luas_M2, Alamat, Hak_Tanah, Sertifikat_Tanggal,Sertifikat_Nomor, Penggunaan,Asal_usul,Harga,Keterangan FROM Ta_KIBAR WHERE Kd_Riwayat IN (2,7,21,23) UNION ALL SELECT 3 as Kd_Riwayat,Kd_Prov,Kd_Kab_Kota,Kd_Bidang,Kd_Unit,Kd_Sub,Kd_UPB,Kd_Aset1,Kd_Aset2,Kd_Aset3,Kd_Aset4,Kd_Aset5,No_Register,Kd_Pemilik,Tgl_Perolehan,Tgl_Tmp as Tgl_Pembukuan, Luas_M2, Alamat, Hak_Tanah, Sertifikat_Tanggal,Sertifikat_Nomor, Penggunaan,Asal_usul, ((Harga + ISNULL(Koreksi_Tambah, 0)) - ISNULL(Koreksi_Kurang, 0) ) as Harga, Keterangan FROM (SELECT a1.*,'{$tahunakhir}' as Tgl_Tmp, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_KIB_A a1 WHERE 1=1 AND EXISTS (SELECT 1 FROM   Ta_KIBAR e WHERE a1.Kd_Bidang=e.Kd_Bidang AND a1.Kd_Unit=e.Kd_Unit AND a1.Kd_Sub=e.Kd_Sub AND a1.Kd_UPB=e.Kd_UPB AND a1.Kd_Aset1=e.Kd_Aset1 AND a1.Kd_Aset2=e.Kd_Aset2 AND a1.Kd_Aset3=e.Kd_Aset3 AND a1.Kd_Aset4=e.Kd_Aset4 AND a1.Kd_Aset5=e.Kd_Aset5 AND a1.No_Register=e.No_Register AND Kd_Riwayat IN (3,19) AND e.Tgl_Dokumen BETWEEN '$tahunawal' AND '$tahunakhir') UNION ALL SELECT a1.*,'{$tahunakhir}' as Tgl_Tmp, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_KIB_A a1 WHERE 1=1 AND EXISTS (SELECT 1 FROM   Ta_KIBAHapus d INNER JOIN Ta_Penghapusan e ON d.No_SK=e.No_SK WHERE a1.Kd_Bidang=d.Kd_Bidang AND a1.Kd_Unit=d.Kd_Unit AND a1.Kd_Sub=d.Kd_Sub AND a1.Kd_UPB=d.Kd_UPB AND a1.Kd_Aset1=d.Kd_Aset1 AND a1.Kd_Aset2=d.Kd_Aset2 AND a1.Kd_Aset3=d.Kd_Aset3 AND a1.Kd_Aset4=d.Kd_Aset4 AND a1.Kd_Aset5=d.Kd_Aset5 AND a1.No_Register=d.No_Register AND e.Tgl_SK BETWEEN '$tahunawal' AND '$tahunakhir') ) as x ) as a LEFT JOIN Ref_Rek_Aset5 n ON a.Kd_Aset1 = n.Kd_Aset1 AND a.Kd_Aset2 = n.Kd_Aset2 AND a.Kd_Aset3 = n.Kd_Aset3 AND a.Kd_Aset4 = n.Kd_Aset4 AND a.Kd_Aset5 = n.Kd_Aset5 WHERE 1=1 $where $tgl_pembukuan GROUP BY a.Kd_Prov, a.Kd_Kab_Kota, a.Kd_Bidang, a.Kd_Unit, a.Kd_Sub, a.Kd_UPB, a.Kd_Aset1, a.Kd_Aset2, a.Kd_Aset3, a.Kd_Aset4, a.Kd_Aset5, a.Kd_Pemilik, a.Tgl_Perolehan, a.Luas_M2, a.Alamat, a.Hak_Tanah, a.Sertifikat_Tanggal,a.Sertifikat_Nomor, a.Penggunaan, a.Asal_usul, a.Keterangan, n.Nm_Aset5 ORDER BY n.Nm_Aset5, MIN (a.No_register)"; return $this->db->query($query); } /** * Total Data Mutasi */ function total_kiba_mutasi($bidang,$unit,$sub,$upb,$like) {if ($this->session->userdata('lvl') == 01){$this->db->where('Kd_Bidang',$bidang); $this->db->where('Kd_Unit',$unit); $this->db->where('Kd_Sub',$sub); $this->db->where('Kd_UPB',$upb); }elseif ($this->session->userdata('lvl') == 02){$this->db->where('Kd_Bidang',$this->session->userdata('kd_bidang')); $this->db->where('Kd_Unit',$this->session->userdata('kd_unit')); $this->db->where('Kd_Sub',$this->session->userdata('kd_sub_unit')); $this->db->where('Kd_UPB',$upb); }else{$this->db->where('Kd_Bidang',$this->session->userdata('kd_bidang')); $this->db->where('Kd_Unit',$this->session->userdata('kd_unit')); $this->db->where('Kd_Sub',$this->session->userdata('kd_sub_unit')); $this->db->where('Kd_UPB',$this->session->userdata('kd_upb')); } $this->db->select_SUM('Harga'); $this->db->where("$like"); $array_keys_values = $this->db->get($this->table); foreach ($array_keys_values->result() as $row) {$result = $row->Harga; } return $result; } function rekap_mutasi($bidang='',$unit='',$sub='',$upb='',$tahunawal,$tahunakhir) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $thn   =  $this->session->userdata('tahun_anggaran'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; $where .= "AND (a.Kd_UPB = $kupb)"; } $tgl_pembukuan 	= " AND Tgl_Pembukuan <= '$tahunakhir'"; $tgl_dokumen 	= " AND Tgl_Dokumen < '$tahunawal'"; $query = "SELECT Ref_Rek_Aset2.Kd_Aset1,Ref_Rek_Aset2.Kd_Aset2,Nm_Aset2, COUNT(CASE WHEN Tgl_Pembukuan < '$tahunawal' THEN 1 else null END) as Jumlah_awal, SUM(CASE WHEN Tgl_Pembukuan < '$tahunawal'  THEN Harga END) as Harga_awal, COUNT(CASE WHEN Tgl_Pembukuan BETWEEN '$tahunawal' AND '$tahunakhir' THEN CASE WHEN Kd_Riwayat IN (3, 7, 23) THEN Harga END END ) AS Jumlah_Kurang, SUM (CASE WHEN Tgl_Pembukuan BETWEEN '$tahunawal' AND '$tahunakhir' THEN CASE WHEN Kd_Riwayat IN (3, 7, 23) THEN Harga END END) AS Mutasi_Kurang, COUNT(CASE WHEN Tgl_Pembukuan BETWEEN '$tahunawal' AND '$tahunakhir' THEN CASE WHEN Kd_Riwayat is null OR Kd_Riwayat IN (2, 21) THEN Harga END END ) AS Jumlah_Tambah, SUM (CASE WHEN Tgl_Pembukuan BETWEEN '$tahunawal' AND '$tahunakhir' THEN CASE WHEN Kd_Riwayat is null OR Kd_Riwayat IN (2, 21) THEN Harga END END) AS Mutasi_Tambah FROM Ref_Rek_Aset2 LEFT JOIN (SELECT * FROM (SELECT Kd_Riwayat,Kd_Prov,Kd_Kab_Kota,Kd_Bidang,Kd_Unit,Kd_Sub,Kd_UPB,Kd_Aset1,Kd_Aset2,Kd_Aset3,Kd_Aset4,Kd_Aset5,No_Register,Kd_Pemilik,Tgl_Perolehan,Tgl_Dokumen as Tgl_Pembukuan, Luas_M2, Alamat, Hak_Tanah, Sertifikat_Tanggal,Sertifikat_Nomor, Penggunaan,Asal_usul,Harga,Keterangan FROM Ta_KIBAR WHERE Kd_Riwayat IN (2,7,21,23) AND Tgl_Dokumen BETWEEN '$tahunawal' AND '$tahunakhir'UNION ALL /* mutasi kurang pindah skpd */ SELECT 3 as Kd_Riwayat,Kd_Prov,Kd_Kab_Kota,Kd_Bidang,Kd_Unit,Kd_Sub,Kd_UPB,Kd_Aset1,Kd_Aset2,Kd_Aset3,Kd_Aset4,Kd_Aset5,No_Register,Kd_Pemilik,Tgl_Perolehan,NewDokumen as Tgl_Pembukuan, Luas_M2, Alamat, Hak_Tanah, Sertifikat_Tanggal,Sertifikat_Nomor, Penggunaan,Asal_usul, ((Harga + ISNULL(Koreksi_Tambah, 0)) - ISNULL(Koreksi_Kurang, 0) ) as Harga, Keterangan FROM (SELECT a1.*,a2.Tgl_Dokumen as NewDokumen, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_KIB_A a1 RIGHT JOIN Ta_KIBAR a2 ON a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register WHERE Kd_Riwayat IN (3,19) AND Tgl_Dokumen BETWEEN '$tahunawal' AND '$tahunakhir') as mk_pindah_skpd UNION ALL /* start mutasi kurang penghapusan */ SELECT 3 as Kd_Riwayat,Kd_Prov,Kd_Kab_Kota,Kd_Bidang,Kd_Unit,Kd_Sub,Kd_UPB,Kd_Aset1,Kd_Aset2,Kd_Aset3,Kd_Aset4,Kd_Aset5,No_Register,Kd_Pemilik,Tgl_Perolehan,NewDokumen as Tgl_Pembukuan, Luas_M2, Alamat, Hak_Tanah, Sertifikat_Tanggal,Sertifikat_Nomor, Penggunaan,Asal_usul, ((Harga + ISNULL(Koreksi_Tambah, 0)) - ISNULL(Koreksi_Kurang, 0) ) as Harga, Keterangan FROM (SELECT a1.*,a3.Tgl_SK as NewDokumen, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_KIB_A a1 RIGHT JOIN Ta_KIBAHapus a2 ON a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register INNER JOIN Ta_Penghapusan a3 ON a2.No_SK=a3.No_SK ) as mk_penghapusan /* end mutasi kurang penghapusan */ UNION ALL SELECT null as Kd_Riwayat,Kd_Prov,Kd_Kab_Kota,Kd_Bidang,Kd_Unit,Kd_Sub,Kd_UPB,Kd_Aset1,Kd_Aset2,Kd_Aset3,Kd_Aset4,Kd_Aset5,No_Register,Kd_Pemilik,Tgl_Perolehan,Tgl_Pembukuan, Luas_M2, Alamat, Hak_Tanah, Sertifikat_Tanggal,Sertifikat_Nomor, Penggunaan,Asal_usul,((Harga + ISNULL(Koreksi_Tambah, 0) ) - ISNULL(Koreksi_Kurang, 0) ) as Harga, Keterangan FROM (SELECT a1.*, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_KIB_A a1 WHERE NOT EXISTS (SELECT 1 FROM   Ta_KIBAHapus d INNER JOIN Ta_Penghapusan e ON d.No_SK=e.No_SK WHERE a1.Kd_Bidang=d.Kd_Bidang AND a1.Kd_Unit=d.Kd_Unit AND a1.Kd_Sub=d.Kd_Sub AND a1.Kd_UPB=d.Kd_UPB AND a1.Kd_Aset1=d.Kd_Aset1 AND a1.Kd_Aset2=d.Kd_Aset2 AND a1.Kd_Aset3=d.Kd_Aset3 AND a1.Kd_Aset4=d.Kd_Aset4 AND a1.Kd_Aset5=d.Kd_Aset5 AND a1.No_Register=d.No_Register AND e.Tgl_SK < '$tahunawal') AND NOT EXISTS (SELECT 1 FROM  Ta_KIBAR e WHERE a1.Kd_Bidang=e.Kd_Bidang AND a1.Kd_Unit=e.Kd_Unit AND a1.Kd_Sub=e.Kd_Sub AND a1.Kd_UPB=e.Kd_UPB AND a1.Kd_Aset1=e.Kd_Aset1 AND a1.Kd_Aset2=e.Kd_Aset2 AND a1.Kd_Aset3=e.Kd_Aset3 AND a1.Kd_Aset4=e.Kd_Aset4 AND a1.Kd_Aset5=e.Kd_Aset5 AND a1.No_Register=e.No_Register AND Kd_Riwayat IN (3,19) AND e.Tgl_Dokumen < '$tahunawal') ) as x ) as a WHERE 1=1 $where $tgl_pembukuan) as a3 ON a3.Kd_Aset1=Ref_Rek_Aset2.Kd_Aset1 AND a3.Kd_Aset2=Ref_Rek_Aset2.Kd_Aset2 WHERE Ref_Rek_Aset2.Kd_Aset1=1 GROUP BY Ref_Rek_Aset2.Kd_Aset1,Ref_Rek_Aset2.Kd_Aset2,Nm_Aset2 ORDER BY Kd_Aset2"; return $this->db->query($query); } /** * Menampilkan Total rekap Mutasi */ function total_rekap_mutasi($bidang='',$unit='',$sub='',$upb='',$tahunawal,$tahunakhir) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){if($bidang){$where = "AND (a.Kd_Bidang = $kb)"; } if($unit){$where .= "AND (a.Kd_Unit = $ku)"; } if($sub){$where .= "AND (a.Kd_Sub = $ks)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{if($bidang){$where = "AND (a.Kd_Bidang = $kb)"; } if($unit){$where .= "AND (a.Kd_Unit = $ku)"; } if($sub){$where .= "AND (a.Kd_Sub = $ks)"; } if($upb){$where .= "AND (a.Kd_UPB = $kupb)"; } } $tgl_pembukuan 	= " AND Tgl_Pembukuan BETWEEN '$tahunawal' AND '$tahunakhir'"; $tgl_dokumen 	= " AND Tgl_Dokumen < '$tahunakhir'"; $awal 	= $tahunawal; $akhir	= "AND Tgl_Pembukuan < '$tahunakhir'"; $query = "SELECT COUNT(CASE WHEN Tgl_Pembukuan < '$awal' THEN 1 else null END) as Jumlah_awal, SUM(CASE WHEN Tgl_Pembukuan < '$awal'  THEN Harga END) as Harga_awal, SUM(0) as Jumlah_Kurang, SUM(Mutasi_Kurang) as Mutasi_Kurang, COUNT(CASE WHEN Tgl_Pembukuan BETWEEN '$tahunawal' AND '$tahunakhir' THEN 1 else null END) as Jumlah_tambah, SUM(CASE WHEN Tgl_Pembukuan BETWEEN '$tahunawal' AND '$tahunakhir' THEN Harga END) as Harga_tambah, SUM(Mutasi_Tambah) as Mutasi_Tambah, COUNT(a3.Harga) as Jumlah, SUM(LastHarga) as Harga FROM Ref_Rek_Aset2 LEFT JOIN (SELECT *, ((CASE WHEN Mutasi_Kurang1 is null THEN 0 ELSE Mutasi_Kurang1 END) + (CASE WHEN Mutasi_Kurang2 is null THEN 0 ELSE Mutasi_Kurang2 END)) as Mutasi_Kurang, ((CASE WHEN Mutasi_Tambah1 is null THEN 0 ELSE Mutasi_Tambah1 END) + (CASE WHEN Mutasi_Tambah2 is null THEN 0 ELSE Mutasi_Tambah2 END)) as Mutasi_Tambah, (a.Harga + (CASE WHEN Kapitalisasi is null THEN 0 ELSE Kapitalisasi END) + (CASE WHEN Koreksi_Tambah is null THEN 0 ELSE Koreksi_Tambah END)) - ((CASE WHEN Koreksi_Kurang is null THEN 0 ELSE Koreksi_Kurang END) + (CASE WHEN Penghapusan is null THEN 0 ELSE Penghapusan END) ) as LastHarga FROM (SELECT *, /* ----------- Mutasi Kurang------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '7'AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register AND a2.Tgl_Dokumen BETWEEN '$tahunawal' AND '$tahunakhir') AS Mutasi_Kurang1, /* ----------- Mutasi Kurang------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '23'AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register AND a2.Tgl_Dokumen BETWEEN '$tahunawal' AND '$tahunakhir') AS Mutasi_Kurang2, /* ----------- Mutasi Tambah------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '2'AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register AND a2.Tgl_Dokumen BETWEEN '$tahunawal' AND '$tahunakhir') AS Mutasi_Tambah1, /* ----------- Mutasi Tambah------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '21'AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register AND a2.Tgl_Dokumen BETWEEN '$tahunawal' AND '$tahunakhir') AS Mutasi_Tambah2, /* ----------- jumlah kapitalisasi ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '2'AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Kapitalisasi, /* ----------- jumlah pengurangan PINDAH SKPD------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '3'AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Pindah_SKPD, /* ----------- jumlah pengurangan PENGHAPUSAN------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '7'AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Penghapusan, /* ----------- jumlah pengurangan Ubah data------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '18'AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Ubah_data, /* ----------- jumlah penambahan Koreksi Nilai------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '21'AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah penambahan Koreksi Nilai------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '23'AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_KIB_A a1) as a WHERE 1=1 $where $akhir ) as a3 ON a3.Kd_Aset1=Ref_Rek_Aset2.Kd_Aset1 AND a3.Kd_Aset2=Ref_Rek_Aset2.Kd_Aset2   WHERE Ref_Rek_Aset2.Kd_Aset1=1 "; /*print_r($query); exit();*/ return $this->db->query($query); } /** * Menampilkan data kib A Buku Induk SKPD */ function kiba_buku_induk($like) {$kb 	=  $this->session->userdata('kd_bidang'); $ku 	=  $this->session->userdata('kd_unit'); $ks 	=  $this->session->userdata('kd_sub_unit'); $kupb 	=  $this->session->userdata('kd_upb'); if ($this->session->userdata('lvl') == 01){$where = ''; }elseif ($this->session->userdata('lvl') == 02){$where = "(Ta_KIB_A.Kd_Bidang = $kb ) AND (Ta_KIB_A.Kd_Unit =$ku ) AND (Ta_KIB_A.Kd_Sub = $ks) AND"; }else{$where = "(Ta_KIB_A.Kd_Bidang = $kb) AND (Ta_KIB_A.Kd_Unit = $ku) AND (Ta_KIB_A.Kd_Sub = $ks) AND (Ta_KIB_A.Kd_UPB = $kupb) AND"; } $query = "SELECT   Nm_UPB,Ref_Rek_Aset5.Nm_Aset5,COUNT(Ta_KIB_A.No_register) as jumlah_register,MIN(Ta_KIB_A.No_register) as min_register, MAX(Ta_KIB_A.No_register) as max_register, Ta_KIB_A.Kd_Prov, Ta_KIB_A.Kd_Kab_Kota, Ta_KIB_A.Kd_Bidang, Ta_KIB_A.Kd_Unit, Ta_KIB_A.Kd_Sub, Ta_KIB_A.Kd_UPB, Ta_KIB_A.Kd_Aset1, Ta_KIB_A.Kd_Aset2, Ta_KIB_A.Kd_Aset3, Ta_KIB_A.Kd_Aset4, Ta_KIB_A.Kd_Aset5, Ta_KIB_A.Kd_Pemilik,DATENAME(yyyy,Ta_KIB_A.Tgl_Perolehan) as Tahun, Ta_KIB_A.Luas_M2, Ta_KIB_A.Alamat, Ta_KIB_A.Hak_Tanah, Ta_KIB_A.Sertifikat_Tanggal,Ta_KIB_A.Sertifikat_Nomor, Ta_KIB_A.Penggunaan,Ta_KIB_A.Asal_usul,COUNT(*) as Jumlah, SUM(Ta_KIB_A.Harga) as Harga,Ta_KIB_A.Keterangan FROM  Ta_KIB_A INNER JOIN Ref_Rek_Aset5 ON Ta_KIB_A.Kd_Aset1 = Ref_Rek_Aset5.Kd_Aset1 AND Ta_KIB_A.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_KIB_A.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_KIB_A.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_KIB_A.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 INNER JOIN Ref_UPB ON Ta_KIB_A.Kd_Bidang=Ref_UPB.Kd_Bidang AND Ta_KIB_A.Kd_Unit=Ref_UPB.Kd_Unit AND Ta_KIB_A.Kd_Sub=Ref_UPB.Kd_Sub AND Ta_KIB_A.Kd_UPB=Ref_UPB.Kd_UPB WHERE  $where $like GROUP BY Ta_KIB_A.Kd_Prov, Ta_KIB_A.Kd_Kab_Kota, Ta_KIB_A.Kd_Bidang, Ta_KIB_A.Kd_Unit, Ta_KIB_A.Kd_Sub, Ta_KIB_A.Kd_UPB, Ta_KIB_A.Kd_Aset1, Ta_KIB_A.Kd_Aset2, Ta_KIB_A.Kd_Aset3, Ta_KIB_A.Kd_Aset4, Ta_KIB_A.Kd_Aset5, Ta_KIB_A.Kd_Pemilik, Ta_KIB_A.Kd_Pemilik,Ta_KIB_A.Tgl_Perolehan, Ta_KIB_A.Luas_M2, Ta_KIB_A.Alamat, Ta_KIB_A.Hak_Tanah, Ta_KIB_A.Sertifikat_Tanggal,Ta_KIB_A.Sertifikat_Nomor, Ta_KIB_A.Penggunaan,Ta_KIB_A.Asal_usul,Ta_KIB_A.Keterangan,Ref_Rek_Aset5.Nm_Aset5,Nm_UPB ORDER BY  Nm_UPB,Ref_Rek_Aset5.Nm_Aset5, MIN(Ta_KIB_A.No_register)"; return $this->db->query($query); } /** * Total Data rekap inventaris */ function total_kiba_rinventaris($bidang,$unit,$sub,$upb,$like) {$kb 	=  $this->session->userdata('kd_bidang'); $ku 	=  $this->session->userdata('kd_unit'); $ks 	=  $this->session->userdata('kd_sub_unit'); $kupb 	=  $this->session->userdata('kd_upb'); if ($this->session->userdata('lvl') == 01){$where = "(Ta_KIB_A.Kd_Bidang = $bidang) AND (Ta_KIB_A.Kd_Unit = $unit) AND (Ta_KIB_A.Kd_Sub = $sub) AND (Ta_KIB_A.Kd_UPB = $upb) AND"; }elseif ($this->session->userdata('lvl') == 02){$where = "(Ta_KIB_A.Kd_Bidang = $kb ) AND (Ta_KIB_A.Kd_Unit =$ku ) AND (Ta_KIB_A.Kd_Sub = $ks) AND (Ta_KIB_A.Kd_UPB = $upb) AND"; }else{$where = "(Ta_KIB_A.Kd_Bidang = $kb) AND (Ta_KIB_A.Kd_Unit = $ku) AND (Ta_KIB_A.Kd_Sub = $ks) AND (Ta_KIB_A.Kd_UPB = $kupb) AND"; } $query = "SELECT COUNT(CASE WHEN Harga > 0 THEN 1 ELSE null END) as Jumlah, Ta_KIB_A.Kd_Bidang,Ta_KIB_A.Kd_Unit,Ta_KIB_A.Kd_Sub,Ta_KIB_A.Kd_UPB,SUM(Ta_KIB_A.Harga) as Harga, (SELECT SUM(Harga) as RHarga FROM Ta_KIBAR WHERE Ta_KIBAR.Kd_Riwayat = '2' AND Ta_KIB_A.Kd_Bidang = Ta_KIBAR.Kd_Bidang AND Ta_KIB_A.Kd_Unit = Ta_KIBAR.Kd_Unit AND Ta_KIB_A.Kd_Sub = Ta_KIBAR.Kd_Sub AND Ta_KIB_A.Kd_UPB = Ta_KIBAR.Kd_UPB ) AS Kapitalisasi, (SELECT SUM(Harga) as RHarga FROM Ta_KIBAR WHERE Ta_KIBAR.Kd_Riwayat = '21' AND Ta_KIB_A.Kd_Bidang = Ta_KIBAR.Kd_Bidang AND Ta_KIB_A.Kd_Unit = Ta_KIBAR.Kd_Unit AND Ta_KIB_A.Kd_Sub = Ta_KIBAR.Kd_Sub AND Ta_KIB_A.Kd_UPB = Ta_KIBAR.Kd_UPB ) AS Koreksi, (SELECT SUM(Harga) as RHarga FROM Ta_KIBAR WHERE Ta_KIBAR.Kd_Riwayat = '7' AND Ta_KIB_A.Kd_Bidang = Ta_KIBAR.Kd_Bidang AND Ta_KIB_A.Kd_Unit = Ta_KIBAR.Kd_Unit AND Ta_KIB_A.Kd_Sub = Ta_KIBAR.Kd_Sub AND Ta_KIB_A.Kd_UPB = Ta_KIBAR.Kd_UPB ) AS Penghapusan FROM Ta_KIB_A WHERE $where $like "; $query .= "GROUP BY Ta_KIB_A.Kd_Bidang,Ta_KIB_A.Kd_Unit,Ta_KIB_A.Kd_Sub,Ta_KIB_A.Kd_UPB "; return $this->db->query($query); } function rekap_skpd($bidang='',$unit='',$sub='',$upb='',$tahunawal,$tahunakhir,$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $thn   =  $this->session->userdata('tahun_anggaran'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; $where .= "AND (a.Kd_UPB = $kupb)"; } $tgl_pembukuan 	= " AND Tgl_Pembukuan ".$like; $tgl_dokumen 	= " AND Tgl_Dokumen <= '".$tahunakhir."'"; $query = "SELECT COUNT(*) as Jumlah, SUM(LastHarga) as  Harga FROM (SELECT *,((Harga + ISNULL(Koreksi_Tambah, 0) ) - ISNULL(Koreksi_Kurang, 0) ) as LastHarga FROM (SELECT n.Nm_Aset5, a1.*, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_KIB_A a1 INNER JOIN Ref_Rek_Aset5 n ON a1.Kd_Aset1 = n.Kd_Aset1 AND a1.Kd_Aset2 = n.Kd_Aset2 AND a1.Kd_Aset3 = n.Kd_Aset3 AND a1.Kd_Aset4 = n.Kd_Aset4 AND a1.Kd_Aset5 = n.Kd_Aset5 WHERE NOT EXISTS (SELECT 1 FROM   Ta_KIBAHapus d INNER JOIN Ta_Penghapusan e ON d.No_SK=e.No_SK WHERE a1.Kd_Bidang=d.Kd_Bidang AND a1.Kd_Unit=d.Kd_Unit AND a1.Kd_Sub=d.Kd_Sub AND a1.Kd_UPB=d.Kd_UPB AND a1.Kd_Aset1=d.Kd_Aset1 AND a1.Kd_Aset2=d.Kd_Aset2 AND a1.Kd_Aset3=d.Kd_Aset3 AND a1.Kd_Aset4=d.Kd_Aset4 AND a1.Kd_Aset5=d.Kd_Aset5 AND a1.No_Register=d.No_Register AND YEAR(e.Tgl_SK) <= '{$thn}') AND NOT EXISTS (SELECT 1 FROM   Ta_KIBAR e WHERE a1.Kd_Bidang=e.Kd_Bidang AND a1.Kd_Unit=e.Kd_Unit AND a1.Kd_Sub=e.Kd_Sub AND a1.Kd_UPB=e.Kd_UPB AND a1.Kd_Aset1=e.Kd_Aset1 AND a1.Kd_Aset2=e.Kd_Aset2 AND a1.Kd_Aset3=e.Kd_Aset3 AND a1.Kd_Aset4=e.Kd_Aset4 AND a1.Kd_Aset5=e.Kd_Aset5 AND a1.No_Register=e.No_Register  AND Kd_Riwayat IN (3,19) AND YEAR(e.Tgl_Dokumen) <= '{$thn}') ) as x ) as a WHERE 1=1 $where $tgl_pembukuan"; return $this->db->query($query); } /** * Mendapatkan data sebuah kiba */ function get_kiba_by_id($kd_prov,$kd_kab,$bidang,$unit,$sub,$upb,$kd_aset1,$kd_aset2,$kd_aset3,$kd_aset4,$kd_aset5,$no_register) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $where = ""; $where .= "AND (a.Kd_Prov = $kd_prov)"; $where .= "AND (a.Kd_Kab_Kota = $kd_kab)"; if ($this->session->userdata('lvl') == 01){$where = "AND (a.Kd_Bidang = $bidang) AND (a.Kd_Unit = $unit) AND (a.Kd_Sub = $sub) AND (a.Kd_UPB = $upb)"; }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb ) AND (a.Kd_Unit =$ku ) AND (a.Kd_Sub = $ks) AND (a.Kd_UPB = $upb)"; }else{$where = "AND (a.Kd_Bidang = $kb) AND (a.Kd_Unit = $ku) AND (a.Kd_Sub = $ks) AND (a.Kd_UPB = $kupb)"; } $where .= "AND a.Kd_Aset1 = {$kd_aset1} AND a.Kd_Aset2 = {$kd_aset2} AND a.Kd_Aset3 = {$kd_aset3} AND a.Kd_Aset4 = {$kd_aset4} AND a.Kd_Aset5 = {$kd_aset5} AND a.No_Register = {$no_register} "; $tgl_dokumen 	= " AND YEAR(Tgl_Dokumen) <= '{$this->session->userdata('tahun_anggaran')}'"; $query = "SELECT *, ((Harga + (CASE WHEN Koreksi_Tambah is null THEN 0 ELSE Koreksi_Tambah END) ) - (CASE WHEN Koreksi_Kurang is null THEN 0 ELSE Koreksi_Kurang END)) as HargaKoreksi, ((Harga + (CASE WHEN Koreksi_Tambah is null THEN 0 ELSE Koreksi_Tambah END) ) - (CASE WHEN Koreksi_Kurang is null THEN 0 ELSE Koreksi_Kurang END)) as LastHarga FROM (SELECT n.Nm_Aset5,a1.*, /* ----------- jumlah pengurangan PENGHAPUSAN------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '7'AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Penghapusan, /* ----------- jumlah penambahan Koreksi Nilai------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '21'AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah penambahan Koreksi Nilai------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '23'AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_KIB_A a1 INNER JOIN Ref_Rek_Aset5 n ON a1.Kd_Aset1 = n.Kd_Aset1 AND a1.Kd_Aset2 = n.Kd_Aset2 AND a1.Kd_Aset3 = n.Kd_Aset3 AND a1.Kd_Aset4 = n.Kd_Aset4 AND a1.Kd_Aset5 = n.Kd_Aset5 )as a WHERE 1=1 $where"; /*print_r($query); exit();*/ return $this->db->query($query); } function get_kibar_by_id($kd_riwayat,$kd_id,$kd_prov,$kd_kab,$bidang,$unit,$sub,$upb,$kd_aset1,$kd_aset2,$kd_aset3,$kd_aset4,$kd_aset5,$no_register) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $where = ""; $where .= "AND a.Kd_Riwayat = {$kd_riwayat} AND a.Kd_Id = {$kd_id} "; $where .= "AND (a.Kd_Prov = $kd_prov)"; $where .= "AND (a.Kd_Kab_Kota = $kd_kab)"; if ($this->session->userdata('lvl') == 01){$where .= "AND (a.Kd_Bidang = $bidang) AND (a.Kd_Unit = $unit) AND (a.Kd_Sub = $sub) AND (a.Kd_UPB = $upb)"; }elseif ($this->session->userdata('lvl') == 02){$where .= "AND (a.Kd_Bidang = $kb ) AND (a.Kd_Unit =$ku ) AND (a.Kd_Sub = $ks) AND (a.Kd_UPB = $upb)"; }else{$where .= "AND (a.Kd_Bidang = $kb) AND (a.Kd_Unit = $ku) AND (a.Kd_Sub = $ks) AND (a.Kd_UPB = $kupb)"; } $where .= "AND a.Kd_Aset1 = {$kd_aset1} AND a.Kd_Aset2 = {$kd_aset2} AND a.Kd_Aset3 = {$kd_aset3} AND a.Kd_Aset4 = {$kd_aset4} AND a.Kd_Aset5 = {$kd_aset5} AND a.No_Register = {$no_register} "; $query = "SELECT * FROM Ta_KIBAR a WHERE 1=1 $where"; return $this->db->query($query); } function data_foto($kd_prov,$kd_kab,$kd_bidang,$kd_unit,$kd_sub,$kd_upb,$kd_aset1,$kd_aset2,$kd_aset3,$kd_aset4,$kd_aset5,$no_register) {$this->db->select('*'); $this->db->from('Ta_FotoA'); $this->db->where('Kd_Prov',$kd_prov); $this->db->where('Kd_Kab_Kota',$kd_kab); $this->db->where('Kd_Bidang',$kd_bidang); $this->db->where('Kd_Unit',$kd_unit); $this->db->where('Kd_Sub',$kd_sub); $this->db->where('Kd_UPB',$kd_upb); $this->db->where('Kd_Aset1',$kd_aset1); $this->db->where('Kd_Aset2',$kd_aset2); $this->db->where('Kd_Aset3',$kd_aset3); $this->db->where('Kd_Aset4',$kd_aset4); $this->db->where('Kd_Aset5',$kd_aset5); $this->db->where('No_Register',$no_register); return $this->db->get(); } /** * mendapatkan no register terakhir */ function get_last_noregister($kd_bidang,$kd_unit,$kd_sub,$kd_upb,$kd_aset1,$kd_aset2,$kd_aset3,$kd_aset4,$kd_aset5) {$this->db->select_MAX('No_Register'); $array_keys_values = $this->db->get_where($this->table,array('Kd_Bidang' => $kd_bidang,'Kd_Unit' => $kd_unit,'Kd_Sub' => $kd_sub, 'Kd_UPB' => $kd_upb,'Kd_Aset1' => $kd_aset1,'Kd_Aset2' => $kd_aset2,'Kd_Aset3' => $kd_aset3,'Kd_Aset4' => $kd_aset4,'Kd_Aset5' => $kd_aset5)); foreach ($array_keys_values->result() as $row) {$result = $row->No_Register; } return $result+1; } /** * memeriksa register */ function cek_register($kd_bidang,$kd_unit,$kd_sub,$kd_upb,$kd_aset1,$kd_aset2,$kd_aset3,$kd_aset4,$kd_aset5,$no_register) {$result = $this->db->get_where($this->table,array('Kd_Bidang' => $kd_bidang,'Kd_Unit' => $kd_unit,'Kd_Sub' => $kd_sub, 'Kd_UPB' => $kd_upb,'Kd_Aset1' => $kd_aset1,'Kd_Aset2' => $kd_aset2,'Kd_Aset3' => $kd_aset3,'Kd_Aset4' => $kd_aset4,'Kd_Aset5' => $kd_aset5,'No_Register' => $no_register)); return $result; } /** * Menambah data tanah */ function add($kiba) {$sql = $this->db->insert($this->table, $kiba); if($sql) return TRUE; } function add_riwayat($data) {$sql = $this->db->insert('Ta_KIBAR', $data); if($sql) return TRUE; } function update_riwayat($data) {$this->db->where('Kd_Riwayat', $this->session->userdata('rKd_Riwayat')); $this->db->where('Kd_Id', $this->session->userdata('rKd_Id')); $this->db->where('Kd_Prov', $this->session->userdata('rKd_Prov')); $this->db->where('Kd_Kab_Kota', $this->session->userdata('rKd_Kab_Kota')); $this->db->where('Kd_Bidang', $this->session->userdata('rKd_Bidang')); $this->db->where('Kd_Unit', $this->session->userdata('rKd_Unit')); $this->db->where('Kd_Sub', $this->session->userdata('rKd_Sub')); $this->db->where('Kd_UPB', $this->session->userdata('rKd_UPB')); $this->db->where('Kd_Aset1', $this->session->userdata('rKd_Aset1')); $this->db->where('Kd_Aset2', $this->session->userdata('rKd_Aset2')); $this->db->where('Kd_Aset3', $this->session->userdata('rKd_Aset3')); $this->db->where('Kd_Aset4', $this->session->userdata('rKd_Aset4')); $this->db->where('Kd_Aset5', $this->session->userdata('rKd_Aset5')); $this->db->where('No_Register', $this->session->userdata('rNo_Register')); $this->db->update('Ta_KIBAR',$data); } /** * Menambah data tanah */ function insert($foto) {$this->db->insert('Ta_FotoA', $foto); return TRUE; } /** * Menghapus sebuah data kiba */ function hapus($kd_prov,$kd_kab,$kd_bidang,$kd_unit,$kd_sub,$kd_upb,$kd_aset1,$kd_aset2,$kd_aset3,$kd_aset4,$kd_aset5,$no_register) {$this->db->delete($this->table, array('Kd_Prov' => $kd_prov,'Kd_Kab_Kota' => $kd_kab,'Kd_Bidang' => $kd_bidang,'Kd_Unit' => $kd_unit, 'Kd_Sub' => $kd_sub,'Kd_UPB' => $kd_upb,'Kd_Aset1' => $kd_aset1,'Kd_Aset2' => $kd_aset2,'Kd_Aset3' => $kd_aset3, 'Kd_Aset4' => $kd_aset4,'Kd_Aset5' => $kd_aset5,'No_Register' => $no_register)); $this->db->delete("Ta_KIBAR", array('Kd_Prov' => $kd_prov,'Kd_Kab_Kota' => $kd_kab,'Kd_Bidang' => $kd_bidang,'Kd_Unit' => $kd_unit, 'Kd_Sub' => $kd_sub,'Kd_UPB' => $kd_upb,'Kd_Aset1' => $kd_aset1,'Kd_Aset2' => $kd_aset2,'Kd_Aset3' => $kd_aset3, 'Kd_Aset4' => $kd_aset4,'Kd_Aset5' => $kd_aset5,'No_Register' => $no_register)); $this->db->delete("Ta_KIBAR", array('Kd_Prov' => $kd_prov,'Kd_Kab_Kota' => $kd_kab,'Kd_Bidang1' => $kd_bidang,'Kd_Unit1' => $kd_unit, 'Kd_Sub1' => $kd_sub,'Kd_UPB1' => $kd_upb,'Kd_Aset1' => $kd_aset1,'Kd_Aset2' => $kd_aset2,'Kd_Aset3' => $kd_aset3, 'Kd_Aset4' => $kd_aset4,'Kd_Aset5' => $kd_aset5,'No_Register1' => $no_register)); } function hapus_riwayat($kd_riwayat,$kd_id,$kd_prov,$kd_kab,$kd_bidang,$kd_unit,$kd_sub,$kd_upb,$kd_aset1,$kd_aset2,$kd_aset3,$kd_aset4,$kd_aset5,$no_register) {$this->db->delete("Ta_KIBAR", array('Kd_Riwayat' => $kd_riwayat,'Kd_Id' => $kd_id,'Kd_Prov' => $kd_prov,'Kd_Kab_Kota' => $kd_kab,'Kd_Bidang' => $kd_bidang,'Kd_Unit' => $kd_unit, 'Kd_Sub' => $kd_sub,'Kd_UPB' => $kd_upb,'Kd_Aset1' => $kd_aset1,'Kd_Aset2' => $kd_aset2,'Kd_Aset3' => $kd_aset3,'Kd_Aset4' => $kd_aset4,'Kd_Aset5' => $kd_aset5,'No_Register' => $no_register)); } /** * 30-05-2014 Update data KIB */ function sm_update($kd_prov,$kd_kab,$kd_bidang,$kd_unit,$kd_sub,$kd_upb,$kd_aset1,$kd_aset2,$kd_aset3,$kd_aset4,$kd_aset5,$no_register,$data) {$this->db->where('Kd_Prov', $kd_prov); $this->db->where('Kd_Kab_Kota', $kd_kab); $this->db->where('Kd_Bidang', $kd_bidang); $this->db->where('Kd_Unit', $kd_unit); $this->db->where('Kd_Sub', $kd_sub); $this->db->where('Kd_UPB', $kd_upb); $this->db->where('Kd_Aset1', $kd_aset1); $this->db->where('Kd_Aset2', $kd_aset2); $this->db->where('Kd_Aset3', $kd_aset3); $this->db->where('Kd_Aset4', $kd_aset4); $this->db->where('Kd_Aset5', $kd_aset5); $this->db->where('No_Register', $no_register); $this->db->update($this->table, $data); return TRUE; } /** * 08-06-2014 Insert Select */ function insert_select($kd_prov,$kd_kab,$kd_bidang,$kd_unit,$kd_sub,$kd_upb,$kd_aset1,$kd_aset2,$kd_aset3,$kd_aset4,$kd_aset5,$no_register) {$query = $this->db->get_where($this->table, array('Kd_Prov' => $kd_prov,'Kd_Kab_Kota' => $kd_kab,'Kd_Bidang' => $kd_bidang,'Kd_Unit' => $kd_unit,'Kd_Sub' => $kd_sub,'Kd_UPB' => $kd_upb,'Kd_Aset1' => $kd_aset1,'Kd_Aset2' => $kd_aset2,'Kd_Aset3' => $kd_aset3, 'Kd_Aset4' => $kd_aset4,'Kd_Aset5' => $kd_aset5,'No_Register' => $no_register), 1)->row(); $data = array('No_Urut'	=> NULL, 'Kd_Riwayat'	=> 7, 'Kd_Id'	=> 1, 'Kd_Prov'	=> $query->Kd_Prov, 'Kd_Kab_Kota'	=> $query->Kd_Kab_Kota, 'Kd_Bidang'	=> $query->Kd_Bidang, 'Kd_Unit'	=> $query->Kd_Unit, 'Kd_Sub'	=> $query->Kd_Sub, 'Kd_UPB'	=> $query->Kd_UPB, 'Kd_Aset1'	=> $query->Kd_Aset1, 'Kd_Aset2'	=> $query->Kd_Aset2, 'Kd_Aset3'	=> $query->Kd_Aset3, 'Kd_Aset4'	=> $query->Kd_Aset4, 'Kd_Aset5'	=> $query->Kd_Aset5, 'No_Register'	=> $query->No_Register, 'Kd_Pemilik'	=> $query->Kd_Pemilik, 'Tgl_Dokumen'	=> date("Y-m-d"), 'No_Dokumen'	=> 'sebagian_hapus_sanjaya', 'Tgl_Perolehan'	=> $query->Tgl_Perolehan, 'Tgl_Pembukuan'	=> $query->Tgl_Pembukuan, 'Luas_M2'	=> $query->Luas_M2, 'Alamat'	=> $query->Alamat, 'Hak_Tanah'	=> $query->Hak_Tanah, 'Sertifikat_Tanggal'	=> $query->Sertifikat_Tanggal, 'Sertifikat_Nomor'	=> $query->Sertifikat_Nomor, 'Penggunaan'	=> $query->Penggunaan, 'Asal_usul'	=> $query->Asal_usul, 'Harga'	=> $query->Harga, 'Keterangan'	=> $query->Keterangan, 'Tahun'	=> $query->Tahun, 'No_SP2D'	=> $query->No_SP2D, 'No_ID'	=> $query->No_ID, 'Kd_Kecamatan'	=> $query->Kd_Kecamatan, 'Kd_Desa'	=> $query->Kd_Desa, 'Invent'	=> $query->Invent, 'No_SKGuna'	=> $query->No_SKGuna, 'Kd_Penyusutan'	=> $query->Kd_Penyusutan, 'Kd_Data'	=> $query->Kd_Data, 'Kd_Alasan'	=> 1, 'Log_User'	=> $query->Log_User, 'Log_entry'	=> $query->Log_entry, 'Nm_Rekanan'	=> NULL, 'Alamat_Reakanan'	=> NULL, 'Kd_KA'	=> 1); $this->db->insert("Ta_KIBAR", $data); return TRUE; } /** * 08-06-2014 usul guna */ function usul_guna($kd_prov,$kd_kab,$kd_bidang,$kd_unit,$kd_sub,$kd_upb,$kd_aset1,$kd_aset2,$kd_aset3,$kd_aset4,$kd_aset5,$no_register) {$query = $this->db->get_where($this->table, array('Kd_Prov' => $kd_prov,'Kd_Kab_Kota' => $kd_kab,'Kd_Bidang' => $kd_bidang,'Kd_Unit' => $kd_unit,'Kd_Sub' => $kd_sub,'Kd_UPB' => $kd_upb,'Kd_Aset1' => $kd_aset1,'Kd_Aset2' => $kd_aset2,'Kd_Aset3' => $kd_aset3, 'Kd_Aset4' => $kd_aset4,'Kd_Aset5' => $kd_aset5,'No_Register' => $no_register), 1)->row(); $data = array('No_Urut'	=> NULL, 'Kd_Riwayat'	=> 12, 'Kd_Id'	=> 1, 'Kd_Prov'	=> $query->Kd_Prov, 'Kd_Kab_Kota'	=> $query->Kd_Kab_Kota, 'Kd_Bidang'	=> $query->Kd_Bidang, 'Kd_Unit'	=> $query->Kd_Unit, 'Kd_Sub'	=> $query->Kd_Sub, 'Kd_UPB'	=> $query->Kd_UPB, 'Kd_Aset1'	=> $query->Kd_Aset1, 'Kd_Aset2'	=> $query->Kd_Aset2, 'Kd_Aset3'	=> $query->Kd_Aset3, 'Kd_Aset4'	=> $query->Kd_Aset4, 'Kd_Aset5'	=> $query->Kd_Aset5, 'No_Register'	=> $query->No_Register, 'Kd_Pemilik'	=> $query->Kd_Pemilik, 'Tgl_Dokumen'	=> date("Y-m-d"), 'No_Dokumen'	=> 'sebagian_hapus_sanjaya', 'Tgl_Perolehan'	=> $query->Tgl_Perolehan, 'Tgl_Pembukuan'	=> $query->Tgl_Pembukuan, 'Luas_M2'	=> $query->Luas_M2, 'Alamat'	=> $query->Alamat, 'Hak_Tanah'	=> $query->Hak_Tanah, 'Sertifikat_Tanggal'	=> $query->Sertifikat_Tanggal, 'Sertifikat_Nomor'	=> $query->Sertifikat_Nomor, 'Penggunaan'	=> $query->Penggunaan, 'Asal_usul'	=> $query->Asal_usul, 'Harga'	=> $query->Harga, 'Keterangan'	=> $query->Keterangan, 'Tahun'	=> $query->Tahun, 'No_SP2D'	=> $query->No_SP2D, 'No_ID'	=> $query->No_ID, 'Kd_Kecamatan'	=> $query->Kd_Kecamatan, 'Kd_Desa'	=> $query->Kd_Desa, 'Invent'	=> $query->Invent, 'No_SKGuna'	=> $query->No_SKGuna, 'Kd_Penyusutan'	=> $query->Kd_Penyusutan, 'Kd_Data'	=> $query->Kd_Data, 'Kd_Alasan'	=> 1, 'Log_User'	=> $query->Log_User, 'Log_entry'	=> $query->Log_entry, 'Nm_Rekanan'	=> NULL, 'Alamat_Reakanan'	=> NULL, 'Kd_KA'	=> 1); $this->db->insert("Ta_KIBAR", $data); return TRUE; } /* 28-03-2014 tambah total kiba*/ function total_kiba() {$arr = array(); $where = ""; if ($this->session->userdata('lvl') == 01){$where .= ""; }elseif ($this->session->userdata('lvl') == 02){$where .= "AND (a.Kd_Bidang = ".$this->session->userdata('kd_bidang').")"; $where .= "AND (a.Kd_Unit = ".$this->session->userdata('kd_unit').")"; $where .= "AND (a.Kd_Sub = ".$this->session->userdata('kd_sub_unit').")"; }else{$where .= "AND (a.Kd_Bidang = ".$this->session->userdata('kd_bidang').")"; $where .= "AND (a.Kd_Unit = ".$this->session->userdata('kd_unit').")"; $where .= "AND (a.Kd_Sub = ".$this->session->userdata('kd_sub_unit').")"; $where .= "AND (a.Kd_UPB = ".$this->session->userdata('kd_upb').")"; } $tgl_pembukuan 	= " AND YEAR(Tgl_Perolehan) <=".$this->session->userdata('tahun_anggaran'); $tgl_dokumen 	= " AND YEAR(Tgl_Dokumen) <=".$this->session->userdata('tahun_anggaran'); $query = "SELECT Thn_Perolehan, COUNT(*) as Jumlah, SUM(LastHarga) as Harga FROM (SELECT *, (CASE WHEN DATENAME(yyyy, Tgl_Perolehan) < 2010 THEN 2009 ELSE DATENAME(yyyy, Tgl_Perolehan) END) as Thn_Perolehan, (Harga + (CASE WHEN Kapitalisasi is null THEN 0 ELSE Kapitalisasi END) + (CASE WHEN Koreksi_Tambah is null THEN 0 ELSE Koreksi_Tambah END)) - (CASE WHEN Koreksi_Kurang is null THEN 0 ELSE Koreksi_Kurang END) as LastHarga FROM (SELECT a1.*, /* ----------- jumlah kapitalisasi ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '2'AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Kapitalisasi, /* ----------- jumlah pengurangan PINDAH SKPD------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '3'AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Pindah_SKPD, /* ----------- jumlah pengurangan PENGHAPUSAN------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '7'AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Penghapusan, /* ----------- jumlah pengurangan Ubah data------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '18'AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Ubah_data, /* ----------- jumlah penambahan Koreksi Nilai------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '21'AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah penambahan Koreksi Nilai------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '23'AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_KIB_A a1 ) as a WHERE 1=1 $where $tgl_pembukuan) as b GROUP BY Thn_Perolehan ORDER BY Thn_Perolehan"; $sql = $this->db->query($query); foreach ($sql->result() as $row) {$arr[] = $row->Harga; } return $arr; } function laporan_all_kiba($like) {$query = "select * from Ta_KIB_A inner join Ref_Rek_Aset5 on  Ta_KIB_A.Kd_Aset1=Ref_Rek_Aset5.Kd_Aset1 AND Ta_KIB_A.Kd_Aset2=Ref_Rek_Aset5.Kd_Aset2 AND  Ta_KIB_A.Kd_Aset3=Ref_Rek_Aset5.Kd_Aset3 AND Ta_KIB_A.Kd_Aset4=Ref_Rek_Aset5.Kd_Aset4 AND Ta_KIB_A.Kd_Aset5=Ref_Rek_Aset5.Kd_Aset5 INNER JOIN Ref_UPB ON Ta_KIB_A.Kd_Bidang=Ref_UPB.Kd_Bidang AND Ta_KIB_A.Kd_Unit=Ref_UPB.Kd_Unit AND Ta_KIB_A.Kd_Sub=Ref_UPB.Kd_Sub AND Ta_KIB_A.Kd_UPB=Ref_UPB.Kd_UPB where $like"; return $this->db->query($query); } function total_laporan_all_kiba($like) {$this->db->select_SUM('Harga'); $this->db->where("$like"); $this->db->from($this->table); $sql = $this->db->get(); foreach ($sql->result() as $row) {$result = $row->Harga; } return $result; } /* total kib a */ /* 02-07-2014 */ function laporan_kodebarang($bidang,$unit,$sub,$upb,$like) {$kb 	=  $this->session->userdata('kd_bidang'); $ku 	=  $this->session->userdata('kd_unit'); $ks 	=  $this->session->userdata('kd_sub_unit'); $kupb 	=  $this->session->userdata('kd_upb'); if ($this->session->userdata('lvl') == 01){$where = "(Ta_KIB_A.Kd_Bidang = $bidang) AND (Ta_KIB_A.Kd_Unit = $unit) AND (Ta_KIB_A.Kd_Sub = $sub) AND (Ta_KIB_A.Kd_UPB = $upb) AND"; }elseif ($this->session->userdata('lvl') == 02){$where = "(Ta_KIB_A.Kd_Bidang = $kb ) AND (Ta_KIB_A.Kd_Unit =$ku ) AND (Ta_KIB_A.Kd_Sub = $ks) AND (Ta_KIB_A.Kd_UPB = $upb) AND"; }else{$where = "(Ta_KIB_A.Kd_Bidang = $kb) AND (Ta_KIB_A.Kd_Unit = $ku) AND (Ta_KIB_A.Kd_Sub = $ks) AND (Ta_KIB_A.Kd_UPB = $kupb) AND"; } $query = "select Ref_Rek_Aset5.Kd_Aset1,Ref_Rek_Aset5.Kd_Aset2,Ref_Rek_Aset5.Kd_Aset3,Ref_Rek_Aset5.Kd_Aset4,Ref_Rek_Aset5.Kd_Aset5, Nm_Aset5,COUNT(*) as Jumlah, SUM(Harga) as Harga from Ref_Rek_Aset5 RIGHT JOIN Ta_KIB_A ON Ta_KIB_A.Kd_Aset1=Ref_Rek_Aset5.Kd_Aset1 AND Ta_KIB_A.Kd_Aset2=Ref_Rek_Aset5.Kd_Aset2 AND Ta_KIB_A.Kd_Aset3=Ref_Rek_Aset5.Kd_Aset3 AND Ta_KIB_A.Kd_Aset4=Ref_Rek_Aset5.Kd_Aset4 AND Ta_KIB_A.Kd_Aset5=Ref_Rek_Aset5.Kd_Aset5  WHERE $where $like GROUP BY Ref_Rek_Aset5.Kd_Aset1,Ref_Rek_Aset5.Kd_Aset2,Ref_Rek_Aset5.Kd_Aset3, Ref_Rek_Aset5.Kd_Aset4,Ref_Rek_Aset5.Kd_Aset5,Nm_Aset5"; return $this->db->query($query); } /** * Tampilkan total_pengadaan */ function total_kodebarang($bidang,$unit,$sub,$upb,$like) {if ($this->session->userdata('lvl') == 01){$this->db->where('Kd_Bidang',$bidang); $this->db->where('Kd_Unit',$unit); $this->db->where('Kd_Sub',$sub); $this->db->where('Kd_UPB',$upb); }elseif ($this->session->userdata('lvl') == 02){$this->db->where('Kd_Bidang',$this->session->userdata('kd_bidang')); $this->db->where('Kd_Unit',$this->session->userdata('kd_unit')); $this->db->where('Kd_Sub',$this->session->userdata('kd_sub_unit')); $this->db->where('Kd_UPB',$upb); }else{$this->db->where('Kd_Bidang',$this->session->userdata('kd_bidang')); $this->db->where('Kd_Unit',$this->session->userdata('kd_unit')); $this->db->where('Kd_Sub',$this->session->userdata('kd_sub_unit')); $this->db->where('Kd_UPB',$this->session->userdata('kd_upb')); } $this->db->select_SUM('Harga'); $this->db->where("$like"); $this->db->from($this->table); $sql = $this->db->get(); foreach ($sql->result() as $row) {$result = $row->Harga; } return $result; } /* 02-07-2014 */ /** * Menampilkan laporan usul guna */ function laporan_usulguna($bidang,$unit,$sub,$upb,$like) {$kb 	=  $this->session->userdata('kd_bidang'); $ku 	=  $this->session->userdata('kd_unit'); $ks 	=  $this->session->userdata('kd_sub_unit'); $kupb 	=  $this->session->userdata('kd_upb'); if ($this->session->userdata('lvl') == 01){$where = "(Ta_KIBAR.Kd_Bidang = $bidang) AND (Ta_KIBAR.Kd_Unit = $unit) AND (Ta_KIBAR.Kd_Sub = $sub) AND (Ta_KIBAR.Kd_UPB = $upb) AND"; }elseif ($this->session->userdata('lvl') == 02){$where = "(Ta_KIBAR.Kd_Bidang = $kb ) AND (Ta_KIBAR.Kd_Unit =$ku ) AND (Ta_KIBAR.Kd_Sub = $ks) AND (Ta_KIBAR.Kd_UPB = $upb) AND"; }else{$where = "(Ta_KIBAR.Kd_Bidang = $kb) AND (Ta_KIBAR.Kd_Unit = $ku) AND (Ta_KIBAR.Kd_Sub = $ks) AND (Ta_KIBAR.Kd_UPB = $kupb) AND"; } $query = "SELECT Ref_Rek_Aset5.Nm_Aset5, Ta_KIBAR.Kd_Prov, Ta_KIBAR.Kd_Kab_Kota, Ta_KIBAR.Kd_Bidang, Ta_KIBAR.Kd_Unit, Ta_KIBAR.Kd_Sub, Ta_KIBAR.Kd_UPB, Ta_KIBAR.Kd_Aset1, Ta_KIBAR.Kd_Aset2, Ta_KIBAR.Kd_Aset3, Ta_KIBAR.Kd_Aset4, Ta_KIBAR.Kd_Aset5, Ta_KIBAR.Kd_Pemilik, Ta_KIBAR.Sertifikat_Nomor, Ta_KIBAR.Luas_M2, Ta_KIBAR.Alamat, DATENAME(yyyy, Ta_KIBAR.Tgl_Perolehan ) AS Tahun, COUNT (*) AS Jumlah_Data, SUM (Ta_KIBAR.Harga) AS Harga, Ta_KIBAR.Keterangan FROM Ta_KIBAR INNER JOIN Ref_Rek_Aset5 ON Ta_KIBAR.Kd_Aset1 = Ref_Rek_Aset5.Kd_Aset1 AND Ta_KIBAR.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_KIBAR.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_KIBAR.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_KIBAR.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 WHERE $where Kd_Riwayat = 12 GROUP BY Ref_Rek_Aset5.Nm_Aset5, Ta_KIBAR.Kd_Prov, Ta_KIBAR.Kd_Kab_Kota, Ta_KIBAR.Kd_Bidang, Ta_KIBAR.Kd_Unit, Ta_KIBAR.Kd_Sub, Ta_KIBAR.Kd_UPB, Ta_KIBAR.Kd_Aset1, Ta_KIBAR.Kd_Aset2, Ta_KIBAR.Kd_Aset3, Ta_KIBAR.Kd_Aset4, Ta_KIBAR.Kd_Aset5, Ta_KIBAR.Kd_Pemilik, Ta_KIBAR.Sertifikat_Nomor, Ta_KIBAR.Luas_M2, Ta_KIBAR.Alamat, DATENAME(yyyy, Ta_KIBAR.Tgl_Perolehan ), Ta_KIBAR.Keterangan"; return $this->db->query($query); } /** * Tampilkan total_pengadaan */ function total_usulguna($bidang,$unit,$sub,$upb,$like) {if ($this->session->userdata('lvl') == 01){$this->db->where('Kd_Bidang',$bidang); $this->db->where('Kd_Unit',$unit); $this->db->where('Kd_Sub',$sub); $this->db->where('Kd_UPB',$upb); }elseif ($this->session->userdata('lvl') == 02){$this->db->where('Kd_Bidang',$this->session->userdata('kd_bidang')); $this->db->where('Kd_Unit',$this->session->userdata('kd_unit')); $this->db->where('Kd_Sub',$this->session->userdata('kd_sub_unit')); $this->db->where('Kd_UPB',$upb); }else{$this->db->where('Kd_Bidang',$this->session->userdata('kd_bidang')); $this->db->where('Kd_Unit',$this->session->userdata('kd_unit')); $this->db->where('Kd_Sub',$this->session->userdata('kd_sub_unit')); $this->db->where('Kd_UPB',$this->session->userdata('kd_upb')); } $this->db->select_SUM('Harga'); $this->db->where("$like"); $this->db->where('Kd_Riwayat = 12'); $this->db->from('Ta_KIBAR'); $sql = $this->db->get(); foreach ($sql->result() as $row) {$result = $row->Harga; } return $result; } function laporan_ekstrakomptabel($bidang,$unit,$sub,$upb,$like) {$kb 	=  $this->session->userdata('kd_bidang'); $ku 	=  $this->session->userdata('kd_unit'); $ks 	=  $this->session->userdata('kd_sub_unit'); $kupb 	=  $this->session->userdata('kd_upb'); if ($this->session->userdata('lvl') == 01){$where = "(Ta_KIB_A.Kd_Bidang = $bidang) AND (Ta_KIB_A.Kd_Unit = $unit) AND (Ta_KIB_A.Kd_Sub = $sub) AND (Ta_KIB_A.Kd_UPB = $upb) AND"; }elseif ($this->session->userdata('lvl') == 02){$where = "(Ta_KIB_A.Kd_Bidang = $kb ) AND (Ta_KIB_A.Kd_Unit =$ku ) AND (Ta_KIB_A.Kd_Sub = $ks) AND (Ta_KIB_A.Kd_UPB = $upb) AND"; }else{$where = "(Ta_KIB_A.Kd_Bidang = $kb) AND (Ta_KIB_A.Kd_Unit = $ku) AND (Ta_KIB_A.Kd_Sub = $ks) AND (Ta_KIB_A.Kd_UPB = $kupb) AND"; } $query = "SELECT Ref_Rek_Aset5.Nm_Aset5, Ta_KIB_A.Kd_Prov, Ta_KIB_A.Kd_Kab_Kota, Ta_KIB_A.Kd_Bidang, Ta_KIB_A.Kd_Unit, Ta_KIB_A.Kd_Sub, Ta_KIB_A.Kd_UPB, Ta_KIB_A.Kd_Aset1, Ta_KIB_A.Kd_Aset2, Ta_KIB_A.Kd_Aset3, Ta_KIB_A.Kd_Aset4, Ta_KIB_A.Kd_Aset5, Ta_KIB_A.Kd_Pemilik, Ta_KIB_A.Sertifikat_Nomor, Ta_KIB_A.Luas_M2, Ta_KIB_A.Alamat, DATENAME(yyyy, Ta_KIB_A.Tgl_Perolehan ) AS Tahun, COUNT (*) AS Jumlah_Data, SUM (Ta_KIB_A.Harga) AS Harga, Ta_KIB_A.Keterangan FROM Ta_KIB_A INNER JOIN Ref_Rek_Aset5 ON Ta_KIB_A.Kd_Aset1 = Ref_Rek_Aset5.Kd_Aset1 AND Ta_KIB_A.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_KIB_A.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_KIB_A.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_KIB_A.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 WHERE  $where $like AND ekstrakomtabel = 'Y'GROUP BY Ref_Rek_Aset5.Nm_Aset5, Ta_KIB_A.Kd_Prov, Ta_KIB_A.Kd_Kab_Kota, Ta_KIB_A.Kd_Bidang, Ta_KIB_A.Kd_Unit, Ta_KIB_A.Kd_Sub, Ta_KIB_A.Kd_UPB, Ta_KIB_A.Kd_Aset1, Ta_KIB_A.Kd_Aset2, Ta_KIB_A.Kd_Aset3, Ta_KIB_A.Kd_Aset4, Ta_KIB_A.Kd_Aset5, Ta_KIB_A.Kd_Pemilik, Ta_KIB_A.Sertifikat_Nomor, Ta_KIB_A.Luas_M2, Ta_KIB_A.Alamat, DATENAME(yyyy, Ta_KIB_A.Tgl_Perolehan ), Ta_KIB_A.Keterangan"; return $this->db->query($query); } /** * Tampilkan total_pengadaan */ function total_ekstrakomptabel($bidang,$unit,$sub,$upb,$like) {if ($this->session->userdata('lvl') == 01){$this->db->where('Kd_Bidang',$bidang); $this->db->where('Kd_Unit',$unit); $this->db->where('Kd_Sub',$sub); $this->db->where('Kd_UPB',$upb); }elseif ($this->session->userdata('lvl') == 02){$this->db->where('Kd_Bidang',$this->session->userdata('kd_bidang')); $this->db->where('Kd_Unit',$this->session->userdata('kd_unit')); $this->db->where('Kd_Sub',$this->session->userdata('kd_sub_unit')); $this->db->where('Kd_UPB',$upb); }else{$this->db->where('Kd_Bidang',$this->session->userdata('kd_bidang')); $this->db->where('Kd_Unit',$this->session->userdata('kd_unit')); $this->db->where('Kd_Sub',$this->session->userdata('kd_sub_unit')); $this->db->where('Kd_UPB',$this->session->userdata('kd_upb')); } $this->db->select_SUM('Harga'); $this->db->where("$like"); $this->db->where("ekstrakomtabel = 'Y'"); $this->db->from($this->table); $sql = $this->db->get(); foreach ($sql->result() as $row) {$result = $row->Harga; } return $result; } function laporan_intrakomptabel($bidang,$unit,$sub,$upb,$like){$kb 	=  $this->session->userdata('kd_bidang'); $ku 	=  $this->session->userdata('kd_unit'); $ks 	=  $this->session->userdata('kd_sub_unit'); $kupb 	=  $this->session->userdata('kd_upb'); if ($this->session->userdata('lvl') == 01){$where = "(Ta_KIB_A.Kd_Bidang = $bidang) AND (Ta_KIB_A.Kd_Unit = $unit) AND (Ta_KIB_A.Kd_Sub = $sub) AND (Ta_KIB_A.Kd_UPB = $upb) AND"; }elseif ($this->session->userdata('lvl') == 02){$where = "(Ta_KIB_A.Kd_Bidang = $kb ) AND (Ta_KIB_A.Kd_Unit =$ku ) AND (Ta_KIB_A.Kd_Sub = $ks) AND (Ta_KIB_A.Kd_UPB = $upb) AND"; }else{$where = "(Ta_KIB_A.Kd_Bidang = $kb) AND (Ta_KIB_A.Kd_Unit = $ku) AND (Ta_KIB_A.Kd_Sub = $ks) AND (Ta_KIB_A.Kd_UPB = $kupb) AND"; } $query = "SELECT Ref_Rek_Aset5.Nm_Aset5, Ta_KIB_A.Kd_Prov, Ta_KIB_A.Kd_Kab_Kota, Ta_KIB_A.Kd_Bidang, Ta_KIB_A.Kd_Unit, Ta_KIB_A.Kd_Sub, Ta_KIB_A.Kd_UPB, Ta_KIB_A.Kd_Aset1, Ta_KIB_A.Kd_Aset2, Ta_KIB_A.Kd_Aset3, Ta_KIB_A.Kd_Aset4, Ta_KIB_A.Kd_Aset5, Ta_KIB_A.Kd_Pemilik, Ta_KIB_A.Sertifikat_Nomor, Ta_KIB_A.Luas_M2, Ta_KIB_A.Alamat, DATENAME(yyyy, Ta_KIB_A.Tgl_Perolehan ) AS Tahun, COUNT (*) AS Jumlah_Data, SUM (Ta_KIB_A.Harga) AS Harga, Ta_KIB_A.Keterangan FROM Ta_KIB_A INNER JOIN Ref_Rek_Aset5 ON Ta_KIB_A.Kd_Aset1 = Ref_Rek_Aset5.Kd_Aset1 AND Ta_KIB_A.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_KIB_A.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_KIB_A.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_KIB_A.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 WHERE  $where $like AND ekstrakomtabel = ''GROUP BY Ref_Rek_Aset5.Nm_Aset5, Ta_KIB_A.Kd_Prov, Ta_KIB_A.Kd_Kab_Kota, Ta_KIB_A.Kd_Bidang, Ta_KIB_A.Kd_Unit, Ta_KIB_A.Kd_Sub, Ta_KIB_A.Kd_UPB, Ta_KIB_A.Kd_Aset1, Ta_KIB_A.Kd_Aset2, Ta_KIB_A.Kd_Aset3, Ta_KIB_A.Kd_Aset4, Ta_KIB_A.Kd_Aset5, Ta_KIB_A.Kd_Pemilik, Ta_KIB_A.Sertifikat_Nomor, Ta_KIB_A.Luas_M2, Ta_KIB_A.Alamat, DATENAME(yyyy, Ta_KIB_A.Tgl_Perolehan ), Ta_KIB_A.Keterangan"; return $this->db->query($query); } /** * Laporan intrakomptabel */ function total_intrakomptabel($bidang,$unit,$sub,$upb,$like){if ($this->session->userdata('lvl') == 01){$this->db->where('Kd_Bidang',$bidang); $this->db->where('Kd_Unit',$unit); $this->db->where('Kd_Sub',$sub); $this->db->where('Kd_UPB',$upb); }elseif ($this->session->userdata('lvl') == 02){$this->db->where('Kd_Bidang',$this->session->userdata('kd_bidang')); $this->db->where('Kd_Unit',$this->session->userdata('kd_unit')); $this->db->where('Kd_Sub',$this->session->userdata('kd_sub_unit')); $this->db->where('Kd_UPB',$upb); }else{$this->db->where('Kd_Bidang',$this->session->userdata('kd_bidang')); $this->db->where('Kd_Unit',$this->session->userdata('kd_unit')); $this->db->where('Kd_Sub',$this->session->userdata('kd_sub_unit')); $this->db->where('Kd_UPB',$this->session->userdata('kd_upb')); } $this->db->select_SUM('Harga'); $this->db->where("$like"); $this->db->where("ekstrakomtabel = 'Y'"); $this->db->from($this->table); $sql = $this->db->get(); foreach ($sql->result() as $row) {$result = $row->Harga; } return $result; } function laporan_ekstrakomptabel_skpd($like){$query = "SELECT Ref_Rek_Aset5.Nm_Aset5, Ta_KIB_A.Kd_Prov, Ta_KIB_A.Kd_Kab_Kota, Ta_KIB_A.Kd_Bidang, Ta_KIB_A.Kd_Unit, Ta_KIB_A.Kd_Sub, Ta_KIB_A.Kd_UPB, Ta_KIB_A.Kd_Aset1, Ta_KIB_A.Kd_Aset2, Ta_KIB_A.Kd_Aset3, Ta_KIB_A.Kd_Aset4, Ta_KIB_A.Kd_Aset5, Ta_KIB_A.Kd_Pemilik, Ta_KIB_A.Sertifikat_Nomor, Ta_KIB_A.Luas_M2, Ta_KIB_A.Alamat, DATENAME(yyyy, Ta_KIB_A.Tgl_Perolehan ) AS Tahun, COUNT (*) AS Jumlah_Data, SUM (Ta_KIB_A.Harga) AS Harga, Ta_KIB_A.Keterangan FROM Ta_KIB_A INNER JOIN Ref_Rek_Aset5 ON Ta_KIB_A.Kd_Aset1 = Ref_Rek_Aset5.Kd_Aset1 AND Ta_KIB_A.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_KIB_A.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_KIB_A.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_KIB_A.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 WHERE  $like AND ekstrakomtabel = 'Y'GROUP BY Ref_Rek_Aset5.Nm_Aset5, Ta_KIB_A.Kd_Prov, Ta_KIB_A.Kd_Kab_Kota, Ta_KIB_A.Kd_Bidang, Ta_KIB_A.Kd_Unit, Ta_KIB_A.Kd_Sub, Ta_KIB_A.Kd_UPB, Ta_KIB_A.Kd_Aset1, Ta_KIB_A.Kd_Aset2, Ta_KIB_A.Kd_Aset3, Ta_KIB_A.Kd_Aset4, Ta_KIB_A.Kd_Aset5, Ta_KIB_A.Kd_Pemilik, Ta_KIB_A.Sertifikat_Nomor, Ta_KIB_A.Luas_M2, Ta_KIB_A.Alamat, DATENAME(yyyy, Ta_KIB_A.Tgl_Perolehan ), Ta_KIB_A.Keterangan"; return $this->db->query($query); } /** * Tampilkan total eksta skpd */ function total_ekstrakomptabel_skpd($like) {$this->db->select_SUM('Harga'); $this->db->where("$like"); $this->db->where("ekstrakomtabel = 'Y'"); $this->db->from($this->table); $sql = $this->db->get(); foreach ($sql->result() as $row) {$result = $row->Harga; } return $result; } function laporan_skguna($like){$query = "SELECT Ref_Rek_Aset5.Nm_Aset5, Ta_KIBAR.Kd_Prov, Ta_KIBAR.Kd_Kab_Kota, Ta_KIBAR.Kd_Bidang, Ta_KIBAR.Kd_Unit, Ta_KIBAR.Kd_Sub, Ta_KIBAR.Kd_UPB, Ta_KIBAR.Kd_Aset1, Ta_KIBAR.Kd_Aset2, Ta_KIBAR.Kd_Aset3, Ta_KIBAR.Kd_Aset4, Ta_KIBAR.Kd_Aset5, Ta_KIBAR.Kd_Pemilik, Ta_KIBAR.Sertifikat_Nomor, Ta_KIBAR.Luas_M2, Ta_KIBAR.Alamat, DATENAME(yyyy, Ta_KIBAR.Tgl_Perolehan ) AS Tahun, COUNT (*) AS Jumlah_Data, SUM (Ta_KIBAR.Harga) AS Harga, Nm_UPB FROM Ta_KIBAR INNER JOIN Ref_Rek_Aset5 ON Ta_KIBAR.Kd_Aset1 = Ref_Rek_Aset5.Kd_Aset1 AND Ta_KIBAR.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_KIBAR.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_KIBAR.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_KIBAR.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 INNER JOIN Ref_UPB ON Ta_KIBAR.Kd_Bidang=Ref_UPB.Kd_Bidang AND Ta_KIBAR.Kd_Unit=Ref_UPB.Kd_Unit AND Ta_KIBAR.Kd_Sub=Ref_UPB.Kd_Sub AND Ta_KIBAR.Kd_UPB=Ref_UPB.Kd_UPB WHERE Kd_Riwayat = 12 AND $like GROUP BY Ref_Rek_Aset5.Nm_Aset5, Ta_KIBAR.Kd_Prov, Ta_KIBAR.Kd_Kab_Kota, Ta_KIBAR.Kd_Bidang, Ta_KIBAR.Kd_Unit, Ta_KIBAR.Kd_Sub, Ta_KIBAR.Kd_UPB, Ta_KIBAR.Kd_Aset1, Ta_KIBAR.Kd_Aset2, Ta_KIBAR.Kd_Aset3, Ta_KIBAR.Kd_Aset4, Ta_KIBAR.Kd_Aset5, Ta_KIBAR.Kd_Pemilik, Ta_KIBAR.Sertifikat_Nomor, Ta_KIBAR.Luas_M2, Ta_KIBAR.Alamat, DATENAME(yyyy, Ta_KIBAR.Tgl_Perolehan ),Nm_UPB"; return $this->db->query($query); } function total_skguna($like){$this->db->select_SUM('Harga'); $this->db->where("$like"); $this->db->where('Kd_Riwayat = 12'); $this->db->from("Ta_KIBAR"); $sql = $this->db->get(); foreach ($sql->result() as $row) {$result = $row->Harga; } return $result; } function laporan_skhapus($like){$query = "SELECT Ref_Rek_Aset5.Nm_Aset5, Ta_KIBAR.Kd_Prov, Ta_KIBAR.Kd_Kab_Kota, Ta_KIBAR.Kd_Bidang, Ta_KIBAR.Kd_Unit, Ta_KIBAR.Kd_Sub, Ta_KIBAR.Kd_UPB, Ta_KIBAR.Kd_Aset1, Ta_KIBAR.Kd_Aset2, Ta_KIBAR.Kd_Aset3, Ta_KIBAR.Kd_Aset4, Ta_KIBAR.Kd_Aset5, Ta_KIBAR.Kd_Pemilik, Ta_KIBAR.Sertifikat_Nomor, Ta_KIBAR.Luas_M2, Ta_KIBAR.Alamat, DATENAME(yyyy, Ta_KIBAR.Tgl_Perolehan ) AS Tahun, COUNT (*) AS Jumlah_Data, SUM (Ta_KIBAR.Harga) AS Harga, Nm_UPB FROM Ta_KIBAR INNER JOIN Ref_Rek_Aset5 ON Ta_KIBAR.Kd_Aset1 = Ref_Rek_Aset5.Kd_Aset1 AND Ta_KIBAR.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_KIBAR.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_KIBAR.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_KIBAR.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 INNER JOIN Ref_UPB ON Ta_KIBAR.Kd_Bidang=Ref_UPB.Kd_Bidang AND Ta_KIBAR.Kd_Unit=Ref_UPB.Kd_Unit AND Ta_KIBAR.Kd_Sub=Ref_UPB.Kd_Sub AND Ta_KIBAR.Kd_UPB=Ref_UPB.Kd_UPB WHERE Kd_Riwayat = 7 AND $like GROUP BY Ref_Rek_Aset5.Nm_Aset5, Ta_KIBAR.Kd_Prov, Ta_KIBAR.Kd_Kab_Kota, Ta_KIBAR.Kd_Bidang, Ta_KIBAR.Kd_Unit, Ta_KIBAR.Kd_Sub, Ta_KIBAR.Kd_UPB, Ta_KIBAR.Kd_Aset1, Ta_KIBAR.Kd_Aset2, Ta_KIBAR.Kd_Aset3, Ta_KIBAR.Kd_Aset4, Ta_KIBAR.Kd_Aset5, Ta_KIBAR.Kd_Pemilik, Ta_KIBAR.Sertifikat_Nomor, Ta_KIBAR.Luas_M2, Ta_KIBAR.Alamat, DATENAME(yyyy, Ta_KIBAR.Tgl_Perolehan ),Nm_UPB"; return $this->db->query($query); } function total_skhapus($like){$this->db->select_SUM('Harga'); $this->db->where("$like"); $this->db->where('Kd_Riwayat = 7'); $this->db->from("Ta_KIBAR"); $sql = $this->db->get(); foreach ($sql->result() as $row) {$result = $row->Harga; } return $result; } function laporan_usulhapus($bidang,$unit,$sub,$upb,$like) {$kb 	=  $this->session->userdata('kd_bidang'); $ku 	=  $this->session->userdata('kd_unit'); $ks 	=  $this->session->userdata('kd_sub_unit'); $kupb 	=  $this->session->userdata('kd_upb'); if ($this->session->userdata('lvl') == 01){$where = "(Ta_KIBAR.Kd_Bidang = $bidang) AND (Ta_KIBAR.Kd_Unit = $unit) AND (Ta_KIBAR.Kd_Sub = $sub) AND (Ta_KIBAR.Kd_UPB = $upb) AND"; }elseif ($this->session->userdata('lvl') == 02){$where = "(Ta_KIBAR.Kd_Bidang = $kb ) AND (Ta_KIBAR.Kd_Unit =$ku ) AND (Ta_KIBAR.Kd_Sub = $ks) AND (Ta_KIBAR.Kd_UPB = $upb) AND"; }else{$where = "(Ta_KIBAR.Kd_Bidang = $kb) AND (Ta_KIBAR.Kd_Unit = $ku) AND (Ta_KIBAR.Kd_Sub = $ks) AND (Ta_KIBAR.Kd_UPB = $kupb) AND"; } $query = "SELECT Ref_Rek_Aset5.Nm_Aset5, Ta_KIBAR.Kd_Prov, Ta_KIBAR.Kd_Kab_Kota, Ta_KIBAR.Kd_Bidang, Ta_KIBAR.Kd_Unit, Ta_KIBAR.Kd_Sub, Ta_KIBAR.Kd_UPB, Ta_KIBAR.Kd_Aset1, Ta_KIBAR.Kd_Aset2, Ta_KIBAR.Kd_Aset3, Ta_KIBAR.Kd_Aset4, Ta_KIBAR.Kd_Aset5, Ta_KIBAR.Kd_Pemilik, Ta_KIBAR.Sertifikat_Nomor, Ta_KIBAR.Luas_M2, Ta_KIBAR.Alamat, DATENAME(yyyy, Ta_KIBAR.Tgl_Perolehan ) AS Tahun, COUNT (*) AS Jumlah_Data, SUM (Ta_KIBAR.Harga) AS Harga, Ta_KIBAR.Keterangan FROM Ta_KIBAR INNER JOIN Ref_Rek_Aset5 ON Ta_KIBAR.Kd_Aset1 = Ref_Rek_Aset5.Kd_Aset1 AND Ta_KIBAR.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_KIBAR.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_KIBAR.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_KIBAR.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 WHERE Kd_Riwayat = 7 GROUP BY Ref_Rek_Aset5.Nm_Aset5, Ta_KIBAR.Kd_Prov, Ta_KIBAR.Kd_Kab_Kota, Ta_KIBAR.Kd_Bidang, Ta_KIBAR.Kd_Unit, Ta_KIBAR.Kd_Sub, Ta_KIBAR.Kd_UPB, Ta_KIBAR.Kd_Aset1, Ta_KIBAR.Kd_Aset2, Ta_KIBAR.Kd_Aset3, Ta_KIBAR.Kd_Aset4, Ta_KIBAR.Kd_Aset5, Ta_KIBAR.Kd_Pemilik, Ta_KIBAR.Sertifikat_Nomor, Ta_KIBAR.Luas_M2, Ta_KIBAR.Alamat, DATENAME(yyyy, Ta_KIBAR.Tgl_Perolehan ), Ta_KIBAR.Keterangan"; return $this->db->query($query); } /** * Tampilkan total_pengadaan */ function total_usulhapus($bidang,$unit,$sub,$upb,$like) {if ($this->session->userdata('lvl') == 01){$this->db->where('Kd_Bidang',$bidang); $this->db->where('Kd_Unit',$unit); $this->db->where('Kd_Sub',$sub); $this->db->where('Kd_UPB',$upb); }elseif ($this->session->userdata('lvl') == 02){$this->db->where('Kd_Bidang',$this->session->userdata('kd_bidang')); $this->db->where('Kd_Unit',$this->session->userdata('kd_unit')); $this->db->where('Kd_Sub',$this->session->userdata('kd_sub_unit')); $this->db->where('Kd_UPB',$upb); }else{$this->db->where('Kd_Bidang',$this->session->userdata('kd_bidang')); $this->db->where('Kd_Unit',$this->session->userdata('kd_unit')); $this->db->where('Kd_Sub',$this->session->userdata('kd_sub_unit')); $this->db->where('Kd_UPB',$this->session->userdata('kd_upb')); } $this->db->select_SUM('Harga'); $this->db->where("$like"); $this->db->where('Kd_Riwayat = 7'); $this->db->from('Ta_KIBAR'); $sql = $this->db->get(); foreach ($sql->result() as $row) {$result = $row->Harga; } return $result; } function kiba_mutasi_barang($like) {$query = "SELECT Nm_UPB, Ref_Rek_Aset5.Nm_Aset5,COUNT(Ta_KIB_A.No_register) as jumlah_register,MIN(Ta_KIB_A.No_register) as min_register, MAX(Ta_KIB_A.No_register) as max_register, Ta_KIB_A.Kd_Prov, Ta_KIB_A.Kd_Kab_Kota, Ta_KIB_A.Kd_Bidang, Ta_KIB_A.Kd_Unit, Ta_KIB_A.Kd_Sub, Ta_KIB_A.Kd_UPB, Ta_KIB_A.Kd_Aset1, Ta_KIB_A.Kd_Aset2, Ta_KIB_A.Kd_Aset3,  Ta_KIB_A.Kd_Aset4, Ta_KIB_A.Kd_Aset5, Ta_KIB_A.Kd_Pemilik,DATENAME(yyyy,Ta_KIB_A.Tgl_Perolehan) as Tahun, Ta_KIB_A.Luas_M2,  Ta_KIB_A.Alamat, Ta_KIB_A.Hak_Tanah, Ta_KIB_A.Sertifikat_Tanggal,Ta_KIB_A.Sertifikat_Nomor, Ta_KIB_A.Penggunaan,Ta_KIB_A.Asal_usul,COUNT(*) as Jumlah, SUM(Ta_KIB_A.Harga) as Harga,Ta_KIB_A.Keterangan  FROM Ta_KIB_A INNER JOIN Ref_Rek_Aset5 ON Ta_KIB_A.Kd_Aset1 = Ref_Rek_Aset5.Kd_Aset1 AND Ta_KIB_A.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_KIB_A.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_KIB_A.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_KIB_A.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 INNER JOIN Ref_UPB ON Ta_KIB_A.Kd_Bidang=Ref_UPB.Kd_Bidang AND Ta_KIB_A.Kd_Unit=Ref_UPB.Kd_Unit AND Ta_KIB_A.Kd_Sub=Ref_UPB.Kd_Sub AND Ta_KIB_A.Kd_UPB=Ref_UPB.Kd_UPB WHERE  $like GROUP BY Ta_KIB_A.Kd_Prov, Ta_KIB_A.Kd_Kab_Kota, Ta_KIB_A.Kd_Bidang, Ta_KIB_A.Kd_Unit, Ta_KIB_A.Kd_Sub, Ta_KIB_A.Kd_UPB, Ta_KIB_A.Kd_Aset1, Ta_KIB_A.Kd_Aset2, Ta_KIB_A.Kd_Aset3, Ta_KIB_A.Kd_Aset4, Ta_KIB_A.Kd_Aset5, Ta_KIB_A.Kd_Pemilik, Ta_KIB_A.Kd_Pemilik,Ta_KIB_A.Tgl_Perolehan, Ta_KIB_A.Luas_M2,  Ta_KIB_A.Alamat, Ta_KIB_A.Hak_Tanah, Ta_KIB_A.Sertifikat_Tanggal,Ta_KIB_A.Sertifikat_Nomor, Ta_KIB_A.Penggunaan,Ta_KIB_A.Asal_usul,Ta_KIB_A.Keterangan,Ref_Rek_Aset5.Nm_Aset5,Nm_UPB ORDER BY Ref_Rek_Aset5.Nm_Aset5, MIN(Ta_KIB_A.No_register)";  return $this->db->query($query); } function total_kiba_mutasi_barang($like){$query = "SELECT COUNT(*) as Jumlah, SUM(Harga) as Harga FROM Ta_KIB_A where Kd_Aset1=1 AND $like"; return $this->db->query($query); } function rekap_mutasi_induk($like,$tahunawal,$tahunakhir)  {$query = "SELECT Ref_Rek_Aset2.Kd_Aset1, Ref_Rek_Aset2.Kd_Aset2, Nm_Aset2, COUNT(case when Tgl_Perolehan < '$tahunawal' then 1 else NULL end) as Jumlah_awal, SUM(CASE WHEN Tgl_Perolehan < '$tahunawal' THEN Harga else 0 END) as Harga_awal, COUNT(case WHEN $like then 0 else null end) as Jumlah_tambah, SUM(CASE WHEN $like THEN Harga END) as Harga_tambah FROM Ref_Rek_Aset2 LEFT JOIN (SELECT * FROM Ta_KIB_A ) AS Ta_KIB_A ON Ta_KIB_A.Kd_Aset1 = Ref_Rek_Aset2.Kd_Aset1 AND Ta_KIB_A.Kd_Aset2 = Ref_Rek_Aset2.Kd_Aset2 WHERE Ref_Rek_Aset2.Kd_Aset1 = 1 GROUP BY Ref_Rek_Aset2.Kd_Aset1, Ref_Rek_Aset2.Kd_Aset2, Nm_Aset2 ORDER BY Ref_Rek_Aset2.Kd_Aset2"; return $this->db->query($query); } function total_rekap_mutasi_induk($like,$tahunawal,$tahunakhir) {$query = "SELECT COUNT(case when Tgl_Perolehan < '$tahunawal' then 1 else NULL end) as Jumlah_awal, SUM(CASE WHEN Tgl_Perolehan < '$tahunawal' THEN Harga else 0 END) as Harga_awal, COUNT(case WHEN $like then 0 else null end) as Jumlah_tambah, SUM(CASE WHEN $like THEN Harga END) as Harga_tambah, COUNT(case when Tgl_Perolehan <= '$tahunakhir' then 1 else NULL end) as Jumlah, SUM(CASE WHEN Tgl_Perolehan <= '$tahunakhir' THEN Harga else 0 END) as Harga FROM Ref_Rek_Aset2 LEFT JOIN (SELECT * FROM Ta_KIB_A ) AS Ta_KIB_A ON Ta_KIB_A.Kd_Aset1 = Ref_Rek_Aset2.Kd_Aset1 AND Ta_KIB_A.Kd_Aset2 = Ref_Rek_Aset2.Kd_Aset2 WHERE Ref_Rek_Aset2.Kd_Aset1 = 1"; return $this->db->query($query); } function kiba_rinventaris_rekap($like)  {$where = "$like"; $query = "select Ref_Rek_Aset2.Kd_Aset1,Ref_Rek_Aset2.Kd_Aset2,Nm_Aset2,COUNT(*) as Jumlah, SUM(Harga) as Harga from Ref_Rek_Aset2 LEFT JOIN (SELECT * from Ta_KIB_A where $where) as Ta_KIB_A ON  Ta_KIB_A.Kd_Aset1=Ref_Rek_Aset2.Kd_Aset1 AND Ta_KIB_A.Kd_Aset2=Ref_Rek_Aset2.Kd_Aset2 WHERE Ref_Rek_Aset2.Kd_Aset1=1 GROUP BY Ref_Rek_Aset2.Kd_Aset1,Ref_Rek_Aset2.Kd_Aset2,Nm_Aset2 "; return $this->db->query($query); } function total_kiba_rinventaris_rekap($like)  {$where = "$like"; $query = "SELECT COUNT(*) as Jumlah,SUM(Harga) as Harga FROM Ta_KIB_A where $where"; return $this->db->query($query); } /* 06-07-2014 */ function laporan_all_rkodebarang($like){$query = "select Ref_Rek_Aset5.Kd_Aset1,Ref_Rek_Aset5.Kd_Aset2,Ref_Rek_Aset5.Kd_Aset3,Ref_Rek_Aset5.Kd_Aset4,Ref_Rek_Aset5.Kd_Aset5, Nm_Aset5,COUNT(*) as Jumlah, SUM(Harga) as Harga,Nm_UPB from Ref_Rek_Aset5 RIGHT JOIN Ta_KIB_A ON Ta_KIB_A.Kd_Aset1=Ref_Rek_Aset5.Kd_Aset1 AND Ta_KIB_A.Kd_Aset2=Ref_Rek_Aset5.Kd_Aset2 AND Ta_KIB_A.Kd_Aset3=Ref_Rek_Aset5.Kd_Aset3 AND Ta_KIB_A.Kd_Aset4=Ref_Rek_Aset5.Kd_Aset4 AND Ta_KIB_A.Kd_Aset5=Ref_Rek_Aset5.Kd_Aset5 LEFT JOIN Ref_UPB ON Ta_KIB_A.Kd_Bidang=Ref_UPB.Kd_Bidang AND Ta_KIB_A.Kd_Unit=Ref_UPB.Kd_Unit AND Ta_KIB_A.Kd_Sub=Ref_UPB.Kd_Sub AND Ta_KIB_A.Kd_UPB=Ref_UPB.Kd_UPB WHERE $like GROUP BY Ref_Rek_Aset5.Kd_Aset1,Ref_Rek_Aset5.Kd_Aset2,Ref_Rek_Aset5.Kd_Aset3, Ref_Rek_Aset5.Kd_Aset4,Ref_Rek_Aset5.Kd_Aset5,Nm_Aset5,Nm_UPB ORDER BY Ref_Rek_Aset5.Kd_Aset1,Ref_Rek_Aset5.Kd_Aset2,Ref_Rek_Aset5.Kd_Aset3, Ref_Rek_Aset5.Kd_Aset4,Ref_Rek_Aset5.Kd_Aset5"; return $this->db->query($query); } /* 12-08-2014*/ function total_kib_skpd($bidang,$unit,$sub,$upb,$like){$kb 	=  $this->session->userdata('kd_bidang'); $ku 	=  $this->session->userdata('kd_unit'); $ks 	=  $this->session->userdata('kd_sub_unit'); $kupb 	=  $this->session->userdata('kd_upb'); if ($this->session->userdata('lvl') == 01){$where = "(Ta_KIB_A.Kd_Bidang = $bidang) AND (Ta_KIB_A.Kd_Unit = $unit) AND (Ta_KIB_A.Kd_Sub = $sub) AND (Ta_KIB_A.Kd_UPB = $upb) AND"; }elseif ($this->session->userdata('lvl') == 02){$where = "(Ta_KIB_A.Kd_Bidang = $kb ) AND (Ta_KIB_A.Kd_Unit =$ku ) AND (Ta_KIB_A.Kd_Sub = $ks) AND (Ta_KIB_A.Kd_UPB = $upb) AND"; }else{$where = "(Ta_KIB_A.Kd_Bidang = $kb) AND (Ta_KIB_A.Kd_Unit = $ku) AND (Ta_KIB_A.Kd_Sub = $ks) AND (Ta_KIB_A.Kd_UPB = $kupb) AND"; } $query = "SELECT COUNT(CASE WHEN Harga > 0 THEN 1 ELSE null END) as Jumlah, Ta_KIB_A.Kd_Bidang,Ta_KIB_A.Kd_Unit,Ta_KIB_A.Kd_Sub,Ta_KIB_A.Kd_UPB,SUM(Ta_KIB_A.Harga) as Harga, (SELECT SUM(Harga) as RHarga FROM Ta_KIBAR WHERE Ta_KIBAR.Kd_Riwayat = '2' AND Ta_KIB_A.Kd_Bidang = Ta_KIBAR.Kd_Bidang AND Ta_KIB_A.Kd_Unit = Ta_KIBAR.Kd_Unit AND Ta_KIB_A.Kd_Sub = Ta_KIBAR.Kd_Sub AND Ta_KIB_A.Kd_UPB = Ta_KIBAR.Kd_UPB ) AS Kapitalisasi, (SELECT SUM(Harga) as RHarga FROM Ta_KIBAR WHERE Ta_KIBAR.Kd_Riwayat = '21' AND Ta_KIB_A.Kd_Bidang = Ta_KIBAR.Kd_Bidang AND Ta_KIB_A.Kd_Unit = Ta_KIBAR.Kd_Unit AND Ta_KIB_A.Kd_Sub = Ta_KIBAR.Kd_Sub AND Ta_KIB_A.Kd_UPB = Ta_KIBAR.Kd_UPB ) AS Koreksi, (SELECT SUM(Harga) as RHarga FROM Ta_KIBAR WHERE Ta_KIBAR.Kd_Riwayat = '7' AND Ta_KIB_A.Kd_Bidang = Ta_KIBAR.Kd_Bidang AND Ta_KIB_A.Kd_Unit = Ta_KIBAR.Kd_Unit AND Ta_KIB_A.Kd_Sub = Ta_KIBAR.Kd_Sub AND Ta_KIB_A.Kd_UPB = Ta_KIBAR.Kd_UPB ) AS Penghapusan FROM Ta_KIB_A WHERE $where $like "; $query .= "GROUP BY Ta_KIB_A.Kd_Bidang,Ta_KIB_A.Kd_Unit,Ta_KIB_A.Kd_Sub,Ta_KIB_A.Kd_UPB "; return $this->db->query($query); } /* start 2015 */ function laporan_intrakomptabel_induk($like){$query = "SELECT Ref_Rek_Aset5.Nm_Aset5, Ta_KIB_A.Kd_Prov, Ta_KIB_A.Kd_Kab_Kota, Ta_KIB_A.Kd_Bidang, Ta_KIB_A.Kd_Unit, Ta_KIB_A.Kd_Sub, Ta_KIB_A.Kd_UPB, Ta_KIB_A.Kd_Aset1, Ta_KIB_A.Kd_Aset2, Ta_KIB_A.Kd_Aset3, Ta_KIB_A.Kd_Aset4, Ta_KIB_A.Kd_Aset5, Ta_KIB_A.Kd_Pemilik, Ta_KIB_A.Sertifikat_Nomor, Ta_KIB_A.Luas_M2, Ta_KIB_A.Alamat, DATENAME(yyyy, Ta_KIB_A.Tgl_Perolehan ) AS Tahun, COUNT (*) AS Jumlah_Data, SUM (Ta_KIB_A.Harga) AS Harga, Ta_KIB_A.Keterangan FROM Ta_KIB_A INNER JOIN Ref_Rek_Aset5 ON Ta_KIB_A.Kd_Aset1 = Ref_Rek_Aset5.Kd_Aset1 AND Ta_KIB_A.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_KIB_A.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_KIB_A.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_KIB_A.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 WHERE  $like AND ekstrakomtabel = ''GROUP BY Ref_Rek_Aset5.Nm_Aset5, Ta_KIB_A.Kd_Prov, Ta_KIB_A.Kd_Kab_Kota, Ta_KIB_A.Kd_Bidang, Ta_KIB_A.Kd_Unit, Ta_KIB_A.Kd_Sub, Ta_KIB_A.Kd_UPB, Ta_KIB_A.Kd_Aset1, Ta_KIB_A.Kd_Aset2, Ta_KIB_A.Kd_Aset3, Ta_KIB_A.Kd_Aset4, Ta_KIB_A.Kd_Aset5, Ta_KIB_A.Kd_Pemilik, Ta_KIB_A.Sertifikat_Nomor, Ta_KIB_A.Luas_M2, Ta_KIB_A.Alamat, DATENAME(yyyy, Ta_KIB_A.Tgl_Perolehan ), Ta_KIB_A.Keterangan"; return $this->db->query($query); } function total_intrakomptabel_induk($like) {$this->db->select_SUM('Harga'); $this->db->where("$like"); $this->db->where("ekstrakomtabel = ''"); $this->db->from($this->table); $sql = $this->db->get(); foreach ($sql->result() as $row) {$result = $row->Harga; } return $result; } /* end 2015 */ /* 13-05-2015 */ function rekap_neraca($bidang='',$unit='',$sub='',$upb='',$tahunawal,$tahunakhir,$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; $where .= "AND (a.Kd_UPB = $kupb)"; } $tgl_pembukuan = " AND Tgl_Pembukuan ".$like; $tgl_dokumen   = " AND Tgl_Dokumen <= '".$tahunakhir."'"; $thn           = $this->session->userdata('tahun_anggaran'); $query = "SELECT Ref_Rek_Aset2.Kd_Aset1,Ref_Rek_Aset2.Kd_Aset2,Nm_Aset2, SUM(CASE WHEN Kd_KA = 0 THEN LastHarga END) as KIB_A_Non_Operasional, SUM(CASE WHEN Kd_KA <> 0 THEN LastHarga END) as NB_Akhir FROM Ref_Rek_Aset2 LEFT JOIN ( SELECT *, floor((Harga + ISNULL(Koreksi_Tambah, 0) ) - ISNULL(Koreksi_Kurang, 0) ) as LastHarga FROM (SELECT a1.*, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_KIB_A a1 INNER JOIN Ref_Rek_Aset5 n ON a1.Kd_Aset1 = n.Kd_Aset1 AND a1.Kd_Aset2 = n.Kd_Aset2 AND a1.Kd_Aset3 = n.Kd_Aset3 AND a1.Kd_Aset4 = n.Kd_Aset4 AND a1.Kd_Aset5 = n.Kd_Aset5 WHERE NOT EXISTS (SELECT 1 FROM   Ta_KIBAHapus d INNER JOIN Ta_Penghapusan e ON d.No_SK=e.No_SK WHERE a1.Kd_Bidang=d.Kd_Bidang AND a1.Kd_Unit=d.Kd_Unit AND a1.Kd_Sub=d.Kd_Sub AND a1.Kd_UPB=d.Kd_UPB AND a1.Kd_Aset1=d.Kd_Aset1 AND a1.Kd_Aset2=d.Kd_Aset2 AND a1.Kd_Aset3=d.Kd_Aset3 AND a1.Kd_Aset4=d.Kd_Aset4 AND a1.Kd_Aset5=d.Kd_Aset5 AND a1.No_Register=d.No_Register AND e.Tgl_SK <= '{$tahunakhir}') AND NOT EXISTS (SELECT 1 FROM   Ta_KIBAR e WHERE a1.Kd_Bidang=e.Kd_Bidang AND a1.Kd_Unit=e.Kd_Unit AND a1.Kd_Sub=e.Kd_Sub AND a1.Kd_UPB=e.Kd_UPB AND a1.Kd_Aset1=e.Kd_Aset1 AND a1.Kd_Aset2=e.Kd_Aset2 AND a1.Kd_Aset3=e.Kd_Aset3 AND a1.Kd_Aset4=e.Kd_Aset4 AND a1.Kd_Aset5=e.Kd_Aset5 AND a1.No_Register=e.No_Register  AND Kd_Riwayat IN (3,19) AND e.Tgl_Dokumen <= '{$tahunakhir}') ) AS a WHERE 1=1 $where $tgl_pembukuan)  as a1 ON a1.Kd_Aset1=Ref_Rek_Aset2.Kd_Aset1 AND a1.Kd_Aset2=Ref_Rek_Aset2.Kd_Aset2 WHERE Ref_Rek_Aset2.Kd_Aset1=1 GROUP BY Ref_Rek_Aset2.Kd_Aset1,Ref_Rek_Aset2.Kd_Aset2,Nm_Aset2"; return $this->db->query($query); } function rincian_neraca($bidang='',$unit='',$sub='',$upb='',$tahunawal,$tahunakhir,$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; $where .= "AND (a.Kd_UPB = $kupb)"; } $tgl_pembukuan = " AND Tgl_Pembukuan ".$like; $tgl_dokumen   = " AND Tgl_Dokumen <= '".$tahunakhir."'"; $thn           = $this->session->userdata('tahun_anggaran'); $query = "SELECT d5.Kd_Bidang,d5.Kd_Unit,d5.Kd_Sub,d5.Kd_UPB, d5.Kd_Aset1,d5.Kd_Aset2,d5.Kd_Aset3,d5.Kd_Aset4,d5.Kd_Aset5, d2.Nm_Aset2,d3.Nm_Aset3,d4.Nm_Aset4,Nm_Aset5, SUM(CASE WHEN Kd_KA = 0 THEN LastHarga END) as NB_Non_Operasional, SUM(CASE WHEN Kd_KA <> 0 THEN LastHarga END) as Harga FROM  (SELECT *, ((Harga + ISNULL(Koreksi_Tambah, 0) ) - ISNULL(Koreksi_Kurang, 0) ) as LastHarga FROM (SELECT n.Nm_Aset5,a1.*, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_KIB_A a1 INNER JOIN Ref_Rek_Aset5 n ON a1.Kd_Aset1 = n.Kd_Aset1 AND a1.Kd_Aset2 = n.Kd_Aset2 AND a1.Kd_Aset3 = n.Kd_Aset3 AND a1.Kd_Aset4 = n.Kd_Aset4 AND a1.Kd_Aset5 = n.Kd_Aset5 WHERE NOT EXISTS (SELECT 1 FROM   Ta_KIBAHapus d INNER JOIN Ta_Penghapusan e ON d.No_SK=e.No_SK WHERE a1.Kd_Bidang=d.Kd_Bidang AND a1.Kd_Unit=d.Kd_Unit AND a1.Kd_Sub=d.Kd_Sub AND a1.Kd_UPB=d.Kd_UPB AND a1.Kd_Aset1=d.Kd_Aset1 AND a1.Kd_Aset2=d.Kd_Aset2 AND a1.Kd_Aset3=d.Kd_Aset3 AND a1.Kd_Aset4=d.Kd_Aset4 AND a1.Kd_Aset5=d.Kd_Aset5 AND a1.No_Register=d.No_Register AND YEAR(e.Tgl_SK) <= '{$thn}') AND NOT EXISTS (SELECT 1 FROM   Ta_KIBAR e WHERE a1.Kd_Bidang=e.Kd_Bidang AND a1.Kd_Unit=e.Kd_Unit AND a1.Kd_Sub=e.Kd_Sub AND a1.Kd_UPB=e.Kd_UPB AND a1.Kd_Aset1=e.Kd_Aset1 AND a1.Kd_Aset2=e.Kd_Aset2 AND a1.Kd_Aset3=e.Kd_Aset3 AND a1.Kd_Aset4=e.Kd_Aset4 AND a1.Kd_Aset5=e.Kd_Aset5 AND a1.No_Register=e.No_Register  AND Kd_Riwayat IN (3,19) AND YEAR(e.Tgl_Dokumen) <= '{$thn}') ) AS a WHERE 1=1 $where $tgl_pembukuan ) as d5 LEFT JOIN Ref_Rek_Aset4 d4 ON d5.Kd_Aset1=d4.Kd_Aset1 AND d5.Kd_Aset2=d4.Kd_Aset2 AND d5.Kd_Aset3=d4.Kd_Aset3 AND d5.Kd_Aset4=d4.Kd_Aset4 LEFT JOIN Ref_Rek_Aset3 d3 ON d5.Kd_Aset1=d3.Kd_Aset1 AND d5.Kd_Aset2=d3.Kd_Aset2 AND d5.Kd_Aset3=d3.Kd_Aset3 LEFT JOIN Ref_Rek_Aset2 d2 ON d5.Kd_Aset1=d2.Kd_Aset1 AND d5.Kd_Aset2=d2.Kd_Aset2 GROUP BY d5.Kd_Bidang,d5.Kd_Unit,d5.Kd_Sub,d5.Kd_UPB, d5.Kd_Aset1,d5.Kd_Aset2,d5.Kd_Aset3,d5.Kd_Aset4,d5.Kd_Aset5, d2.Nm_Aset2,d3.Nm_Aset3,d4.Nm_Aset4,d5.Nm_Aset5"; return $this->db->query($query); } /** * Total Rekap Kendaraan */ function total_neraca_kiba($bidang='',$unit='',$sub='',$upb='',$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (Ta_KIB_A.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (Ta_KIB_A.Kd_Unit = $unit)"; } if($sub){$where .= "AND (Ta_KIB_A.Kd_Sub = $sub)"; } if($upb){$where .= "AND (Ta_KIB_A.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){if($bidang){$where = "AND (Ta_KIB_A.Kd_Bidang = $kb)"; } if($unit){$where .= "AND (Ta_KIB_A.Kd_Unit = $ku)"; } if($sub){$where .= "AND (Ta_KIB_A.Kd_Sub = $ks)"; } if($upb){$where .= "AND (Ta_KIB_A.Kd_UPB = $upb)"; } }else{if($bidang){$where = "AND (Ta_KIB_A.Kd_Bidang = $kb)"; } if($unit){$where .= "AND (Ta_KIB_A.Kd_Unit = $ku)"; } if($sub){$where .= "AND (Ta_KIB_A.Kd_Sub = $ks)"; } if($upb){$where .= "AND (Ta_KIB_A.Kd_UPB = $kupb)"; } } $query = "SELECT SUM(Harga) as Harga, SUM(Harga) AS intra, NULL AS ekstra, NULL AS RB, NULL AS Susut FROM Ref_Rek_Aset2 LEFT JOIN (SELECT * FROM Ta_KIB_A WHERE 1=1 $where AND $like) as Ta_KIB_A ON Ta_KIB_A.Kd_Aset1=Ref_Rek_Aset2.Kd_Aset1 AND Ta_KIB_A.Kd_Aset2=Ref_Rek_Aset2.Kd_Aset2 WHERE Ref_Rek_Aset2.Kd_Aset1=1"; return $this->db->query($query); } /* riwayat */ function get_riwayat($limit, $offset, $where, $like){if($offset == 0  or !isset($offset)){$first = 1; $last  = $limit; }else{$first = $offset+1; $last  = $first + ($limit -1); } $sql = "SELECT  * FROM  (SELECT  Ref_Rek_Aset5.Nm_Aset5, Ref_Riwayat.Nm_Riwayat,Ta_KIBAR.*, ROW_NUMBER() OVER (ORDER BY Ta_KIBAR.Tgl_Pembukuan DESC) AS halaman		FROM  Ta_KIBAR INNER JOIN Ref_Rek_Aset5 ON Ta_KIBAR.Kd_Aset1=Ref_Rek_Aset5.Kd_Aset1 AND Ta_KIBAR.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_KIBAR.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_KIBAR.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_KIBAR.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 LEFT JOIN Ref_Riwayat ON Ta_KIBAR.Kd_Riwayat=Ref_Riwayat.Kd_Riwayat WHERE 1=1 $where $like AND Ta_KIBAR.Kd_Aset1 = '1') AS Ta_KIBAR WHERE halaman BETWEEN $first AND $last  ORDER BY halaman ASC"; return $this->db->query($sql); } /* count kib b total page */ function count_riwayat($where, $like) {$sql= "SELECT     * FROM (SELECT     *	FROM   Ta_KIBAR WHERE 1=1 $where $like AND Ta_KIBAR.Kd_Aset1 = '1' ) AS Ta_KIBAR INNER JOIN Ref_Rek_Aset5 ON Ta_KIBAR.Kd_Aset1=Ref_Rek_Aset5.Kd_Aset1 AND Ta_KIBAR.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_KIBAR.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_KIBAR.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_KIBAR.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5"; return $this->db->query($sql); } /** * Tampilkan total harga kib b */ function total_riwayat($where, $like) {$query= "SELECT SUM(Harga) AS Harga FROM  Ta_KIBAR INNER JOIN Ref_Rek_Aset5 ON Ta_KIBAR.Kd_Aset1=Ref_Rek_Aset5.Kd_Aset1 AND Ta_KIBAR.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_KIBAR.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_KIBAR.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_KIBAR.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5  WHERE 1=1 $where $like AND Ta_KIBAR.Kd_Aset1 = '1'"; $sql = $this->db->query($query); foreach ($sql->result() as $row) {$result = $row->Harga; } return $result; } function get_riwayat_barang($kd_prov,$kd_kab,$kd_bidang,$kd_unit,$kd_sub,$kd_upb, $kd_aset1,$kd_aset2,$kd_aset3,$kd_aset4,$kd_aset5,$no_register){$where = ""; $where .= " AND Ta_KIBAR.Kd_Prov=".$kd_prov; $where .= " AND Ta_KIBAR.Kd_Kab_Kota=".$kd_kab; $where .= " AND Ta_KIBAR.Kd_Bidang=".$kd_bidang; $where .= " AND Ta_KIBAR.Kd_Unit=".$kd_unit; $where .= " AND Ta_KIBAR.Kd_Sub=".$kd_sub; $where .= " AND Ta_KIBAR.Kd_UPB=".$kd_upb; $where .= " AND Ta_KIBAR.Kd_Aset1=".$kd_aset1; $where .= " AND Ta_KIBAR.Kd_Aset2=".$kd_aset2; $where .= " AND Ta_KIBAR.Kd_Aset3=".$kd_aset3; $where .= " AND Ta_KIBAR.Kd_Aset4=".$kd_aset4; $where .= " AND Ta_KIBAR.Kd_Aset5=".$kd_aset5; $where .= " AND Ta_KIBAR.No_register=".$no_register; $sql = "SELECT  * FROM  (SELECT  Ref_Rek_Aset5.Nm_Aset5, Ref_Riwayat.Nm_Riwayat,Ta_KIBAR.*, ROW_NUMBER() OVER (ORDER BY Ta_KIBAR.Log_entry DESC) AS halaman		FROM  Ta_KIBAR INNER JOIN Ref_Rek_Aset5 ON Ta_KIBAR.Kd_Aset1=Ref_Rek_Aset5.Kd_Aset1 AND Ta_KIBAR.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_KIBAR.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_KIBAR.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_KIBAR.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 LEFT JOIN Ref_Riwayat ON Ta_KIBAR.Kd_Riwayat=Ref_Riwayat.Kd_Riwayat WHERE 1=1 $where) AS Ta_KIBAR"; return $this->db->query($sql); } /** * Menampilkan semua data kib b rekap */ function rekap_inventaris($bidang='',$unit='',$sub='',$upb='',$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $thn   =  $this->session->userdata('tahun_anggaran'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; $where .= "AND (a.Kd_UPB = $kupb)"; } $tgl_pembukuan 	= " AND Tgl_Pembukuan ".$like; $tgl_dokumen 	= " AND Tgl_Dokumen ".$like; $query = "SELECT Ref_Rek_Aset2.Kd_Aset1,Ref_Rek_Aset2.Kd_Aset2,Nm_Aset2,COUNT(*) as Jumlah, SUM ((Harga+ (CASE WHEN Koreksi_Tambah is null THEN 0 ELSE Koreksi_Tambah END) ) - (CASE WHEN Koreksi_Kurang is null THEN 0 ELSE Koreksi_Kurang END) ) AS Harga FROM Ref_Rek_Aset2 LEFT JOIN (SELECT * FROM (SELECT n.Nm_Aset5,a1.Kd_Prov,a1.Kd_Kab_Kota, (CASE WHEN Kd_Bidang1 IS NULL THEN a1.Kd_Bidang ELSE Kd_Bidang1 END) as Kd_Bidang, (CASE WHEN Kd_Unit1 IS NULL THEN a1.Kd_Unit ELSE Kd_Unit1 END) as Kd_Unit, (CASE WHEN Kd_Sub1 IS NULL THEN a1.Kd_Sub ELSE Kd_Sub1 END) as Kd_Sub, (CASE WHEN Kd_UPB1 IS NULL THEN a1.Kd_UPB ELSE Kd_UPB1 END) as Kd_UPB, a1.Kd_Aset1,a1.Kd_Aset2,a1.Kd_Aset3,a1.Kd_Aset4,a1.Kd_Aset5,a1.No_Register, a1.Kd_Pemilik,a1.Tgl_Perolehan,a1.Tgl_Pembukuan,a1.Luas_M2,a1.Alamat,a1.Hak_Tanah, a1.Sertifikat_Tanggal,a1.Sertifikat_Nomor,a1.Penggunaan,a1.Asal_usul,a1.Harga,a1.Keterangan, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_KIB_A a1 OUTER APPLY (SELECT TOP 1 Kd_Bidang1,Kd_Unit1,Kd_Sub1,Kd_UPB1 FROM Ta_KIBAR c WHERE a1.Kd_Bidang=c.Kd_Bidang AND a1.Kd_Unit=c.Kd_Unit AND a1.Kd_Sub=c.Kd_Sub AND a1.Kd_UPB=c.Kd_UPB AND a1.Kd_Aset1=c.Kd_Aset1 AND a1.Kd_Aset2=c.Kd_Aset2 AND a1.Kd_Aset3=c.Kd_Aset3 AND a1.Kd_Aset4=c.Kd_Aset4 AND a1.Kd_Aset5=c.Kd_Aset5 AND a1.No_Register=c.No_Register AND Kd_Riwayat IN (3,19)  AND YEAR(c.Tgl_Dokumen) <= '{$thn}'ORDER BY c.Tgl_Dokumen DESC) as c INNER JOIN Ref_Rek_Aset5 n ON a1.Kd_Aset1 = n.Kd_Aset1 AND a1.Kd_Aset2 = n.Kd_Aset2 AND a1.Kd_Aset3 = n.Kd_Aset3 AND a1.Kd_Aset4 = n.Kd_Aset4 AND a1.Kd_Aset5 = n.Kd_Aset5 WHERE NOT EXISTS (SELECT 1 FROM   Ta_KIBAHapus d INNER JOIN Ta_Penghapusan e ON d.No_SK=e.No_SK WHERE a1.Kd_Bidang=d.Kd_Bidang AND a1.Kd_Unit=d.Kd_Unit AND a1.Kd_Sub=d.Kd_Sub AND a1.Kd_UPB=d.Kd_UPB AND a1.Kd_Aset1=d.Kd_Aset1 AND a1.Kd_Aset2=d.Kd_Aset2 AND a1.Kd_Aset3=d.Kd_Aset3 AND a1.Kd_Aset4=d.Kd_Aset4 AND a1.Kd_Aset5=d.Kd_Aset5 AND a1.No_Register=d.No_Register AND YEAR(e.Tgl_SK) <= '{$thn}') AND NOT EXISTS (SELECT 1 FROM Ta_KIBAR e WHERE a1.Kd_Bidang = e.Kd_Bidang AND a1.Kd_Unit = e.Kd_Unit AND a1.Kd_Sub = e.Kd_Sub AND a1.Kd_UPB = e.Kd_UPB AND a1.Kd_Aset1 = e.Kd_Aset1 AND a1.Kd_Aset2 = e.Kd_Aset2 AND a1.Kd_Aset3 = e.Kd_Aset3 AND a1.Kd_Aset4 = e.Kd_Aset4 AND a1.Kd_Aset5 = e.Kd_Aset5 AND a1.No_Register = e.No_Register AND Kd_Riwayat IN (3, 19) AND YEAR(e.Tgl_Dokumen) <= '{$thn}') )as a WHERE 1=1 $where $tgl_pembukuan) as a1 ON a1.Kd_Aset1=Ref_Rek_Aset2.Kd_Aset1 AND a1.Kd_Aset2=Ref_Rek_Aset2.Kd_Aset2 WHERE Ref_Rek_Aset2.Kd_Aset1=1 GROUP BY Ref_Rek_Aset2.Kd_Aset1,Ref_Rek_Aset2.Kd_Aset2,Nm_Aset2"; return $this->db->query($query); } /** * Menampilkan semua data kib b rekap */ function total_rekap_inventaris($bidang='',$unit='',$sub='',$upb='',$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = " AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= " AND (a.Kd_Unit = $unit)"; } if($sub){$where .= " AND (a.Kd_Sub = $sub)"; } if($upb){$where .= " AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){if($bidang){$where = " AND (a.Kd_Bidang = $kb)"; } if($unit){$where .= " AND (a.Kd_Unit = $ku)"; } if($sub){$where .= " AND (a.Kd_Sub = $ks)"; } if($upb){$where .= " AND (a.Kd_UPB = $upb)"; } }else{if($bidang){$where = " AND (a.Kd_Bidang = $kb)"; } if($unit){$where .= " AND (a.Kd_Unit = $ku)"; } if($sub){$where .= " AND (a.Kd_Sub = $ks)"; } if($upb){$where .= " AND (a.Kd_UPB = $kupb)"; } } $tgl_pembukuan 	= " AND Tgl_Pembukuan ".$like; $tgl_dokumen 	= " AND Tgl_Dokumen ".$like; $query = "SELECT SUM (Harga) AS Harga, SUM (Kapitalisasi) AS Kapitalisasi, SUM (Pindah_SKPD) AS Pindah_SKPD, SUM (Penghapusan) AS Penghapusan, SUM (Ubah_data) AS Ubah_data, SUM (Koreksi_Tambah) AS Koreksi_Tambah, SUM (Koreksi_Kurang) AS Koreksi_Kurang, COUNT(*) as Jumlah FROM (SELECT *, /* ----------- jumlah kapitalisasi ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '2'AND a.Kd_Bidang = a2.Kd_Bidang AND a.Kd_Unit = a2.Kd_Unit AND a.Kd_Sub = a2.Kd_Sub AND a.Kd_UPB = a2.Kd_UPB AND a.Kd_Aset1 = a2.Kd_Aset1 AND a.Kd_Aset2 = a2.Kd_Aset2 AND a.Kd_Aset3 = a2.Kd_Aset3 AND a.Kd_Aset4 = a2.Kd_Aset4 AND a.Kd_Aset5 = a2.Kd_Aset5 AND a.No_Register = a2.No_Register $tgl_dokumen ) AS Kapitalisasi, /* ----------- jumlah pengurangan PINDAH SKPD------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '3'AND a.Kd_Bidang = a2.Kd_Bidang AND a.Kd_Unit = a2.Kd_Unit AND a.Kd_Sub = a2.Kd_Sub AND a.Kd_UPB = a2.Kd_UPB AND a.Kd_Aset1 = a2.Kd_Aset1 AND a.Kd_Aset2 = a2.Kd_Aset2 AND a.Kd_Aset3 = a2.Kd_Aset3 AND a.Kd_Aset4 = a2.Kd_Aset4 AND a.Kd_Aset5 = a2.Kd_Aset5 AND a.No_Register = a2.No_Register $tgl_dokumen ) AS Pindah_SKPD, /* ----------- jumlah pengurangan PENGHAPUSAN------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '7'AND a.Kd_Bidang = a2.Kd_Bidang AND a.Kd_Unit = a2.Kd_Unit AND a.Kd_Sub = a2.Kd_Sub AND a.Kd_UPB = a2.Kd_UPB AND a.Kd_Aset1 = a2.Kd_Aset1 AND a.Kd_Aset2 = a2.Kd_Aset2 AND a.Kd_Aset3 = a2.Kd_Aset3 AND a.Kd_Aset4 = a2.Kd_Aset4 AND a.Kd_Aset5 = a2.Kd_Aset5 AND a.No_Register = a2.No_Register $tgl_dokumen ) AS Penghapusan, /* ----------- jumlah pengurangan Ubah data------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '18'AND a.Kd_Bidang = a2.Kd_Bidang AND a.Kd_Unit = a2.Kd_Unit AND a.Kd_Sub = a2.Kd_Sub AND a.Kd_UPB = a2.Kd_UPB AND a.Kd_Aset1 = a2.Kd_Aset1 AND a.Kd_Aset2 = a2.Kd_Aset2 AND a.Kd_Aset3 = a2.Kd_Aset3 AND a.Kd_Aset4 = a2.Kd_Aset4 AND a.Kd_Aset5 = a2.Kd_Aset5 AND a.No_Register = a2.No_Register $tgl_dokumen ) AS Ubah_data, /* ----------- jumlah penambahan Koreksi Nilai------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '21'AND a.Kd_Bidang = a2.Kd_Bidang AND a.Kd_Unit = a2.Kd_Unit AND a.Kd_Sub = a2.Kd_Sub AND a.Kd_UPB = a2.Kd_UPB AND a.Kd_Aset1 = a2.Kd_Aset1 AND a.Kd_Aset2 = a2.Kd_Aset2 AND a.Kd_Aset3 = a2.Kd_Aset3 AND a.Kd_Aset4 = a2.Kd_Aset4 AND a.Kd_Aset5 = a2.Kd_Aset5 AND a.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah pengurangan Koreksi Nilai------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '23'AND a.Kd_Bidang = a2.Kd_Bidang AND a.Kd_Unit = a2.Kd_Unit AND a.Kd_Sub = a2.Kd_Sub AND a.Kd_UPB = a2.Kd_UPB AND a.Kd_Aset1 = a2.Kd_Aset1 AND a.Kd_Aset2 = a2.Kd_Aset2 AND a.Kd_Aset3 = a2.Kd_Aset3 AND a.Kd_Aset4 = a2.Kd_Aset4 AND a.Kd_Aset5 = a2.Kd_Aset5 AND a.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_KIB_A a WHERE 1=1 $where $tgl_pembukuan ) as Ta_KIB_A"; return $this->db->query($query); } /** * Menampilkan semua data kib b */ function bi($bidang='',$unit='',$sub='',$upb='',$tahunawal,$tahunakhir,$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $thn   =  $this->session->userdata('tahun_anggaran'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; $where .= "AND (a.Kd_UPB = $kupb)"; } $tgl_pembukuan 	= " AND Tgl_Pembukuan ".$like; $tgl_dokumen 	= " AND Tgl_Dokumen <= '".$tahunakhir."'"; $query = "SELECT a.Nm_Aset5,COUNT(a.No_register) as jumlah_register,MIN(a.No_register) as min_register, MAX(a.No_register) as max_register, a.Kd_Prov, a.Kd_Kab_Kota, a.Kd_Bidang, a.Kd_Unit, a.Kd_Sub, a.Kd_UPB, a.Kd_Aset1, a.Kd_Aset2, a.Kd_Aset3, a.Kd_Aset4, a.Kd_Aset5, a.Kd_Pemilik,DATENAME(yyyy,a.Tgl_Perolehan) as Tahun, a.Luas_M2, a.Alamat, a.Hak_Tanah, a.Sertifikat_Tanggal,a.Sertifikat_Nomor, a.Penggunaan,a.Asal_usul,COUNT(*) as Jumlah, SUM(LastHarga) as  Harga, a.Keterangan FROM (SELECT *,((Harga + ISNULL(Koreksi_Tambah, 0) ) - ISNULL(Koreksi_Kurang, 0) ) as LastHarga FROM (SELECT n.Nm_Aset5, a1.*, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_KIB_A a1 INNER JOIN Ref_Rek_Aset5 n ON a1.Kd_Aset1 = n.Kd_Aset1 AND a1.Kd_Aset2 = n.Kd_Aset2 AND a1.Kd_Aset3 = n.Kd_Aset3 AND a1.Kd_Aset4 = n.Kd_Aset4 AND a1.Kd_Aset5 = n.Kd_Aset5 WHERE NOT EXISTS (SELECT 1 FROM   Ta_KIBAHapus d INNER JOIN Ta_Penghapusan e ON d.No_SK=e.No_SK WHERE a1.Kd_Bidang=d.Kd_Bidang AND a1.Kd_Unit=d.Kd_Unit AND a1.Kd_Sub=d.Kd_Sub AND a1.Kd_UPB=d.Kd_UPB AND a1.Kd_Aset1=d.Kd_Aset1 AND a1.Kd_Aset2=d.Kd_Aset2 AND a1.Kd_Aset3=d.Kd_Aset3 AND a1.Kd_Aset4=d.Kd_Aset4 AND a1.Kd_Aset5=d.Kd_Aset5 AND a1.No_Register=d.No_Register AND YEAR(e.Tgl_SK) <= '{$thn}') AND NOT EXISTS (SELECT 1 FROM   Ta_KIBAR e WHERE a1.Kd_Bidang=e.Kd_Bidang AND a1.Kd_Unit=e.Kd_Unit AND a1.Kd_Sub=e.Kd_Sub AND a1.Kd_UPB=e.Kd_UPB AND a1.Kd_Aset1=e.Kd_Aset1 AND a1.Kd_Aset2=e.Kd_Aset2 AND a1.Kd_Aset3=e.Kd_Aset3 AND a1.Kd_Aset4=e.Kd_Aset4 AND a1.Kd_Aset5=e.Kd_Aset5 AND a1.No_Register=e.No_Register  AND Kd_Riwayat IN (3,19) AND YEAR(e.Tgl_Dokumen) <= '{$thn}') ) as x ) as a WHERE 1=1 $where $tgl_pembukuan GROUP BY a.Kd_Prov, a.Kd_Kab_Kota, a.Kd_Bidang, a.Kd_Unit, a.Kd_Sub, a.Kd_UPB, a.Kd_Aset1, a.Kd_Aset2, a.Kd_Aset3, a.Kd_Aset4, a.Kd_Aset5, a.No_Register, a.Kd_Pemilik,a.Tgl_Perolehan, a.Luas_M2, a.Alamat, a.Hak_Tanah, a.Sertifikat_Tanggal,a.Sertifikat_Nomor, a.Penggunaan,a.Asal_usul,a.Keterangan,a.Nm_Aset5 ORDER BY  a.Kd_Aset1, a.Kd_Aset2, a.Kd_Aset3,a.Kd_Aset4, a.Kd_Aset5"; return $this->db->query($query); } /** * Menampilkan semua data kib bi */ function total_bi($bidang='',$unit='',$sub='',$upb='',$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = " AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= " AND (a.Kd_Unit = $unit)"; } if($sub){$where .= " AND (a.Kd_Sub = $sub)"; } if($upb){$where .= " AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){if($bidang){$where = " AND (a.Kd_Bidang = $kb)"; } if($unit){$where .= " AND (a.Kd_Unit = $ku)"; } if($sub){$where .= " AND (a.Kd_Sub = $ks)"; } if($upb){$where .= " AND (a.Kd_UPB = $upb)"; } }else{if($bidang){$where = " AND (a.Kd_Bidang = $kb)"; } if($unit){$where .= " AND (a.Kd_Unit = $ku)"; } if($sub){$where .= " AND (a.Kd_Sub = $ks)"; } if($upb){$where .= " AND (a.Kd_UPB = $kupb)"; } } $tgl_pembukuan 	= " AND Tgl_Pembukuan ".$like; $tgl_dokumen 	= " AND Tgl_Dokumen ".$like; $query = "SELECT SUM (Harga) AS Harga, SUM (Kapitalisasi) AS Kapitalisasi, SUM (Pindah_SKPD) AS Pindah_SKPD, SUM (Penghapusan) AS Penghapusan, SUM (Ubah_data) AS Ubah_data, SUM (Koreksi_Tambah) AS Koreksi_Tambah, SUM (Koreksi_Kurang) AS Koreksi_Kurang, COUNT(*) as Jumlah FROM (SELECT *, /* ----------- jumlah kapitalisasi ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '2'AND a.Kd_Bidang = a2.Kd_Bidang AND a.Kd_Unit = a2.Kd_Unit AND a.Kd_Sub = a2.Kd_Sub AND a.Kd_UPB = a2.Kd_UPB AND a.Kd_Aset1 = a2.Kd_Aset1 AND a.Kd_Aset2 = a2.Kd_Aset2 AND a.Kd_Aset3 = a2.Kd_Aset3 AND a.Kd_Aset4 = a2.Kd_Aset4 AND a.Kd_Aset5 = a2.Kd_Aset5 AND a.No_Register = a2.No_Register $tgl_dokumen ) AS Kapitalisasi, /* ----------- jumlah pengurangan PINDAH SKPD------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '3'AND a.Kd_Bidang = a2.Kd_Bidang AND a.Kd_Unit = a2.Kd_Unit AND a.Kd_Sub = a2.Kd_Sub AND a.Kd_UPB = a2.Kd_UPB AND a.Kd_Aset1 = a2.Kd_Aset1 AND a.Kd_Aset2 = a2.Kd_Aset2 AND a.Kd_Aset3 = a2.Kd_Aset3 AND a.Kd_Aset4 = a2.Kd_Aset4 AND a.Kd_Aset5 = a2.Kd_Aset5 AND a.No_Register = a2.No_Register $tgl_dokumen ) AS Pindah_SKPD, /* ----------- jumlah pengurangan PENGHAPUSAN------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '7'AND a.Kd_Bidang = a2.Kd_Bidang AND a.Kd_Unit = a2.Kd_Unit AND a.Kd_Sub = a2.Kd_Sub AND a.Kd_UPB = a2.Kd_UPB AND a.Kd_Aset1 = a2.Kd_Aset1 AND a.Kd_Aset2 = a2.Kd_Aset2 AND a.Kd_Aset3 = a2.Kd_Aset3 AND a.Kd_Aset4 = a2.Kd_Aset4 AND a.Kd_Aset5 = a2.Kd_Aset5 AND a.No_Register = a2.No_Register $tgl_dokumen ) AS Penghapusan, /* ----------- jumlah pengurangan Ubah data------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '18'AND a.Kd_Bidang = a2.Kd_Bidang AND a.Kd_Unit = a2.Kd_Unit AND a.Kd_Sub = a2.Kd_Sub AND a.Kd_UPB = a2.Kd_UPB AND a.Kd_Aset1 = a2.Kd_Aset1 AND a.Kd_Aset2 = a2.Kd_Aset2 AND a.Kd_Aset3 = a2.Kd_Aset3 AND a.Kd_Aset4 = a2.Kd_Aset4 AND a.Kd_Aset5 = a2.Kd_Aset5 AND a.No_Register = a2.No_Register $tgl_dokumen ) AS Ubah_data, /* ----------- jumlah penambahan Koreksi Nilai------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '21'AND a.Kd_Bidang = a2.Kd_Bidang AND a.Kd_Unit = a2.Kd_Unit AND a.Kd_Sub = a2.Kd_Sub AND a.Kd_UPB = a2.Kd_UPB AND a.Kd_Aset1 = a2.Kd_Aset1 AND a.Kd_Aset2 = a2.Kd_Aset2 AND a.Kd_Aset3 = a2.Kd_Aset3 AND a.Kd_Aset4 = a2.Kd_Aset4 AND a.Kd_Aset5 = a2.Kd_Aset5 AND a.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah penambahan Koreksi Nilai------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '23'AND a.Kd_Bidang = a2.Kd_Bidang AND a.Kd_Unit = a2.Kd_Unit AND a.Kd_Sub = a2.Kd_Sub AND a.Kd_UPB = a2.Kd_UPB AND a.Kd_Aset1 = a2.Kd_Aset1 AND a.Kd_Aset2 = a2.Kd_Aset2 AND a.Kd_Aset3 = a2.Kd_Aset3 AND a.Kd_Aset4 = a2.Kd_Aset4 AND a.Kd_Aset5 = a2.Kd_Aset5 AND a.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_KIB_A a WHERE 1=1 $where $tgl_pembukuan) as Ta_KIB_A"; return $this->db->query($query); } /** * Menampilkan semua data per Kondisi */ function kib_eksint($bidang='',$unit='',$sub='',$upb='',$like,$kondisi) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){if($bidang){$where = "AND (a.Kd_Bidang = $kb)"; } if($unit){$where .= "AND (a.Kd_Unit = $ku)"; } if($sub){$where .= "AND (a.Kd_Sub = $ks)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{if($bidang){$where = "AND (a.Kd_Bidang = $kb)"; } if($unit){$where .= "AND (a.Kd_Unit = $ku)"; } if($sub){$where .= "AND (a.Kd_Sub = $ks)"; } if($upb){$where .= "AND (a.Kd_UPB = $kupb)"; } } $tgl_pembukuan 	= " AND Tgl_Pembukuan ".$like; $tgl_dokumen 	= " AND Tgl_Dokumen ".$like; $minSatuan 		= $this->auth->getMinSatuan(2); if($kondisi == 1){$kondisi = " AND LastHarga < $minSatuan"; }else{$kondisi = " AND LastHarga >= $minSatuan"; } $query = "SELECT  a.Nm_Aset5,COUNT(a.No_register) as jumlah_register,MIN(a.No_register) as min_register, MAX(a.No_register) as max_register, a.Kd_Prov, a.Kd_Kab_Kota, a.Kd_Bidang, a.Kd_Unit, a.Kd_Sub, a.Kd_UPB, a.Kd_Aset1, a.Kd_Aset2, a.Kd_Aset3, a.Kd_Aset4, a.Kd_Aset5, a.Kd_Pemilik,DATENAME(yyyy,a.Tgl_Perolehan) as Tahun, a.Luas_M2, a.Alamat, a.Hak_Tanah, a.Sertifikat_Tanggal,a.Sertifikat_Nomor, a.Penggunaan,a.Asal_usul, COUNT(*) as Jumlah, SUM(LastHarga) as Harga, a.Keterangan FROM (SELECT *,(a.Harga + (CASE WHEN Koreksi_Tambah is null THEN 0 ELSE Koreksi_Tambah END)) - (CASE WHEN Koreksi_Kurang is null THEN 0 ELSE Koreksi_Kurang END) as LastHarga FROM (SELECT n.Nm_Aset5,a1.*, /* ----------- jumlah kapitalisasi ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '2'AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Kapitalisasi, /* ----------- jumlah pengurangan PINDAH SKPD------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '3'AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Pindah_SKPD, /* ----------- jumlah pengurangan PENGHAPUSAN------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '7'AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Penghapusan, /* ----------- jumlah pengurangan Ubah data------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '18'AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Ubah_data, /* ----------- jumlah penambahan Koreksi Nilai------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '21'AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah penambahan Koreksi Nilai------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '23'AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_KIB_A a1 INNER JOIN Ref_Rek_Aset5 n ON a1.Kd_Aset1 = n.Kd_Aset1 AND a1.Kd_Aset2 = n.Kd_Aset2 AND a1.Kd_Aset3 = n.Kd_Aset3 AND a1.Kd_Aset4 = n.Kd_Aset4 AND a1.Kd_Aset5 = n.Kd_Aset5) as a) as a WHERE 1=1 $where $tgl_pembukuan $kondisi GROUP BY a.Kd_Prov, a.Kd_Kab_Kota, a.Kd_Bidang, a.Kd_Unit, a.Kd_Sub, a.Kd_UPB, a.Kd_Aset1, a.Kd_Aset2, a.Kd_Aset3, a.Kd_Aset4, a.Kd_Aset5, a.No_Register, a.Kd_Pemilik,a.Tgl_Perolehan, a.Luas_M2, a.Alamat, a.Hak_Tanah, a.Sertifikat_Tanggal,a.Sertifikat_Nomor, a.Penggunaan,a.Asal_usul,a.Keterangan,a.Nm_Aset5"; return $this->db->query($query); } /** * Menampilkan semua data kib b */ function total_kib_eksint($bidang='',$unit='',$sub='',$upb='',$like,$kondisi) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){if($bidang){$where = "AND (a.Kd_Bidang = $kb)"; } if($unit){$where .= "AND (a.Kd_Unit = $ku)"; } if($sub){$where .= "AND (a.Kd_Sub = $ks)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{if($bidang){$where = "AND (a.Kd_Bidang = $kb)"; } if($unit){$where .= "AND (a.Kd_Unit = $ku)"; } if($sub){$where .= "AND (a.Kd_Sub = $ks)"; } if($upb){$where .= "AND (a.Kd_UPB = $kupb)"; } } $tgl_pembukuan 	= " AND Tgl_Pembukuan ".$like; $tgl_dokumen 	= " AND Tgl_Dokumen ".$like; $minSatuan 		= $this->auth->getMinSatuan(2); if($kondisi == 1){$kondisi = " AND LastHarga < $minSatuan"; }else{$kondisi = " AND LastHarga >= $minSatuan"; } $query = "SELECT COUNT(*) as Jumlah, SUM(LastHarga) as Harga FROM (SELECT *,(Harga + (CASE WHEN Koreksi_Tambah is null THEN 0 ELSE Koreksi_Tambah END)) - (CASE WHEN Koreksi_Kurang is null THEN 0 ELSE Koreksi_Kurang END) as LastHarga FROM (SELECT a1.*, /* ----------- jumlah kapitalisasi ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '2'AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Kapitalisasi, /* ----------- jumlah pengurangan PINDAH SKPD------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '3'AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Pindah_SKPD, /* ----------- jumlah pengurangan PENGHAPUSAN------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '7'AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Penghapusan, /* ----------- jumlah pengurangan Ubah data------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '18'AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Ubah_data, /* ----------- jumlah penambahan Koreksi Nilai------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '21'AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah penambahan Koreksi Nilai------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = '23'AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_KIB_A a1 ) as a ) as a WHERE 1=1 $where $tgl_pembukuan $kondisi"; return $this->db->query($query); } /** * Menampilkan semua data aset pemeliharaan */ function pemeliharaan($bidang='',$unit='',$sub='',$upb='',$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){if($bidang){$where = "AND (a.Kd_Bidang = $kb)"; } if($unit){$where .= "AND (a.Kd_Unit = $ku)"; } if($sub){$where .= "AND (a.Kd_Sub = $ks)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{if($bidang){$where = "AND (a.Kd_Bidang = $kb)"; } if($unit){$where .= "AND (a.Kd_Unit = $ku)"; } if($sub){$where .= "AND (a.Kd_Sub = $ks)"; } if($upb){$where .= "AND (a.Kd_UPB = $kupb)"; } } $tgl_dokumen 	= " AND Tgl_Dokumen ".$like; $query = "SELECT n.Nm_Aset5,COUNT(a.No_register) as jumlah_register,MIN(a.No_register) as min_register, MAX(a.No_register) as max_register, a.Kd_Prov, a.Kd_Kab_Kota, a.Kd_Bidang, a.Kd_Unit, a.Kd_Sub, a.Kd_UPB, a.Kd_Aset1, a.Kd_Aset2, a.Kd_Aset3, a.Kd_Aset4, a.Kd_Aset5, a.Kd_Pemilik,DATENAME(yyyy,a.Tgl_Perolehan) as Tahun, a.Luas_M2, a.Alamat, a.Hak_Tanah, a.Sertifikat_Tanggal,a.Sertifikat_Nomor, a.Penggunaan,a.Asal_usul,COUNT(*) as Jumlah, SUM(ar.Harga) as Harga,ar.Tgl_Dokumen,ar.No_Dokumen,ar.Keterangan FROM Ta_KIBAR ar LEFT JOIN Ta_KIB_A a ON ar.Kd_Bidang = a.Kd_Bidang AND ar.Kd_Unit = a.Kd_Unit AND ar.Kd_Sub = a.Kd_Sub AND ar.Kd_UPB = a.Kd_UPB AND ar.Kd_Aset1 = a.Kd_Aset1 AND ar.Kd_Aset2 = a.Kd_Aset2 AND ar.Kd_Aset3 = a.Kd_Aset3 AND ar.Kd_Aset4 = a.Kd_Aset4 AND ar.Kd_Aset5 = a.Kd_Aset5 INNER JOIN Ref_Rek_Aset5 n ON ar.Kd_Aset1 = n.Kd_Aset1 AND ar.Kd_Aset2 = n.Kd_Aset2 AND ar.Kd_Aset3 = n.Kd_Aset3 AND ar.Kd_Aset4 = n.Kd_Aset4 AND ar.Kd_Aset5 = n.Kd_Aset5 WHERE Kd_Riwayat=2 $where $tgl_dokumen GROUP BY a.Kd_Prov, a.Kd_Kab_Kota, a.Kd_Bidang, a.Kd_Unit, a.Kd_Sub, a.Kd_UPB, a.Kd_Aset1, a.Kd_Aset2, a.Kd_Aset3, a.Kd_Aset4, a.Kd_Aset5, a.No_Register, a.Kd_Pemilik,a.Tgl_Perolehan, a.Luas_M2, a.Alamat, a.Hak_Tanah, a.Sertifikat_Tanggal,a.Sertifikat_Nomor, a.Penggunaan,a.Asal_usul,ar.Tgl_Dokumen,ar.No_Dokumen,ar.Keterangan,n.Nm_Aset5"; /*print_r($query); exit();*/ return $this->db->query($query); } /** * Menampilkan semua data kib bi */ function total_pemeliharaan($bidang='',$unit='',$sub='',$upb='',$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = " AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= " AND (a.Kd_Unit = $unit)"; } if($sub){$where .= " AND (a.Kd_Sub = $sub)"; } if($upb){$where .= " AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){if($bidang){$where = " AND (a.Kd_Bidang = $kb)"; } if($unit){$where .= " AND (a.Kd_Unit = $ku)"; } if($sub){$where .= " AND (a.Kd_Sub = $ks)"; } if($upb){$where .= " AND (a.Kd_UPB = $upb)"; } }else{if($bidang){$where = " AND (a.Kd_Bidang = $kb)"; } if($unit){$where .= " AND (a.Kd_Unit = $ku)"; } if($sub){$where .= " AND (a.Kd_Sub = $ks)"; } if($upb){$where .= " AND (a.Kd_UPB = $kupb)"; } } $tgl_dokumen 	= " AND Tgl_Dokumen ".$like; $query = "SELECT COUNT(*) as Jumlah, SUM(Harga) as Harga FROM Ta_KIBAR a WHERE a.Kd_Riwayat=2 $where $tgl_dokumen"; /*print_r($query); exit();*/ return $this->db->query($query); } function insert_usul_penghapusan($data) {$sql = $this->db->insert("Ta_KIBAHapus", $data); if ($sql) return true; } function update_kib($kd_prov,$kd_kab,$kd_bidang,$kd_unit,$kd_sub,$kd_upb,$kd_aset1,$kd_aset2,$kd_aset3,$kd_aset4,$kd_aset5,$no_register,$data) {$this->db->where('Kd_Prov', $kd_prov); $this->db->where('Kd_Kab_Kota', $kd_kab); $this->db->where('Kd_Bidang', $kd_bidang); $this->db->where('Kd_Unit', $kd_unit); $this->db->where('Kd_Sub', $kd_sub); $this->db->where('Kd_UPB', $kd_upb); $this->db->where('Kd_Aset1', $kd_aset1); $this->db->where('Kd_Aset2', $kd_aset2); $this->db->where('Kd_Aset3', $kd_aset3); $this->db->where('Kd_Aset4', $kd_aset4); $this->db->where('Kd_Aset5', $kd_aset5); $this->db->where('No_Register', $no_register); $sql = $this->db->update($this->table, $data); if($sql){return TRUE; } } function rincian_barang($bidang='',$unit='',$sub='',$upb='',$tahunawal,$tahunakhir,$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; $where .= "AND (a.Kd_UPB = $kupb)"; } $tgl_pembukuan = " AND Tgl_Pembukuan ".$like; $tgl_dokumen   = " AND Tgl_Dokumen <= '".$tahunakhir."'"; $thn           = $this->session->userdata('tahun_anggaran'); $query = "SELECT d5.Kd_Bidang,d5.Kd_Unit,d5.Kd_Sub,d5.Kd_UPB, d5.Kd_Aset1,d5.Kd_Aset2,d5.Kd_Aset3,d5.Kd_Aset4,d5.Kd_Aset5, d2.Nm_Aset2,d3.Nm_Aset3,d4.Nm_Aset4,Nm_Aset5, COUNT(d5.LastHarga) as Jumlah, SUM(d5.LastHarga) as Harga FROM  (SELECT *, ((Harga + ISNULL(Koreksi_Tambah, 0) ) - ISNULL(Koreksi_Kurang, 0) ) as LastHarga FROM (SELECT n.Nm_Aset5,a1.*, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_KIB_A a1 INNER JOIN Ref_Rek_Aset5 n ON a1.Kd_Aset1 = n.Kd_Aset1 AND a1.Kd_Aset2 = n.Kd_Aset2 AND a1.Kd_Aset3 = n.Kd_Aset3 AND a1.Kd_Aset4 = n.Kd_Aset4 AND a1.Kd_Aset5 = n.Kd_Aset5 WHERE NOT EXISTS (SELECT 1 FROM   Ta_KIBAHapus d INNER JOIN Ta_Penghapusan e ON d.No_SK=e.No_SK WHERE a1.Kd_Bidang=d.Kd_Bidang AND a1.Kd_Unit=d.Kd_Unit AND a1.Kd_Sub=d.Kd_Sub AND a1.Kd_UPB=d.Kd_UPB AND a1.Kd_Aset1=d.Kd_Aset1 AND a1.Kd_Aset2=d.Kd_Aset2 AND a1.Kd_Aset3=d.Kd_Aset3 AND a1.Kd_Aset4=d.Kd_Aset4 AND a1.Kd_Aset5=d.Kd_Aset5 AND a1.No_Register=d.No_Register AND YEAR(e.Tgl_SK) <= '{$thn}') AND NOT EXISTS (SELECT 1 FROM   Ta_KIBAR e WHERE a1.Kd_Bidang=e.Kd_Bidang AND a1.Kd_Unit=e.Kd_Unit AND a1.Kd_Sub=e.Kd_Sub AND a1.Kd_UPB=e.Kd_UPB AND a1.Kd_Aset1=e.Kd_Aset1 AND a1.Kd_Aset2=e.Kd_Aset2 AND a1.Kd_Aset3=e.Kd_Aset3 AND a1.Kd_Aset4=e.Kd_Aset4 AND a1.Kd_Aset5=e.Kd_Aset5 AND a1.No_Register=e.No_Register  AND Kd_Riwayat IN (3,19) AND YEAR(e.Tgl_Dokumen) <= '{$thn}') ) AS a WHERE 1=1 $where $tgl_pembukuan ) as d5 LEFT JOIN Ref_Rek_Aset4 d4 ON d5.Kd_Aset1=d4.Kd_Aset1 AND d5.Kd_Aset2=d4.Kd_Aset2 AND d5.Kd_Aset3=d4.Kd_Aset3 AND d5.Kd_Aset4=d4.Kd_Aset4 LEFT JOIN Ref_Rek_Aset3 d3 ON d5.Kd_Aset1=d3.Kd_Aset1 AND d5.Kd_Aset2=d3.Kd_Aset2 AND d5.Kd_Aset3=d3.Kd_Aset3 LEFT JOIN Ref_Rek_Aset2 d2 ON d5.Kd_Aset1=d2.Kd_Aset1 AND d5.Kd_Aset2=d2.Kd_Aset2 GROUP BY d5.Kd_Bidang,d5.Kd_Unit,d5.Kd_Sub,d5.Kd_UPB, d5.Kd_Aset1,d5.Kd_Aset2,d5.Kd_Aset3,d5.Kd_Aset4,d5.Kd_Aset5, d2.Nm_Aset2,d3.Nm_Aset3,d4.Nm_Aset4,d5.Nm_Aset5"; return $this->db->query($query); } function non_operasional($bidang='',$unit='',$sub='',$upb='',$tahunawal,$tahunakhir,$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $thn   =  $this->session->userdata('tahun_anggaran'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; $where .= "AND (a.Kd_UPB = $kupb)"; } $tgl_pembukuan 	= " AND Tgl_Pembukuan ".$like; $tgl_dokumen 	= " AND Tgl_Dokumen <= '".$tahunakhir."'"; $query = "SELECT a.Nm_Aset5,COUNT(a.No_register) as jumlah_register,MIN(a.No_register) as min_register, MAX(a.No_register) as max_register, a.Kd_Prov, a.Kd_Kab_Kota, a.Kd_Bidang, a.Kd_Unit, a.Kd_Sub, a.Kd_UPB, a.Kd_Aset1, a.Kd_Aset2, a.Kd_Aset3, a.Kd_Aset4, a.Kd_Aset5, a.Kd_Pemilik,DATENAME(yyyy,a.Tgl_Perolehan) as Tahun, a.Luas_M2, a.Alamat, a.Hak_Tanah, a.Sertifikat_Tanggal,a.Sertifikat_Nomor, a.Penggunaan,a.Asal_usul,COUNT(*) as Jumlah, SUM(LastHarga) as  Harga, a.Keterangan FROM (SELECT *,((Harga + ISNULL(Koreksi_Tambah, 0) ) - ISNULL(Koreksi_Kurang, 0) ) as LastHarga FROM (SELECT n.Nm_Aset5, a1.*, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_KIB_A a1 INNER JOIN Ref_Rek_Aset5 n ON a1.Kd_Aset1 = n.Kd_Aset1 AND a1.Kd_Aset2 = n.Kd_Aset2 AND a1.Kd_Aset3 = n.Kd_Aset3 AND a1.Kd_Aset4 = n.Kd_Aset4 AND a1.Kd_Aset5 = n.Kd_Aset5 WHERE NOT EXISTS (SELECT 1 FROM   Ta_KIBAHapus d INNER JOIN Ta_Penghapusan e ON d.No_SK=e.No_SK WHERE a1.Kd_Bidang=d.Kd_Bidang AND a1.Kd_Unit=d.Kd_Unit AND a1.Kd_Sub=d.Kd_Sub AND a1.Kd_UPB=d.Kd_UPB AND a1.Kd_Aset1=d.Kd_Aset1 AND a1.Kd_Aset2=d.Kd_Aset2 AND a1.Kd_Aset3=d.Kd_Aset3 AND a1.Kd_Aset4=d.Kd_Aset4 AND a1.Kd_Aset5=d.Kd_Aset5 AND a1.No_Register=d.No_Register AND YEAR(e.Tgl_SK) <= '{$thn}') AND NOT EXISTS (SELECT 1 FROM   Ta_KIBAR e WHERE a1.Kd_Bidang=e.Kd_Bidang AND a1.Kd_Unit=e.Kd_Unit AND a1.Kd_Sub=e.Kd_Sub AND a1.Kd_UPB=e.Kd_UPB AND a1.Kd_Aset1=e.Kd_Aset1 AND a1.Kd_Aset2=e.Kd_Aset2 AND a1.Kd_Aset3=e.Kd_Aset3 AND a1.Kd_Aset4=e.Kd_Aset4 AND a1.Kd_Aset5=e.Kd_Aset5 AND a1.No_Register=e.No_Register  AND Kd_Riwayat IN (3,19) AND YEAR(e.Tgl_Dokumen) <= '{$thn}') ) as x ) as a WHERE 1=1 AND Kd_KA = 0 $where $tgl_pembukuan GROUP BY a.Kd_Prov, a.Kd_Kab_Kota, a.Kd_Bidang, a.Kd_Unit, a.Kd_Sub, a.Kd_UPB, a.Kd_Aset1, a.Kd_Aset2, a.Kd_Aset3, a.Kd_Aset4, a.Kd_Aset5, a.No_Register, a.Kd_Pemilik,a.Tgl_Perolehan, a.Luas_M2, a.Alamat, a.Hak_Tanah, a.Sertifikat_Tanggal,a.Sertifikat_Nomor, a.Penggunaan,a.Asal_usul,a.Keterangan,a.Nm_Aset5 ORDER BY  a.Kd_Aset1, a.Kd_Aset2, a.Kd_Aset3,a.Kd_Aset4, a.Kd_Aset5"; return $this->db->query($query); } function akm_hapus($bidang='',$unit='',$sub='',$upb='',$tahunawal,$tahunakhir,$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $thn   =  $this->session->userdata('tahun_anggaran'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; $where .= "AND (a.Kd_UPB = $kupb)"; } $tgl_pembukuan = " AND Tgl_SK ".$like; $tgl_dokumen   = " AND Tgl_Dokumen <= '".$tahunakhir."'"; $thn           = $this->session->userdata('tahun_anggaran')-1; $query = "SELECT n.Kd_Aset1,n.Kd_Aset2,n.Nm_Aset2, 0 as Jumlah, 0 as Beban_Susut, 0 as Akm_Susut, 0 as Nilai_Buku, SUM(CASE WHEN Kd_KA=1 THEN LastHarga END) as Nilai_Perolehan FROM Ref_Rek_Aset2 n LEFT JOIN (SELECT *, ((Harga + ISNULL(Total_Koreksi, 0) ) - ISNULL(Koreksi_Kurang, 0) ) as HargaKoreksi, ((Harga + ISNULL(Koreksi_Tambah, 0) ) - ISNULL(Koreksi_Kurang, 0) ) as LastHarga FROM (SELECT n.Nm_Aset5, a1.*, a3.No_SK, a3.Tgl_SK, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = 21 AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Total_Koreksi, (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = 2 AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Kapitalisasi, (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_KIBAHapus h LEFT JOIN Ta_KIB_A a1 ON h.Kd_Bidang = a1.Kd_Bidang AND h.Kd_Unit = a1.Kd_Unit AND h.Kd_Sub = a1.Kd_Sub AND h.Kd_UPB = a1.Kd_UPB AND h.Kd_Aset1 = a1.Kd_Aset1 AND h.Kd_Aset2 = a1.Kd_Aset2 AND h.Kd_Aset3 = a1.Kd_Aset3 AND h.Kd_Aset4 = a1.Kd_Aset4 AND h.Kd_Aset5 = a1.Kd_Aset5 AND h.No_Register = a1.No_Register RIGHT JOIN Ta_Penghapusan a3 ON h.No_SK = a3.No_SK INNER JOIN Ref_Rek_Aset5 n ON a1.Kd_Aset1 = n.Kd_Aset1 AND a1.Kd_Aset2 = n.Kd_Aset2 AND a1.Kd_Aset3 = n.Kd_Aset3 AND a1.Kd_Aset4 = n.Kd_Aset4 AND a1.Kd_Aset5 = n.Kd_Aset5 ) as a WHERE 1=1 $where $tgl_pembukuan ) as a3 ON a3.Kd_Aset1=n.Kd_Aset1 AND a3.Kd_Aset2=n.Kd_Aset2 WHERE n.Kd_Aset1=1 GROUP BY n.Kd_Aset1,n.Kd_Aset2,n.Nm_Aset2 ORDER BY Kd_Aset2"; return $this->db->query($query); } function akm_pindah($bidang='',$unit='',$sub='',$upb='',$tahunawal,$tahunakhir,$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $thn   =  $this->session->userdata('tahun_anggaran'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; $where .= "AND (a.Kd_UPB = $kupb)"; } $tgl_pembukuan = " AND Tgl_SK ".$like; $tgl_dokumen   = " AND Tgl_Dokumen <= '".$tahunakhir."'"; $thn           = $this->session->userdata('tahun_anggaran')-1; $query = "SELECT n.Kd_Aset1,n.Kd_Aset2,n.Nm_Aset2, 0 as Jumlah, 0 as Beban_Susut, 0 as Akm_Susut, 0 as Nilai_Buku, SUM(CASE WHEN Kd_KA=1 THEN LastHarga END) as Nilai_Perolehan FROM Ref_Rek_Aset2 n LEFT JOIN (SELECT *, ((Harga + ISNULL(Total_Koreksi, 0) ) - ISNULL(Koreksi_Kurang, 0) ) as HargaKoreksi, ((Harga + ISNULL(Koreksi_Tambah, 0) ) - ISNULL(Koreksi_Kurang, 0) ) as LastHarga FROM (SELECT n.Nm_Aset5, a1.*, a3.No_SK, a3.Tgl_SK, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = 21 AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Total_Koreksi, (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat = 2 AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Kapitalisasi, (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_KIBAHapus h LEFT JOIN Ta_KIB_A a1 ON h.Kd_Bidang = a1.Kd_Bidang AND h.Kd_Unit = a1.Kd_Unit AND h.Kd_Sub = a1.Kd_Sub AND h.Kd_UPB = a1.Kd_UPB AND h.Kd_Aset1 = a1.Kd_Aset1 AND h.Kd_Aset2 = a1.Kd_Aset2 AND h.Kd_Aset3 = a1.Kd_Aset3 AND h.Kd_Aset4 = a1.Kd_Aset4 AND h.Kd_Aset5 = a1.Kd_Aset5 AND h.No_Register = a1.No_Register RIGHT JOIN Ta_Penghapusan a3 ON h.No_SK = a3.No_SK INNER JOIN Ref_Rek_Aset5 n ON a1.Kd_Aset1 = n.Kd_Aset1 AND a1.Kd_Aset2 = n.Kd_Aset2 AND a1.Kd_Aset3 = n.Kd_Aset3 AND a1.Kd_Aset4 = n.Kd_Aset4 AND a1.Kd_Aset5 = n.Kd_Aset5 ) as a WHERE 1=1 $where $tgl_pembukuan ) as a3 ON a3.Kd_Aset1=n.Kd_Aset1 AND a3.Kd_Aset2=n.Kd_Aset2 WHERE n.Kd_Aset1=1 GROUP BY n.Kd_Aset1,n.Kd_Aset2,n.Nm_Aset2 ORDER BY Kd_Aset2"; return $this->db->query($query); } function rincian_susut($bidang='',$unit='',$sub='',$upb='',$tahunawal,$tahunakhir,$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; $where .= "AND (a.Kd_UPB = $kupb)"; } $tgl_pembukuan = " AND Tgl_Pembukuan ".$like; $tgl_dokumen   = " AND Tgl_Dokumen <= '".$tahunakhir."'"; $thn           = $this->session->userdata('tahun_anggaran'); $query = "SELECT d5.Kd_Bidang,d5.Kd_Unit,d5.Kd_Sub,d5.Kd_UPB, d5.Kd_Aset1,d5.Kd_Aset2,d5.Kd_Aset3,d5.Kd_Aset4,d5.Kd_Aset5, d2.Nm_Aset2,d3.Nm_Aset3,d4.Nm_Aset4,Nm_Aset5, SUM(CASE WHEN Kd_KA <> 0 THEN LastHarga END) as NB_Awal, 0 as Susut, 0 as Akm_Susut, SUM(CASE WHEN Kd_KA <> 0 THEN LastHarga END) as NB_Akhir FROM  (SELECT *, ((Harga + ISNULL(Koreksi_Tambah, 0) ) - ISNULL(Koreksi_Kurang, 0) ) as LastHarga FROM (SELECT n.Nm_Aset5,a1.*, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBAR a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_KIB_A a1 INNER JOIN Ref_Rek_Aset5 n ON a1.Kd_Aset1 = n.Kd_Aset1 AND a1.Kd_Aset2 = n.Kd_Aset2 AND a1.Kd_Aset3 = n.Kd_Aset3 AND a1.Kd_Aset4 = n.Kd_Aset4 AND a1.Kd_Aset5 = n.Kd_Aset5 WHERE NOT EXISTS (SELECT 1 FROM   Ta_KIBAHapus d INNER JOIN Ta_Penghapusan e ON d.No_SK=e.No_SK WHERE a1.Kd_Bidang=d.Kd_Bidang AND a1.Kd_Unit=d.Kd_Unit AND a1.Kd_Sub=d.Kd_Sub AND a1.Kd_UPB=d.Kd_UPB AND a1.Kd_Aset1=d.Kd_Aset1 AND a1.Kd_Aset2=d.Kd_Aset2 AND a1.Kd_Aset3=d.Kd_Aset3 AND a1.Kd_Aset4=d.Kd_Aset4 AND a1.Kd_Aset5=d.Kd_Aset5 AND a1.No_Register=d.No_Register AND YEAR(e.Tgl_SK) <= '{$thn}') AND NOT EXISTS (SELECT 1 FROM   Ta_KIBAR e WHERE a1.Kd_Bidang=e.Kd_Bidang AND a1.Kd_Unit=e.Kd_Unit AND a1.Kd_Sub=e.Kd_Sub AND a1.Kd_UPB=e.Kd_UPB AND a1.Kd_Aset1=e.Kd_Aset1 AND a1.Kd_Aset2=e.Kd_Aset2 AND a1.Kd_Aset3=e.Kd_Aset3 AND a1.Kd_Aset4=e.Kd_Aset4 AND a1.Kd_Aset5=e.Kd_Aset5 AND a1.No_Register=e.No_Register  AND Kd_Riwayat IN (3,19) AND YEAR(e.Tgl_Dokumen) <= '{$thn}') ) AS a WHERE 1=1 $where $tgl_pembukuan ) as d5 LEFT JOIN Ref_Rek_Aset4 d4 ON d5.Kd_Aset1=d4.Kd_Aset1 AND d5.Kd_Aset2=d4.Kd_Aset2 AND d5.Kd_Aset3=d4.Kd_Aset3 AND d5.Kd_Aset4=d4.Kd_Aset4 LEFT JOIN Ref_Rek_Aset3 d3 ON d5.Kd_Aset1=d3.Kd_Aset1 AND d5.Kd_Aset2=d3.Kd_Aset2 AND d5.Kd_Aset3=d3.Kd_Aset3 LEFT JOIN Ref_Rek_Aset2 d2 ON d5.Kd_Aset1=d2.Kd_Aset1 AND d5.Kd_Aset2=d2.Kd_Aset2 GROUP BY d5.Kd_Bidang,d5.Kd_Unit,d5.Kd_Sub,d5.Kd_UPB, d5.Kd_Aset1,d5.Kd_Aset2,d5.Kd_Aset3,d5.Kd_Aset4,d5.Kd_Aset5, d2.Nm_Aset2,d3.Nm_Aset3,d4.Nm_Aset4,d5.Nm_Aset5"; return $this->db->query($query); } } /* End of file Contoh_model.php */ /* Location: ./system/application/models/Contoh_model.php */