<?php /** * Contoh_model Class */ class Kibf_model extends CI_Model {/** * Constructor */ function __construct(){parent::__construct(); } /* Inisialisasi nama tabel yang digunakan */ var $table = 'Ta_KIB_F'; function get_page($limit, $offset, $where, $like){$thn   =  $this->session->userdata('tahun_anggaran'); if($offset == 0  or !isset($offset)){$first = 1; $last  = $limit; }else{$first = $offset+1; $last  = $first + ($limit -1); } $sql = "SELECT    * FROM  (SELECT     Ref_UPB.Nm_UPB,a.*,Ref_Rek_Aset5.Nm_Aset5, ROW_NUMBER() OVER (ORDER BY a.Kd_Prov) AS no_urut		FROM  Ta_KIB_F a INNER JOIN Ref_Rek_Aset5 ON a.Kd_Aset1=Ref_Rek_Aset5.Kd_Aset1 AND a.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND a.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND a.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND a.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 LEFT JOIN Ref_UPB ON a.Kd_Bidang=Ref_UPB.Kd_Bidang AND a.Kd_Unit=Ref_UPB.Kd_Unit AND a.Kd_Sub=Ref_UPB.Kd_Sub AND a.Kd_UPB=Ref_UPB.Kd_UPB WHERE $where $like AND NOT EXISTS (SELECT 1 FROM Ta_KIB_C d  WHERE a.ID_KDP=d.ID_KDP AND YEAR(d.Tgl_Perolehan) <= '{$thn}') AND NOT EXISTS (SELECT 1 FROM Ta_KIB_D e  WHERE a.ID_KDP=e.ID_KDP AND YEAR(e.Tgl_Perolehan) <= '{$thn}') ) AS Ta_KIB_F WHERE no_urut BETWEEN $first AND $last  ORDER BY no_urut ASC"; return $this->db->query($sql); } /* count kib b total page */ function count_kib($where, $like) {return $this->db->query("SELECT     * FROM (SELECT     *	FROM   Ta_KIB_F a WHERE $where  ) AS a INNER JOIN Ref_Rek_Aset5 ON a.Kd_Aset1=Ref_Rek_Aset5.Kd_Aset1 AND a.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND a.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND a.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND a.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 $like")->num_rows(); } /** * Tampilkan total harga kib b */ function total_kib($where, $like) {$query= "SELECT   SUM(Harga) AS Harga FROM  Ta_KIB_F a INNER JOIN Ref_Rek_Aset5 ON a.Kd_Aset1=Ref_Rek_Aset5.Kd_Aset1 AND a.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND a.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND a.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND a.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5  WHERE $where $like "; $sql = $this->db->query($query); foreach ($sql->result() as $row) {$result = $row->Harga; } return $result; } /** * Menampilkan semua data kib b */ function laporan_kib($bidang='',$unit='',$sub='',$upb='',$tahunawal,$tahunakhir,$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $thn   =  $this->session->userdata('tahun_anggaran'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; $where .= "AND (a.Kd_UPB = $kupb)"; } $tgl_pembukuan 	= " AND Tgl_Pembukuan ".$like; $tgl_dokumen 	= " AND Tgl_Dokumen <= '".$tahunakhir."'"; $query = "SELECT a.Nm_Aset5,COUNT(a.No_register) as jumlah_register, MIN(a.No_register) as min_register, MAX(a.No_register) as max_register, a.Kd_Prov, a.Kd_Kab_Kota, a.Kd_Bidang, a.Kd_Unit, a.Kd_Sub, a.Kd_UPB, a.Kd_Aset1, a.Kd_Aset2, a.Kd_Aset3, a.Kd_Aset4, a.Kd_Aset5, a.Kd_Pemilik,a.Kondisi,a.Tgl_Perolehan, a.Bertingkat_Tidak,a.Beton_tidak,a.Panjang,a.Lebar,a.Luas_Lantai,a.Lokasi,a.Dokumen_Tanggal, a.Dokumen_Nomor,a.Status_Tanah,a.Asal_usul,COUNT(*) as Jumlah, SUM(LastHarga) as  Harga, a.Keterangan FROM (SELECT *,((Harga + ISNULL(Koreksi_Tambah, 0) ) - ISNULL(Koreksi_Kurang, 0) ) as LastHarga FROM (SELECT n.Nm_Aset5, a1.*, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBFR a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBFR a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_KIB_F a1 INNER JOIN Ref_Rek_Aset5 n ON a1.Kd_Aset1 = n.Kd_Aset1 AND a1.Kd_Aset2 = n.Kd_Aset2 AND a1.Kd_Aset3 = n.Kd_Aset3 AND a1.Kd_Aset4 = n.Kd_Aset4 AND a1.Kd_Aset5 = n.Kd_Aset5 WHERE NOT EXISTS (SELECT 1 FROM Ta_KIBFR e WHERE a1.Kd_Bidang=e.Kd_Bidang AND a1.Kd_Unit=e.Kd_Unit AND a1.Kd_Sub=e.Kd_Sub AND a1.Kd_UPB=e.Kd_UPB AND a1.Kd_Aset1=e.Kd_Aset1 AND a1.Kd_Aset2=e.Kd_Aset2 AND a1.Kd_Aset3=e.Kd_Aset3 AND a1.Kd_Aset4=e.Kd_Aset4 AND a1.Kd_Aset5=e.Kd_Aset5 AND a1.No_Register=e.No_Register AND Kd_Riwayat=19 AND e.Tgl_Dokumen <= '{$tahunakhir}') ) as x ) as a WHERE 1=1 $where $tgl_pembukuan GROUP BY a.Kd_Prov, a.Kd_Kab_Kota, a.Kd_Bidang, a.Kd_Unit, a.Kd_Sub, a.Kd_UPB, a.Kd_Aset1, a.Kd_Aset2, a.Kd_Aset3, a.Kd_Aset4, a.Kd_Aset5, a.Kd_Pemilik, a.Kd_Pemilik,a.Kondisi,a.Tgl_Perolehan, a.Bertingkat_Tidak,a.Beton_tidak,a.Panjang,a.Lebar,a.Luas_Lantai,a.Lokasi,a.Dokumen_Tanggal, a.Dokumen_Nomor,a.Status_Tanah,a.Asal_usul,a.Keterangan,a.Nm_Aset5 ORDER BY  a.Nm_Aset5, MIN(a.No_register)"; return $this->db->query($query); } /** * Menampilkan data kib F Mutasi */ function mutasi($bidang,$unit,$sub,$upb,$tahunawal,$tahunakhir,$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $thn   =  $this->session->userdata('tahun_anggaran'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){$where .= "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{$where .= "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; $where .= "AND (a.Kd_UPB = $kupb)"; } $tgl_pembukuan 	= " AND Tgl_Pembukuan ".$like; $tgl_dokumen 	= " AND Tgl_Dokumen <= '".$tahunakhir."'"; $query = "SELECT n.Nm_Aset5, COUNT(a.No_register) as jumlah_register,MIN(a.No_register) as min_register, MAX(a.No_register) as max_register, a.Kd_Prov, a.Kd_Kab_Kota, a.Kd_Bidang, a.Kd_Unit, a.Kd_Sub, a.Kd_UPB, a.Kd_Aset1, a.Kd_Aset2, a.Kd_Aset3, a.Kd_Aset4, a.Kd_Aset5, a.Kd_Pemilik,DATENAME(yyyy,a.Tgl_Perolehan) as Tahun, COUNT (CASE WHEN a.Kd_Riwayat IN (3, 7, 23) THEN a.Harga END ) AS Jumlah_Kurang, COUNT (CASE WHEN Kd_Riwayat is null OR Kd_Riwayat IN (2, 21) THEN a.Harga END ) AS Jumlah_Tambah, SUM (CASE WHEN a.Kd_Riwayat IN (3, 7, 23) THEN a.Harga END ) AS Mutasi_Kurang, SUM (CASE WHEN Kd_Riwayat is null OR Kd_Riwayat IN (2, 21) THEN a.Harga END ) AS Mutasi_Tambah, a.Keterangan FROM (SELECT null as Kd_Riwayat,Kd_Prov, Kd_Kab_Kota, Kd_Bidang, Kd_Unit, Kd_Sub, Kd_UPB, Kd_Aset1, Kd_Aset2, Kd_Aset3, Kd_Aset4,Kd_Aset5, No_Register, Kd_Pemilik,Tgl_Perolehan,Tgl_Pembukuan,Kondisi,Asal_usul,Harga,Keterangan FROM Ta_KIB_F UNION SELECT Kd_Riwayat,Kd_Prov, Kd_Kab_Kota, Kd_Bidang, Kd_Unit, Kd_Sub, Kd_UPB, Kd_Aset1, Kd_Aset2, Kd_Aset3, Kd_Aset4, Kd_Aset5, No_Register,Kd_Pemilik,null as Tgl_Perolehan,Tgl_Dokumen as Tgl_Pembukuan,null as Kondisi,null as Asal_usul,Harga,Keterangan FROM Ta_KIBFR WHERE Kd_Riwayat IN (2,7,21,23) UNION SELECT 3 as Kd_Riwayat,Kd_Prov, Kd_Kab_Kota, Kd_Bidang, Kd_Unit, Kd_Sub, Kd_UPB, Kd_Aset1, Kd_Aset2, Kd_Aset3, Kd_Aset4,Kd_Aset5, No_Register, Kd_Pemilik,Tgl_Perolehan,NewDokumen as Tgl_Pembukuan,Kondisi,Asal_usul, ((Harga + ISNULL(Koreksi_Tambah, 0)) - ISNULL(Koreksi_Kurang, 0) ) as Harga, Keterangan FROM (SELECT a1.*,a2.Tgl_Dokumen as NewDokumen, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBFR a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBFR a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_KIB_F a1 RIGHT JOIN Ta_KIBFR a2 ON a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register WHERE Kd_Riwayat=19 AND Tgl_Dokumen BETWEEN '$tahunawal' AND '$tahunakhir') as x ) as a LEFT JOIN Ref_Rek_Aset5 n ON a.Kd_Aset1 = n.Kd_Aset1 AND a.Kd_Aset2 = n.Kd_Aset2 AND a.Kd_Aset3 = n.Kd_Aset3 AND a.Kd_Aset4 = n.Kd_Aset4 AND a.Kd_Aset5 = n.Kd_Aset5 WHERE 1=1 $where $tgl_pembukuan GROUP BY a.Kd_Prov, a.Kd_Kab_Kota, a.Kd_Bidang, a.Kd_Unit, a.Kd_Sub, a.Kd_UPB, a.Kd_Aset1, a.Kd_Aset2, a.Kd_Aset3, a.Kd_Aset4, a.Kd_Aset5, a.Kd_Pemilik, a.Kd_Pemilik,a.Tgl_Perolehan,a.Asal_usul, a.Kondisi,a.Keterangan,n.Nm_Aset5 ORDER BY  n.Nm_Aset5, MIN(a.No_register)"; return $this->db->query($query); } /** * Menampilkan semua data kib f rekap */ function rekap_mutasi($bidang='',$unit='',$sub='',$upb='',$tahunawal,$tahunakhir) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $thn   =  $this->session->userdata('tahun_anggaran'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; $where .= "AND (a.Kd_UPB = $kupb)"; } $tgl_pembukuan 	= " AND Tgl_Pembukuan <= '$tahunakhir'"; $tgl_dokumen 	= " AND Tgl_Dokumen < '$tahunawal'"; $query = "SELECT Ref_Rek_Aset2.Kd_Aset1,Ref_Rek_Aset2.Kd_Aset2,Nm_Aset2, COUNT(CASE WHEN Tgl_Pembukuan < '$tahunawal' THEN 1 else null END) as Jumlah_awal, SUM(CASE WHEN Tgl_Pembukuan < '$tahunawal'  THEN Harga END) as Harga_awal, COUNT(CASE WHEN Tgl_Pembukuan BETWEEN '$tahunawal' AND '$tahunakhir' THEN CASE WHEN Kd_Riwayat IN (3, 7, 23) THEN Harga END END ) AS Jumlah_Kurang, SUM (CASE WHEN Tgl_Pembukuan BETWEEN '$tahunawal' AND '$tahunakhir' THEN CASE WHEN Kd_Riwayat IN (3, 7, 23) THEN Harga END END) AS Mutasi_Kurang, COUNT(CASE WHEN Tgl_Pembukuan BETWEEN '$tahunawal' AND '$tahunakhir' THEN CASE WHEN Kd_Riwayat is null OR Kd_Riwayat IN (2, 21) THEN Harga END END ) AS Jumlah_Tambah, SUM (CASE WHEN Tgl_Pembukuan BETWEEN '$tahunawal' AND '$tahunakhir' THEN CASE WHEN Kd_Riwayat is null OR Kd_Riwayat IN (2, 21) THEN Harga END END) AS Mutasi_Tambah FROM Ref_Rek_Aset2 LEFT JOIN (SELECT * FROM (SELECT Kd_Riwayat,Kd_Prov, Kd_Kab_Kota, Kd_Bidang, Kd_Unit, Kd_Sub, Kd_UPB, Kd_Aset1, Kd_Aset2, Kd_Aset3, Kd_Aset4,Kd_Aset5, No_Register, Kd_Pemilik,null as Tgl_Perolehan,Tgl_Dokumen as Tgl_Pembukuan,Harga,Keterangan FROM Ta_KIBFR WHERE Kd_Riwayat IN (7,21,23) AND Tgl_Dokumen BETWEEN '$tahunawal' AND '$tahunakhir'UNION /* mutasi kurang reklas */ SELECT 3 as Kd_Riwayat,Kd_Prov, Kd_Kab_Kota, Kd_Bidang, Kd_Unit, Kd_Sub, Kd_UPB, Kd_Aset1, Kd_Aset2, Kd_Aset3, Kd_Aset4,Kd_Aset5, No_Register, Kd_Pemilik,Tgl_Perolehan,NewDokumen as Tgl_Pembukuan, ((Harga + ISNULL(Koreksi_Tambah, 0)) - ISNULL(Koreksi_Kurang, 0) ) as Harga, Keterangan FROM (SELECT a1.*,a2.Tgl_Dokumen as NewDokumen, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBFR a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBFR a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_KIB_F a1 RIGHT JOIN Ta_KIBFR a2 ON a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register WHERE Kd_Riwayat=19 AND Tgl_Dokumen BETWEEN '$tahunawal' AND '$tahunakhir') as mk_reklas UNION SELECT null as Kd_Riwayat,Kd_Prov, Kd_Kab_Kota, Kd_Bidang, Kd_Unit, Kd_Sub, Kd_UPB, Kd_Aset1, Kd_Aset2, Kd_Aset3, Kd_Aset4,Kd_Aset5, No_Register, Kd_Pemilik,Tgl_Perolehan,Tgl_Pembukuan,((Harga + ISNULL(Koreksi_Tambah, 0) ) - ISNULL(Koreksi_Kurang, 0) ) as Harga, Keterangan FROM (SELECT n.Nm_Aset5, a1.*, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBFR a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBFR a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_KIB_F a1 INNER JOIN Ref_Rek_Aset5 n ON a1.Kd_Aset1 = n.Kd_Aset1 AND a1.Kd_Aset2 = n.Kd_Aset2 AND a1.Kd_Aset3 = n.Kd_Aset3 AND a1.Kd_Aset4 = n.Kd_Aset4 AND a1.Kd_Aset5 = n.Kd_Aset5 WHERE NOT EXISTS (SELECT 1 FROM  Ta_KIBFR e WHERE a1.Kd_Bidang=e.Kd_Bidang AND a1.Kd_Unit=e.Kd_Unit AND a1.Kd_Sub=e.Kd_Sub AND a1.Kd_UPB=e.Kd_UPB AND a1.Kd_Aset1=e.Kd_Aset1 AND a1.Kd_Aset2=e.Kd_Aset2 AND a1.Kd_Aset3=e.Kd_Aset3 AND a1.Kd_Aset4=e.Kd_Aset4 AND a1.Kd_Aset5=e.Kd_Aset5 AND a1.No_Register=e.No_Register AND Kd_Riwayat=19 AND e.Tgl_Dokumen < '$tahunawal') ) as x ) as a WHERE 1=1 $where $tgl_pembukuan) as a3 ON a3.Kd_Aset1=Ref_Rek_Aset2.Kd_Aset1 AND a3.Kd_Aset2=Ref_Rek_Aset2.Kd_Aset2  WHERE Ref_Rek_Aset2.Kd_Aset1 IN (3,4) GROUP BY Ref_Rek_Aset2.Kd_Aset1,Ref_Rek_Aset2.Kd_Aset2,Nm_Aset2 ORDER BY Kd_Aset2"; return $this->db->query($query); } /** * Menampilkan data kib F Buku induk */ function kibf_buku_induk($like) {$kb 	=  $this->session->userdata('kd_bidang'); $ku 	=  $this->session->userdata('kd_unit'); $ks 	=  $this->session->userdata('kd_sub_unit'); $kupb 	=  $this->session->userdata('kd_upb'); if ($this->session->userdata('lvl') == 01){$where = ''; }elseif ($this->session->userdata('lvl') == 02){$where = "(Ta_KIB_F.Kd_Bidang = $kb ) AND (Ta_KIB_F.Kd_Unit =$ku ) AND (Ta_KIB_F.Kd_Sub = $ks) AND"; }else{$where = "(Ta_KIB_F.Kd_Bidang = $kb) AND (Ta_KIB_F.Kd_Unit = $ku) AND (Ta_KIB_F.Kd_Sub = $ks) AND (Ta_KIB_F.Kd_UPB = $kupb) AND"; } $query = "SELECT  Nm_UPB,Ref_Rek_Aset5.Nm_Aset5,COUNT(Ta_KIB_F.No_register) as jumlah_register,MIN(Ta_KIB_F.No_register) as min_register, MAX(Ta_KIB_F.No_register) as max_register, Ta_KIB_F.Kd_Prov, Ta_KIB_F.Kd_Kab_Kota, Ta_KIB_F.Kd_Bidang, Ta_KIB_F.Kd_Unit, Ta_KIB_F.Kd_Sub, Ta_KIB_F.Kd_UPB, Ta_KIB_F.Kd_Aset1, Ta_KIB_F.Kd_Aset2, Ta_KIB_F.Kd_Aset3, Ta_KIB_F.Kd_Aset4, Ta_KIB_F.Kd_Aset5, Ta_KIB_F.Kd_Pemilik,DATENAME(yyyy,Ta_KIB_F.Tgl_Perolehan) as Tahun, Ta_KIB_F.Asal_usul,Ta_KIB_F.Kondisi,COUNT(*) as Jumlah, SUM(Ta_KIB_F.Harga) as Harga,Ta_KIB_F.Keterangan FROM  Ta_KIB_F INNER JOIN Ref_Rek_Aset5 ON Ta_KIB_F.Kd_Aset1 = Ref_Rek_Aset5.Kd_Aset1 AND Ta_KIB_F.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_KIB_F.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_KIB_F.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_KIB_F.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 INNER JOIN Ref_UPB ON Ta_KIB_F.Kd_Bidang=Ref_UPB.Kd_Bidang AND Ta_KIB_F.Kd_Unit=Ref_UPB.Kd_Unit AND Ta_KIB_F.Kd_Sub=Ref_UPB.Kd_Sub AND Ta_KIB_F.Kd_UPB=Ref_UPB.Kd_UPB WHERE  $where $like GROUP BY Ta_KIB_F.Kd_Prov, Ta_KIB_F.Kd_Kab_Kota, Ta_KIB_F.Kd_Bidang, Ta_KIB_F.Kd_Unit, Ta_KIB_F.Kd_Sub, Ta_KIB_F.Kd_UPB, Ta_KIB_F.Kd_Aset1, Ta_KIB_F.Kd_Aset2, Ta_KIB_F.Kd_Aset3, Ta_KIB_F.Kd_Aset4, Ta_KIB_F.Kd_Aset5, Ta_KIB_F.Kd_Pemilik, Ta_KIB_F.Kd_Pemilik,Ta_KIB_F.Tgl_Perolehan,Ta_KIB_F.Asal_usul, Ta_KIB_F.Kondisi,Ta_KIB_F.Keterangan,Ref_Rek_Aset5.Nm_Aset5,Nm_UPB ORDER BY  Nm_UPB,Ref_Rek_Aset5.Nm_Aset5, MIN(Ta_KIB_F.No_register)"; return $this->db->query($query); } /** * Total Data buku induk skpd */ function total_kibf_buku_induk($like) {$query = "SELECT COUNT(*) as Jumlah, SUM(Harga) as Harga FROM Ta_KIB_F where $like"; return $this->db->query($query); } /** * Menampilkan sdata kib f rekap inventaris */ function kibf_rinventaris($bidang,$unit,$sub,$upb,$like) {$kb 	=  $this->session->userdata('kd_bidang'); $ku 	=  $this->session->userdata('kd_unit'); $ks 	=  $this->session->userdata('kd_sub_unit'); $kupb 	=  $this->session->userdata('kd_upb'); if ($this->session->userdata('lvl') == 01){$where = "WHERE (Ta_KIB_F.Kd_Bidang = $bidang) AND (Ta_KIB_F.Kd_Unit = $unit) AND (Ta_KIB_F.Kd_Sub = $sub) AND (Ta_KIB_F.Kd_UPB = $upb) AND $like"; }elseif ($this->session->userdata('lvl') == 02){$where = "WHERE (Ta_KIB_F.Kd_Bidang = $kb ) AND (Ta_KIB_F.Kd_Unit =$ku ) AND (Ta_KIB_F.Kd_Sub = $ks) AND (Ta_KIB_F.Kd_UPB = $upb) AND $like"; }else{$where = "WHERE (Ta_KIB_F.Kd_Bidang = $kb) AND (Ta_KIB_F.Kd_Unit = $ku) AND (Ta_KIB_F.Kd_Sub = $ks) AND (Ta_KIB_F.Kd_UPB = $kupb) AND $like"; } $query = "SELECT Ref_Rek_Aset2.Kd_Aset1,Ref_Rek_Aset2.Kd_Aset2,Nm_Aset2,COUNT(*) as Jumlah, SUM(Harga) as Harga from Ref_Rek_Aset2 LEFT JOIN (SELECT * from Ta_KIB_F $where) as Ta_KIB_F ON Ta_KIB_F.Kd_Aset1=Ref_Rek_Aset2.Kd_Aset1 AND Ta_KIB_F.Kd_Aset2=Ref_Rek_Aset2.Kd_Aset2   WHERE Ref_Rek_Aset2.Kd_Aset1=6 GROUP BY Ref_Rek_Aset2.Kd_Aset1,Ref_Rek_Aset2.Kd_Aset2,Nm_Aset2 "; return $this->db->query($query); } /** * Total Data Mutasi */ function total_kibf_rinventaris($bidang,$unit,$sub,$upb,$like) {$kb 	=  $this->session->userdata('kd_bidang'); $ku 	=  $this->session->userdata('kd_unit'); $ks 	=  $this->session->userdata('kd_sub_unit'); $kupb 	=  $this->session->userdata('kd_upb'); if ($this->session->userdata('lvl') == 01){$where = "WHERE (Ta_KIB_F.Kd_Bidang = $bidang) AND (Ta_KIB_F.Kd_Unit = $unit) AND (Ta_KIB_F.Kd_Sub = $sub) AND (Ta_KIB_F.Kd_UPB = $upb) AND $like"; }elseif ($this->session->userdata('lvl') == 02){$where = "WHERE (Ta_KIB_F.Kd_Bidang = $kb ) AND (Ta_KIB_F.Kd_Unit =$ku ) AND (Ta_KIB_F.Kd_Sub = $ks) AND (Ta_KIB_F.Kd_UPB = $upb) AND $like"; }else{$where = "WHERE (Ta_KIB_F.Kd_Bidang = $kb) AND (Ta_KIB_F.Kd_Unit = $ku) AND (Ta_KIB_F.Kd_Sub = $ks) AND (Ta_KIB_F.Kd_UPB = $kupb) AND $like"; } $query = "SELECT COUNT(*) as Jumlah,SUM(Harga) as Harga FROM Ta_KIB_F $where"; return $this->db->query($query); } function rekap_skpd($bidang='',$unit='',$sub='',$upb='',$tahunawal,$tahunakhir,$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $thn   =  $this->session->userdata('tahun_anggaran'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; $where .= "AND (a.Kd_UPB = $kupb)"; } $tgl_pembukuan 	= " AND Tgl_Pembukuan ".$like; $tgl_dokumen 	= " AND Tgl_Dokumen <= '".$tahunakhir."'"; $query = "SELECT COUNT(*) as Jumlah, SUM(LastHarga) as  Harga FROM (SELECT *,((Harga + ISNULL(Koreksi_Tambah, 0) ) - ISNULL(Koreksi_Kurang, 0) ) as LastHarga FROM (SELECT n.Nm_Aset5, a1.*, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBFR a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBFR a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_KIB_F a1 INNER JOIN Ref_Rek_Aset5 n ON a1.Kd_Aset1 = n.Kd_Aset1 AND a1.Kd_Aset2 = n.Kd_Aset2 AND a1.Kd_Aset3 = n.Kd_Aset3 AND a1.Kd_Aset4 = n.Kd_Aset4 AND a1.Kd_Aset5 = n.Kd_Aset5 WHERE NOT EXISTS (SELECT 1 FROM Ta_KIBFR e WHERE a1.Kd_Bidang=e.Kd_Bidang AND a1.Kd_Unit=e.Kd_Unit AND a1.Kd_Sub=e.Kd_Sub AND a1.Kd_UPB=e.Kd_UPB AND a1.Kd_Aset1=e.Kd_Aset1 AND a1.Kd_Aset2=e.Kd_Aset2 AND a1.Kd_Aset3=e.Kd_Aset3 AND a1.Kd_Aset4=e.Kd_Aset4 AND a1.Kd_Aset5=e.Kd_Aset5 AND a1.No_Register=e.No_Register AND Kd_Riwayat=19 AND e.Tgl_Dokumen <= '{$tahunakhir}') ) as x ) as a WHERE 1=1 $where $tgl_pembukuan"; return $this->db->query($query); } /** * Mendapatkan data sebuah kibf */ function get_kibf_by_id($kd_prov,$kd_kab,$bidang,$unit,$sub,$upb,$kd_aset1,$kd_aset2,$kd_aset3,$kd_aset4,$kd_aset5,$no_register) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $where = ""; $where .= "AND (a.Kd_Prov = $kd_prov)"; $where .= "AND (a.Kd_Kab_Kota = $kd_kab)"; if ($this->session->userdata('lvl') == 01){$where = "AND (a.Kd_Bidang = $bidang) AND (a.Kd_Unit = $unit) AND (a.Kd_Sub = $sub) AND (a.Kd_UPB = $upb)"; }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb ) AND (a.Kd_Unit =$ku ) AND (a.Kd_Sub = $ks) AND (a.Kd_UPB = $upb)"; }else{$where = "AND (a.Kd_Bidang = $kb) AND (a.Kd_Unit = $ku) AND (a.Kd_Sub = $ks) AND (a.Kd_UPB = $kupb)"; } $where .= "AND a.Kd_Aset1 = {$kd_aset1} AND a.Kd_Aset2 = {$kd_aset2} AND a.Kd_Aset3 = {$kd_aset3} AND a.Kd_Aset4 = {$kd_aset4} AND a.Kd_Aset5 = {$kd_aset5} AND a.No_Register = {$no_register} "; $tgl_dokumen 	= " AND YEAR(Tgl_Dokumen) <= '{$this->session->userdata('tahun_anggaran')}'"; $query = "SELECT *,((Harga + (CASE WHEN Koreksi_Tambah is null THEN 0 ELSE Koreksi_Tambah END) ) - (CASE WHEN Koreksi_Kurang is null THEN 0 ELSE Koreksi_Kurang END)) as LastHarga FROM (SELECT n.Nm_Aset5, a1.*, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBFR a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBFR a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_KIB_F a1 INNER JOIN Ref_Rek_Aset5 n ON a1.Kd_Aset1 = n.Kd_Aset1 AND a1.Kd_Aset2 = n.Kd_Aset2 AND a1.Kd_Aset3 = n.Kd_Aset3 AND a1.Kd_Aset4 = n.Kd_Aset4 AND a1.Kd_Aset5 = n.Kd_Aset5 )as a WHERE 1=1 $where"; /*print_r($query); exit();*/ return $this->db->query($query); } /** * Menampilkan semua data tanah */ /* function data_kib_F($kd_bidang,$kd_unit,$kd_sub,$kd_upb,$tahun) {$this->db->select('Ta_KIB_F.*,Ref_Rek_Aset5.Nm_Aset5'); $this->db->from('Ta_KIB_F'); $this->db->join('Ref_Rek_Aset5', 'Ta_KIB_F.Kd_Aset1 = Ref_Rek_Aset5.Kd_Aset1 AND Ta_KIB_F.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_KIB_F.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_KIB_F.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_KIB_F.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5'); $this->db->where('Ta_KIB_F.Kd_Bidang',$kd_bidang); $this->db->where('Ta_KIB_F.Kd_Unit',$kd_unit); $this->db->where('Ta_KIB_F.Kd_Sub',$kd_sub); $this->db->where('Ta_KIB_F.Kd_UPB',$kd_upb); $this->db->like('Tgl_Perolehan',$tahun); return $this->db->get(); }*/ /** * Menghitung jumlah baris dalam sebuah tabel, ada kaitannya dengan pagination */ /* function count_all_num_rows() {return $this->db->count_all($this->table); }*/ /*function getTotalRowAllData($kd_bidang,$kd_unit,$kd_sub,$kd_upb,$tahun){$this->db->where('Ta_Kib_F.Kd_Bidang',$kd_bidang); $this->db->where('Ta_Kib_F.Kd_Unit',$kd_unit); $this->db->where('Ta_Kib_F.Kd_Sub',$kd_sub); $this->db->where('Ta_Kib_F.Kd_UPB',$kd_upb); $this->db->like('Ta_Kib_F.Tgl_Perolehan',$tahun); return $this->db->count_all($this->table); } */ /** * pencarian semua data tanah */ /* function caridata($limit, $offset,$kd_bidang,$kd_unit,$kd_sub,$kd_upb,$q,$s){if($offset == 0  or !isset($offset)){$first = 1; $last  = $limit; }else{$first = $offset+1; $last  = $first + ($limit -1); } if ($q == 'all'){$like = ''; }else{$like = "AND Ta_KIB_F.$q like '%$s%'"; } $query= $this->db->query("SELECT     no_urut,* FROM         (SELECT     *, ROW_NUMBER() OVER (ORDER BY Kd_Prov) AS no_urut FROM         Ta_KIB_F where Ta_KIB_F.Kd_Bidang=$kd_bidang AND Ta_KIB_F.Kd_Unit=$kd_unit AND Ta_KIB_F.Kd_Sub=$kd_sub AND Ta_KIB_F.Kd_UPB=$kd_upb $like) AS Ta_KIB_F INNER JOIN Ref_Rek_Aset5 ON Ta_KIB_F.Kd_Aset1=Ref_Rek_Aset5.Kd_Aset1 AND Ta_KIB_F.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_KIB_F.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_KIB_F.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_KIB_F.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 WHERE no_urut BETWEEN $first AND $last"); return $query; } */ /** * Menampilkan semua data tanah */ /* function get_all() {$this->db->limit('10'); $this->db->select('Ta_Kib_F.*,Ref_UPB.Nm_UPB'); $this->db->from('Ta_Kib_F'); $this->db->join('Ref_UPB', 'Ta_KIB_F.Kd_Prov = Ref_UPB.Kd_Prov AND Ta_KIB_F.Kd_Kab_Kota = Ref_UPB.Kd_Kab_Kota AND Ta_KIB_F.Kd_Bidang = Ref_UPB.Kd_Bidang AND Ta_KIB_F.Kd_Unit = Ref_UPB.Kd_Unit AND Ta_KIB_F.Kd_Sub = Ref_UPB.Kd_Sub AND Ta_KIB_F.Kd_UPB = Ref_UPB.Kd_UPB'); return $this->db->get(); }/* /** * Tampilkan 10 baris absen terkini, diurutkan berdasarkan tanggal (Descending) */ /* function get_10_data($limit, $offset, $kd_upb) {if($offset == 0  or !isset($offset)){$first = 1; $last  = $limit; }else{$first = $offset+1; $last  = $first + ($limit -1); } $kd_bidang	=  $this->session->userdata('kd_bidang'); $kd_unit	=  $this->session->userdata('kd_unit'); $kd_sub		=  $this->session->userdata('kd_sub_unit'); $kd_upb		=  $this->session->userdata('kd_upb'); $tahun		=  $this->session->userdata('tahun_anggaran'); if ($this->session->userdata('lvl') == 02){$x = "where Ta_KIB_F.Kd_Bidang=$kd_bidang AND Ta_KIB_F.Kd_Unit=$kd_unit AND Ta_KIB_F.Kd_Sub=$kd_sub AND Ta_KIB_F.Kd_UPB=$kd_upb AND Ta_KIB_F.Tgl_Perolehan like '%$tahun%'"; }else{$x = ''; } $query= $this->db->query("SELECT     no_urut,* FROM         (SELECT     *, ROW_NUMBER() OVER (ORDER BY Kd_Prov) AS no_urut FROM         Ta_KIB_F $x) AS Ta_KIB_F INNER JOIN Ref_Rek_Aset5 ON Ta_KIB_F.Kd_Aset1=Ref_Rek_Aset5.Kd_Aset1 AND Ta_KIB_F.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_KIB_F.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_KIB_F.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_KIB_F.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 WHERE no_urut BETWEEN $first AND $last"); return $query; }*/ function data_foto($kd_prov,$kd_kab,$kd_bidang,$kd_unit,$kd_sub,$kd_upb,$kd_aset1,$kd_aset2,$kd_aset3,$kd_aset4,$kd_aset5,$no_register) {$this->db->select('*'); $this->db->from('Ta_FotoA'); $this->db->where('Kd_Prov',$kd_prov); $this->db->where('Kd_Kab_Kota',$kd_kab); $this->db->where('Kd_Bidang',$kd_bidang); $this->db->where('Kd_Unit',$kd_unit); $this->db->where('Kd_Sub',$kd_sub); $this->db->where('Kd_UPB',$kd_upb); $this->db->where('Kd_Aset1',$kd_aset1); $this->db->where('Kd_Aset2',$kd_aset2); $this->db->where('Kd_Aset3',$kd_aset3); $this->db->where('Kd_Aset4',$kd_aset4); $this->db->where('Kd_Aset5',$kd_aset5); $this->db->where('No_Register',$no_register); return $this->db->get(); } /** * Tampilkan jumlah data */ /* function get_jumlah_data($kd_bidang,$kd_unit,$kd_sub,$kd_upb,$tahun) {$this->db->select('*'); $this->db->from($this->table); $this->db->where('Kd_Bidang',$kd_bidang); $this->db->where('Kd_Unit',$kd_unit); $this->db->where('Kd_Sub',$kd_sub); $this->db->where('Kd_UPB',$kd_upb); $this->db->like('Tgl_Perolehan',$tahun); return $this->db->get(); } */ /** * Tampilkan total harga */ /* function total_perupb($kd_bidang,$kd_unit,$kd_sub,$kd_upb) {$this->db->select_SUM('Harga'); $this->db->from($this->table); $this->db->where('Kd_Bidang',$kd_bidang); $this->db->where('Kd_Unit',$kd_unit); $this->db->where('Kd_Sub',$kd_sub); $this->db->where('Kd_UPB',$kd_upb); $sql = $this->db->get(); foreach ($sql->result() as $row) {$result = $row->Harga; } return $result; } */ /** * Tampilkan total harga pencarian */ /* function total_cari($kd_bidang,$kd_unit,$kd_sub,$kd_upb,$q,$s) {$this->db->select_SUM('Harga'); $this->db->from($this->table); $this->db->where('Kd_Bidang',$kd_bidang); $this->db->where('Kd_Unit',$kd_unit); $this->db->where('Kd_Sub',$kd_sub); $this->db->where('Kd_UPB',$kd_upb); $q != 'all' ? $this->db->like($q,$s) : ''; $sql = $this->db->get(); foreach ($sql->result() as $row) {$result = $row->Harga; } return $result; }*/ /** * Tampilkan jumlah data pencarian */ /* function get_jumlah_datacari($kd_bidang,$kd_unit,$kd_sub,$kd_upb,$q,$s) {$this->db->select('*'); $this->db->from($this->table); $this->db->where('Kd_Bidang',$kd_bidang); $this->db->where('Kd_Unit',$kd_unit); $this->db->where('Kd_Sub',$kd_sub); $this->db->where('Kd_UPB',$kd_upb); $q != 'all' ? $this->db->like($q,$s) : ''; return $this->db->get(); } */ /** * mendapatkan no register terakhir */ function get_last_noregister($kd_bidang,$kd_unit,$kd_sub,$kd_upb,$kd_aset1,$kd_aset2,$kd_aset3,$kd_aset4,$kd_aset5) {$this->db->select_MAX('No_Register'); $array_keys_values = $this->db->get_where($this->table,array('Kd_Bidang' => $kd_bidang,'Kd_Unit' => $kd_unit,'Kd_Sub' => $kd_sub, 'Kd_UPB' => $kd_upb,'Kd_Aset1' => $kd_aset1,'Kd_Aset2' => $kd_aset2,'Kd_Aset3' => $kd_aset3,'Kd_Aset4' => $kd_aset4,'Kd_Aset5' => $kd_aset5)); foreach ($array_keys_values->result() as $row) {$result = $row->No_Register; } return $result+1; } /** * memeriksa register */ function cek_register($kd_bidang,$kd_unit,$kd_sub,$kd_upb,$kd_aset1,$kd_aset2,$kd_aset3,$kd_aset4,$kd_aset5,$no_register) {$result = $this->db->get_where($this->table,array('Kd_Bidang' => $kd_bidang,'Kd_Unit' => $kd_unit,'Kd_Sub' => $kd_sub, 'Kd_UPB' => $kd_upb,'Kd_Aset1' => $kd_aset1,'Kd_Aset2' => $kd_aset2,'Kd_Aset3' => $kd_aset3,'Kd_Aset4' => $kd_aset4,'Kd_Aset5' => $kd_aset5,'No_Register' => $no_register)); return $result; } /** * Menambah data tanah */ function add($data) {return $this->db->insert($this->table, $data); } function add_riwayat($data) {return $this->db->insert('Ta_KIBFR', $data); } /** * Menambah data tanah */ function insert($foto) {$this->db->insert('Ta_FotoA', $foto); return TRUE; } /** * Menghapus sebuah data kibf */ function hapus($kd_prov,$kd_kab,$kd_bidang,$kd_unit,$kd_sub,$kd_upb,$kd_aset1,$kd_aset2,$kd_aset3,$kd_aset4,$kd_aset5,$no_register) {$this->db->delete($this->table, array('Kd_Prov' => $kd_prov,'Kd_Kab_Kota' => $kd_kab,'Kd_Bidang' => $kd_bidang,'Kd_Unit' => $kd_unit, 'Kd_Sub' => $kd_sub,'Kd_UPB' => $kd_upb,'Kd_Aset1' => $kd_aset1,'Kd_Aset2' => $kd_aset2,'Kd_Aset3' => $kd_aset3, 'Kd_Aset4' => $kd_aset4,'Kd_Aset5' => $kd_aset5,'No_Register' => $no_register)); $this->db->delete("Ta_KIBFR", array('Kd_Prov' => $kd_prov,'Kd_Kab_Kota' => $kd_kab,'Kd_Bidang' => $kd_bidang,'Kd_Unit' => $kd_unit, 'Kd_Sub' => $kd_sub,'Kd_UPB' => $kd_upb,'Kd_Aset1' => $kd_aset1,'Kd_Aset2' => $kd_aset2,'Kd_Aset3' => $kd_aset3, 'Kd_Aset4' => $kd_aset4,'Kd_Aset5' => $kd_aset5,'No_Register' => $no_register)); $this->db->delete("Ta_KIBFR", array('Kd_Prov' => $kd_prov,'Kd_Kab_Kota' => $kd_kab,'Kd_Bidang1' => $kd_bidang,'Kd_Unit1' => $kd_unit, 'Kd_Sub1' => $kd_sub,'Kd_UPB1' => $kd_upb,'Kd_Aset1' => $kd_aset1,'Kd_Aset2' => $kd_aset2,'Kd_Aset3' => $kd_aset3, 'Kd_Aset4' => $kd_aset4,'Kd_Aset5' => $kd_aset5,'No_Register1' => $no_register)); } function hapus_riwayat($kd_riwayat,$kd_id,$kd_prov,$kd_kab,$kd_bidang,$kd_unit,$kd_sub,$kd_upb,$kd_aset1,$kd_aset2,$kd_aset3,$kd_aset4,$kd_aset5,$no_register) {$this->db->delete("Ta_KIBFR", array('Kd_Riwayat' => $kd_riwayat,'Kd_Id' => $kd_id,'Kd_Prov' => $kd_prov,'Kd_Kab_Kota' => $kd_kab,'Kd_Bidang' => $kd_bidang,'Kd_Unit' => $kd_unit, 'Kd_Sub' => $kd_sub,'Kd_UPB' => $kd_upb,'Kd_Aset1' => $kd_aset1,'Kd_Aset2' => $kd_aset2,'Kd_Aset3' => $kd_aset3,'Kd_Aset4' => $kd_aset4,'Kd_Aset5' => $kd_aset5,'No_Register' => $no_register)); } /** * 30-05-2014 Update data KIB */ function sm_update($kd_prov,$kd_kab,$kd_bidang,$kd_unit,$kd_sub,$kd_upb,$kd_aset1,$kd_aset2,$kd_aset3,$kd_aset4,$kd_aset5,$no_register,$data) {$this->db->where('Kd_Prov', $kd_prov); $this->db->where('Kd_Kab_Kota', $kd_kab); $this->db->where('Kd_Bidang', $kd_bidang); $this->db->where('Kd_Unit', $kd_unit); $this->db->where('Kd_Sub', $kd_sub); $this->db->where('Kd_UPB', $kd_upb); $this->db->where('Kd_Aset1', $kd_aset1); $this->db->where('Kd_Aset2', $kd_aset2); $this->db->where('Kd_Aset3', $kd_aset3); $this->db->where('Kd_Aset4', $kd_aset4); $this->db->where('Kd_Aset5', $kd_aset5); $this->db->where('No_Register', $no_register); $this->db->update($this->table, $data); return TRUE; } /* 28-03-2014 tambah total kibf*/ function total_kibf() {$arr = array(); $query= "SELECT   DATENAME(yyyy,Tgl_Perolehan) as Tahun, SUM(Harga) AS Harga FROM  Ta_KIB_F INNER JOIN Ref_Rek_Aset5 ON Ta_KIB_F.Kd_Aset1=Ref_Rek_Aset5.Kd_Aset1 AND Ta_KIB_F.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_KIB_F.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_KIB_F.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_KIB_F.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5  WHERE 1=1 "; if ($this->session->userdata('lvl') == 01){$query .= ""; }elseif ($this->session->userdata('lvl') == 02){$query .= "AND (Ta_KIB_F.Kd_Bidang = ".$this->session->userdata('kd_bidang').")"; $query .= "AND (Ta_KIB_F.Kd_Unit = ".$this->session->userdata('kd_unit').")"; $query .= "AND (Ta_KIB_F.Kd_Sub = ".$this->session->userdata('kd_sub_unit').")"; }else{$query .= "AND (Ta_KIB_F.Kd_Bidang = ".$this->session->userdata('kd_bidang').")"; $query .= "AND (Ta_KIB_F.Kd_Unit = ".$this->session->userdata('kd_unit').")"; $query .= "AND (Ta_KIB_F.Kd_Sub = ".$this->session->userdata('kd_sub_unit').")"; $query .= "AND (Ta_KIB_F.Kd_UPB = ".$this->session->userdata('kd_upb').")"; } $query .= "GROUP BY DATENAME(yyyy,Tgl_Perolehan)"; $query .= "ORDER BY Tahun"; $sql = $this->db->query($query); foreach ($sql->result() as $row) {$arr[] = $row->Harga; } return $arr; } function laporan_all_kibf($like){$query = "SELECT * from Ta_KIB_F inner join Ref_Rek_Aset5 on Ta_KIB_F.Kd_Aset1=Ref_Rek_Aset5.Kd_Aset1 AND Ta_KIB_F.Kd_Aset2=Ref_Rek_Aset5.Kd_Aset2 AND Ta_KIB_F.Kd_Aset3=Ref_Rek_Aset5.Kd_Aset3 AND Ta_KIB_F.Kd_Aset4=Ref_Rek_Aset5.Kd_Aset4 AND Ta_KIB_F.Kd_Aset5=Ref_Rek_Aset5.Kd_Aset5 WHERE $like"; return $this->db->query($query); } function total_laporan_all_kibf($like) {$this->db->select_SUM('Harga'); $this->db->where("$like"); $this->db->from($this->table); $sql = $this->db->get(); foreach ($sql->result() as $row) {$result = $row->Harga; } return $result; } /* total kib e */ /* 02-07-2014 */ function laporan_kodebarang($bidang,$unit,$sub,$upb,$like) {$kb 	=  $this->session->userdata('kd_bidang'); $ku 	=  $this->session->userdata('kd_unit'); $ks 	=  $this->session->userdata('kd_sub_unit'); $kupb 	=  $this->session->userdata('kd_upb'); if ($this->session->userdata('lvl') == 01){$where = "(Ta_KIB_F.Kd_Bidang = $bidang) AND (Ta_KIB_F.Kd_Unit = $unit) AND (Ta_KIB_F.Kd_Sub = $sub) AND (Ta_KIB_F.Kd_UPB = $upb) AND"; }elseif ($this->session->userdata('lvl') == 02){$where = "(Ta_KIB_F.Kd_Bidang = $kb ) AND (Ta_KIB_F.Kd_Unit =$ku ) AND (Ta_KIB_F.Kd_Sub = $ks) AND (Ta_KIB_F.Kd_UPB = $upb) AND"; }else{$where = "(Ta_KIB_F.Kd_Bidang = $kb) AND (Ta_KIB_F.Kd_Unit = $ku) AND (Ta_KIB_F.Kd_Sub = $ks) AND (Ta_KIB_F.Kd_UPB = $kupb) AND"; } $query = "select Ref_Rek_Aset5.Kd_Aset1,Ref_Rek_Aset5.Kd_Aset2,Ref_Rek_Aset5.Kd_Aset3,Ref_Rek_Aset5.Kd_Aset4,Ref_Rek_Aset5.Kd_Aset5, Nm_Aset5,COUNT(*) as Jumlah, SUM(Harga) as Harga from Ref_Rek_Aset5 RIGHT JOIN Ta_KIB_F ON Ta_KIB_F.Kd_Aset1=Ref_Rek_Aset5.Kd_Aset1 AND Ta_KIB_F.Kd_Aset2=Ref_Rek_Aset5.Kd_Aset2 AND Ta_KIB_F.Kd_Aset3=Ref_Rek_Aset5.Kd_Aset3 AND Ta_KIB_F.Kd_Aset4=Ref_Rek_Aset5.Kd_Aset4 AND Ta_KIB_F.Kd_Aset5=Ref_Rek_Aset5.Kd_Aset5  WHERE $where $like GROUP BY Ref_Rek_Aset5.Kd_Aset1,Ref_Rek_Aset5.Kd_Aset2,Ref_Rek_Aset5.Kd_Aset3, Ref_Rek_Aset5.Kd_Aset4,Ref_Rek_Aset5.Kd_Aset5,Nm_Aset5 ORDER BY Ref_Rek_Aset5.Kd_Aset1,Ref_Rek_Aset5.Kd_Aset2,Ref_Rek_Aset5.Kd_Aset3, Ref_Rek_Aset5.Kd_Aset4,Ref_Rek_Aset5.Kd_Aset5"; return $this->db->query($query); } /** * Tampilkan total_pengadaan */ function total_kodebarang($bidang,$unit,$sub,$upb,$like) {if ($this->session->userdata('lvl') == 01){$this->db->where('Kd_Bidang',$bidang); $this->db->where('Kd_Unit',$unit); $this->db->where('Kd_Sub',$sub); $this->db->where('Kd_UPB',$upb); }elseif ($this->session->userdata('lvl') == 02){$this->db->where('Kd_Bidang',$this->session->userdata('kd_bidang')); $this->db->where('Kd_Unit',$this->session->userdata('kd_unit')); $this->db->where('Kd_Sub',$this->session->userdata('kd_sub_unit')); $this->db->where('Kd_UPB',$upb); }else{$this->db->where('Kd_Bidang',$this->session->userdata('kd_bidang')); $this->db->where('Kd_Unit',$this->session->userdata('kd_unit')); $this->db->where('Kd_Sub',$this->session->userdata('kd_sub_unit')); $this->db->where('Kd_UPB',$this->session->userdata('kd_upb')); } $this->db->select_SUM('Harga'); $this->db->where("$like"); $this->db->from($this->table); $sql = $this->db->get(); foreach ($sql->result() as $row) {$result = $row->Harga; } return $result; } /** * Menampilkan data kib F Mutasi */ function kibf_mutasi_barang($like) {$query = "SELECT   Nm_UPB, Ref_Rek_Aset5.Nm_Aset5,COUNT(Ta_KIB_F.No_register) as jumlah_register,MIN(Ta_KIB_F.No_register) as min_register, MAX(Ta_KIB_F.No_register) as max_register, Ta_KIB_F.Kd_Prov, Ta_KIB_F.Kd_Kab_Kota, Ta_KIB_F.Kd_Bidang, Ta_KIB_F.Kd_Unit, Ta_KIB_F.Kd_Sub, Ta_KIB_F.Kd_UPB, Ta_KIB_F.Kd_Aset1, Ta_KIB_F.Kd_Aset2, Ta_KIB_F.Kd_Aset3, Ta_KIB_F.Kd_Aset4, Ta_KIB_F.Kd_Aset5, Ta_KIB_F.Kd_Pemilik,DATENAME(yyyy,Ta_KIB_F.Tgl_Perolehan) as Tahun, Ta_KIB_F.Asal_usul,Ta_KIB_F.Kondisi,COUNT(*) as Jumlah, SUM(Ta_KIB_F.Harga) as Harga,Ta_KIB_F.Keterangan FROM  Ta_KIB_F INNER JOIN Ref_Rek_Aset5 ON Ta_KIB_F.Kd_Aset1 = Ref_Rek_Aset5.Kd_Aset1 AND Ta_KIB_F.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_KIB_F.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_KIB_F.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_KIB_F.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 INNER JOIN Ref_UPB ON Ta_KIB_F.Kd_Bidang=Ref_UPB.Kd_Bidang AND Ta_KIB_F.Kd_Unit=Ref_UPB.Kd_Unit AND Ta_KIB_F.Kd_Sub=Ref_UPB.Kd_Sub AND Ta_KIB_F.Kd_UPB=Ref_UPB.Kd_UPB WHERE $like GROUP BY Ta_KIB_F.Kd_Prov, Ta_KIB_F.Kd_Kab_Kota, Ta_KIB_F.Kd_Bidang, Ta_KIB_F.Kd_Unit, Ta_KIB_F.Kd_Sub, Ta_KIB_F.Kd_UPB, Ta_KIB_F.Kd_Aset1, Ta_KIB_F.Kd_Aset2, Ta_KIB_F.Kd_Aset3, Ta_KIB_F.Kd_Aset4, Ta_KIB_F.Kd_Aset5, Ta_KIB_F.Kd_Pemilik, Ta_KIB_F.Kd_Pemilik,Ta_KIB_F.Tgl_Perolehan,Ta_KIB_F.Asal_usul, Ta_KIB_F.Kondisi,Ta_KIB_F.Keterangan,Ref_Rek_Aset5.Nm_Aset5,Nm_UPB ORDER BY  Ref_Rek_Aset5.Nm_Aset5, MIN(Ta_KIB_F.No_register)"; return $this->db->query($query); } /** * Tampilkan total harga */ function total_kibf_mutasi_barang($like){$query = "SELECT COUNT(*) as Jumlah, SUM(Harga) as Harga FROM Ta_KIB_F where $like"; return $this->db->query($query); } /** * Menampilkan semua data kib f rekap induk*/ function rekap_mutasi_induk($like,$tahunawal,$tahunakhir)  {$query = "SELECT Ref_Rek_Aset2.Kd_Aset1, Ref_Rek_Aset2.Kd_Aset2, Nm_Aset2, COUNT(case when Tgl_Perolehan < '$tahunawal' then 1 else NULL end) as Jumlah_awal, SUM(CASE WHEN Tgl_Perolehan < '$tahunawal' THEN Harga else 0 END) as Harga_awal, COUNT(case WHEN $like then 0 else null end) as Jumlah_tambah, SUM(CASE WHEN $like THEN Harga END) as Harga_tambah FROM Ref_Rek_Aset2 RIGHT JOIN (SELECT * FROM Ta_KIB_F ) AS Ta_KIB_F ON Ta_KIB_F.Kd_Aset1 = Ref_Rek_Aset2.Kd_Aset1 AND Ta_KIB_F.Kd_Aset2 = Ref_Rek_Aset2.Kd_Aset2 GROUP BY Ref_Rek_Aset2.Kd_Aset1, Ref_Rek_Aset2.Kd_Aset2, Nm_Aset2 ORDER BY Ref_Rek_Aset2.Kd_Aset2"; return $this->db->query($query); } /** * Menampilkan Total rekap Mutasi Induk*/ function total_rekap_mutasi_induk($like,$tahunawal,$tahunakhir) {$query = "SELECT COUNT(case when Tgl_Perolehan < '$tahunawal' then 1 else NULL end) as Jumlah_awal, SUM(CASE WHEN Tgl_Perolehan < '$tahunawal' THEN Harga else 0 END) as Harga_awal, COUNT(case WHEN $like then 0 else null end) as Jumlah_tambah, SUM(CASE WHEN $like THEN Harga END) as Harga_tambah, COUNT(case when Tgl_Perolehan <= '$tahunakhir' then 1 else NULL end) as Jumlah, SUM(CASE WHEN Tgl_Perolehan <= '$tahunakhir' THEN Harga else 0 END) as Harga FROM Ref_Rek_Aset2 LEFT JOIN (SELECT * FROM Ta_KIB_F ) AS Ta_KIB_F ON Ta_KIB_F.Kd_Aset1 = Ref_Rek_Aset2.Kd_Aset1 AND Ta_KIB_F.Kd_Aset2 = Ref_Rek_Aset2.Kd_Aset2"; return $this->db->query($query); } /** * Menampilkan sdata kib f rekap inventaris */ function kibf_rinventaris_rekap($like)  {$where = $like; $query = "select Ref_Rek_Aset2.Kd_Aset1,Ref_Rek_Aset2.Kd_Aset2,Nm_Aset2,COUNT(*) as Jumlah, SUM(Harga) as Harga from Ref_Rek_Aset2 LEFT JOIN (SELECT * from Ta_KIB_F where $where) as Ta_KIB_F ON  Ta_KIB_F.Kd_Aset1=Ref_Rek_Aset2.Kd_Aset1 AND Ta_KIB_F.Kd_Aset2=Ref_Rek_Aset2.Kd_Aset2 WHERE Ref_Rek_Aset2.Kd_Aset1=3 GROUP BY Ref_Rek_Aset2.Kd_Aset1,Ref_Rek_Aset2.Kd_Aset2,Nm_Aset2 "; return $this->db->query($query); } /** * Total Data Mutasi Induk*/ function total_kibf_rinventaris_rekap($like) {$where = "$like"; $query = "SELECT COUNT(*) as Jumlah,SUM(Harga) as Harga FROM Ta_KIB_F where $where"; return $this->db->query($query); } /* 06-07-2014 */ function laporan_all_rkodebarang($like){$query = "select Ref_Rek_Aset5.Kd_Aset1,Ref_Rek_Aset5.Kd_Aset2,Ref_Rek_Aset5.Kd_Aset3,Ref_Rek_Aset5.Kd_Aset4,Ref_Rek_Aset5.Kd_Aset5, Nm_Aset5,COUNT(*) as Jumlah, SUM(Harga) as Harga,Nm_UPB from Ref_Rek_Aset5 RIGHT JOIN Ta_KIB_F ON Ta_KIB_F.Kd_Aset1=Ref_Rek_Aset5.Kd_Aset1 AND Ta_KIB_F.Kd_Aset2=Ref_Rek_Aset5.Kd_Aset2 AND Ta_KIB_F.Kd_Aset3=Ref_Rek_Aset5.Kd_Aset3 AND Ta_KIB_F.Kd_Aset4=Ref_Rek_Aset5.Kd_Aset4 AND Ta_KIB_F.Kd_Aset5=Ref_Rek_Aset5.Kd_Aset5 LEFT JOIN Ref_UPB ON Ta_KIB_F.Kd_Bidang=Ref_UPB.Kd_Bidang AND Ta_KIB_F.Kd_Unit=Ref_UPB.Kd_Unit AND Ta_KIB_F.Kd_Sub=Ref_UPB.Kd_Sub AND Ta_KIB_F.Kd_UPB=Ref_UPB.Kd_UPB WHERE $like GROUP BY Ref_Rek_Aset5.Kd_Aset1,Ref_Rek_Aset5.Kd_Aset2,Ref_Rek_Aset5.Kd_Aset3, Ref_Rek_Aset5.Kd_Aset4,Ref_Rek_Aset5.Kd_Aset5,Nm_Aset5,Nm_UPB ORDER BY Ref_Rek_Aset5.Kd_Aset1,Ref_Rek_Aset5.Kd_Aset2,Ref_Rek_Aset5.Kd_Aset3, Ref_Rek_Aset5.Kd_Aset4,Ref_Rek_Aset5.Kd_Aset5"; return $this->db->query($query); } /* 12-08-2014*/ function total_kib_skpd($bidang,$unit,$sub,$upb,$like){$kb 	=  $this->session->userdata('kd_bidang'); $ku 	=  $this->session->userdata('kd_unit'); $ks 	=  $this->session->userdata('kd_sub_unit'); $kupb 	=  $this->session->userdata('kd_upb'); if ($this->session->userdata('lvl') == 01){$where = "WHERE (Ta_KIB_F.Kd_Bidang = $bidang) AND (Ta_KIB_F.Kd_Unit = $unit) AND (Ta_KIB_F.Kd_Sub = $sub) AND (Ta_KIB_F.Kd_UPB = $upb) AND $like"; }elseif ($this->session->userdata('lvl') == 02){$where = "WHERE (Ta_KIB_F.Kd_Bidang = $kb ) AND (Ta_KIB_F.Kd_Unit =$ku ) AND (Ta_KIB_F.Kd_Sub = $ks) AND (Ta_KIB_F.Kd_UPB = $upb) AND $like"; }else{$where = "WHERE (Ta_KIB_F.Kd_Bidang = $kb) AND (Ta_KIB_F.Kd_Unit = $ku) AND (Ta_KIB_F.Kd_Sub = $ks) AND (Ta_KIB_F.Kd_UPB = $kupb) AND $like"; } $query = "SELECT COUNT(*) as Jumlah,SUM(Harga) as Harga FROM Ta_KIB_F $where"; return $this->db->query($query); } /* 13-05-2015 */ function rekap_neraca($bidang='',$unit='',$sub='',$upb='',$tahunawal,$tahunakhir,$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $thn   =  $this->session->userdata('tahun_anggaran'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; $where .= "AND (a.Kd_UPB = $kupb)"; } $tgl_pembukuan = " AND Tgl_Pembukuan ".$like; $tgl_dokumen   = " AND Tgl_Dokumen <= '".$tahunakhir."'"; $query = "SELECT SUM(LastHarga) as NB_Akhir FROM Ref_Rek_Aset2 a LEFT JOIN (SELECT *, ((Harga + ISNULL(Total_Koreksi, 0) ) - ISNULL(Koreksi_Kurang, 0) ) as HargaKoreksi, ((Harga + ISNULL(Koreksi_Tambah, 0) ) - ISNULL(Koreksi_Kurang, 0) ) as LastHarga FROM  (SELECT a1.*, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBFR a2 WHERE a2.Kd_Riwayat = 21 AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Total_Koreksi, (SELECT SUM(Harga) as Rharga FROM Ta_KIBFR a2 WHERE a2.Kd_Riwayat = 2 AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Kapitalisasi, (SELECT SUM(Harga) as Rharga FROM Ta_KIBFR a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBFR a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_KIB_F a1 WHERE NOT EXISTS (SELECT 1 FROM Ta_KIBFR e WHERE a1.Kd_Bidang=e.Kd_Bidang AND a1.Kd_Unit=e.Kd_Unit AND a1.Kd_Sub=e.Kd_Sub AND a1.Kd_UPB=e.Kd_UPB AND a1.Kd_Aset1=e.Kd_Aset1 AND a1.Kd_Aset2=e.Kd_Aset2 AND a1.Kd_Aset3=e.Kd_Aset3 AND a1.Kd_Aset4=e.Kd_Aset4 AND a1.Kd_Aset5=e.Kd_Aset5 AND a1.No_Register=e.No_Register AND Kd_Riwayat IN (3,19) AND e.Tgl_Dokumen <= '{$tahunakhir}') )as a WHERE 1=1 $where $tgl_pembukuan ) as a3 ON a3.Kd_Aset1=a.Kd_Aset1 AND a3.Kd_Aset2=a.Kd_Aset2"; return $this->db->query($query); } function rincian_neraca($bidang='',$unit='',$sub='',$upb='',$tahunawal,$tahunakhir,$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $thn   =  $this->session->userdata('tahun_anggaran'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; $where .= "AND (a.Kd_UPB = $kupb)"; } $tgl_pembukuan = " AND Tgl_Pembukuan ".$like; $query = "SELECT a.Kd_Bidang,a.Kd_Unit,a.Kd_Sub,a.Kd_UPB, a.Kd_Aset1,a.Kd_Aset2,a.Kd_Aset3,a.Kd_Aset4,a.Kd_Aset5, d2.Nm_Aset2,d3.Nm_Aset3,d4.Nm_Aset4,n.Nm_Aset5, SUM(Harga) as Harga FROM Ta_KIB_F a INNER JOIN Ref_Rek_Aset5 n ON a.Kd_Aset1 = n.Kd_Aset1 AND a.Kd_Aset2 = n.Kd_Aset2 AND a.Kd_Aset3 = n.Kd_Aset3 AND a.Kd_Aset4 = n.Kd_Aset4 AND a.Kd_Aset5 = n.Kd_Aset5 LEFT JOIN Ref_Rek_Aset4 d4 ON a.Kd_Aset1=d4.Kd_Aset1 AND a.Kd_Aset2=d4.Kd_Aset2 AND a.Kd_Aset3=d4.Kd_Aset3 AND a.Kd_Aset4=d4.Kd_Aset4 LEFT JOIN Ref_Rek_Aset3 d3 ON a.Kd_Aset1=d3.Kd_Aset1 AND a.Kd_Aset2=d3.Kd_Aset2 AND a.Kd_Aset3=d3.Kd_Aset3 LEFT JOIN Ref_Rek_Aset2 d2 ON a.Kd_Aset1=d2.Kd_Aset1 AND a.Kd_Aset2=d2.Kd_Aset2 WHERE 1=1 $where $tgl_pembukuan AND NOT EXISTS (SELECT 1 FROM Ta_KIB_C d  WHERE a.ID_KDP=d.ID_KDP AND YEAR(d.Tgl_Pembukuan) <= '{$thn}') GROUP BY a.Kd_Bidang,a.Kd_Unit,a.Kd_Sub,a.Kd_UPB, a.Kd_Aset1,a.Kd_Aset2,a.Kd_Aset3,a.Kd_Aset4,a.Kd_Aset5, d2.Nm_Aset2,d3.Nm_Aset3,d4.Nm_Aset4,n.Nm_Aset5"; return $this->db->query($query); } /** * Menampilkan semua data kib f rekap */ function rekap_inventaris($bidang='',$unit='',$sub='',$upb='',$tahunawal,$tahunakhir,$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $thn   =  $this->session->userdata('tahun_anggaran'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; $where .= "AND (a.Kd_UPB = $kupb)"; } $tgl_pembukuan 	= " AND Tgl_Pembukuan ".$like; $tgl_dokumen 	= " AND Tgl_Dokumen <= ".$tahunakhir; $query = "SELECT n.Kd_Aset1,n.Kd_Aset2,Nm_Aset2,COUNT(Harga) as Jumlah, SUM(LastHarga) as Harga FROM Ref_Rek_Aset2 n LEFT JOIN (SELECT * FROM (SELECT *,((Harga + ISNULL(Koreksi_Tambah, 0) ) - ISNULL(Koreksi_Kurang, 0) ) as LastHarga FROM (SELECT n.Nm_Aset5, a1.*, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBFR a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBFR a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_KIB_F a1 INNER JOIN Ref_Rek_Aset5 n ON a1.Kd_Aset1 = n.Kd_Aset1 AND a1.Kd_Aset2 = n.Kd_Aset2 AND a1.Kd_Aset3 = n.Kd_Aset3 AND a1.Kd_Aset4 = n.Kd_Aset4 AND a1.Kd_Aset5 = n.Kd_Aset5 WHERE NOT EXISTS (SELECT 1 FROM  Ta_KIBFR e WHERE a1.Kd_Bidang=e.Kd_Bidang AND a1.Kd_Unit=e.Kd_Unit AND a1.Kd_Sub=e.Kd_Sub AND a1.Kd_UPB=e.Kd_UPB AND a1.Kd_Aset1=e.Kd_Aset1 AND a1.Kd_Aset2=e.Kd_Aset2 AND a1.Kd_Aset3=e.Kd_Aset3 AND a1.Kd_Aset4=e.Kd_Aset4 AND a1.Kd_Aset5=e.Kd_Aset5 AND a1.No_Register=e.No_Register AND Kd_Riwayat=19 AND e.Tgl_Dokumen < '{$tahunakhir}') ) as x ) as a WHERE 1=1 $where $tgl_pembukuan ) as a1 ON a1.Kd_Aset1=n.Kd_Aset1 AND a1.Kd_Aset2=n.Kd_Aset2 WHERE n.Kd_Aset1 IN (3,4) GROUP BY n.Kd_Aset1,n.Kd_Aset2,Nm_Aset2"; return $this->db->query($query); } /** * Menampilkan semua data kib b */ function bi($bidang='',$unit='',$sub='',$upb='',$tahunawal,$tahunakhir,$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $thn   =  $this->session->userdata('tahun_anggaran'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; $where .= "AND (a.Kd_UPB = $kupb)"; } $tgl_pembukuan 	= " AND Tgl_Pembukuan ".$like; $tgl_dokumen 	= " AND Tgl_Dokumen <= '".$tahunakhir."'"; $query = "SELECT a.Nm_Aset5,COUNT(a.No_register) as jumlah_register, MIN(a.No_register) as min_register, MAX(a.No_register) as max_register, a.Kd_Prov, a.Kd_Kab_Kota, a.Kd_Bidang, a.Kd_Unit, a.Kd_Sub, a.Kd_UPB, a.Kd_Aset1, a.Kd_Aset2, a.Kd_Aset3, a.Kd_Aset4, a.Kd_Aset5, a.Kd_Pemilik,a.Kondisi,a.Tgl_Perolehan, a.Bertingkat_Tidak,a.Beton_tidak,a.Panjang,a.Lebar,a.Luas_Lantai,a.Lokasi,a.Dokumen_Tanggal, a.Dokumen_Nomor,a.Status_Tanah,a.Asal_usul,COUNT(*) as Jumlah, SUM(LastHarga) as  Harga, a.Keterangan FROM (SELECT *,((Harga + ISNULL(Koreksi_Tambah, 0) ) - ISNULL(Koreksi_Kurang, 0) ) as LastHarga FROM (SELECT n.Nm_Aset5, a1.*, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBFR a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBFR a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_KIB_F a1 INNER JOIN Ref_Rek_Aset5 n ON a1.Kd_Aset1 = n.Kd_Aset1 AND a1.Kd_Aset2 = n.Kd_Aset2 AND a1.Kd_Aset3 = n.Kd_Aset3 AND a1.Kd_Aset4 = n.Kd_Aset4 AND a1.Kd_Aset5 = n.Kd_Aset5 WHERE NOT EXISTS (SELECT 1 FROM   Ta_KIBFR e WHERE a1.Kd_Bidang=e.Kd_Bidang AND a1.Kd_Unit=e.Kd_Unit AND a1.Kd_Sub=e.Kd_Sub AND a1.Kd_UPB=e.Kd_UPB AND a1.Kd_Aset1=e.Kd_Aset1 AND a1.Kd_Aset2=e.Kd_Aset2 AND a1.Kd_Aset3=e.Kd_Aset3 AND a1.Kd_Aset4=e.Kd_Aset4 AND a1.Kd_Aset5=e.Kd_Aset5 AND a1.No_Register=e.No_Register  AND Kd_Riwayat=19 AND YEAR(e.Tgl_Dokumen) <= '{$thn}') ) as x ) as a WHERE 1=1 $where $tgl_pembukuan GROUP BY a.Kd_Prov, a.Kd_Kab_Kota, a.Kd_Bidang, a.Kd_Unit, a.Kd_Sub, a.Kd_UPB, a.Kd_Aset1, a.Kd_Aset2, a.Kd_Aset3, a.Kd_Aset4, a.Kd_Aset5, a.Kd_Pemilik, a.Kd_Pemilik,a.Kondisi,a.Tgl_Perolehan, a.Bertingkat_Tidak,a.Beton_tidak,a.Panjang,a.Lebar,a.Luas_Lantai,a.Lokasi,a.Dokumen_Tanggal, a.Dokumen_Nomor,a.Status_Tanah,a.Asal_usul,a.Keterangan,a.Nm_Aset5 ORDER BY  a.Nm_Aset5, MIN(a.No_register)"; return $this->db->query($query); } function get_riwayat_barang($kd_prov,$kd_kab,$kd_bidang,$kd_unit,$kd_sub,$kd_upb, $kd_aset1,$kd_aset2,$kd_aset3,$kd_aset4,$kd_aset5,$no_register){$where = ""; $where .= " AND Ta_KIBFR.Kd_Prov=".$kd_prov; $where .= " AND Ta_KIBFR.Kd_Kab_Kota=".$kd_kab; $where .= " AND Ta_KIBFR.Kd_Bidang=".$kd_bidang; $where .= " AND Ta_KIBFR.Kd_Unit=".$kd_unit; $where .= " AND Ta_KIBFR.Kd_Sub=".$kd_sub; $where .= " AND Ta_KIBFR.Kd_UPB=".$kd_upb; $where .= " AND Ta_KIBFR.Kd_Aset1=".$kd_aset1; $where .= " AND Ta_KIBFR.Kd_Aset2=".$kd_aset2; $where .= " AND Ta_KIBFR.Kd_Aset3=".$kd_aset3; $where .= " AND Ta_KIBFR.Kd_Aset4=".$kd_aset4; $where .= " AND Ta_KIBFR.Kd_Aset5=".$kd_aset5; $where .= " AND Ta_KIBFR.No_register=".$no_register; $sql = "SELECT  * FROM  (SELECT  Ref_Rek_Aset5.Nm_Aset5, Ref_Riwayat.Nm_Riwayat,Ta_KIBFR.*, ROW_NUMBER() OVER (ORDER BY Ta_KIBFR.Log_entry DESC) AS halaman		FROM  Ta_KIBFR INNER JOIN Ref_Rek_Aset5 ON Ta_KIBFR.Kd_Aset1=Ref_Rek_Aset5.Kd_Aset1 AND Ta_KIBFR.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_KIBFR.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_KIBFR.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_KIBFR.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 LEFT JOIN Ref_Riwayat ON Ta_KIBFR.Kd_Riwayat=Ref_Riwayat.Kd_Riwayat WHERE 1=1 $where) AS Ta_KIBFR"; return $this->db->query($sql); } function rincian_barang($bidang='',$unit='',$sub='',$upb='',$tahunawal,$tahunakhir,$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $thn   =  $this->session->userdata('tahun_anggaran'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; $where .= "AND (a.Kd_UPB = $kupb)"; } $tgl_pembukuan = " AND Tgl_Pembukuan ".$like; $query = "SELECT a.Kd_Bidang,a.Kd_Unit,a.Kd_Sub,a.Kd_UPB, a.Kd_Aset1,a.Kd_Aset2,a.Kd_Aset3,a.Kd_Aset4,a.Kd_Aset5, d2.Nm_Aset2,d3.Nm_Aset3,d4.Nm_Aset4,n.Nm_Aset5, '-' as B, '-' as KB, '-' as RB, COUNT(*) as Jumlah, SUM(Harga) as Harga FROM Ta_KIB_F a INNER JOIN Ref_Rek_Aset5 n ON a.Kd_Aset1 = n.Kd_Aset1 AND a.Kd_Aset2 = n.Kd_Aset2 AND a.Kd_Aset3 = n.Kd_Aset3 AND a.Kd_Aset4 = n.Kd_Aset4 AND a.Kd_Aset5 = n.Kd_Aset5 LEFT JOIN Ref_Rek_Aset4 d4 ON a.Kd_Aset1=d4.Kd_Aset1 AND a.Kd_Aset2=d4.Kd_Aset2 AND a.Kd_Aset3=d4.Kd_Aset3 AND a.Kd_Aset4=d4.Kd_Aset4 LEFT JOIN Ref_Rek_Aset3 d3 ON a.Kd_Aset1=d3.Kd_Aset1 AND a.Kd_Aset2=d3.Kd_Aset2 AND a.Kd_Aset3=d3.Kd_Aset3 LEFT JOIN Ref_Rek_Aset2 d2 ON a.Kd_Aset1=d2.Kd_Aset1 AND a.Kd_Aset2=d2.Kd_Aset2 WHERE 1=1 $where $tgl_pembukuan AND NOT EXISTS (SELECT 1 FROM Ta_KIB_C d  WHERE a.ID_KDP=d.ID_KDP AND YEAR(d.Tgl_Pembukuan) <= '{$thn}') GROUP BY a.Kd_Bidang,a.Kd_Unit,a.Kd_Sub,a.Kd_UPB, a.Kd_Aset1,a.Kd_Aset2,a.Kd_Aset3,a.Kd_Aset4,a.Kd_Aset5, d2.Nm_Aset2,d3.Nm_Aset3,d4.Nm_Aset4,n.Nm_Aset5"; return $this->db->query($query); } function rincian_susut($bidang='',$unit='',$sub='',$upb='',$tahunawal,$tahunakhir,$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $thn   =  $this->session->userdata('tahun_anggaran'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; $where .= "AND (a.Kd_UPB = $kupb)"; } $tgl_pembukuan = " AND Tgl_Pembukuan ".$like; $query = "SELECT a.Kd_Bidang,a.Kd_Unit,a.Kd_Sub,a.Kd_UPB, a.Kd_Aset1,a.Kd_Aset2,a.Kd_Aset3,a.Kd_Aset4,a.Kd_Aset5, d2.Nm_Aset2,d3.Nm_Aset3,d4.Nm_Aset4,n.Nm_Aset5, SUM(Harga) as NB_Awal, 0 as Susut, 0 as Akm_Susut, SUM(Harga) as NB_Akhir FROM Ta_KIB_F a INNER JOIN Ref_Rek_Aset5 n ON a.Kd_Aset1 = n.Kd_Aset1 AND a.Kd_Aset2 = n.Kd_Aset2 AND a.Kd_Aset3 = n.Kd_Aset3 AND a.Kd_Aset4 = n.Kd_Aset4 AND a.Kd_Aset5 = n.Kd_Aset5 LEFT JOIN Ref_Rek_Aset4 d4 ON a.Kd_Aset1=d4.Kd_Aset1 AND a.Kd_Aset2=d4.Kd_Aset2 AND a.Kd_Aset3=d4.Kd_Aset3 AND a.Kd_Aset4=d4.Kd_Aset4 LEFT JOIN Ref_Rek_Aset3 d3 ON a.Kd_Aset1=d3.Kd_Aset1 AND a.Kd_Aset2=d3.Kd_Aset2 AND a.Kd_Aset3=d3.Kd_Aset3 LEFT JOIN Ref_Rek_Aset2 d2 ON a.Kd_Aset1=d2.Kd_Aset1 AND a.Kd_Aset2=d2.Kd_Aset2 WHERE 1=1 $where $tgl_pembukuan AND NOT EXISTS (SELECT 1 FROM Ta_KIB_C d  WHERE a.ID_KDP=d.ID_KDP AND YEAR(d.Tgl_Pembukuan) <= '{$thn}') GROUP BY a.Kd_Bidang,a.Kd_Unit,a.Kd_Sub,a.Kd_UPB, a.Kd_Aset1,a.Kd_Aset2,a.Kd_Aset3,a.Kd_Aset4,a.Kd_Aset5, d2.Nm_Aset2,d3.Nm_Aset3,d4.Nm_Aset4,n.Nm_Aset5"; return $this->db->query($query); } } /* End of file Contoh_model.php */ /* Location: ./system/application/models/Contoh_model.php */