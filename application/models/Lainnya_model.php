<?php /** * Contoh_model Class */ class Lainnya_model extends CI_Model {/** * Constructor */ function __construct(){parent::__construct(); } /* Inisialisasi nama tabel yang digunakan */ var $table       = 'Ta_Lainnya'; var $neraca_awal = NERACA_AWAL; function getInfoKIB($kd_prov,$kd_kab,$kd_bidang,$kd_unit,$kd_sub,$kd_upb,$kd_aset1,$kd_aset2,$kd_aset3,$kd_aset4,$kd_aset5,$no_register){$query = $this->db->get_where($this->table, array('Kd_Prov' => $kd_prov,'Kd_Kab_Kota' => $kd_kab,'Kd_Bidang' => $kd_bidang,'Kd_Unit' => $kd_unit, 'Kd_Sub' => $kd_sub,'Kd_UPB' => $kd_upb,'Kd_Aset1' => $kd_aset1,'Kd_Aset2' => $kd_aset2,'Kd_Aset3' => $kd_aset3, 'Kd_Aset4' => $kd_aset4,'Kd_Aset5' => $kd_aset5,'No_Register' => $no_register), 1)->row(); return $query; } function get_page($limit, $offset, $where, $like){if($offset == 0  or !isset($offset)){$first = 1; $last  = $limit; }else{$first = $offset+1; $last  = $first + ($limit -1); } $sql ="SELECT  * FROM  (SELECT     Ref_UPB.Nm_UPB,a.*,Ref_Rek_Aset5.Nm_Aset5, (SELECT TOP 1 Status FROM Ta_KILHapus h WHERE	a.Kd_Prov = h.Kd_Prov AND a.Kd_Kab_Kota = h.Kd_Kab_Kota AND a.Kd_Bidang = h.Kd_Bidang AND a.Kd_Unit = h.Kd_Unit AND a.Kd_Sub = h.Kd_Sub AND a.Kd_UPB = h.Kd_UPB AND a.Kd_Aset1 = h.Kd_Aset1 AND a.Kd_Aset2 = h.Kd_Aset2 AND a.Kd_Aset3 = h.Kd_Aset3 AND a.Kd_Aset4 = h.Kd_Aset4 AND a.Kd_Aset5 = h.Kd_Aset5 AND a.No_Register = h.No_Register ORDER BY Tgl_UP DESC ) AS Penghapusan, ROW_NUMBER() OVER (ORDER BY a.Log_entry DESC) AS no_urut		FROM  Ta_Lainnya a INNER JOIN Ref_Rek_Aset5 ON a.Kd_Aset1=Ref_Rek_Aset5.Kd_Aset1 AND a.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND a.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND a.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND a.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 LEFT JOIN Ref_UPB ON a.Kd_Bidang=Ref_UPB.Kd_Bidang AND a.Kd_Unit=Ref_UPB.Kd_Unit AND a.Kd_Sub=Ref_UPB.Kd_Sub AND a.Kd_UPB=Ref_UPB.Kd_UPB WHERE $where $like ) AS a WHERE no_urut BETWEEN $first AND $last  ORDER BY no_urut ASC"; return $this->db->query($sql); } /* count kib b total page */ function count_kib($where, $like) {$sql = "SELECT COUNT(*) as Jumlah, SUM(Harga) as Total FROM Ta_Lainnya a INNER JOIN Ref_Rek_Aset5 ON a.Kd_Aset1=Ref_Rek_Aset5.Kd_Aset1 AND a.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND a.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND a.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND a.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 WHERE 1=1 "; $sql .= "AND $where "; $sql .= "$like "; $sql .= "AND a.Kd_Aset1 = '7'"; return  $this->db->query($sql)->row(); } /** * Tampilkan total harga kib b */ function total_kib($where, $like) {$query= "SELECT   SUM(Harga) AS Harga FROM  Ta_Lainnya INNER JOIN Ref_Rek_Aset5 ON Ta_Lainnya.Kd_Aset1=Ref_Rek_Aset5.Kd_Aset1 AND Ta_Lainnya.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_Lainnya.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_Lainnya.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_Lainnya.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5  WHERE $where $like AND Ta_Lainnya.Kd_Aset1 = '7'"; $sql = $this->db->query($query); foreach ($sql->result() as $row) {$result = $row->Harga; } return $result; } /** * Menampilkan data laporan kibb */ function laporan_kibb($bidang,$unit,$sub,$upb,$like) {$kb 	=  $this->session->userdata('kd_bidang'); $ku 	=  $this->session->userdata('kd_unit'); $ks 	=  $this->session->userdata('kd_sub_unit'); $kupb 	=  $this->session->userdata('kd_upb'); if ($this->session->userdata('lvl') == 01){$where = "(Ta_Lainnya.Kd_Bidang = $bidang) AND (Ta_Lainnya.Kd_Unit = $unit) AND (Ta_Lainnya.Kd_Sub = $sub) AND (Ta_Lainnya.Kd_UPB = $upb) AND"; }elseif ($this->session->userdata('lvl') == 02){$where = "(Ta_Lainnya.Kd_Bidang = $kb ) AND (Ta_Lainnya.Kd_Unit =$ku ) AND (Ta_Lainnya.Kd_Sub = $ks) AND (Ta_Lainnya.Kd_UPB = $upb) AND"; }else{$where = "(Ta_Lainnya.Kd_Bidang = $kb) AND (Ta_Lainnya.Kd_Unit = $ku) AND (Ta_Lainnya.Kd_Sub = $ks) AND (Ta_Lainnya.Kd_UPB = $kupb) AND"; } $query = "SELECT  Ref_Rek_Aset5.Nm_Aset5,COUNT(Ta_Lainnya.No_register) as jumlah_register,MIN(Ta_Lainnya.No_register) as min_register, MAX(Ta_Lainnya.No_register) as max_register, Ta_Lainnya.Kd_Prov, Ta_Lainnya.Kd_Kab_Kota, Ta_Lainnya.Kd_Bidang, Ta_Lainnya.Kd_Unit, Ta_Lainnya.Kd_Sub, Ta_Lainnya.Kd_UPB, Ta_Lainnya.Kd_Aset1, Ta_Lainnya.Kd_Aset2, Ta_Lainnya.Kd_Aset3, Ta_Lainnya.Kd_Aset4, Ta_Lainnya.Kd_Aset5, Ta_Lainnya.Kd_Pemilik, Ta_Lainnya.Merk, Ta_Lainnya.Type, Ta_Lainnya.CC, Ta_Lainnya.Bahan, DATENAME(yyyy,Ta_Lainnya.Tgl_Perolehan) as Tahun,Ta_Lainnya.Nomor_Pabrik,Ta_Lainnya.Nomor_Rangka,Ta_Lainnya.Nomor_Mesin, Ta_Lainnya.Nomor_Polisi,Ta_Lainnya.Nomor_BPKB,Ta_Lainnya.Asal_usul,COUNT(*) as Jumlah, SUM(Ta_Lainnya.Harga) as Harga,Ta_Lainnya.Keterangan FROM  Ta_Lainnya INNER JOIN Ref_Rek_Aset5 ON Ta_Lainnya.Kd_Aset1 = Ref_Rek_Aset5.Kd_Aset1 AND Ta_Lainnya.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_Lainnya.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_Lainnya.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_Lainnya.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 WHERE  $where $like GROUP BY Ta_Lainnya.Kd_Prov, Ta_Lainnya.Kd_Kab_Kota, Ta_Lainnya.Kd_Bidang, Ta_Lainnya.Kd_Unit, Ta_Lainnya.Kd_Sub, Ta_Lainnya.Kd_UPB, Ta_Lainnya.Kd_Aset1, Ta_Lainnya.Kd_Aset2, Ta_Lainnya.Kd_Aset3, Ta_Lainnya.Kd_Aset4, Ta_Lainnya.Kd_Aset5, Ta_Lainnya.Kd_Pemilik, Ta_Lainnya.Merk, Ta_Lainnya.Type, Ta_Lainnya.CC, Ta_Lainnya.Bahan, Ta_Lainnya.Tgl_Perolehan,Ta_Lainnya.Nomor_Pabrik,Ta_Lainnya.Nomor_Rangka,Ta_Lainnya.Nomor_Mesin,Ta_Lainnya.Nomor_Polisi, Ta_Lainnya.Nomor_BPKB,Ta_Lainnya.Asal_usul,Ta_Lainnya.Keterangan,Ref_Rek_Aset5.Nm_Aset5 ORDER BY  Ref_Rek_Aset5.Nm_Aset5, MIN(Ta_Lainnya.No_register)"; return $this->db->query($query); } /** * Tampilkan total harga laporan kibb */ function total_laporan_kibb($bidang,$unit,$sub,$upb,$like) {if ($this->session->userdata('lvl') == 01){$this->db->where('Kd_Bidang',$bidang); $this->db->where('Kd_Unit',$unit); $this->db->where('Kd_Sub',$sub); $this->db->where('Kd_UPB',$upb); }elseif ($this->session->userdata('lvl') == 02){$this->db->where('Kd_Bidang',$this->session->userdata('kd_bidang')); $this->db->where('Kd_Unit',$this->session->userdata('kd_unit')); $this->db->where('Kd_Sub',$this->session->userdata('kd_sub_unit')); $this->db->where('Kd_UPB',$upb); }else{$this->db->where('Kd_Bidang',$this->session->userdata('kd_bidang')); $this->db->where('Kd_Unit',$this->session->userdata('kd_unit')); $this->db->where('Kd_Sub',$this->session->userdata('kd_sub_unit')); $this->db->where('Kd_UPB',$this->session->userdata('kd_upb')); } $this->db->select_SUM('Harga'); $this->db->where("$like"); $this->db->from($this->table); $sql = $this->db->get(); foreach ($sql->result() as $row) {$result = $row->Harga; } return $result; } /** * Proses rekap cetak data kir */ function laporan_kir($bidang,$unit,$sub,$upb,$ruang,$like) {$kb 	=  $this->session->userdata('kd_bidang'); $ku 	=  $this->session->userdata('kd_unit'); $ks 	=  $this->session->userdata('kd_sub_unit'); $kupb 	=  $this->session->userdata('kd_upb'); if ($this->session->userdata('lvl') == 01){$where = "(Kd_Bidang = $bidang) AND (Kd_Unit = $unit) AND (Kd_Sub = $sub) AND (Kd_UPB = $upb) AND"; }elseif ($this->session->userdata('lvl') == 02){$where = "(Kd_Bidang = $kb ) AND (Kd_Unit =$ku ) AND (Kd_Sub = $ks) AND (Kd_UPB = $upb) AND"; }else{$where = "(Kd_Bidang = $kb) AND (Kd_Unit = $ku) AND (Kd_Sub = $ks) AND (Kd_UPB = $kupb) AND"; } $sql = "SELECT  Ref_Rek_Aset5.Nm_Aset5,Ta_Lainnya.Kd_Prov, Ta_Lainnya.Kd_Kab_Kota, Ta_Lainnya.Kd_Bidang, Ta_Lainnya.Kd_Unit, Ta_Lainnya.Kd_Sub, Ta_Lainnya.Kd_UPB, Ta_Lainnya.Kd_Aset1, Ta_Lainnya.Kd_Aset2, Ta_Lainnya.Kd_Aset3, Ta_Lainnya.Kd_Aset4, Ta_Lainnya.Kd_Aset5, Ta_Lainnya.Kd_Pemilik, Ta_Lainnya.Merk, Ta_Lainnya.Type, Ta_Lainnya.CC, Ta_Lainnya.Bahan, Ta_Lainnya.Nomor_Pabrik,SUM(Ta_Lainnya.Harga) as Harga, Ta_Lainnya.Masa_Manfaat,Ta_Lainnya.Keterangan,DATENAME(yyyy,Ta_Lainnya.Tgl_Perolehan) as Tahun, count(case when Kondisi = 1 then 1 else null end) as Baik, count(case when Kondisi = 2 then 1 else null end) as Kurang_baik, count(case when Kondisi = 3 then 1 else null end) as Rusak, COUNT(Kondisi) as Jumlah_Data,MIN(Ta_Lainnya.No_register) as min_register, MAX(Ta_Lainnya.No_register) as max_register FROM  Ta_Lainnya INNER JOIN Ref_Rek_Aset5 ON Ta_Lainnya.Kd_Aset1 = Ref_Rek_Aset5.Kd_Aset1 AND Ta_Lainnya.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_Lainnya.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_Lainnya.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_Lainnya.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 WHERE   $where Kd_Ruang=$ruang $like GROUP BY Ta_Lainnya.Kd_Prov, Ta_Lainnya.Kd_Kab_Kota, Ta_Lainnya.Kd_Bidang, Ta_Lainnya.Kd_Unit, Ta_Lainnya.Kd_Sub, Ta_Lainnya.Kd_UPB, Ta_Lainnya.Kd_Aset1, Ta_Lainnya.Kd_Aset2, Ta_Lainnya.Kd_Aset3, Ta_Lainnya.Kd_Aset4, Ta_Lainnya.Kd_Aset5, Ta_Lainnya.Kd_Pemilik, Ta_Lainnya.Merk, Ta_Lainnya.Type, Ta_Lainnya.CC, Ta_Lainnya.Bahan, Ta_Lainnya.Nomor_Pabrik, Ta_Lainnya.Masa_Manfaat,Ta_Lainnya.Keterangan,Ref_Rek_Aset5.Nm_Aset5,Ta_Lainnya.Tgl_Perolehan UNION ALL SELECT  Ref_Rek_Aset5.Nm_Aset5,Ta_Lainnya.Kd_Prov, Ta_Lainnya.Kd_Kab_Kota, Ta_Lainnya.Kd_Bidang, Ta_Lainnya.Kd_Unit, Ta_Lainnya.Kd_Sub, Ta_Lainnya.Kd_UPB, Ta_Lainnya.Kd_Aset1, Ta_Lainnya.Kd_Aset2, Ta_Lainnya.Kd_Aset3, Ta_Lainnya.Kd_Aset4, Ta_Lainnya.Kd_Aset5, Ta_Lainnya.Kd_Pemilik, '' as Merk, '' as Type, '' as CC, Ta_Lainnya.Bahan, '' as Nomor_Pabrik,SUM(Ta_Lainnya.Harga) as Harga, Ta_Lainnya.Masa_Manfaat,Ta_Lainnya.Keterangan,DATENAME(yyyy,Ta_Lainnya.Tgl_Perolehan) as Tahun, count(case when Kondisi = 1 then 1 else null end) as Baik, count(case when Kondisi = 2 then 1 else null end) as Kurang_baik, count(case when Kondisi = 3 then 1 else null end) as Rusak, COUNT(Kondisi) as Jumlah_Data,MIN(Ta_Lainnya.No_register) as min_register, MAX(Ta_Lainnya.No_register) as max_register FROM  Ta_Lainnya INNER JOIN Ref_Rek_Aset5 ON Ta_Lainnya.Kd_Aset1 = Ref_Rek_Aset5.Kd_Aset1 AND Ta_Lainnya.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_Lainnya.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_Lainnya.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_Lainnya.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 WHERE   $where Kd_Ruang=$ruang $like GROUP BY Ta_Lainnya.Kd_Prov, Ta_Lainnya.Kd_Kab_Kota, Ta_Lainnya.Kd_Bidang, Ta_Lainnya.Kd_Unit, Ta_Lainnya.Kd_Sub, Ta_Lainnya.Kd_UPB, Ta_Lainnya.Kd_Aset1, Ta_Lainnya.Kd_Aset2, Ta_Lainnya.Kd_Aset3, Ta_Lainnya.Kd_Aset4, Ta_Lainnya.Kd_Aset5, Ta_Lainnya.Kd_Pemilik, Ta_Lainnya.Bahan, Ta_Lainnya.Masa_Manfaat,Ta_Lainnya.Keterangan,Ref_Rek_Aset5.Nm_Aset5,Ta_Lainnya.Tgl_Perolehan"; return $this->db->query($sql); } /** * Tampilkan total harga kir */ function total_laporan_kir($bidang,$unit,$sub,$upb,$ruang,$like){$kb 	=  $this->session->userdata('kd_bidang'); $ku 	=  $this->session->userdata('kd_unit'); $ks 	=  $this->session->userdata('kd_sub_unit'); $kupb 	=  $this->session->userdata('kd_upb'); if ($this->session->userdata('lvl') == 01){$where = "(Kd_Bidang = $bidang) AND (Kd_Unit = $unit) AND (Kd_Sub = $sub) AND (Kd_UPB = $upb) AND"; }elseif ($this->session->userdata('lvl') == 02){$where = "(Kd_Bidang = $kb ) AND (Kd_Unit =$ku ) AND (Kd_Sub = $ks) AND (Kd_UPB = $upb) AND"; }else{$where = "(Kd_Bidang = $kb) AND (Kd_Unit = $ku) AND (Kd_Sub = $ks) AND (Kd_UPB = $kupb) AND"; } $sql = "select SUM(Jlh) as Jumlah, SUM(Harga) as Harga  from (select COUNT(*) as Jlh, SUM(Harga) as Harga from Ta_Lainnya WHERE $where Kd_Ruang=$ruang $like UNION ALL select COUNT(*) as Jlh, SUM(Harga) as Harga from Ta_Lainnya WHERE $where Kd_Ruang=$ruang $like) as counts"; return $this->db->query($sql); } /** * Menampilkan data kib L Mutasi */ function mutasi($bidang,$unit,$sub,$upb,$tahunawal,$tahunakhir,$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $thn   =  $this->session->userdata('tahun_anggaran'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){$where .= "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{$where .= "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; $where .= "AND (a.Kd_UPB = $kupb)"; } $tgl_pembukuan 	= " AND Tgl_Pembukuan ".$like; $tgl_dokumen 	= " AND Tgl_Dokumen <= ".$tahunakhir; $query = "SELECT n.Nm_Aset5, COUNT(a.No_register) as jumlah_register,MIN(a.No_register) as min_register, MAX(a.No_register) as max_register, a.Kd_Prov, a.Kd_Kab_Kota, a.Kd_Bidang, a.Kd_Unit, a.Kd_Sub, a.Kd_UPB, a.Kd_Aset1, a.Kd_Aset2, a.Kd_Aset3, a.Kd_Aset4, a.Kd_Aset5, a.Kd_Pemilik,DATENAME(yyyy,a.Tgl_Perolehan) as Tahun, COUNT (CASE WHEN a.Kd_Riwayat IN (3, 7, 23) THEN a.Harga END ) AS Jumlah_Kurang, COUNT (CASE WHEN Kd_Riwayat is null OR Kd_Riwayat IN (2, 21) THEN a.Harga END ) AS Jumlah_Tambah, SUM (CASE WHEN a.Kd_Riwayat IN (3, 7, 23) THEN a.Harga END ) AS Mutasi_Kurang, SUM (CASE WHEN Kd_Riwayat is null OR Kd_Riwayat IN (2, 21) THEN a.Harga END ) AS Mutasi_Tambah, a.Keterangan FROM (SELECT null as Kd_Riwayat, Kd_Prov, Kd_Kab_Kota, Kd_Bidang, Kd_Unit, Kd_Sub, Kd_UPB, Kd_Aset1, Kd_Aset2, Kd_Aset3, Kd_Aset4,Kd_Aset5, No_Register, Kd_Pemilik,Tgl_Perolehan,Tgl_Pembukuan, Asal_usul,Kondisi,Harga,Keterangan FROM Ta_Lainnya UNION ALL SELECT Kd_Riwayat, Kd_Prov, Kd_Kab_Kota, Kd_Bidang, Kd_Unit, Kd_Sub, Kd_UPB, Kd_Aset1, Kd_Aset2, Kd_Aset3, Kd_Aset4, Kd_Aset5, No_Register,Kd_Pemilik,Tgl_Perolehan,Tgl_Dokumen as Tgl_Pembukuan, Asal_usul,Kondisi,Harga,Keterangan FROM Ta_KILER WHERE Kd_Riwayat IN (2,7,21,23) UNION ALL SELECT 3 as Kd_Riwayat,Kd_Prov, Kd_Kab_Kota, Kd_Bidang, Kd_Unit, Kd_Sub, Kd_UPB, Kd_Aset1, Kd_Aset2, Kd_Aset3, Kd_Aset4,Kd_Aset5, No_Register, Kd_Pemilik,Tgl_Perolehan,Tgl_Pembukuan, Asal_usul,Kondisi, ((Harga + ISNULL(Koreksi_Tambah, 0)) - ISNULL(Koreksi_Kurang, 0) ) as Harga, Keterangan FROM (SELECT a1.*, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KILER a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KILER a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_Lainnya a1 WHERE 1=1 AND EXISTS (SELECT 1 FROM   Ta_KILER e WHERE a1.Kd_Bidang=e.Kd_Bidang AND a1.Kd_Unit=e.Kd_Unit AND a1.Kd_Sub=e.Kd_Sub AND a1.Kd_UPB=e.Kd_UPB AND a1.Kd_Aset1=e.Kd_Aset1 AND a1.Kd_Aset2=e.Kd_Aset2 AND a1.Kd_Aset3=e.Kd_Aset3 AND a1.Kd_Aset4=e.Kd_Aset4 AND a1.Kd_Aset5=e.Kd_Aset5 AND a1.No_Register=e.No_Register  AND Kd_Riwayat IN (3,19) AND YEAR(e.Tgl_Dokumen) <= '{$thn}') UNION ALL SELECT a1.*, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KILER a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen										) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KILER a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_Lainnya a1 WHERE 1=1 AND EXISTS (SELECT 1 FROM   Ta_KILHapus d INNER JOIN Ta_Penghapusan e ON d.No_SK=e.No_SK WHERE a1.Kd_Bidang=d.Kd_Bidang AND a1.Kd_Unit=d.Kd_Unit AND a1.Kd_Sub=d.Kd_Sub AND a1.Kd_UPB=d.Kd_UPB AND a1.Kd_Aset1=d.Kd_Aset1 AND a1.Kd_Aset2=d.Kd_Aset2 AND a1.Kd_Aset3=d.Kd_Aset3 AND a1.Kd_Aset4=d.Kd_Aset4 AND a1.Kd_Aset5=d.Kd_Aset5 AND a1.No_Register=d.No_Register AND YEAR(e.Tgl_SK) <= '{$thn}') ) as x ) as a LEFT JOIN Ref_Rek_Aset5 n ON a.Kd_Aset1 = n.Kd_Aset1 AND a.Kd_Aset2 = n.Kd_Aset2 AND a.Kd_Aset3 = n.Kd_Aset3 AND a.Kd_Aset4 = n.Kd_Aset4 AND a.Kd_Aset5 = n.Kd_Aset5 WHERE 1=1 AND n.Kd_Aset1=7 AND n.Kd_Aset2 IN (22,24) $where $tgl_pembukuan GROUP BY a.Kd_Prov, a.Kd_Kab_Kota, a.Kd_Bidang, a.Kd_Unit, a.Kd_Sub, a.Kd_UPB, a.Kd_Aset1, a.Kd_Aset2, a.Kd_Aset3, a.Kd_Aset4, a.Kd_Aset5, a.Kd_Pemilik, a.Kd_Pemilik,a.Tgl_Perolehan,a.Kondisi,a.Keterangan,n.Nm_Aset5 ORDER BY  n.Nm_Aset5, MIN(a.No_register)"; return $this->db->query($query); } /** * Menampilkan semua data kib b */ function lainnya_mutasi($bidang,$unit,$sub,$upb,$like) {$kb 	=  $this->session->userdata('kd_bidang'); $ku 	=  $this->session->userdata('kd_unit'); $ks 	=  $this->session->userdata('kd_sub_unit'); $kupb 	=  $this->session->userdata('kd_upb'); if ($this->session->userdata('lvl') == 01){$where = "(Ta_Lainnya.Kd_Bidang = $bidang) AND (Ta_Lainnya.Kd_Unit = $unit) AND (Ta_Lainnya.Kd_Sub = $sub) AND (Ta_Lainnya.Kd_UPB = $upb) AND"; }elseif ($this->session->userdata('lvl') == 02){$where = "(Ta_Lainnya.Kd_Bidang = $kb ) AND (Ta_Lainnya.Kd_Unit =$ku ) AND (Ta_Lainnya.Kd_Sub = $ks) AND (Ta_Lainnya.Kd_UPB = $upb) AND"; }else{$where = "(Ta_Lainnya.Kd_Bidang = $kb) AND (Ta_Lainnya.Kd_Unit = $ku) AND (Ta_Lainnya.Kd_Sub = $ks) AND (Ta_Lainnya.Kd_UPB = $kupb) AND"; } $query = "SELECT   Ref_Rek_Aset5.Nm_Aset5,COUNT(Ta_Lainnya.No_register) as jumlah_register,MIN(Ta_Lainnya.No_register) as min_register, MAX(Ta_Lainnya.No_register) as max_register, Ta_Lainnya.Kd_Prov, Ta_Lainnya.Kd_Kab_Kota, Ta_Lainnya.Kd_Bidang, Ta_Lainnya.Kd_Unit, Ta_Lainnya.Kd_Sub, Ta_Lainnya.Kd_UPB, Ta_Lainnya.Kd_Aset1, Ta_Lainnya.Kd_Aset2, Ta_Lainnya.Kd_Aset3, Ta_Lainnya.Kd_Aset4, Ta_Lainnya.Kd_Aset5, Ta_Lainnya.Kd_Pemilik, Ta_Lainnya.Merk, Ta_Lainnya.Type, Ta_Lainnya.CC, Ta_Lainnya.Bahan, DATENAME(yyyy,Ta_Lainnya.Tgl_Perolehan) as Tahun,Ta_Lainnya.Nomor_Pabrik,Ta_Lainnya.Nomor_Rangka,Ta_Lainnya.Nomor_Mesin, Ta_Lainnya.Nomor_Polisi,Ta_Lainnya.Nomor_BPKB,Ta_Lainnya.Asal_usul,Ta_Lainnya.Kondisi,COUNT(*) as Jumlah, SUM(Ta_Lainnya.Harga) as Harga,Ta_Lainnya.Keterangan FROM  Ta_Lainnya INNER JOIN Ref_Rek_Aset5 ON Ta_Lainnya.Kd_Aset1 = Ref_Rek_Aset5.Kd_Aset1 AND Ta_Lainnya.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_Lainnya.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_Lainnya.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_Lainnya.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 WHERE  $where $like GROUP BY Ta_Lainnya.Kd_Prov, Ta_Lainnya.Kd_Kab_Kota, Ta_Lainnya.Kd_Bidang, Ta_Lainnya.Kd_Unit, Ta_Lainnya.Kd_Sub, Ta_Lainnya.Kd_UPB, Ta_Lainnya.Kd_Aset1, Ta_Lainnya.Kd_Aset2, Ta_Lainnya.Kd_Aset3, Ta_Lainnya.Kd_Aset4, Ta_Lainnya.Kd_Aset5, Ta_Lainnya.Kd_Pemilik, Ta_Lainnya.Merk, Ta_Lainnya.Type, Ta_Lainnya.CC, Ta_Lainnya.Bahan, Ta_Lainnya.Tgl_Perolehan,Ta_Lainnya.Nomor_Pabrik,Ta_Lainnya.Nomor_Rangka,Ta_Lainnya.Nomor_Mesin,Ta_Lainnya.Nomor_Polisi, Ta_Lainnya.Nomor_BPKB,Ta_Lainnya.Asal_usul,Ta_Lainnya.Kondisi,Ta_Lainnya.Keterangan,Ref_Rek_Aset5.Nm_Aset5 ORDER BY  Ref_Rek_Aset5.Nm_Aset5, MIN(Ta_Lainnya.No_register)"; return $this->db->query($query); } /** * Total Data Mutasi */ function total_lainnya_mutasi($bidang,$unit,$sub,$upb,$like) {if ($this->session->userdata('lvl') == 01){$this->db->where('Kd_Bidang',$bidang); $this->db->where('Kd_Unit',$unit); $this->db->where('Kd_Sub',$sub); $this->db->where('Kd_UPB',$upb); }elseif ($this->session->userdata('lvl') == 02){$this->db->where('Kd_Bidang',$this->session->userdata('kd_bidang')); $this->db->where('Kd_Unit',$this->session->userdata('kd_unit')); $this->db->where('Kd_Sub',$this->session->userdata('kd_sub_unit')); $this->db->where('Kd_UPB',$upb); }else{$this->db->where('Kd_Bidang',$this->session->userdata('kd_bidang')); $this->db->where('Kd_Unit',$this->session->userdata('kd_unit')); $this->db->where('Kd_Sub',$this->session->userdata('kd_sub_unit')); $this->db->where('Kd_UPB',$this->session->userdata('kd_upb')); } $this->db->select_SUM('Harga'); $this->db->where("$like"); $array_keys_values = $this->db->get($this->table); foreach ($array_keys_values->result() as $row) {$result = $row->Harga; } return $result; } /** * Menampilkan semua data kib f rekap */ function rekap_mutasi($bidang='',$unit='',$sub='',$upb='',$tahunawal,$tahunakhir) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $thn   =  $this->session->userdata('tahun_anggaran'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; $where .= "AND (a.Kd_UPB = $kupb)"; } $tgl_pembukuan 	= " AND Tgl_Pembukuan <= '$tahunakhir'"; $tgl_dokumen 	= " AND Tgl_Dokumen < '$tahunawal'"; $query = "SELECT Ref_Rek_Aset2.Kd_Aset1,Ref_Rek_Aset2.Kd_Aset2,Nm_Aset2, COUNT(CASE WHEN Tgl_Pembukuan < '$tahunawal' THEN 1 else null END) as Jumlah_awal, SUM(CASE WHEN Tgl_Pembukuan < '$tahunawal'  THEN Harga END) as Harga_awal, COUNT(CASE WHEN Tgl_Pembukuan BETWEEN '$tahunawal' AND '$tahunakhir' THEN CASE WHEN Kd_Riwayat IN (3, 7, 23) THEN Harga END END ) AS Jumlah_Kurang, SUM (CASE WHEN Tgl_Pembukuan BETWEEN '$tahunawal' AND '$tahunakhir' THEN CASE WHEN Kd_Riwayat IN (3, 7, 23) THEN Harga END END) AS Mutasi_Kurang, COUNT(CASE WHEN Tgl_Pembukuan BETWEEN '$tahunawal' AND '$tahunakhir' THEN CASE WHEN Kd_Riwayat is null OR Kd_Riwayat IN (2, 21) THEN Harga END END ) AS Jumlah_Tambah, SUM (CASE WHEN Tgl_Pembukuan BETWEEN '$tahunawal' AND '$tahunakhir' THEN CASE WHEN Kd_Riwayat is null OR Kd_Riwayat IN (2, 21) THEN Harga END END) AS Mutasi_Tambah FROM Ref_Rek_Aset2 LEFT JOIN (SELECT * FROM (SELECT Kd_Riwayat, Kd_Prov, Kd_Kab_Kota, Kd_Bidang, Kd_Unit, Kd_Sub, Kd_UPB, Kd_Aset1, Kd_Aset2, Kd_Aset3, Kd_Aset4, Kd_Aset5, No_Register,Kd_Pemilik,Tgl_Perolehan,Tgl_Dokumen as Tgl_Pembukuan, Asal_usul,Kondisi,Harga,Keterangan FROM Ta_KILER WHERE Kd_Riwayat IN (2,7,21,23) AND Tgl_Dokumen BETWEEN '$tahunawal' AND '$tahunakhir'UNION ALL /* mutasi kurang pindah skpd */ SELECT 3 as Kd_Riwayat,Kd_Prov, Kd_Kab_Kota, Kd_Bidang, Kd_Unit, Kd_Sub, Kd_UPB, Kd_Aset1, Kd_Aset2, Kd_Aset3, Kd_Aset4,Kd_Aset5, No_Register, Kd_Pemilik,Tgl_Perolehan,NewDokumen as Tgl_Pembukuan, Asal_usul,Kondisi, ((Harga + ISNULL(Koreksi_Tambah, 0)) - ISNULL(Koreksi_Kurang, 0) ) as Harga, Keterangan FROM (SELECT a1.*,a2.Tgl_Dokumen as NewDokumen, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KILER a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KILER a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_Lainnya a1 RIGHT JOIN Ta_KILER a2 ON a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register WHERE Kd_Riwayat IN (3,19) AND Tgl_Dokumen BETWEEN '$tahunawal' AND '$tahunakhir') as mk_pindah_skpd UNION ALL /* start mutasi kurang penghapusan */ SELECT 3 as Kd_Riwayat,Kd_Prov, Kd_Kab_Kota, Kd_Bidang, Kd_Unit, Kd_Sub, Kd_UPB, Kd_Aset1, Kd_Aset2, Kd_Aset3, Kd_Aset4,Kd_Aset5, No_Register, Kd_Pemilik,Tgl_Perolehan,NewDokumen as Tgl_Pembukuan, Asal_usul,Kondisi, ((Harga + ISNULL(Koreksi_Tambah, 0)) - ISNULL(Koreksi_Kurang, 0) ) as Harga, Keterangan FROM (SELECT a1.*,a3.Tgl_SK as NewDokumen, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KILER a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KILER a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_Lainnya a1 RIGHT JOIN Ta_KILHapus a2 ON a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register INNER JOIN Ta_Penghapusan a3  ON a2.No_SK=a3.No_SK ) as mk_penghapusan /* end mutasi kurang penghapusan */ UNION ALL SELECT null as Kd_Riwayat, Kd_Prov, Kd_Kab_Kota, Kd_Bidang, Kd_Unit, Kd_Sub, Kd_UPB, Kd_Aset1, Kd_Aset2, Kd_Aset3, Kd_Aset4,Kd_Aset5, No_Register, Kd_Pemilik,Tgl_Perolehan,Tgl_Pembukuan, Asal_usul,Kondisi, ((Harga + ISNULL(Koreksi_Tambah, 0)) - ISNULL(Koreksi_Kurang, 0) ) as Harga, Keterangan FROM (SELECT n.Nm_Aset5, a1.*, (CASE WHEN NewKondisi is null THEN Kondisi ELSE NewKondisi END) as lastKondisi, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KILER a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KILER a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_Lainnya a1 OUTER APPLY (SELECT TOP 1 b.Kondisi as NewKondisi FROM Ta_KILER b WHERE a1.Kd_Bidang=b.Kd_Bidang AND a1.Kd_Unit=b.Kd_Unit AND a1.Kd_Sub=b.Kd_Sub AND a1.Kd_UPB=b.Kd_UPB AND a1.Kd_Aset1=b.Kd_Aset1 AND a1.Kd_Aset2=b.Kd_Aset2 AND a1.Kd_Aset3=b.Kd_Aset3 AND a1.Kd_Aset4=b.Kd_Aset4 AND a1.Kd_Aset5=b.Kd_Aset5 AND a1.No_Register=b.No_Register AND Kd_Riwayat=1 AND YEAR(b.Tgl_Dokumen) <= '{$thn}'ORDER BY b.Tgl_Dokumen DESC) as b INNER JOIN Ref_Rek_Aset5 n ON a1.Kd_Aset1 = n.Kd_Aset1 AND a1.Kd_Aset2 = n.Kd_Aset2 AND a1.Kd_Aset3 = n.Kd_Aset3 AND a1.Kd_Aset4 = n.Kd_Aset4 AND a1.Kd_Aset5 = n.Kd_Aset5 WHERE NOT EXISTS (SELECT 1 FROM   Ta_KILHapus d INNER JOIN Ta_Penghapusan e ON d.No_SK=e.No_SK WHERE a1.Kd_Bidang=d.Kd_Bidang AND a1.Kd_Unit=d.Kd_Unit AND a1.Kd_Sub=d.Kd_Sub AND a1.Kd_UPB=d.Kd_UPB AND a1.Kd_Aset1=d.Kd_Aset1 AND a1.Kd_Aset2=d.Kd_Aset2 AND a1.Kd_Aset3=d.Kd_Aset3 AND a1.Kd_Aset4=d.Kd_Aset4 AND a1.Kd_Aset5=d.Kd_Aset5 AND a1.No_Register=d.No_Register AND e.Tgl_SK < '$tahunawal') AND NOT EXISTS (SELECT 1 FROM  Ta_KILER e WHERE a1.Kd_Bidang=e.Kd_Bidang AND a1.Kd_Unit=e.Kd_Unit AND a1.Kd_Sub=e.Kd_Sub AND a1.Kd_UPB=e.Kd_UPB AND a1.Kd_Aset1=e.Kd_Aset1 AND a1.Kd_Aset2=e.Kd_Aset2 AND a1.Kd_Aset3=e.Kd_Aset3 AND a1.Kd_Aset4=e.Kd_Aset4 AND a1.Kd_Aset5=e.Kd_Aset5 AND a1.No_Register=e.No_Register  AND Kd_Riwayat IN (3,19) AND e.Tgl_Dokumen < '$tahunawal') ) as x ) as a WHERE 1=1 $where $tgl_pembukuan) as a3 ON a3.Kd_Aset1=Ref_Rek_Aset2.Kd_Aset1 AND a3.Kd_Aset2=Ref_Rek_Aset2.Kd_Aset2 WHERE Ref_Rek_Aset2.Kd_Aset1=7 AND Ref_Rek_Aset2.Kd_Aset2 IN (24,22) GROUP BY Ref_Rek_Aset2.Kd_Aset1,Ref_Rek_Aset2.Kd_Aset2,Nm_Aset2 ORDER BY Ref_Rek_Aset2.Kd_Aset2"; return $this->db->query($query); } /** * Menampilkan semua data kib b buku induk */ function lainnya_buku_induk($like) {$kb 	=  $this->session->userdata('kd_bidang'); $ku 	=  $this->session->userdata('kd_unit'); $ks 	=  $this->session->userdata('kd_sub_unit'); $kupb 	=  $this->session->userdata('kd_upb'); if ($this->session->userdata('lvl') == 01){$where = ''; }elseif ($this->session->userdata('lvl') == 02){$where = "(Ta_Lainnya.Kd_Bidang = $kb ) AND (Ta_Lainnya.Kd_Unit =$ku ) AND (Ta_Lainnya.Kd_Sub = $ks) AND"; }else{$where = "(Ta_Lainnya.Kd_Bidang = $kb) AND (Ta_Lainnya.Kd_Unit = $ku) AND (Ta_Lainnya.Kd_Sub = $ks) AND (Ta_Lainnya.Kd_UPB = $kupb) AND"; } $query = "SELECT  Nm_UPB,Ref_Rek_Aset5.Nm_Aset5,COUNT(Ta_Lainnya.No_register) as jumlah_register,MIN(Ta_Lainnya.No_register) as min_register, MAX(Ta_Lainnya.No_register) as max_register, Ta_Lainnya.Kd_Prov, Ta_Lainnya.Kd_Kab_Kota, Ta_Lainnya.Kd_Bidang, Ta_Lainnya.Kd_Unit, Ta_Lainnya.Kd_Sub, Ta_Lainnya.Kd_UPB, Ta_Lainnya.Kd_Aset1, Ta_Lainnya.Kd_Aset2, Ta_Lainnya.Kd_Aset3, Ta_Lainnya.Kd_Aset4, Ta_Lainnya.Kd_Aset5, Ta_Lainnya.Kd_Pemilik, Ta_Lainnya.Merk, Ta_Lainnya.Type, Ta_Lainnya.CC, Ta_Lainnya.Bahan, DATENAME(yyyy,Ta_Lainnya.Tgl_Perolehan) as Tahun,Ta_Lainnya.Nomor_Pabrik,Ta_Lainnya.Nomor_Rangka,Ta_Lainnya.Nomor_Mesin, Ta_Lainnya.Nomor_Polisi,Ta_Lainnya.Nomor_BPKB,Ta_Lainnya.Asal_usul,Ta_Lainnya.Kondisi,COUNT(*) as Jumlah, SUM(Ta_Lainnya.Harga) as Harga,Ta_Lainnya.Keterangan FROM  Ta_Lainnya INNER JOIN Ref_Rek_Aset5 ON Ta_Lainnya.Kd_Aset1 = Ref_Rek_Aset5.Kd_Aset1 AND Ta_Lainnya.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_Lainnya.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_Lainnya.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_Lainnya.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 INNER JOIN Ref_UPB ON Ta_Lainnya.Kd_Bidang=Ref_UPB.Kd_Bidang AND Ta_Lainnya.Kd_Unit=Ref_UPB.Kd_Unit AND Ta_Lainnya.Kd_Sub=Ref_UPB.Kd_Sub AND Ta_Lainnya.Kd_UPB=Ref_UPB.Kd_UPB WHERE  $where $like GROUP BY Ta_Lainnya.Kd_Prov, Ta_Lainnya.Kd_Kab_Kota, Ta_Lainnya.Kd_Bidang, Ta_Lainnya.Kd_Unit, Ta_Lainnya.Kd_Sub, Ta_Lainnya.Kd_UPB, Ta_Lainnya.Kd_Aset1, Ta_Lainnya.Kd_Aset2, Ta_Lainnya.Kd_Aset3, Ta_Lainnya.Kd_Aset4, Ta_Lainnya.Kd_Aset5, Ta_Lainnya.Kd_Pemilik, Ta_Lainnya.Merk, Ta_Lainnya.Type, Ta_Lainnya.CC, Ta_Lainnya.Bahan, Ta_Lainnya.Tgl_Perolehan,Ta_Lainnya.Nomor_Pabrik,Ta_Lainnya.Nomor_Rangka,Ta_Lainnya.Nomor_Mesin,Ta_Lainnya.Nomor_Polisi, Ta_Lainnya.Nomor_BPKB,Ta_Lainnya.Asal_usul,Ta_Lainnya.Kondisi,Ta_Lainnya.Keterangan,Ref_Rek_Aset5.Nm_Aset5,Nm_UPB ORDER BY  Nm_UPB,Ref_Rek_Aset5.Nm_Aset5, MIN(Ta_Lainnya.No_register)"; return $this->db->query($query); } /** * Total Data buku induk skpd */ function total_lainnya_buku_induk($like) {$query = "SELECT COUNT(*) as Jumlah, SUM(Harga) as Harga FROM Ta_Lainnya where Kd_Aset1=2 AND $like"; return $this->db->query($query); } /** * Menampilkan sdata kib b rekap inventaris */ function lainnya_rinventaris($bidang,$unit,$sub,$upb,$like) {$kb 	=  $this->session->userdata('kd_bidang'); $ku 	=  $this->session->userdata('kd_unit'); $ks 	=  $this->session->userdata('kd_sub_unit'); $kupb 	=  $this->session->userdata('kd_upb'); if ($this->session->userdata('lvl') == 01){$where = "WHERE (Ta_Lainnya.Kd_Bidang = $bidang) AND (Ta_Lainnya.Kd_Unit = $unit) AND (Ta_Lainnya.Kd_Sub = $sub) AND (Ta_Lainnya.Kd_UPB = $upb) AND $like"; }elseif ($this->session->userdata('lvl') == 02){$where = "WHERE (Ta_Lainnya.Kd_Bidang = $kb ) AND (Ta_Lainnya.Kd_Unit =$ku ) AND (Ta_Lainnya.Kd_Sub = $ks) AND (Ta_Lainnya.Kd_UPB = $upb) AND $like"; }else{$where = "WHERE (Ta_Lainnya.Kd_Bidang = $kb) AND (Ta_Lainnya.Kd_Unit = $ku) AND (Ta_Lainnya.Kd_Sub = $ks) AND (Ta_Lainnya.Kd_UPB = $kupb) AND $like"; } $query = "select Ref_Rek_Aset2.Kd_Aset1,Ref_Rek_Aset2.Kd_Aset2,Nm_Aset2,COUNT(*) as Jumlah, SUM(Harga) as Harga from Ref_Rek_Aset2 LEFT JOIN (SELECT * from Ta_Lainnya $where) as Ta_Lainnya ON Ta_Lainnya.Kd_Aset1=Ref_Rek_Aset2.Kd_Aset1 AND Ta_Lainnya.Kd_Aset2=Ref_Rek_Aset2.Kd_Aset2   WHERE Ref_Rek_Aset2.Kd_Aset1=7 GROUP BY Ref_Rek_Aset2.Kd_Aset1,Ref_Rek_Aset2.Kd_Aset2,Nm_Aset2 "; return $this->db->query($query); } /** * Total Data Mutasi */ function total_lainnya_rinventaris($bidang,$unit,$sub,$upb,$like) {$kb 	=  $this->session->userdata('kd_bidang'); $ku 	=  $this->session->userdata('kd_unit'); $ks 	=  $this->session->userdata('kd_sub_unit'); $kupb 	=  $this->session->userdata('kd_upb'); if ($this->session->userdata('lvl') == 01){$where = "WHERE (Ta_Lainnya.Kd_Bidang = $bidang) AND (Ta_Lainnya.Kd_Unit = $unit) AND (Ta_Lainnya.Kd_Sub = $sub) AND (Ta_Lainnya.Kd_UPB = $upb) AND $like"; }elseif ($this->session->userdata('lvl') == 02){$where = "WHERE (Ta_Lainnya.Kd_Bidang = $kb ) AND (Ta_Lainnya.Kd_Unit =$ku ) AND (Ta_Lainnya.Kd_Sub = $ks) AND (Ta_Lainnya.Kd_UPB = $upb) AND $like"; }else{$where = "WHERE (Ta_Lainnya.Kd_Bidang = $kb) AND (Ta_Lainnya.Kd_Unit = $ku) AND (Ta_Lainnya.Kd_Sub = $ks) AND (Ta_Lainnya.Kd_UPB = $kupb) AND $like"; } $query = "SELECT COUNT(*) as Jumlah,SUM(Harga) as Harga FROM Ta_Lainnya $where"; return $this->db->query($query); } function rekap_skpd($bidang='',$unit='',$sub='',$upb='', $tahunawal, $tahunakhir,$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $thn   =  $this->session->userdata('tahun_anggaran'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; $where .= "AND (a.Kd_UPB = $kupb)"; } $tgl_pembukuan 	= " AND Tgl_Pembukuan ".$like; $tgl_dokumen 	= " AND Tgl_Dokumen <= '".$tahunakhir."'"; $query = "SELECT COUNT(*) as Jumlah, SUM(LastHarga) as  Harga FROM (SELECT *,((Harga + ISNULL(Koreksi_Tambah, 0) ) - ISNULL(Koreksi_Kurang, 0) ) as LastHarga FROM (SELECT n.Nm_Aset5, a1.*, (CASE WHEN NewKondisi is null THEN Kondisi ELSE NewKondisi END) as lastKondisi, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KILER a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KILER a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_Lainnya a1 OUTER APPLY (SELECT TOP 1 b.Kondisi as NewKondisi FROM Ta_KILER b WHERE a1.Kd_Bidang=b.Kd_Bidang AND a1.Kd_Unit=b.Kd_Unit AND a1.Kd_Sub=b.Kd_Sub AND a1.Kd_UPB=b.Kd_UPB AND a1.Kd_Aset1=b.Kd_Aset1 AND a1.Kd_Aset2=b.Kd_Aset2 AND a1.Kd_Aset3=b.Kd_Aset3 AND a1.Kd_Aset4=b.Kd_Aset4 AND a1.Kd_Aset5=b.Kd_Aset5 AND a1.No_Register=b.No_Register AND Kd_Riwayat=1 AND b.Tgl_Dokumen <= '{$tahunakhir}'ORDER BY b.Tgl_Dokumen DESC) as b INNER JOIN Ref_Rek_Aset5 n ON a1.Kd_Aset1 = n.Kd_Aset1 AND a1.Kd_Aset2 = n.Kd_Aset2 AND a1.Kd_Aset3 = n.Kd_Aset3 AND a1.Kd_Aset4 = n.Kd_Aset4 AND a1.Kd_Aset5 = n.Kd_Aset5 WHERE NOT EXISTS (SELECT 1 FROM   Ta_KILHapus d INNER JOIN Ta_Penghapusan e ON d.No_SK=e.No_SK WHERE a1.Kd_Bidang=d.Kd_Bidang AND a1.Kd_Unit=d.Kd_Unit AND a1.Kd_Sub=d.Kd_Sub AND a1.Kd_UPB=d.Kd_UPB AND a1.Kd_Aset1=d.Kd_Aset1 AND a1.Kd_Aset2=d.Kd_Aset2 AND a1.Kd_Aset3=d.Kd_Aset3 AND a1.Kd_Aset4=d.Kd_Aset4 AND a1.Kd_Aset5=d.Kd_Aset5 AND a1.No_Register=d.No_Register AND e.Tgl_SK <= '{$tahunakhir}') AND NOT EXISTS (SELECT 1 FROM   Ta_KILER e WHERE a1.Kd_Bidang=e.Kd_Bidang AND a1.Kd_Unit=e.Kd_Unit AND a1.Kd_Sub=e.Kd_Sub AND a1.Kd_UPB=e.Kd_UPB AND a1.Kd_Aset1=e.Kd_Aset1 AND a1.Kd_Aset2=e.Kd_Aset2 AND a1.Kd_Aset3=e.Kd_Aset3 AND a1.Kd_Aset4=e.Kd_Aset4 AND a1.Kd_Aset5=e.Kd_Aset5 AND a1.No_Register=e.No_Register AND Kd_Riwayat IN (3,19) AND e.Tgl_Dokumen <= '{$tahunakhir}') ) as x ) as a WHERE 1=1 AND a.Kd_Aset1=7 AND a.Kd_Aset2 IN (22,24) $where $tgl_pembukuan"; return $this->db->query($query); } /** * Mendapatkan data sebuah kibb */ function get_lainnya_by_id($kd_prov,$kd_kab,$bidang,$unit,$sub,$upb,$kd_aset1,$kd_aset2,$kd_aset3,$kd_aset4,$kd_aset5,$no_register) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $thn =  $this->session->userdata('tahun_anggaran'); $where = ""; $where .= "AND (a.Kd_Prov = $kd_prov)"; $where .= "AND (a.Kd_Kab_Kota = $kd_kab)"; if ($this->session->userdata('lvl') == 01){$where = "AND (a.Kd_Bidang = $bidang) AND (a.Kd_Unit = $unit) AND (a.Kd_Sub = $sub) AND (a.Kd_UPB = $upb)"; }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb ) AND (a.Kd_Unit =$ku ) AND (a.Kd_Sub = $ks) AND (a.Kd_UPB = $upb)"; }else{$where = "AND (a.Kd_Bidang = $kb) AND (a.Kd_Unit = $ku) AND (a.Kd_Sub = $ks) AND (a.Kd_UPB = $kupb)"; } $thn         = $this->session->userdata('tahun_anggaran'); $where       .= "AND a.Kd_Aset1 = {$kd_aset1} AND a.Kd_Aset2 = {$kd_aset2} AND a.Kd_Aset3 = {$kd_aset3} AND a.Kd_Aset4 = {$kd_aset4} AND a.Kd_Aset5 = {$kd_aset5} AND a.No_Register = {$no_register} "; $tgl_dokumen = " AND YEAR(Tgl_Dokumen) <= '{$thn}'"; $query = "SELECT *, ((Harga + ISNULL(Total_Koreksi, 0) ) - ISNULL(Koreksi_Kurang, 0) ) as HargaKoreksi, ((Harga + ISNULL(Koreksi_Tambah, 0) ) - ISNULL(Koreksi_Kurang, 0) ) as LastHarga FROM (SELECT n.Nm_Aset5,a1.*, (CASE WHEN NewKondisi is null THEN Kondisi ELSE NewKondisi END) as lastKondisi, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KILER a2 WHERE a2.Kd_Riwayat = 21 AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Total_Koreksi, (SELECT SUM(Harga) as Rharga FROM Ta_KILER a2 WHERE a2.Kd_Riwayat = 2 AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Kapitalisasi, (SELECT SUM(Harga) as Rharga FROM Ta_KILER a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KILER a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_Lainnya a1 OUTER APPLY (SELECT TOP 1 b.Kondisi as NewKondisi FROM Ta_KILER b WHERE a1.Kd_Bidang=b.Kd_Bidang AND a1.Kd_Unit=b.Kd_Unit AND a1.Kd_Sub=b.Kd_Sub AND a1.Kd_UPB=b.Kd_UPB AND a1.Kd_Aset1=b.Kd_Aset1 AND a1.Kd_Aset2=b.Kd_Aset2 AND a1.Kd_Aset3=b.Kd_Aset3 AND a1.Kd_Aset4=b.Kd_Aset4 AND a1.Kd_Aset5=b.Kd_Aset5 AND a1.No_Register=b.No_Register AND Kd_Riwayat=1 AND YEAR(b.Tgl_Dokumen) <= '{$thn}'ORDER BY b.Tgl_Dokumen DESC) as b INNER JOIN Ref_Rek_Aset5 n ON a1.Kd_Aset1 = n.Kd_Aset1 AND a1.Kd_Aset2 = n.Kd_Aset2 AND a1.Kd_Aset3 = n.Kd_Aset3 AND a1.Kd_Aset4 = n.Kd_Aset4 AND a1.Kd_Aset5 = n.Kd_Aset5 )as a WHERE 1=1 $where"; return $this->db->query($query); } function get_kiler_by_id($kd_riwayat,$kd_id,$kd_prov,$kd_kab,$bidang,$unit,$sub,$upb,$kd_aset1,$kd_aset2,$kd_aset3,$kd_aset4,$kd_aset5,$no_register) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $where = ""; $where .= "AND a.Kd_Riwayat = {$kd_riwayat} AND a.Kd_Id = {$kd_id} "; $where .= "AND (a.Kd_Prov = $kd_prov)"; $where .= "AND (a.Kd_Kab_Kota = $kd_kab)"; if ($this->session->userdata('lvl') == 01){$where .= "AND (a.Kd_Bidang = $bidang) AND (a.Kd_Unit = $unit) AND (a.Kd_Sub = $sub) AND (a.Kd_UPB = $upb)"; }elseif ($this->session->userdata('lvl') == 02){$where .= "AND (a.Kd_Bidang = $kb ) AND (a.Kd_Unit =$ku ) AND (a.Kd_Sub = $ks) AND (a.Kd_UPB = $upb)"; }else{$where .= "AND (a.Kd_Bidang = $kb) AND (a.Kd_Unit = $ku) AND (a.Kd_Sub = $ks) AND (a.Kd_UPB = $kupb)"; } $where .= "AND a.Kd_Aset1 = {$kd_aset1} AND a.Kd_Aset2 = {$kd_aset2} AND a.Kd_Aset3 = {$kd_aset3} AND a.Kd_Aset4 = {$kd_aset4} AND a.Kd_Aset5 = {$kd_aset5} AND a.No_Register = {$no_register} "; $query = "SELECT * FROM Ta_KILER a WHERE 1=1 $where"; return $this->db->query($query); } function data_foto($kd_prov,$kd_kab,$kd_bidang,$kd_unit,$kd_sub,$kd_upb,$kd_aset1,$kd_aset2,$kd_aset3,$kd_aset4,$kd_aset5,$no_register) {$this->db->select('*'); $this->db->from('Ta_FotoLainnya'); $this->db->where('Kd_Prov',$kd_prov); $this->db->where('Kd_Kab_Kota',$kd_kab); $this->db->where('Kd_Bidang',$kd_bidang); $this->db->where('Kd_Unit',$kd_unit); $this->db->where('Kd_Sub',$kd_sub); $this->db->where('Kd_UPB',$kd_upb); $this->db->where('Kd_Aset1',$kd_aset1); $this->db->where('Kd_Aset2',$kd_aset2); $this->db->where('Kd_Aset3',$kd_aset3); $this->db->where('Kd_Aset4',$kd_aset4); $this->db->where('Kd_Aset5',$kd_aset5); $this->db->where('No_Register',$no_register); return $this->db->get(); } function get_last_kapitalisasi($kd_prov,$kd_kab,$bidang,$unit,$sub,$upb,$kd_aset1,$kd_aset2,$kd_aset3,$kd_aset4,$kd_aset5,$no_register) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $where = ""; $where .= "AND (a.Kd_Prov = $kd_prov)"; $where .= "AND (a.Kd_Kab_Kota = $kd_kab)"; if ($this->session->userdata('lvl') == 01){$where = "AND (a.Kd_Bidang = $bidang) AND (a.Kd_Unit = $unit) AND (a.Kd_Sub = $sub) AND (a.Kd_UPB = $upb)"; }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb ) AND (a.Kd_Unit =$ku ) AND (a.Kd_Sub = $ks) AND (a.Kd_UPB = $upb)"; }else{$where = "AND (a.Kd_Bidang = $kb) AND (a.Kd_Unit = $ku) AND (a.Kd_Sub = $ks) AND (a.Kd_UPB = $kupb)"; } $where .= "AND a.Kd_Riwayat = 2 "; $where .= "AND a.Kd_Aset1 = {$kd_aset1} AND a.Kd_Aset2 = {$kd_aset2} AND a.Kd_Aset3 = {$kd_aset3} AND a.Kd_Aset4 = {$kd_aset4} AND a.Kd_Aset5 = {$kd_aset5} AND a.No_Register = {$no_register} "; $query = "SELECT MAX(YEAR(Tgl_Dokumen)) as last_kapitalisasi FROM Ta_KILER a WHERE 1=1 $where"; return $this->db->query($query); } /** * mendapatkan no register terakhir */ function get_last_noregister($kd_bidang,$kd_unit,$kd_sub,$kd_upb,$kd_aset1,$kd_aset2,$kd_aset3,$kd_aset4,$kd_aset5) {$this->db->select_MAX('No_Register'); $array_keys_values = $this->db->get_where($this->table,array('Kd_Bidang' => $kd_bidang,'Kd_Unit' => $kd_unit,'Kd_Sub' => $kd_sub, 'Kd_UPB' => $kd_upb,'Kd_Aset1' => $kd_aset1,'Kd_Aset2' => $kd_aset2,'Kd_Aset3' => $kd_aset3,'Kd_Aset4' => $kd_aset4,'Kd_Aset5' => $kd_aset5)); foreach ($array_keys_values->result() as $row) {$result = $row->No_Register; } return $result+1; } /** * memeriksa register */ function cek_register($kd_bidang,$kd_unit,$kd_sub,$kd_upb,$kd_aset1,$kd_aset2,$kd_aset3,$kd_aset4,$kd_aset5,$no_register) {$result = $this->db->get_where($this->table,array('Kd_Bidang' => $kd_bidang,'Kd_Unit' => $kd_unit,'Kd_Sub' => $kd_sub, 'Kd_UPB' => $kd_upb,'Kd_Aset1' => $kd_aset1,'Kd_Aset2' => $kd_aset2,'Kd_Aset3' => $kd_aset3,'Kd_Aset4' => $kd_aset4,'Kd_Aset5' => $kd_aset5,'No_Register' => $no_register)); return $result; } /** * Menambah data tanah */ function add($kibb) {$this->db->insert($this->table, $kibb); return TRUE; } function add_riwayat($data) {$sql = $this->db->insert('Ta_KILER', $data); if($sql) return TRUE; } function update_riwayat($data) {$this->db->where('Kd_Riwayat', $this->session->userdata('rKd_Riwayat')); $this->db->where('Kd_Id', $this->session->userdata('rKd_Id')); $this->db->where('Kd_Prov', $this->session->userdata('rKd_Prov')); $this->db->where('Kd_Kab_Kota', $this->session->userdata('rKd_Kab_Kota')); $this->db->where('Kd_Bidang', $this->session->userdata('rKd_Bidang')); $this->db->where('Kd_Unit', $this->session->userdata('rKd_Unit')); $this->db->where('Kd_Sub', $this->session->userdata('rKd_Sub')); $this->db->where('Kd_UPB', $this->session->userdata('rKd_UPB')); $this->db->where('Kd_Aset1', $this->session->userdata('rKd_Aset1')); $this->db->where('Kd_Aset2', $this->session->userdata('rKd_Aset2')); $this->db->where('Kd_Aset3', $this->session->userdata('rKd_Aset3')); $this->db->where('Kd_Aset4', $this->session->userdata('rKd_Aset4')); $this->db->where('Kd_Aset5', $this->session->userdata('rKd_Aset5')); $this->db->where('No_Register', $this->session->userdata('rNo_Register')); $this->db->update('Ta_KILER',$data); } /** * Menambah data tanah */ function insert($foto) {$this->db->insert('Ta_FotoLainnya', $foto); return TRUE; } /** * Menghapus sebuah data kibb */ function hapus($kd_prov,$kd_kab,$kd_bidang,$kd_unit,$kd_sub,$kd_upb,$kd_aset1,$kd_aset2,$kd_aset3,$kd_aset4,$kd_aset5,$no_register) {$this->db->delete($this->table, array('Kd_Prov' => $kd_prov,'Kd_Kab_Kota' => $kd_kab,'Kd_Bidang' => $kd_bidang,'Kd_Unit' => $kd_unit, 'Kd_Sub' => $kd_sub,'Kd_UPB' => $kd_upb,'Kd_Aset1' => $kd_aset1,'Kd_Aset2' => $kd_aset2,'Kd_Aset3' => $kd_aset3, 'Kd_Aset4' => $kd_aset4,'Kd_Aset5' => $kd_aset5,'No_Register' => $no_register)); } function hapus_riwayat($kd_riwayat,$kd_id,$kd_prov,$kd_kab,$kd_bidang,$kd_unit,$kd_sub,$kd_upb,$kd_aset1,$kd_aset2,$kd_aset3,$kd_aset4,$kd_aset5,$no_register) {$this->db->delete("Ta_KILER", array('Kd_Riwayat' => $kd_riwayat,'Kd_Id' => $kd_id,'Kd_Prov' => $kd_prov,'Kd_Kab_Kota' => $kd_kab,'Kd_Bidang' => $kd_bidang,'Kd_Unit' => $kd_unit, 'Kd_Sub' => $kd_sub,'Kd_UPB' => $kd_upb,'Kd_Aset1' => $kd_aset1,'Kd_Aset2' => $kd_aset2,'Kd_Aset3' => $kd_aset3,'Kd_Aset4' => $kd_aset4,'Kd_Aset5' => $kd_aset5,'No_Register' => $no_register)); } /** * 30-05-2014 Update data KIB */ function sm_update($kd_prov,$kd_kab,$kd_bidang,$kd_unit,$kd_sub,$kd_upb,$kd_aset1,$kd_aset2,$kd_aset3,$kd_aset4,$kd_aset5,$no_register,$data) {$this->db->where('Kd_Prov', $kd_prov); $this->db->where('Kd_Kab_Kota', $kd_kab); $this->db->where('Kd_Bidang', $kd_bidang); $this->db->where('Kd_Unit', $kd_unit); $this->db->where('Kd_Sub', $kd_sub); $this->db->where('Kd_UPB', $kd_upb); $this->db->where('Kd_Aset1', $kd_aset1); $this->db->where('Kd_Aset2', $kd_aset2); $this->db->where('Kd_Aset3', $kd_aset3); $this->db->where('Kd_Aset4', $kd_aset4); $this->db->where('Kd_Aset5', $kd_aset5); $this->db->where('No_Register', $no_register); $this->db->update($this->table, $data); return TRUE; } /** * 08-06-2014 Insert Select */ function insert_select($kd_prov,$kd_kab,$kd_bidang,$kd_unit,$kd_sub,$kd_upb,$kd_aset1,$kd_aset2,$kd_aset3,$kd_aset4,$kd_aset5,$no_register) {$query = $this->db->get_where($this->table, array('Kd_Prov' => $kd_prov,'Kd_Kab_Kota' => $kd_kab,'Kd_Bidang' => $kd_bidang,'Kd_Unit' => $kd_unit,'Kd_Sub' => $kd_sub,'Kd_UPB' => $kd_upb,'Kd_Aset1' => $kd_aset1,'Kd_Aset2' => $kd_aset2,'Kd_Aset3' => $kd_aset3, 'Kd_Aset4' => $kd_aset4,'Kd_Aset5' => $kd_aset5,'No_Register' => $no_register), 1)->row(); $data = array('No_Urut'       => NULL, 'Kd_Riwayat'    => 7, 'Kd_Id'         => 1, 'Kd_Prov'       => $query->Kd_Prov, 'Kd_Kab_Kota'   => $query->Kd_Kab_Kota, 'Kd_Bidang'     => $query->Kd_Bidang, 'Kd_Unit'       => $query->Kd_Unit, 'Kd_Sub'        => $query->Kd_Sub, 'Kd_UPB'        => $query->Kd_UPB, 'Kd_Aset1'      => $query->Kd_Aset1, 'Kd_Aset2'      => $query->Kd_Aset2, 'Kd_Aset3'      => $query->Kd_Aset3, 'Kd_Aset4'      => $query->Kd_Aset4, 'Kd_Aset5'      => $query->Kd_Aset5, 'No_Register'   => $query->No_Register, 'Kd_Ruang'      => $query->Kd_Ruang, 'Kd_Pemilik'    => $query->Kd_Pemilik, 'Tgl_Dokumen'   => date("Y-m-d"), 'No_Dokumen'    => NULL, 'Tgl_Perolehan' => $query->Tgl_Perolehan, 'Tgl_Pembukuan' => $query->Tgl_Pembukuan, 'Merk'          => $query->Merk, 'Type'          => $query->Type, 'CC'            => $query->CC, 'Bahan'         => $query->Bahan, 'Nomor_Pabrik'  => $query->Nomor_Pabrik, 'Nomor_Rangka'  => $query->Nomor_Rangka, 'Nomor_Mesin'   => $query->Nomor_Mesin, 'Nomor_Polisi'  => $query->Nomor_Polisi, 'Nomor_BPKB'    => $query->Nomor_BPKB, 'Asal_usul'     => $query->Asal_usul, 'Kondisi'       => $query->Kondisi, 'Harga'         => $query->Harga, 'Masa_Manfaat'  => $query->Masa_Manfaat, 'Nilai_Sisa'    => $query->Nilai_Sisa, 'Keterangan'    => $query->Keterangan, 'Tahun'         => $query->Tahun, 'No_SP2D'       => $query->No_SP2D, 'No_ID'         => $query->No_ID, 'Kd_Kecamatan'  => $query->Kd_Kecamatan, 'Kd_Desa'       => $query->Kd_Desa, 'Invent'        => $query->Invent, 'No_SKGuna'     => $query->No_SKGuna, 'Kd_Penyusutan' => $query->Kd_Penyusutan, 'Kd_Data'       => $query->Kd_Data, 'Log_User'      => $query->Log_User, 'Log_entry'     => $query->Log_entry, 'Kd_KA'         => 1); $this->db->insert("Ta_KIBBR", $data); return TRUE; } /** * 08-06-2014 usul guna */ function usul_guna($kd_prov,$kd_kab,$kd_bidang,$kd_unit,$kd_sub,$kd_upb,$kd_aset1,$kd_aset2,$kd_aset3,$kd_aset4,$kd_aset5,$no_register) {$query = $this->db->get_where($this->table, array('Kd_Prov' => $kd_prov,'Kd_Kab_Kota' => $kd_kab,'Kd_Bidang' => $kd_bidang,'Kd_Unit' => $kd_unit,'Kd_Sub' => $kd_sub,'Kd_UPB' => $kd_upb,'Kd_Aset1' => $kd_aset1,'Kd_Aset2' => $kd_aset2,'Kd_Aset3' => $kd_aset3, 'Kd_Aset4' => $kd_aset4,'Kd_Aset5' => $kd_aset5,'No_Register' => $no_register), 1)->row(); $data = array('No_Urut'	=> NULL, 'Kd_Riwayat'	=> 12, 'Kd_Id'	=> 1, 'Kd_Prov'	=> $query->Kd_Prov, 'Kd_Kab_Kota'	=> $query->Kd_Kab_Kota, 'Kd_Bidang'	=> $query->Kd_Bidang, 'Kd_Unit'	=> $query->Kd_Unit, 'Kd_Sub'	=> $query->Kd_Sub, 'Kd_UPB'	=> $query->Kd_UPB, 'Kd_Aset1'	=> $query->Kd_Aset1, 'Kd_Aset2'	=> $query->Kd_Aset2, 'Kd_Aset3'	=> $query->Kd_Aset3, 'Kd_Aset4'	=> $query->Kd_Aset4, 'Kd_Aset5'	=> $query->Kd_Aset5, 'No_Register'	=> $query->No_Register, 'Kd_Ruang'	=> $query->Kd_Ruang, 'Kd_Pemilik'	=> $query->Kd_Pemilik, 'Tgl_Dokumen'	=> date("Y-m-d"), 'No_Dokumen'	=> NULL, 'Tgl_Perolehan'	=> $query->Tgl_Perolehan, 'Tgl_Pembukuan'	=> $query->Tgl_Pembukuan, 'Merk'	=> $query->Merk, 'Type'	=> $query->Type, 'CC'	=> $query->CC, 'Bahan'	=> $query->Bahan, 'Nomor_Pabrik'	=> $query->Nomor_Pabrik, 'Nomor_Rangka'	=> $query->Nomor_Rangka, 'Nomor_Mesin'	=> $query->Nomor_Mesin, 'Nomor_Polisi'	=> $query->Nomor_Polisi, 'Nomor_BPKB'	=> $query->Nomor_BPKB, 'Asal_usul'	=> $query->Asal_usul, 'Kondisi'	=> $query->Kondisi, 'Harga'	=> $query->Harga, 'Masa_Manfaat'	=> $query->Masa_Manfaat, 'Nilai_Sisa'	=> $query->Nilai_Sisa, 'Keterangan'	=> $query->Keterangan, 'Tahun'	=> $query->Tahun, 'No_SP2D'	=> $query->No_SP2D, 'No_ID'	=> $query->No_ID, 'Kd_Kecamatan'	=> $query->Kd_Kecamatan, 'Kd_Desa'	=> $query->Kd_Desa, 'Invent'	=> $query->Invent, 'No_SKGuna'	=> $query->No_SKGuna, 'Kd_Penyusutan'	=> $query->Kd_Penyusutan, 'Kd_Data'	=> $query->Kd_Data, 'Log_User'	=> $query->Log_User, 'Log_entry'	=> $query->Log_entry, 'Kd_KA'		=> 1); $this->db->insert("Ta_KIBBR", $data); return TRUE; } /* 28-03-2014 tambah total kibb*/ function total_kibb() {$arr = array(); $query= "SELECT   DATENAME(yyyy,Tgl_Perolehan) as Tahun, SUM(Harga) AS Harga FROM  Ta_Lainnya INNER JOIN Ref_Rek_Aset5 ON Ta_Lainnya.Kd_Aset1=Ref_Rek_Aset5.Kd_Aset1 AND Ta_Lainnya.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_Lainnya.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_Lainnya.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_Lainnya.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5  WHERE 1=1 "; if ($this->session->userdata('lvl') == 01){$query .= ""; }elseif ($this->session->userdata('lvl') == 02){$query .= "AND (Ta_Lainnya.Kd_Bidang = ".$this->session->userdata('kd_bidang').")"; $query .= "AND (Ta_Lainnya.Kd_Unit = ".$this->session->userdata('kd_unit').")"; $query .= "AND (Ta_Lainnya.Kd_Sub = ".$this->session->userdata('kd_sub_unit').")"; }else{$query .= "AND (Ta_Lainnya.Kd_Bidang = ".$this->session->userdata('kd_bidang').")"; $query .= "AND (Ta_Lainnya.Kd_Unit = ".$this->session->userdata('kd_unit').")"; $query .= "AND (Ta_Lainnya.Kd_Sub = ".$this->session->userdata('kd_sub_unit').")"; $query .= "AND (Ta_Lainnya.Kd_UPB = ".$this->session->userdata('kd_upb').")"; } $query .= "GROUP BY DATENAME(yyyy,Tgl_Perolehan)"; $query .= "ORDER BY Tahun"; $sql = $this->db->query($query); foreach ($sql->result() as $row) {$arr[] = $row->Harga; } return $arr; } function laporan_all_kibb($like){$query = "SELECT   Ref_Rek_Aset5.Nm_Aset5,COUNT(Ta_Lainnya.No_register) as jumlah_register,MIN(Ta_Lainnya.No_register) as min_register, MAX(Ta_Lainnya.No_register) as max_register, Ta_Lainnya.Kd_Prov, Ta_Lainnya.Kd_Kab_Kota, Ta_Lainnya.Kd_Bidang, Ta_Lainnya.Kd_Unit, Ta_Lainnya.Kd_Sub, Ta_Lainnya.Kd_UPB, Ta_Lainnya.Kd_Aset1, Ta_Lainnya.Kd_Aset2, Ta_Lainnya.Kd_Aset3, Ta_Lainnya.Kd_Aset4, Ta_Lainnya.Kd_Aset5, Ta_Lainnya.Kd_Pemilik, Ta_Lainnya.Merk, Ta_Lainnya.Type, Ta_Lainnya.CC, Ta_Lainnya.Bahan, DATENAME(yyyy,Ta_Lainnya.Tgl_Perolehan) as Tahun,Ta_Lainnya.Nomor_Pabrik,Ta_Lainnya.Nomor_Rangka,Ta_Lainnya.Nomor_Mesin, Ta_Lainnya.Nomor_Polisi,Ta_Lainnya.Nomor_BPKB,Ta_Lainnya.Asal_usul,Ta_Lainnya.Kondisi,COUNT(*) as Jumlah, SUM(Ta_Lainnya.Harga) as Harga,Ref_UPB.Nm_UPB FROM  Ta_Lainnya INNER JOIN Ref_Rek_Aset5 ON Ta_Lainnya.Kd_Aset1 = Ref_Rek_Aset5.Kd_Aset1 AND Ta_Lainnya.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_Lainnya.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_Lainnya.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_Lainnya.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 LEFT JOIN Ref_UPB ON Ta_Lainnya.Kd_Bidang=Ref_UPB.Kd_Bidang AND Ta_Lainnya.Kd_Unit=Ref_UPB.Kd_Unit AND Ta_Lainnya.Kd_Sub=Ref_UPB.Kd_Sub AND Ta_Lainnya.Kd_UPB=Ref_UPB.Kd_UPB WHERE $like GROUP BY Ta_Lainnya.Kd_Prov, Ta_Lainnya.Kd_Kab_Kota, Ta_Lainnya.Kd_Bidang, Ta_Lainnya.Kd_Unit, Ta_Lainnya.Kd_Sub, Ta_Lainnya.Kd_UPB, Ta_Lainnya.Kd_Aset1, Ta_Lainnya.Kd_Aset2, Ta_Lainnya.Kd_Aset3, Ta_Lainnya.Kd_Aset4, Ta_Lainnya.Kd_Aset5, Ta_Lainnya.Kd_Pemilik, Ta_Lainnya.Merk, Ta_Lainnya.Type, Ta_Lainnya.CC, Ta_Lainnya.Bahan, Ta_Lainnya.Tgl_Perolehan,Ta_Lainnya.Nomor_Pabrik,Ta_Lainnya.Nomor_Rangka,Ta_Lainnya.Nomor_Mesin,Ta_Lainnya.Nomor_Polisi, Ta_Lainnya.Nomor_BPKB,Ta_Lainnya.Asal_usul,Ta_Lainnya.Kondisi,Ref_Rek_Aset5.Nm_Aset5,Ref_UPB.Nm_UPB ORDER BY  Ref_Rek_Aset5.Nm_Aset5, MIN(Ta_Lainnya.No_register)"; return $this->db->query($query); } function total_laporan_all_kibb($like) {$this->db->select_SUM('Harga'); $this->db->where("$like"); $this->db->from($this->table); $sql = $this->db->get(); foreach ($sql->result() as $row) {$result = $row->Harga; } return $result; } /* total kib b */ /* 02-07-2014 */ function laporan_kodebarang($bidang,$unit,$sub,$upb,$like) {$kb 	=  $this->session->userdata('kd_bidang'); $ku 	=  $this->session->userdata('kd_unit'); $ks 	=  $this->session->userdata('kd_sub_unit'); $kupb 	=  $this->session->userdata('kd_upb'); if ($this->session->userdata('lvl') == 01){$where = "(Ta_Lainnya.Kd_Bidang = $bidang) AND (Ta_Lainnya.Kd_Unit = $unit) AND (Ta_Lainnya.Kd_Sub = $sub) AND (Ta_Lainnya.Kd_UPB = $upb) AND"; }elseif ($this->session->userdata('lvl') == 02){$where = "(Ta_Lainnya.Kd_Bidang = $kb ) AND (Ta_Lainnya.Kd_Unit =$ku ) AND (Ta_Lainnya.Kd_Sub = $ks) AND (Ta_Lainnya.Kd_UPB = $upb) AND"; }else{$where = "(Ta_Lainnya.Kd_Bidang = $kb) AND (Ta_Lainnya.Kd_Unit = $ku) AND (Ta_Lainnya.Kd_Sub = $ks) AND (Ta_Lainnya.Kd_UPB = $kupb) AND"; } $query = "select Ref_Rek_Aset5.Kd_Aset1,Ref_Rek_Aset5.Kd_Aset2,Ref_Rek_Aset5.Kd_Aset3,Ref_Rek_Aset5.Kd_Aset4,Ref_Rek_Aset5.Kd_Aset5, Nm_Aset5,COUNT(*) as Jumlah, SUM(Harga) as Harga from Ref_Rek_Aset5 RIGHT JOIN Ta_Lainnya ON Ta_Lainnya.Kd_Aset1=Ref_Rek_Aset5.Kd_Aset1 AND Ta_Lainnya.Kd_Aset2=Ref_Rek_Aset5.Kd_Aset2 AND Ta_Lainnya.Kd_Aset3=Ref_Rek_Aset5.Kd_Aset3 AND Ta_Lainnya.Kd_Aset4=Ref_Rek_Aset5.Kd_Aset4 AND Ta_Lainnya.Kd_Aset5=Ref_Rek_Aset5.Kd_Aset5  WHERE $where $like GROUP BY Ref_Rek_Aset5.Kd_Aset1,Ref_Rek_Aset5.Kd_Aset2,Ref_Rek_Aset5.Kd_Aset3, Ref_Rek_Aset5.Kd_Aset4,Ref_Rek_Aset5.Kd_Aset5,Nm_Aset5 ORDER BY Ref_Rek_Aset5.Kd_Aset1,Ref_Rek_Aset5.Kd_Aset2,Ref_Rek_Aset5.Kd_Aset3, Ref_Rek_Aset5.Kd_Aset4,Ref_Rek_Aset5.Kd_Aset5"; return $this->db->query($query); } /** * Tampilkan total_pengadaan */ function total_kodebarang($bidang,$unit,$sub,$upb,$like) {if ($this->session->userdata('lvl') == 01){$this->db->where('Kd_Bidang',$bidang); $this->db->where('Kd_Unit',$unit); $this->db->where('Kd_Sub',$sub); $this->db->where('Kd_UPB',$upb); }elseif ($this->session->userdata('lvl') == 02){$this->db->where('Kd_Bidang',$this->session->userdata('kd_bidang')); $this->db->where('Kd_Unit',$this->session->userdata('kd_unit')); $this->db->where('Kd_Sub',$this->session->userdata('kd_sub_unit')); $this->db->where('Kd_UPB',$upb); }else{$this->db->where('Kd_Bidang',$this->session->userdata('kd_bidang')); $this->db->where('Kd_Unit',$this->session->userdata('kd_unit')); $this->db->where('Kd_Sub',$this->session->userdata('kd_sub_unit')); $this->db->where('Kd_UPB',$this->session->userdata('kd_upb')); } $this->db->select_SUM('Harga'); $this->db->where("$like"); $this->db->from($this->table); $sql = $this->db->get(); foreach ($sql->result() as $row) {$result = $row->Harga; } return $result; } /* 02-07-2014 */ /** * Menampilkan laporan usul guna */ function laporan_usulguna($bidang,$unit,$sub,$upb,$like) {$kb 	=  $this->session->userdata('kd_bidang'); $ku 	=  $this->session->userdata('kd_unit'); $ks 	=  $this->session->userdata('kd_sub_unit'); $kupb 	=  $this->session->userdata('kd_upb'); if ($this->session->userdata('lvl') == 01){$where = "(Ta_KIBBR.Kd_Bidang = $bidang) AND (Ta_KIBBR.Kd_Unit = $unit) AND (Ta_KIBBR.Kd_Sub = $sub) AND (Ta_KIBBR.Kd_UPB = $upb) AND"; }elseif ($this->session->userdata('lvl') == 02){$where = "(Ta_KIBBR.Kd_Bidang = $kb ) AND (Ta_KIBBR.Kd_Unit =$ku ) AND (Ta_KIBBR.Kd_Sub = $ks) AND (Ta_KIBBR.Kd_UPB = $upb) AND"; }else{$where = "(Ta_KIBBR.Kd_Bidang = $kb) AND (Ta_KIBBR.Kd_Unit = $ku) AND (Ta_KIBBR.Kd_Sub = $ks) AND (Ta_KIBBR.Kd_UPB = $kupb) AND"; } $query = "SELECT  Ref_Rek_Aset5.Nm_Aset5,Ta_KIBBR.Kd_Prov, Ta_KIBBR.Kd_Kab_Kota, Ta_KIBBR.Kd_Bidang, Ta_KIBBR.Kd_Unit, Ta_KIBBR.Kd_Sub, Ta_KIBBR.Kd_UPB, Ta_KIBBR.Kd_Aset1, Ta_KIBBR.Kd_Aset2, Ta_KIBBR.Kd_Aset3, Ta_KIBBR.Kd_Aset4, Ta_KIBBR.Kd_Aset5, Ta_KIBBR.Kd_Pemilik, Ta_KIBBR.Merk, Ta_KIBBR.Type, Ta_KIBBR.CC, Ta_KIBBR.Bahan, Ta_KIBBR.Nomor_Pabrik,SUM(Ta_KIBBR.Harga) as Harga, Ta_KIBBR.Masa_Manfaat,Ta_KIBBR.Keterangan,DATENAME(yyyy,Ta_KIBBR.Tgl_Perolehan) as Tahun, count(case when Kondisi = 1 then 1 else null end) as Baik, count(case when Kondisi = 2 then 1 else null end) as Kurang_baik, count(case when Kondisi = 3 then 1 else null end) as Rusak, COUNT(Kondisi) as Jumlah_Data FROM  Ta_KIBBR INNER JOIN Ref_Rek_Aset5 ON Ta_KIBBR.Kd_Aset1 = Ref_Rek_Aset5.Kd_Aset1 AND Ta_KIBBR.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_KIBBR.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_KIBBR.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_KIBBR.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 WHERE   $where $like AND Kd_Riwayat=12 GROUP BY Ta_KIBBR.Kd_Prov, Ta_KIBBR.Kd_Kab_Kota, Ta_KIBBR.Kd_Bidang, Ta_KIBBR.Kd_Unit, Ta_KIBBR.Kd_Sub, Ta_KIBBR.Kd_UPB, Ta_KIBBR.Kd_Aset1, Ta_KIBBR.Kd_Aset2, Ta_KIBBR.Kd_Aset3, Ta_KIBBR.Kd_Aset4, Ta_KIBBR.Kd_Aset5, Ta_KIBBR.Kd_Pemilik, Ta_KIBBR.Merk, Ta_KIBBR.Type, Ta_KIBBR.CC, Ta_KIBBR.Bahan, Ta_KIBBR.Nomor_Pabrik, Ta_KIBBR.Masa_Manfaat,Ta_KIBBR.Keterangan,Ref_Rek_Aset5.Nm_Aset5,Ta_KIBBR.Tgl_Perolehan"; return $this->db->query($query); } /** * Tampilkan total_pengadaan */ function total_usulguna($bidang,$unit,$sub,$upb,$like) {if ($this->session->userdata('lvl') == 01){$this->db->where('Kd_Bidang',$bidang); $this->db->where('Kd_Unit',$unit); $this->db->where('Kd_Sub',$sub); $this->db->where('Kd_UPB',$upb); }elseif ($this->session->userdata('lvl') == 02){$this->db->where('Kd_Bidang',$this->session->userdata('kd_bidang')); $this->db->where('Kd_Unit',$this->session->userdata('kd_unit')); $this->db->where('Kd_Sub',$this->session->userdata('kd_sub_unit')); $this->db->where('Kd_UPB',$upb); }else{$this->db->where('Kd_Bidang',$this->session->userdata('kd_bidang')); $this->db->where('Kd_Unit',$this->session->userdata('kd_unit')); $this->db->where('Kd_Sub',$this->session->userdata('kd_sub_unit')); $this->db->where('Kd_UPB',$this->session->userdata('kd_upb')); } $this->db->select_SUM('Harga'); $this->db->where("$like"); $this->db->where('Kd_Riwayat = 12'); $this->db->from('Ta_KIBBR'); $sql = $this->db->get(); foreach ($sql->result() as $row) {$result = $row->Harga; } return $result; } function laporan_ekstrakomptabel($bidang,$unit,$sub,$upb,$like) {$kb 	=  $this->session->userdata('kd_bidang'); $ku 	=  $this->session->userdata('kd_unit'); $ks 	=  $this->session->userdata('kd_sub_unit'); $kupb 	=  $this->session->userdata('kd_upb'); if ($this->session->userdata('lvl') == 01){$where = "(Ta_Lainnya.Kd_Bidang = $bidang) AND (Ta_Lainnya.Kd_Unit = $unit) AND (Ta_Lainnya.Kd_Sub = $sub) AND (Ta_Lainnya.Kd_UPB = $upb) AND"; }elseif ($this->session->userdata('lvl') == 02){$where = "(Ta_Lainnya.Kd_Bidang = $kb ) AND (Ta_Lainnya.Kd_Unit =$ku ) AND (Ta_Lainnya.Kd_Sub = $ks) AND (Ta_Lainnya.Kd_UPB = $upb) AND"; }else{$where = "(Ta_Lainnya.Kd_Bidang = $kb) AND (Ta_Lainnya.Kd_Unit = $ku) AND (Ta_Lainnya.Kd_Sub = $ks) AND (Ta_Lainnya.Kd_UPB = $kupb) AND"; } $query = "SELECT  Ref_Rek_Aset5.Nm_Aset5,Ta_Lainnya.Kd_Prov, Ta_Lainnya.Kd_Kab_Kota, Ta_Lainnya.Kd_Bidang, Ta_Lainnya.Kd_Unit, Ta_Lainnya.Kd_Sub, Ta_Lainnya.Kd_UPB, Ta_Lainnya.Kd_Aset1, Ta_Lainnya.Kd_Aset2, Ta_Lainnya.Kd_Aset3, Ta_Lainnya.Kd_Aset4, Ta_Lainnya.Kd_Aset5, Ta_Lainnya.Kd_Pemilik, Ta_Lainnya.Merk, Ta_Lainnya.Type, Ta_Lainnya.CC, Ta_Lainnya.Bahan, Ta_Lainnya.Nomor_Pabrik,SUM(Ta_Lainnya.Harga) as Harga, Ta_Lainnya.Masa_Manfaat,Ta_Lainnya.Keterangan,DATENAME(yyyy,Ta_Lainnya.Tgl_Perolehan) as Tahun, count(case when Kondisi = 1 then 1 else null end) as Baik, count(case when Kondisi = 2 then 1 else null end) as Kurang_baik, count(case when Kondisi = 3 then 1 else null end) as Rusak, COUNT(Kondisi) as Jumlah_Data FROM  Ta_Lainnya INNER JOIN Ref_Rek_Aset5 ON Ta_Lainnya.Kd_Aset1 = Ref_Rek_Aset5.Kd_Aset1 AND Ta_Lainnya.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_Lainnya.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_Lainnya.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_Lainnya.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 WHERE 1=1"; $query .= "AND $where $like"; $query .= "AND Harga <= '300000'"; $query .= "GROUP BY Ta_Lainnya.Kd_Prov, Ta_Lainnya.Kd_Kab_Kota, Ta_Lainnya.Kd_Bidang, Ta_Lainnya.Kd_Unit, Ta_Lainnya.Kd_Sub, Ta_Lainnya.Kd_UPB, Ta_Lainnya.Kd_Aset1, Ta_Lainnya.Kd_Aset2, Ta_Lainnya.Kd_Aset3, Ta_Lainnya.Kd_Aset4, Ta_Lainnya.Kd_Aset5, Ta_Lainnya.Kd_Pemilik, Ta_Lainnya.Merk, Ta_Lainnya.Type, Ta_Lainnya.CC, Ta_Lainnya.Bahan, Ta_Lainnya.Nomor_Pabrik, Ta_Lainnya.Masa_Manfaat,Ta_Lainnya.Keterangan,Ref_Rek_Aset5.Nm_Aset5,Ta_Lainnya.Tgl_Perolehan"; return $this->db->query($query); } /** * Tampilkan total_pengadaan */ function total_ekstrakomptabel($bidang,$unit,$sub,$upb,$like) {if ($this->session->userdata('lvl') == 01){$this->db->where('Kd_Bidang',$bidang); $this->db->where('Kd_Unit',$unit); $this->db->where('Kd_Sub',$sub); $this->db->where('Kd_UPB',$upb); }elseif ($this->session->userdata('lvl') == 02){$this->db->where('Kd_Bidang',$this->session->userdata('kd_bidang')); $this->db->where('Kd_Unit',$this->session->userdata('kd_unit')); $this->db->where('Kd_Sub',$this->session->userdata('kd_sub_unit')); $this->db->where('Kd_UPB',$upb); }else{$this->db->where('Kd_Bidang',$this->session->userdata('kd_bidang')); $this->db->where('Kd_Unit',$this->session->userdata('kd_unit')); $this->db->where('Kd_Sub',$this->session->userdata('kd_sub_unit')); $this->db->where('Kd_UPB',$this->session->userdata('kd_upb')); } $this->db->select_SUM('Harga'); $this->db->where("$like"); $this->db->where("Harga <= '300000'"); $this->db->from($this->table); $sql = $this->db->get(); foreach ($sql->result() as $row) {$result = $row->Harga; } return $result; } function laporan_ekstrakomptabel_skpd($like){$query = "SELECT  Ref_Rek_Aset5.Nm_Aset5,Ta_Lainnya.Kd_Prov, Ta_Lainnya.Kd_Kab_Kota, Ta_Lainnya.Kd_Bidang, Ta_Lainnya.Kd_Unit, Ta_Lainnya.Kd_Sub, Ta_Lainnya.Kd_UPB, Ta_Lainnya.Kd_Aset1, Ta_Lainnya.Kd_Aset2, Ta_Lainnya.Kd_Aset3, Ta_Lainnya.Kd_Aset4, Ta_Lainnya.Kd_Aset5, Ta_Lainnya.Kd_Pemilik, Ta_Lainnya.Merk, Ta_Lainnya.Type, Ta_Lainnya.CC, Ta_Lainnya.Bahan, Ta_Lainnya.Nomor_Pabrik,SUM(Ta_Lainnya.Harga) as Harga, Ta_Lainnya.Masa_Manfaat,Ref_UPB.Nm_UPB,DATENAME(yyyy,Ta_Lainnya.Tgl_Perolehan) as Tahun, count(case when Kondisi = 1 then 1 else null end) as Baik, count(case when Kondisi = 2 then 1 else null end) as Kurang_baik, count(case when Kondisi = 3 then 1 else null end) as Rusak, COUNT(Kondisi) as Jumlah_Data FROM  Ta_Lainnya INNER JOIN Ref_Rek_Aset5 ON Ta_Lainnya.Kd_Aset1 = Ref_Rek_Aset5.Kd_Aset1 AND Ta_Lainnya.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_Lainnya.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_Lainnya.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_Lainnya.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 LEFT JOIN Ref_UPB ON Ta_Lainnya.Kd_Bidang=Ref_UPB.Kd_Bidang AND Ta_Lainnya.Kd_Unit=Ref_UPB.Kd_Unit AND Ta_Lainnya.Kd_Sub=Ref_UPB.Kd_Sub AND Ta_Lainnya.Kd_UPB=Ref_UPB.Kd_UPB WHERE $like AND Harga <= '300000'GROUP BY Ta_Lainnya.Kd_Prov, Ta_Lainnya.Kd_Kab_Kota, Ta_Lainnya.Kd_Bidang, Ta_Lainnya.Kd_Unit, Ta_Lainnya.Kd_Sub, Ta_Lainnya.Kd_UPB, Ta_Lainnya.Kd_Aset1, Ta_Lainnya.Kd_Aset2, Ta_Lainnya.Kd_Aset3, Ta_Lainnya.Kd_Aset4, Ta_Lainnya.Kd_Aset5, Ta_Lainnya.Kd_Pemilik, Ta_Lainnya.Merk, Ta_Lainnya.Type, Ta_Lainnya.CC, Ta_Lainnya.Bahan, Ta_Lainnya.Nomor_Pabrik, Ta_Lainnya.Masa_Manfaat,Ref_UPB.Nm_UPB,Ref_Rek_Aset5.Nm_Aset5,Ta_Lainnya.Tgl_Perolehan"; return $this->db->query($query); } function total_ekstrakomptabel_skpd($like){$this->db->select_SUM('Harga'); $this->db->where("$like"); $this->db->where("Harga <= '300000'"); $this->db->from($this->table); $sql = $this->db->get(); foreach ($sql->result() as $row) {$result = $row->Harga; } return $result; } function laporan_skguna($like){$query = "SELECT  Ref_Rek_Aset5.Nm_Aset5,Ta_KIBBR.Kd_Prov, Ta_KIBBR.Kd_Kab_Kota, Ta_KIBBR.Kd_Bidang, Ta_KIBBR.Kd_Unit, Ta_KIBBR.Kd_Sub, Ta_KIBBR.Kd_UPB, Ta_KIBBR.Kd_Aset1, Ta_KIBBR.Kd_Aset2, Ta_KIBBR.Kd_Aset3, Ta_KIBBR.Kd_Aset4, Ta_KIBBR.Kd_Aset5, Ta_KIBBR.Kd_Pemilik, Ta_KIBBR.Merk, Ta_KIBBR.Type, Ta_KIBBR.CC, Ta_KIBBR.Bahan, Ta_KIBBR.Nomor_Pabrik,SUM(Ta_KIBBR.Harga) as Harga,DATENAME(yyyy,Ta_KIBBR.Tgl_Perolehan) as Tahun, count(case when Kondisi = 1 then 1 else null end) as Baik, count(case when Kondisi = 2 then 1 else null end) as Kurang_baik, count(case when Kondisi = 3 then 1 else null end) as Rusak, COUNT(Kondisi) as Jumlah_Data,Nm_UPB FROM  Ta_KIBBR INNER JOIN Ref_Rek_Aset5 ON Ta_KIBBR.Kd_Aset1 = Ref_Rek_Aset5.Kd_Aset1 AND Ta_KIBBR.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_KIBBR.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_KIBBR.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_KIBBR.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 INNER JOIN Ref_UPB ON Ta_KIBBR.Kd_Bidang=Ref_UPB.Kd_Bidang AND Ta_KIBBR.Kd_Unit=Ref_UPB.Kd_Unit AND Ta_KIBBR.Kd_Sub=Ref_UPB.Kd_Sub AND Ta_KIBBR.Kd_UPB=Ref_UPB.Kd_UPB WHERE   $like AND Kd_Riwayat=12 GROUP BY Ta_KIBBR.Kd_Prov, Ta_KIBBR.Kd_Kab_Kota, Ta_KIBBR.Kd_Bidang, Ta_KIBBR.Kd_Unit, Ta_KIBBR.Kd_Sub, Ta_KIBBR.Kd_UPB, Ta_KIBBR.Kd_Aset1, Ta_KIBBR.Kd_Aset2, Ta_KIBBR.Kd_Aset3, Ta_KIBBR.Kd_Aset4, Ta_KIBBR.Kd_Aset5, Ta_KIBBR.Kd_Pemilik, Ta_KIBBR.Merk, Ta_KIBBR.Type, Ta_KIBBR.CC, Ta_KIBBR.Bahan, Ta_KIBBR.Nomor_Pabrik,Ref_Rek_Aset5.Nm_Aset5,Ta_KIBBR.Tgl_Perolehan,Nm_UPB"; return $this->db->query($query); } function total_skguna($like){$this->db->select_SUM('Harga'); $this->db->where("$like"); $this->db->where('Kd_Riwayat = 12'); $this->db->from("Ta_KIBBR"); $sql = $this->db->get(); foreach ($sql->result() as $row) {$result = $row->Harga; } return $result; } function laporan_skhapus($like){$query = "SELECT  Ref_Rek_Aset5.Nm_Aset5,Ta_KIBBR.Kd_Prov, Ta_KIBBR.Kd_Kab_Kota, Ta_KIBBR.Kd_Bidang, Ta_KIBBR.Kd_Unit, Ta_KIBBR.Kd_Sub, Ta_KIBBR.Kd_UPB, Ta_KIBBR.Kd_Aset1, Ta_KIBBR.Kd_Aset2, Ta_KIBBR.Kd_Aset3, Ta_KIBBR.Kd_Aset4, Ta_KIBBR.Kd_Aset5, Ta_KIBBR.Kd_Pemilik, Ta_KIBBR.Merk, Ta_KIBBR.Type, Ta_KIBBR.CC, Ta_KIBBR.Bahan, Ta_KIBBR.Nomor_Pabrik,SUM(Ta_KIBBR.Harga) as Harga,DATENAME(yyyy,Ta_KIBBR.Tgl_Perolehan) as Tahun, count(case when Kondisi = 1 then 1 else null end) as Baik, count(case when Kondisi = 2 then 1 else null end) as Kurang_baik, count(case when Kondisi = 3 then 1 else null end) as Rusak, COUNT(Kondisi) as Jumlah_Data,Nm_UPB FROM  Ta_KIBBR INNER JOIN Ref_Rek_Aset5 ON Ta_KIBBR.Kd_Aset1 = Ref_Rek_Aset5.Kd_Aset1 AND Ta_KIBBR.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_KIBBR.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_KIBBR.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_KIBBR.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 INNER JOIN Ref_UPB ON Ta_KIBBR.Kd_Bidang=Ref_UPB.Kd_Bidang AND Ta_KIBBR.Kd_Unit=Ref_UPB.Kd_Unit AND Ta_KIBBR.Kd_Sub=Ref_UPB.Kd_Sub AND Ta_KIBBR.Kd_UPB=Ref_UPB.Kd_UPB WHERE   $like AND Kd_Riwayat=7 GROUP BY Ta_KIBBR.Kd_Prov, Ta_KIBBR.Kd_Kab_Kota, Ta_KIBBR.Kd_Bidang, Ta_KIBBR.Kd_Unit, Ta_KIBBR.Kd_Sub, Ta_KIBBR.Kd_UPB, Ta_KIBBR.Kd_Aset1, Ta_KIBBR.Kd_Aset2, Ta_KIBBR.Kd_Aset3, Ta_KIBBR.Kd_Aset4, Ta_KIBBR.Kd_Aset5, Ta_KIBBR.Kd_Pemilik, Ta_KIBBR.Merk, Ta_KIBBR.Type, Ta_KIBBR.CC, Ta_KIBBR.Bahan, Ta_KIBBR.Nomor_Pabrik,Ref_Rek_Aset5.Nm_Aset5,Ta_KIBBR.Tgl_Perolehan,Nm_UPB"; return $this->db->query($query); } function total_skhapus($like){$this->db->select_SUM('Harga'); $this->db->where("$like"); $this->db->where('Kd_Riwayat = 7'); $this->db->from("Ta_KIBBR"); $sql = $this->db->get(); foreach ($sql->result() as $row) {$result = $row->Harga; } return $result; } function laporan_usulhapus($bidang,$unit,$sub,$upb,$like) {$kb 	=  $this->session->userdata('kd_bidang'); $ku 	=  $this->session->userdata('kd_unit'); $ks 	=  $this->session->userdata('kd_sub_unit'); $kupb 	=  $this->session->userdata('kd_upb'); if ($this->session->userdata('lvl') == 01){$where = "(Ta_KIBBR.Kd_Bidang = $bidang) AND (Ta_KIBBR.Kd_Unit = $unit) AND (Ta_KIBBR.Kd_Sub = $sub) AND (Ta_KIBBR.Kd_UPB = $upb) AND"; }elseif ($this->session->userdata('lvl') == 02){$where = "(Ta_KIBBR.Kd_Bidang = $kb ) AND (Ta_KIBBR.Kd_Unit =$ku ) AND (Ta_KIBBR.Kd_Sub = $ks) AND (Ta_KIBBR.Kd_UPB = $upb) AND"; }else{$where = "(Ta_KIBBR.Kd_Bidang = $kb) AND (Ta_KIBBR.Kd_Unit = $ku) AND (Ta_KIBBR.Kd_Sub = $ks) AND (Ta_KIBBR.Kd_UPB = $kupb) AND"; } $query = "SELECT  Ref_Rek_Aset5.Nm_Aset5,Ta_KIBBR.Kd_Prov, Ta_KIBBR.Kd_Kab_Kota, Ta_KIBBR.Kd_Bidang, Ta_KIBBR.Kd_Unit, Ta_KIBBR.Kd_Sub, Ta_KIBBR.Kd_UPB, Ta_KIBBR.Kd_Aset1, Ta_KIBBR.Kd_Aset2, Ta_KIBBR.Kd_Aset3, Ta_KIBBR.Kd_Aset4, Ta_KIBBR.Kd_Aset5, Ta_KIBBR.Kd_Pemilik, Ta_KIBBR.Merk, Ta_KIBBR.Type, Ta_KIBBR.CC, Ta_KIBBR.Bahan, Ta_KIBBR.Nomor_Pabrik,SUM(Ta_KIBBR.Harga) as Harga, Ta_KIBBR.Masa_Manfaat,Ta_KIBBR.Keterangan,DATENAME(yyyy,Ta_KIBBR.Tgl_Perolehan) as Tahun, count(case when Kondisi = 1 then 1 else null end) as Baik, count(case when Kondisi = 2 then 1 else null end) as Kurang_baik, count(case when Kondisi = 3 then 1 else null end) as Rusak, COUNT(Kondisi) as Jumlah_Data FROM  Ta_KIBBR INNER JOIN Ref_Rek_Aset5 ON Ta_KIBBR.Kd_Aset1 = Ref_Rek_Aset5.Kd_Aset1 AND Ta_KIBBR.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_KIBBR.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_KIBBR.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_KIBBR.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 WHERE   $like AND Kd_Riwayat=7 GROUP BY Ta_KIBBR.Kd_Prov, Ta_KIBBR.Kd_Kab_Kota, Ta_KIBBR.Kd_Bidang, Ta_KIBBR.Kd_Unit, Ta_KIBBR.Kd_Sub, Ta_KIBBR.Kd_UPB, Ta_KIBBR.Kd_Aset1, Ta_KIBBR.Kd_Aset2, Ta_KIBBR.Kd_Aset3, Ta_KIBBR.Kd_Aset4, Ta_KIBBR.Kd_Aset5, Ta_KIBBR.Kd_Pemilik, Ta_KIBBR.Merk, Ta_KIBBR.Type, Ta_KIBBR.CC, Ta_KIBBR.Bahan, Ta_KIBBR.Nomor_Pabrik, Ta_KIBBR.Masa_Manfaat,Ta_KIBBR.Keterangan,Ref_Rek_Aset5.Nm_Aset5,Ta_KIBBR.Tgl_Perolehan"; return $this->db->query($query); } /** * Tampilkan total_pengadaan */ function total_usulhapus($bidang,$unit,$sub,$upb,$like) {if ($this->session->userdata('lvl') == 01){$this->db->where('Kd_Bidang',$bidang); $this->db->where('Kd_Unit',$unit); $this->db->where('Kd_Sub',$sub); $this->db->where('Kd_UPB',$upb); }elseif ($this->session->userdata('lvl') == 02){$this->db->where('Kd_Bidang',$this->session->userdata('kd_bidang')); $this->db->where('Kd_Unit',$this->session->userdata('kd_unit')); $this->db->where('Kd_Sub',$this->session->userdata('kd_sub_unit')); $this->db->where('Kd_UPB',$upb); }else{$this->db->where('Kd_Bidang',$this->session->userdata('kd_bidang')); $this->db->where('Kd_Unit',$this->session->userdata('kd_unit')); $this->db->where('Kd_Sub',$this->session->userdata('kd_sub_unit')); $this->db->where('Kd_UPB',$this->session->userdata('kd_upb')); } $this->db->select_SUM('Harga'); $this->db->where("$like"); $this->db->where('Kd_Riwayat = 7'); $this->db->from('Ta_KIBBR'); $sql = $this->db->get(); foreach ($sql->result() as $row) {$result = $row->Harga; } return $result; } function lainnya_mutasi_barang($like) {$query = "SELECT Nm_UPB, Ref_Rek_Aset5.Nm_Aset5,COUNT(Ta_Lainnya.No_register) as jumlah_register,MIN(Ta_Lainnya.No_register) as min_register, MAX(Ta_Lainnya.No_register) as max_register, Ta_Lainnya.Kd_Prov, Ta_Lainnya.Kd_Kab_Kota, Ta_Lainnya.Kd_Bidang, Ta_Lainnya.Kd_Unit, Ta_Lainnya.Kd_Sub, Ta_Lainnya.Kd_UPB, Ta_Lainnya.Kd_Aset1, Ta_Lainnya.Kd_Aset2, Ta_Lainnya.Kd_Aset3, Ta_Lainnya.Kd_Aset4, Ta_Lainnya.Kd_Aset5, Ta_Lainnya.Kd_Pemilik, Ta_Lainnya.Merk, Ta_Lainnya.Type, Ta_Lainnya.CC, Ta_Lainnya.Bahan, DATENAME(yyyy,Ta_Lainnya.Tgl_Perolehan) as Tahun,Ta_Lainnya.Nomor_Pabrik,Ta_Lainnya.Nomor_Rangka,Ta_Lainnya.Nomor_Mesin, Ta_Lainnya.Nomor_Polisi,Ta_Lainnya.Nomor_BPKB,Ta_Lainnya.Asal_usul,Ta_Lainnya.Kondisi,COUNT(*) as Jumlah, SUM(Ta_Lainnya.Harga) as Harga,Ta_Lainnya.Keterangan FROM Ta_Lainnya INNER JOIN Ref_Rek_Aset5 ON Ta_Lainnya.Kd_Aset1 = Ref_Rek_Aset5.Kd_Aset1 AND Ta_Lainnya.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_Lainnya.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_Lainnya.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_Lainnya.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 INNER JOIN Ref_UPB ON Ta_Lainnya.Kd_Bidang=Ref_UPB.Kd_Bidang AND Ta_Lainnya.Kd_Unit=Ref_UPB.Kd_Unit AND Ta_Lainnya.Kd_Sub=Ref_UPB.Kd_Sub AND Ta_Lainnya.Kd_UPB=Ref_UPB.Kd_UPB  WHERE $like GROUP BY Ta_Lainnya.Kd_Prov, Ta_Lainnya.Kd_Kab_Kota, Ta_Lainnya.Kd_Bidang, Ta_Lainnya.Kd_Unit, Ta_Lainnya.Kd_Sub, Ta_Lainnya.Kd_UPB, Ta_Lainnya.Kd_Aset1, Ta_Lainnya.Kd_Aset2, Ta_Lainnya.Kd_Aset3, Ta_Lainnya.Kd_Aset4, Ta_Lainnya.Kd_Aset5, Ta_Lainnya.Kd_Pemilik, Ta_Lainnya.Merk, Ta_Lainnya.Type, Ta_Lainnya.CC, Ta_Lainnya.Bahan, Ta_Lainnya.Tgl_Perolehan, Ta_Lainnya.Nomor_Pabrik,Ta_Lainnya.Nomor_Rangka,Ta_Lainnya.Nomor_Mesin,Ta_Lainnya.Nomor_Polisi, Ta_Lainnya.Nomor_BPKB,Ta_Lainnya.Asal_usul, Ta_Lainnya.Kondisi,Ta_Lainnya.Keterangan,Ref_Rek_Aset5.Nm_Aset5,Nm_UPB ORDER BY Ref_Rek_Aset5.Nm_Aset5, MIN(Ta_Lainnya.No_register)"; return $this->db->query($query); } /** * Total Data Mutasi */ function total_lainnya_mutasi_barang($like){$query = "SELECT COUNT(*) as Jumlah, SUM(Harga) as Harga FROM Ta_Lainnya where Kd_Aset1=2 AND $like"; return $this->db->query($query); } function rekap_mutasi_induk($like,$tahunawal,$tahunakhir)  {$query = "SELECT Ref_Rek_Aset2.Kd_Aset1, Ref_Rek_Aset2.Kd_Aset2, Nm_Aset2, COUNT(case when Tgl_Perolehan < '$tahunawal' then 1 else NULL end) as Jumlah_awal, SUM(CASE WHEN Tgl_Perolehan < '$tahunawal' THEN Harga else 0 END) as Harga_awal, COUNT(case WHEN $like then 0 else null end) as Jumlah_tambah, SUM(CASE WHEN $like THEN Harga END) as Harga_tambah FROM Ref_Rek_Aset2 LEFT JOIN (SELECT * FROM Ta_Lainnya ) AS Ta_Lainnya ON Ta_Lainnya.Kd_Aset1 = Ref_Rek_Aset2.Kd_Aset1 AND Ta_Lainnya.Kd_Aset2 = Ref_Rek_Aset2.Kd_Aset2 WHERE Ref_Rek_Aset2.Kd_Aset1 = 2 GROUP BY Ref_Rek_Aset2.Kd_Aset1, Ref_Rek_Aset2.Kd_Aset2, Nm_Aset2 ORDER BY Ref_Rek_Aset2.Kd_Aset2"; return $this->db->query($query); } function total_rekap_mutasi_induk($like,$tahunawal,$tahunakhir) {$query = "SELECT COUNT(case when Tgl_Perolehan < '$tahunawal' then 1 else NULL end) as Jumlah_awal, SUM(CASE WHEN Tgl_Perolehan < '$tahunawal' THEN Harga else 0 END) as Harga_awal, COUNT(case WHEN $like then 0 else null end) as Jumlah_tambah, SUM(CASE WHEN $like THEN Harga END) as Harga_tambah, COUNT(case when Tgl_Perolehan <= '$tahunakhir' then 1 else NULL end) as Jumlah, SUM(CASE WHEN Tgl_Perolehan <= '$tahunakhir' THEN Harga else 0 END) as Harga FROM Ref_Rek_Aset2 LEFT JOIN (SELECT * FROM Ta_Lainnya ) AS Ta_Lainnya ON Ta_Lainnya.Kd_Aset1 = Ref_Rek_Aset2.Kd_Aset1 AND Ta_Lainnya.Kd_Aset2 = Ref_Rek_Aset2.Kd_Aset2 WHERE Ref_Rek_Aset2.Kd_Aset1 = 2"; return $this->db->query($query); } function lainnya_rinventaris_rekap($like) {$where = "$like"; $query = "select Ref_Rek_Aset2.Kd_Aset1,Ref_Rek_Aset2.Kd_Aset2,Nm_Aset2,COUNT(*) as Jumlah, SUM(Harga) as Harga from Ref_Rek_Aset2 LEFT JOIN (SELECT * from Ta_Lainnya where $where ) as Ta_Lainnya ON Ta_Lainnya.Kd_Aset1=Ref_Rek_Aset2.Kd_Aset1 AND Ta_Lainnya.Kd_Aset2=Ref_Rek_Aset2.Kd_Aset2 WHERE Ref_Rek_Aset2.Kd_Aset1=2 GROUP BY Ref_Rek_Aset2.Kd_Aset1,Ref_Rek_Aset2.Kd_Aset2,Nm_Aset2 "; return $this->db->query($query); } function total_lainnya_rinventaris_rekap($like){$where = "$like"; $query = "SELECT COUNT(*) as Jumlah,SUM(Harga) as Harga FROM Ta_Lainnya where Kd_Aset1=2 AND $where"; return $this->db->query($query); } /* 06-07-2014 */ function laporan_all_rkodebarang($like){$query = "SELECT Ref_Rek_Aset5.Kd_Aset1,Ref_Rek_Aset5.Kd_Aset2,Ref_Rek_Aset5.Kd_Aset3, Ref_Rek_Aset5.Kd_Aset4,Ref_Rek_Aset5.Kd_Aset5, Nm_Aset5,COUNT(*) as Jumlah, SUM(Harga) as Harga,Nm_UPB from Ref_Rek_Aset5 RIGHT JOIN Ta_Lainnya ON Ta_Lainnya.Kd_Aset1=Ref_Rek_Aset5.Kd_Aset1 AND Ta_Lainnya.Kd_Aset2=Ref_Rek_Aset5.Kd_Aset2 AND Ta_Lainnya.Kd_Aset3=Ref_Rek_Aset5.Kd_Aset3 AND Ta_Lainnya.Kd_Aset4=Ref_Rek_Aset5.Kd_Aset4 AND Ta_Lainnya.Kd_Aset5=Ref_Rek_Aset5.Kd_Aset5 LEFT JOIN Ref_UPB ON Ta_Lainnya.Kd_Bidang=Ref_UPB.Kd_Bidang AND Ta_Lainnya.Kd_Unit=Ref_UPB.Kd_Unit AND Ta_Lainnya.Kd_Sub=Ref_UPB.Kd_Sub AND Ta_Lainnya.Kd_UPB=Ref_UPB.Kd_UPB WHERE $like GROUP BY Ref_Rek_Aset5.Kd_Aset1,Ref_Rek_Aset5.Kd_Aset2,Ref_Rek_Aset5.Kd_Aset3, Ref_Rek_Aset5.Kd_Aset4,Ref_Rek_Aset5.Kd_Aset5,Nm_Aset5,Nm_UPB ORDER BY Ref_Rek_Aset5.Kd_Aset1,Ref_Rek_Aset5.Kd_Aset2,Ref_Rek_Aset5.Kd_Aset3, Ref_Rek_Aset5.Kd_Aset4,Ref_Rek_Aset5.Kd_Aset5"; return $this->db->query($query); } /* 12-08-2014*/ function total_kib_skpd($bidang,$unit,$sub,$upb,$like){$kb 	=  $this->session->userdata('kd_bidang'); $ku 	=  $this->session->userdata('kd_unit'); $ks 	=  $this->session->userdata('kd_sub_unit'); $kupb 	=  $this->session->userdata('kd_upb'); if ($this->session->userdata('lvl') == 01){$where = "WHERE (Ta_Lainnya.Kd_Bidang = $bidang) AND (Ta_Lainnya.Kd_Unit = $unit) AND (Ta_Lainnya.Kd_Sub = $sub) AND (Ta_Lainnya.Kd_UPB = $upb) AND $like"; }elseif ($this->session->userdata('lvl') == 02){$where = "WHERE (Ta_Lainnya.Kd_Bidang = $kb ) AND (Ta_Lainnya.Kd_Unit =$ku ) AND (Ta_Lainnya.Kd_Sub = $ks) AND (Ta_Lainnya.Kd_UPB = $upb) AND $like"; }else{$where = "WHERE (Ta_Lainnya.Kd_Bidang = $kb) AND (Ta_Lainnya.Kd_Unit = $ku) AND (Ta_Lainnya.Kd_Sub = $ks) AND (Ta_Lainnya.Kd_UPB = $kupb) AND $like"; } $query = "SELECT COUNT(*) as Jumlah,SUM(Harga) as Harga FROM Ta_Lainnya $where"; return $this->db->query($query); } /* 13-05-2015 */ function laporan_kendaraan($bidang='',$unit='',$sub='',$upb='',$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (Ta_Lainnya.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (Ta_Lainnya.Kd_Unit = $unit)"; } if($sub){$where .= "AND (Ta_Lainnya.Kd_Sub = $sub)"; } if($upb){$where .= "AND (Ta_Lainnya.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){if($bidang){$where = "AND (Ta_Lainnya.Kd_Bidang = $kb)"; } if($unit){$where .= "AND (Ta_Lainnya.Kd_Unit = $ku)"; } if($sub){$where .= "AND (Ta_Lainnya.Kd_Sub = $ks)"; } if($upb){$where .= "AND (Ta_Lainnya.Kd_UPB = $upb)"; } }else{if($bidang){$where = "AND (Ta_Lainnya.Kd_Bidang = $kb)"; } if($unit){$where .= "AND (Ta_Lainnya.Kd_Unit = $ku)"; } if($sub){$where .= "AND (Ta_Lainnya.Kd_Sub = $ks)"; } if($upb){$where .= "AND (Ta_Lainnya.Kd_UPB = $kupb)"; } } if($bidang == '' AND $unit =='' AND $sub =='' AND $upb ==''){$query = "SELECT Ref_Rek_Aset5.Nm_Aset5,Ta_Lainnya.Jumlah_Roda,Ta_Lainnya.Pemakai,COUNT(Ta_Lainnya.No_register) as jumlah_register,MIN(Ta_Lainnya.No_register) as min_register, MAX(Ta_Lainnya.No_register) as max_register, Ta_Lainnya.Kd_Prov, Ta_Lainnya.Kd_Kab_Kota, Ta_Lainnya.Kd_Bidang, Ta_Lainnya.Kd_Unit, Ta_Lainnya.Kd_Sub, Ta_Lainnya.Kd_UPB, Ta_Lainnya.Kd_Aset1, Ta_Lainnya.Kd_Aset2, Ta_Lainnya.Kd_Aset3, Ta_Lainnya.Kd_Aset4, Ta_Lainnya.Kd_Aset5, Ta_Lainnya.Kd_Pemilik, Ta_Lainnya.Merk, Ta_Lainnya.Type, Ta_Lainnya.CC, Ta_Lainnya.Bahan, DATENAME(yyyy,Ta_Lainnya.Tgl_Perolehan) as Tahun,Ta_Lainnya.Nomor_Pabrik,Ta_Lainnya.Nomor_Rangka,Ta_Lainnya.Nomor_Mesin, Ta_Lainnya.Nomor_Polisi,Ta_Lainnya.Nomor_BPKB,Ta_Lainnya.Asal_usul,Ta_Lainnya.Kondisi,COUNT(*) as Jumlah, SUM(Ta_Lainnya.Harga) as Harga,Ref_UPB.Nm_UPB FROM  Ta_Lainnya INNER JOIN Ref_Rek_Aset5 ON Ta_Lainnya.Kd_Aset1 = Ref_Rek_Aset5.Kd_Aset1 AND Ta_Lainnya.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_Lainnya.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_Lainnya.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_Lainnya.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 LEFT JOIN Ref_UPB ON Ta_Lainnya.Kd_Bidang=Ref_UPB.Kd_Bidang AND Ta_Lainnya.Kd_Unit=Ref_UPB.Kd_Unit AND Ta_Lainnya.Kd_Sub=Ref_UPB.Kd_Sub AND Ta_Lainnya.Kd_UPB=Ref_UPB.Kd_UPB WHERE Ta_Lainnya.Kd_Aset1=2 AND Ta_Lainnya.Kd_Aset2=3 AND Ta_Lainnya.Kd_Aset3=1 $where $like GROUP BY Ta_Lainnya.Kd_Prov, Ta_Lainnya.Kd_Kab_Kota, Ta_Lainnya.Kd_Bidang, Ta_Lainnya.Kd_Unit, Ta_Lainnya.Kd_Sub, Ta_Lainnya.Kd_UPB, Ta_Lainnya.Kd_Aset1, Ta_Lainnya.Kd_Aset2, Ta_Lainnya.Kd_Aset3, Ta_Lainnya.Kd_Aset4, Ta_Lainnya.Kd_Aset5, Ta_Lainnya.Kd_Pemilik, Ta_Lainnya.Merk, Ta_Lainnya.Type, Ta_Lainnya.CC, Ta_Lainnya.Bahan, Ta_Lainnya.Tgl_Perolehan,Ta_Lainnya.Nomor_Pabrik,Ta_Lainnya.Nomor_Rangka,Ta_Lainnya.Nomor_Mesin,Ta_Lainnya.Nomor_Polisi, Ta_Lainnya.Nomor_BPKB,Ta_Lainnya.Asal_usul,Ta_Lainnya.Kondisi,Ref_UPB.Nm_UPB,Ref_Rek_Aset5.Nm_Aset5,Ta_Lainnya.Jumlah_Roda,Ta_Lainnya.Pemakai ORDER BY  Ref_Rek_Aset5.Nm_Aset5, MIN(Ta_Lainnya.No_register)"; }else{$query = "SELECT Ref_Rek_Aset5.Nm_Aset5,Ta_Lainnya.Jumlah_Roda,Ta_Lainnya.Pemakai,COUNT(Ta_Lainnya.No_register) as jumlah_register,MIN(Ta_Lainnya.No_register) as min_register, MAX(Ta_Lainnya.No_register) as max_register, Ta_Lainnya.Kd_Prov, Ta_Lainnya.Kd_Kab_Kota, Ta_Lainnya.Kd_Bidang, Ta_Lainnya.Kd_Unit, Ta_Lainnya.Kd_Sub, Ta_Lainnya.Kd_UPB, Ta_Lainnya.Kd_Aset1, Ta_Lainnya.Kd_Aset2, Ta_Lainnya.Kd_Aset3, Ta_Lainnya.Kd_Aset4, Ta_Lainnya.Kd_Aset5, Ta_Lainnya.Kd_Pemilik, Ta_Lainnya.Merk, Ta_Lainnya.Type, Ta_Lainnya.CC, Ta_Lainnya.Bahan, DATENAME(yyyy,Ta_Lainnya.Tgl_Perolehan) as Tahun,Ta_Lainnya.Nomor_Pabrik,Ta_Lainnya.Nomor_Rangka,Ta_Lainnya.Nomor_Mesin, Ta_Lainnya.Nomor_Polisi,Ta_Lainnya.Nomor_BPKB,Ta_Lainnya.Asal_usul,Ta_Lainnya.Kondisi,COUNT(*) as Jumlah, SUM(Ta_Lainnya.Harga) as Harga,Ta_Lainnya.Keterangan FROM  Ta_Lainnya INNER JOIN Ref_Rek_Aset5 ON Ta_Lainnya.Kd_Aset1 = Ref_Rek_Aset5.Kd_Aset1 AND Ta_Lainnya.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_Lainnya.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_Lainnya.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_Lainnya.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 WHERE Ta_Lainnya.Kd_Aset1=2 AND Ta_Lainnya.Kd_Aset2=3 AND Ta_Lainnya.Kd_Aset3=1 $where $like GROUP BY Ta_Lainnya.Kd_Prov, Ta_Lainnya.Kd_Kab_Kota, Ta_Lainnya.Kd_Bidang, Ta_Lainnya.Kd_Unit, Ta_Lainnya.Kd_Sub, Ta_Lainnya.Kd_UPB, Ta_Lainnya.Kd_Aset1, Ta_Lainnya.Kd_Aset2, Ta_Lainnya.Kd_Aset3, Ta_Lainnya.Kd_Aset4, Ta_Lainnya.Kd_Aset5, Ta_Lainnya.Kd_Pemilik, Ta_Lainnya.Merk, Ta_Lainnya.Type, Ta_Lainnya.CC, Ta_Lainnya.Bahan, Ta_Lainnya.Tgl_Perolehan,Ta_Lainnya.Nomor_Pabrik,Ta_Lainnya.Nomor_Rangka,Ta_Lainnya.Nomor_Mesin,Ta_Lainnya.Nomor_Polisi, Ta_Lainnya.Nomor_BPKB,Ta_Lainnya.Asal_usul,Ta_Lainnya.Kondisi,Ta_Lainnya.Keterangan,Ref_Rek_Aset5.Nm_Aset5,Ta_Lainnya.Jumlah_Roda,Ta_Lainnya.Pemakai ORDER BY  Ref_Rek_Aset5.Nm_Aset5, MIN(Ta_Lainnya.No_register)"; } return $this->db->query($query); } /** * Total Data Kendaraan */ /* 14-05-2015*/ function total_kendaraan($bidang='',$unit='',$sub='',$upb='',$like){$kb 	=  $this->session->userdata('kd_bidang'); $ku 	=  $this->session->userdata('kd_unit'); $ks 	=  $this->session->userdata('kd_sub_unit'); $kupb 	=  $this->session->userdata('kd_upb'); $where  = ''; $where .= "AND Ta_Lainnya.Kd_Aset2='3' AND Ta_Lainnya.Kd_Aset3='1'"; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (Ta_Lainnya.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (Ta_Lainnya.Kd_Unit = $unit)"; } if($sub){$where .= "AND (Ta_Lainnya.Kd_Sub = $sub)"; } if($upb){$where .= "AND (Ta_Lainnya.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){if($bidang){$where = "AND (Ta_Lainnya.Kd_Bidang = $kb)"; } if($unit){$where .= "AND (Ta_Lainnya.Kd_Unit = $ku)"; } if($sub){$where .= "AND (Ta_Lainnya.Kd_Sub = $ks)"; } if($upb){$where .= "AND (Ta_Lainnya.Kd_UPB = $upb)"; } }else{if($bidang){$where = "AND (Ta_Lainnya.Kd_Bidang = $kb)"; } if($unit){$where .= "AND (Ta_Lainnya.Kd_Unit = $ku)"; } if($sub){$where .= "AND (Ta_Lainnya.Kd_Sub = $ks)"; } if($upb){$where .= "AND (Ta_Lainnya.Kd_UPB = $kupb)"; } } $query = "SELECT COUNT(*) as Jumlah,SUM(Harga) as Harga FROM Ta_Lainnya WHERE 1=1 AND Ta_Lainnya.Kd_Aset1=2 AND Ta_Lainnya.Kd_Aset2=3 AND Ta_Lainnya.Kd_Aset3=1 $where $like"; return $this->db->query($query); } /** * Menampilkan sdata kib b rekap kendaraan */ function rekap_kendaraan($bidang='',$unit='',$sub='',$upb='',$like,$roda) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (Ta_Lainnya.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (Ta_Lainnya.Kd_Unit = $unit)"; } if($sub){$where .= "AND (Ta_Lainnya.Kd_Sub = $sub)"; } if($upb){$where .= "AND (Ta_Lainnya.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){if($bidang){$where = "AND (Ta_Lainnya.Kd_Bidang = $kb)"; } if($unit){$where .= "AND (Ta_Lainnya.Kd_Unit = $ku)"; } if($sub){$where .= "AND (Ta_Lainnya.Kd_Sub = $ks)"; } if($upb){$where .= "AND (Ta_Lainnya.Kd_UPB = $upb)"; } }else{if($bidang){$where = "AND (Ta_Lainnya.Kd_Bidang = $kb)"; } if($unit){$where .= "AND (Ta_Lainnya.Kd_Unit = $ku)"; } if($sub){$where .= "AND (Ta_Lainnya.Kd_Sub = $ks)"; } if($upb){$where .= "AND (Ta_Lainnya.Kd_UPB = $kupb)"; } } if($bidang == '' AND $unit =='' AND $sub =='' AND $upb ==''){$query = "SELECT Ta_Lainnya.Kd_Aset1, Ta_Lainnya.Kd_Aset2, Ta_Lainnya.Kd_Aset3, Ta_Lainnya.Kd_Aset4, Ta_Lainnya.Kd_Aset5,Jumlah_Roda,Ref_Rek_Aset5.Nm_Aset5, COUNT(*) as Jumlah, SUM(Ta_Lainnya.Harga) as Harga, Nm_UPB FROM Ta_Lainnya INNER JOIN Ref_Rek_Aset5 ON Ta_Lainnya.Kd_Aset1 = Ref_Rek_Aset5.Kd_Aset1 AND Ta_Lainnya.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_Lainnya.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_Lainnya.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_Lainnya.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 LEFT JOIN Ref_UPB ON Ta_Lainnya.Kd_Bidang=Ref_UPB.Kd_Bidang AND Ta_Lainnya.Kd_Unit=Ref_UPB.Kd_Unit AND Ta_Lainnya.Kd_Sub=Ref_UPB.Kd_Sub AND Ta_Lainnya.Kd_UPB=Ref_UPB.Kd_UPB WHERE Ta_Lainnya.Kd_Aset1=2 AND Ta_Lainnya.Kd_Aset2=3 AND Ta_Lainnya.Kd_Aset3=1 AND Ta_Lainnya.Jumlah_Roda='$roda' $where $like GROUP BY Ta_Lainnya.Kd_Aset1, Ta_Lainnya.Kd_Aset2, Ta_Lainnya.Kd_Aset3, Ta_Lainnya.Kd_Aset4, Ta_Lainnya.Kd_Aset5,Jumlah_Roda,Ref_Rek_Aset5.Nm_Aset5,Nm_UPB"; }else{$query = "SELECT Ta_Lainnya.Kd_Aset1, Ta_Lainnya.Kd_Aset2, Ta_Lainnya.Kd_Aset3, Ta_Lainnya.Kd_Aset4, Ta_Lainnya.Kd_Aset5,Jumlah_Roda,Ref_Rek_Aset5.Nm_Aset5, COUNT(*) as Jumlah, SUM(Ta_Lainnya.Harga) as Harga, Ta_Lainnya.Keterangan FROM Ta_Lainnya INNER JOIN Ref_Rek_Aset5 ON Ta_Lainnya.Kd_Aset1 = Ref_Rek_Aset5.Kd_Aset1 AND Ta_Lainnya.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_Lainnya.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_Lainnya.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_Lainnya.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 WHERE Ta_Lainnya.Kd_Aset1=2 AND Ta_Lainnya.Kd_Aset2=3 AND Ta_Lainnya.Kd_Aset3=1 AND Ta_Lainnya.Jumlah_Roda='$roda' $where $like GROUP BY Ta_Lainnya.Kd_Aset1, Ta_Lainnya.Kd_Aset2, Ta_Lainnya.Kd_Aset3, Ta_Lainnya.Kd_Aset4, Ta_Lainnya.Kd_Aset5,Jumlah_Roda,Ref_Rek_Aset5.Nm_Aset5,Ta_Lainnya.Keterangan"; } /*var_dump($query); exit();*/ return $this->db->query($query); } /** * Total Rekap Kendaraan */ function total_rekap_kendaraan($bidang='',$unit='',$sub='',$upb='',$like,$roda) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (Ta_Lainnya.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (Ta_Lainnya.Kd_Unit = $unit)"; } if($sub){$where .= "AND (Ta_Lainnya.Kd_Sub = $sub)"; } if($upb){$where .= "AND (Ta_Lainnya.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){if($bidang){$where = "AND (Ta_Lainnya.Kd_Bidang = $kb)"; } if($unit){$where .= "AND (Ta_Lainnya.Kd_Unit = $ku)"; } if($sub){$where .= "AND (Ta_Lainnya.Kd_Sub = $ks)"; } if($upb){$where .= "AND (Ta_Lainnya.Kd_UPB = $upb)"; } }else{if($bidang){$where = "AND (Ta_Lainnya.Kd_Bidang = $kb)"; } if($unit){$where .= "AND (Ta_Lainnya.Kd_Unit = $ku)"; } if($sub){$where .= "AND (Ta_Lainnya.Kd_Sub = $ks)"; } if($upb){$where .= "AND (Ta_Lainnya.Kd_UPB = $kupb)"; } } $query = "SELECT COUNT(*) as Jumlah,SUM(Harga) as Harga FROM Ta_Lainnya  WHERE 1=1 AND Ta_Lainnya.Kd_Aset1=2 AND Ta_Lainnya.Kd_Aset2=3 AND Ta_Lainnya.Kd_Aset3=1 AND Ta_Lainnya.Jumlah_Roda='$roda' $where $like"; return $this->db->query($query); } /* 13-05-2015 */ function laporan_penyusutan($bidang='',$unit='',$sub='',$upb='',$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (Ta_Lainnya.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (Ta_Lainnya.Kd_Unit = $unit)"; } if($sub){$where .= "AND (Ta_Lainnya.Kd_Sub = $sub)"; } if($upb){$where .= "AND (Ta_Lainnya.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){if($bidang){$where = "AND (Ta_Lainnya.Kd_Bidang = $kb)"; } if($unit){$where .= "AND (Ta_Lainnya.Kd_Unit = $ku)"; } if($sub){$where .= "AND (Ta_Lainnya.Kd_Sub = $ks)"; } if($upb){$where .= "AND (Ta_Lainnya.Kd_UPB = $upb)"; } }else{if($bidang){$where = "AND (Ta_Lainnya.Kd_Bidang = $kb)"; } if($unit){$where .= "AND (Ta_Lainnya.Kd_Unit = $ku)"; } if($sub){$where .= "AND (Ta_Lainnya.Kd_Sub = $ks)"; } if($upb){$where .= "AND (Ta_Lainnya.Kd_UPB = $kupb)"; } } $query = "SELECT Ref_Rek_Aset5.Nm_Aset5,Ta_Lainnya.Jumlah_Roda,Ta_Lainnya.Pemakai,COUNT(Ta_Lainnya.No_register) as jumlah_register,MIN(Ta_Lainnya.No_register) as min_register, MAX(Ta_Lainnya.No_register) as max_register, Ta_Lainnya.Kd_Prov, Ta_Lainnya.Kd_Kab_Kota, Ta_Lainnya.Kd_Bidang, Ta_Lainnya.Kd_Unit, Ta_Lainnya.Kd_Sub, Ta_Lainnya.Kd_UPB, Ta_Lainnya.Kd_Aset1, Ta_Lainnya.Kd_Aset2, Ta_Lainnya.Kd_Aset3, Ta_Lainnya.Kd_Aset4, Ta_Lainnya.Kd_Aset5, Ta_Lainnya.Kd_Pemilik, Ta_Lainnya.Merk, Ta_Lainnya.Type, Ta_Lainnya.CC, Ta_Lainnya.Bahan, DATENAME(yyyy,Ta_Lainnya.Tgl_Perolehan) as Tahun,Ta_Lainnya.Nomor_Pabrik,Ta_Lainnya.Nomor_Rangka,Ta_Lainnya.Nomor_Mesin, Ta_Lainnya.Nomor_Polisi,Ta_Lainnya.Nomor_BPKB,Ta_Lainnya.Asal_usul,Ta_Lainnya.Kondisi,COUNT(*) as Jumlah, SUM(Ta_Lainnya.Harga) as Harga, Masa_Manfaat, Ref_UPB.Nm_UPB FROM  Ta_Lainnya INNER JOIN Ref_Rek_Aset5 ON Ta_Lainnya.Kd_Aset1 = Ref_Rek_Aset5.Kd_Aset1 AND Ta_Lainnya.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_Lainnya.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_Lainnya.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_Lainnya.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 LEFT JOIN Ref_UPB ON Ta_Lainnya.Kd_Bidang=Ref_UPB.Kd_Bidang AND Ta_Lainnya.Kd_Unit=Ref_UPB.Kd_Unit AND Ta_Lainnya.Kd_Sub=Ref_UPB.Kd_Sub AND Ta_Lainnya.Kd_UPB=Ref_UPB.Kd_UPB WHERE 1=1 AND Harga > '300000' $where $like GROUP BY Ta_Lainnya.Kd_Prov, Ta_Lainnya.Kd_Kab_Kota, Ta_Lainnya.Kd_Bidang, Ta_Lainnya.Kd_Unit, Ta_Lainnya.Kd_Sub, Ta_Lainnya.Kd_UPB, Ta_Lainnya.Kd_Aset1, Ta_Lainnya.Kd_Aset2, Ta_Lainnya.Kd_Aset3, Ta_Lainnya.Kd_Aset4, Ta_Lainnya.Kd_Aset5, Ta_Lainnya.Kd_Pemilik, Ta_Lainnya.Merk, Ta_Lainnya.Type, Ta_Lainnya.CC, Ta_Lainnya.Bahan, Ta_Lainnya.Tgl_Perolehan,Ta_Lainnya.Nomor_Pabrik,Ta_Lainnya.Nomor_Rangka,Ta_Lainnya.Nomor_Mesin,Ta_Lainnya.Nomor_Polisi, Ta_Lainnya.Nomor_BPKB,Ta_Lainnya.Asal_usul,Ta_Lainnya.Kondisi,Ref_UPB.Nm_UPB,Ref_Rek_Aset5.Nm_Aset5,Ta_Lainnya.Jumlah_Roda,Ta_Lainnya.Pemakai,Masa_Manfaat ORDER BY  Ref_Rek_Aset5.Nm_Aset5, MIN(Ta_Lainnya.No_register)"; return $this->db->query($query); } /* starts 2015 */ function laporan_intrakomptabel($bidang,$unit,$sub,$upb,$like){$kb 	=  $this->session->userdata('kd_bidang'); $ku 	=  $this->session->userdata('kd_unit'); $ks 	=  $this->session->userdata('kd_sub_unit'); $kupb 	=  $this->session->userdata('kd_upb'); if ($this->session->userdata('lvl') == 01){$where = "(Ta_Lainnya.Kd_Bidang = $bidang) AND (Ta_Lainnya.Kd_Unit = $unit) AND (Ta_Lainnya.Kd_Sub = $sub) AND (Ta_Lainnya.Kd_UPB = $upb) AND"; }elseif ($this->session->userdata('lvl') == 02){$where = "(Ta_Lainnya.Kd_Bidang = $kb ) AND (Ta_Lainnya.Kd_Unit =$ku ) AND (Ta_Lainnya.Kd_Sub = $ks) AND (Ta_Lainnya.Kd_UPB = $upb) AND"; }else{$where = "(Ta_Lainnya.Kd_Bidang = $kb) AND (Ta_Lainnya.Kd_Unit = $ku) AND (Ta_Lainnya.Kd_Sub = $ks) AND (Ta_Lainnya.Kd_UPB = $kupb) AND"; } $query = "SELECT  Ref_Rek_Aset5.Nm_Aset5,Ta_Lainnya.Kd_Prov, Ta_Lainnya.Kd_Kab_Kota, Ta_Lainnya.Kd_Bidang, Ta_Lainnya.Kd_Unit, Ta_Lainnya.Kd_Sub, Ta_Lainnya.Kd_UPB, Ta_Lainnya.Kd_Aset1, Ta_Lainnya.Kd_Aset2, Ta_Lainnya.Kd_Aset3, Ta_Lainnya.Kd_Aset4, Ta_Lainnya.Kd_Aset5, Ta_Lainnya.Kd_Pemilik, Ta_Lainnya.Merk, Ta_Lainnya.Type, Ta_Lainnya.CC, Ta_Lainnya.Bahan, Ta_Lainnya.Nomor_Pabrik,SUM(Ta_Lainnya.Harga) as Harga, Ta_Lainnya.Masa_Manfaat,Ta_Lainnya.Keterangan,DATENAME(yyyy,Ta_Lainnya.Tgl_Perolehan) as Tahun, count(case when Kondisi = 1 then 1 else null end) as Baik, count(case when Kondisi = 2 then 1 else null end) as Kurang_baik, count(case when Kondisi = 3 then 1 else null end) as Rusak, COUNT(Kondisi) as Jumlah_Data FROM  Ta_Lainnya INNER JOIN Ref_Rek_Aset5 ON Ta_Lainnya.Kd_Aset1 = Ref_Rek_Aset5.Kd_Aset1 AND Ta_Lainnya.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_Lainnya.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_Lainnya.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_Lainnya.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 WHERE 1=1"; $query .= "AND $where $like"; $query .= "AND Harga > '300000'"; $query .= "GROUP BY Ta_Lainnya.Kd_Prov, Ta_Lainnya.Kd_Kab_Kota, Ta_Lainnya.Kd_Bidang, Ta_Lainnya.Kd_Unit, Ta_Lainnya.Kd_Sub, Ta_Lainnya.Kd_UPB, Ta_Lainnya.Kd_Aset1, Ta_Lainnya.Kd_Aset2, Ta_Lainnya.Kd_Aset3, Ta_Lainnya.Kd_Aset4, Ta_Lainnya.Kd_Aset5, Ta_Lainnya.Kd_Pemilik, Ta_Lainnya.Merk, Ta_Lainnya.Type, Ta_Lainnya.CC, Ta_Lainnya.Bahan, Ta_Lainnya.Nomor_Pabrik, Ta_Lainnya.Masa_Manfaat,Ta_Lainnya.Keterangan,Ref_Rek_Aset5.Nm_Aset5,Ta_Lainnya.Tgl_Perolehan"; return $this->db->query($query); } /** * Tampilkan intrakomptabel */ function total_intrakomptabel($bidang,$unit,$sub,$upb,$like) {if ($this->session->userdata('lvl') == 01){$this->db->where('Kd_Bidang',$bidang); $this->db->where('Kd_Unit',$unit); $this->db->where('Kd_Sub',$sub); $this->db->where('Kd_UPB',$upb); }elseif ($this->session->userdata('lvl') == 02){$this->db->where('Kd_Bidang',$this->session->userdata('kd_bidang')); $this->db->where('Kd_Unit',$this->session->userdata('kd_unit')); $this->db->where('Kd_Sub',$this->session->userdata('kd_sub_unit')); $this->db->where('Kd_UPB',$upb); }else{$this->db->where('Kd_Bidang',$this->session->userdata('kd_bidang')); $this->db->where('Kd_Unit',$this->session->userdata('kd_unit')); $this->db->where('Kd_Sub',$this->session->userdata('kd_sub_unit')); $this->db->where('Kd_UPB',$this->session->userdata('kd_upb')); } $this->db->select_SUM('Harga'); $this->db->where("$like"); $this->db->where("Harga > '300000'"); $this->db->from($this->table); $sql = $this->db->get(); foreach ($sql->result() as $row) {$result = $row->Harga; } return $result; } /* end 2015 */ /* start 2015 */ function laporan_intrakomptabel_induk($like){$query = "SELECT  Ref_Rek_Aset5.Nm_Aset5,Ta_Lainnya.Kd_Prov, Ta_Lainnya.Kd_Kab_Kota, Ta_Lainnya.Kd_Bidang, Ta_Lainnya.Kd_Unit, Ta_Lainnya.Kd_Sub, Ta_Lainnya.Kd_UPB, Ta_Lainnya.Kd_Aset1, Ta_Lainnya.Kd_Aset2, Ta_Lainnya.Kd_Aset3, Ta_Lainnya.Kd_Aset4, Ta_Lainnya.Kd_Aset5, Ta_Lainnya.Kd_Pemilik, Ta_Lainnya.Merk, Ta_Lainnya.Type, Ta_Lainnya.CC, Ta_Lainnya.Bahan, Ta_Lainnya.Nomor_Pabrik,SUM(Ta_Lainnya.Harga) as Harga, Ta_Lainnya.Masa_Manfaat,Ref_UPB.Nm_UPB,DATENAME(yyyy,Ta_Lainnya.Tgl_Perolehan) as Tahun, count(case when Kondisi = 1 then 1 else null end) as Baik, count(case when Kondisi = 2 then 1 else null end) as Kurang_baik, count(case when Kondisi = 3 then 1 else null end) as Rusak, COUNT(Kondisi) as Jumlah_Data FROM  Ta_Lainnya INNER JOIN Ref_Rek_Aset5 ON Ta_Lainnya.Kd_Aset1 = Ref_Rek_Aset5.Kd_Aset1 AND Ta_Lainnya.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_Lainnya.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_Lainnya.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_Lainnya.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 LEFT JOIN Ref_UPB ON Ta_Lainnya.Kd_Bidang=Ref_UPB.Kd_Bidang AND Ta_Lainnya.Kd_Unit=Ref_UPB.Kd_Unit AND Ta_Lainnya.Kd_Sub=Ref_UPB.Kd_Sub AND Ta_Lainnya.Kd_UPB=Ref_UPB.Kd_UPB WHERE $like AND Harga > '300000'GROUP BY Ta_Lainnya.Kd_Prov, Ta_Lainnya.Kd_Kab_Kota, Ta_Lainnya.Kd_Bidang, Ta_Lainnya.Kd_Unit, Ta_Lainnya.Kd_Sub, Ta_Lainnya.Kd_UPB, Ta_Lainnya.Kd_Aset1, Ta_Lainnya.Kd_Aset2, Ta_Lainnya.Kd_Aset3, Ta_Lainnya.Kd_Aset4, Ta_Lainnya.Kd_Aset5, Ta_Lainnya.Kd_Pemilik, Ta_Lainnya.Merk, Ta_Lainnya.Type, Ta_Lainnya.CC, Ta_Lainnya.Bahan, Ta_Lainnya.Nomor_Pabrik, Ta_Lainnya.Masa_Manfaat,Ref_UPB.Nm_UPB,Ref_Rek_Aset5.Nm_Aset5,Ta_Lainnya.Tgl_Perolehan"; return $this->db->query($query); } /** * Tampilkan total_pengadaan */ function total_intrakomptabel_induk($like) {$this->db->select_SUM('Harga'); $this->db->where("$like"); $this->db->where("Harga > '300000'"); $this->db->from($this->table); $sql = $this->db->get(); foreach ($sql->result() as $row) {$result = $row->Harga; } return $result; } /* end 2015 */ /* 13-05-2015 */ function neraca_lainnya($bidang='',$unit='',$sub='',$upb='',$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $thn   =  $this->session->userdata('tahun_anggaran'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (Ta_Lainnya.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (Ta_Lainnya.Kd_Unit = $unit)"; } if($sub){$where .= "AND (Ta_Lainnya.Kd_Sub = $sub)"; } if($upb){$where .= "AND (Ta_Lainnya.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){if($bidang){$where = "AND (Ta_Lainnya.Kd_Bidang = $kb)"; } if($unit){$where .= "AND (Ta_Lainnya.Kd_Unit = $ku)"; } if($sub){$where .= "AND (Ta_Lainnya.Kd_Sub = $ks)"; } if($upb){$where .= "AND (Ta_Lainnya.Kd_UPB = $upb)"; } }else{if($bidang){$where = "AND (Ta_Lainnya.Kd_Bidang = $kb)"; } if($unit){$where .= "AND (Ta_Lainnya.Kd_Unit = $ku)"; } if($sub){$where .= "AND (Ta_Lainnya.Kd_Sub = $ks)"; } if($upb){$where .= "AND (Ta_Lainnya.Kd_UPB = $kupb)"; } } $query = "SELECT * FROM (SELECT Kd_Aset1,'20' as Kd_Aset2,'Aset Lain' as Nm_Aset2, SUM(0) as Harga, SUM(CASE WHEN Harga > '300000' THEN 0 ELSE NULL END) AS intra, SUM(CASE WHEN Harga <= '300000' THEN 0 ELSE NULL END) AS ekstra, SUM(CASE WHEN Harga > '300000' AND Kondisi = '3' THEN Harga ELSE NULL END) AS RB, SUM(1) AS Susut, SUM(1) as Total_Susut FROM Ta_Lainnya GROUP BY Kd_Aset1 UNION ALL SELECT Kd_Aset1,'23' as Kd_Aset2,'Kemitraan dengan pihak ketiga' as Nm_Aset2, SUM(0) as Harga, SUM(CASE WHEN Harga > '300000' THEN 0 ELSE NULL END) AS intra, SUM(CASE WHEN Harga <= '300000' THEN 0 ELSE NULL END) AS ekstra, SUM(CASE WHEN Harga > '300000' AND Kondisi = '3' THEN Harga ELSE NULL END) AS RB, SUM(1) AS Susut, SUM(1) as Total_Susut FROM Ta_Lainnya GROUP BY Kd_Aset1 UNION ALL SELECT Kd_Aset1,'21' as Kd_Aset2,'Aset Rusak Berat' as Nm_Aset2, SUM(0) as Harga, SUM(CASE WHEN Harga > '300000' THEN 0 ELSE NULL END) AS intra, SUM(CASE WHEN Harga <= '300000' THEN 0 ELSE NULL END) AS ekstra, SUM(CASE WHEN Harga > '300000' AND Kondisi = '3' THEN Harga ELSE NULL END) AS RB, SUM(1) AS Susut, SUM(1) as Total_Susut FROM Ta_KIB_B GROUP BY Kd_Aset1 UNION ALL SELECT Ref_Rek_Aset2.Kd_Aset1,Ref_Rek_Aset2.Kd_Aset2,Nm_Aset2, SUM(Harga) as Harga, SUM(CASE WHEN Harga > '300000' THEN Harga ELSE NULL END) AS intra, SUM(CASE WHEN Harga <= '300000' THEN Harga ELSE NULL END) AS ekstra, SUM(CASE WHEN Harga > '300000' AND Kondisi = '3' THEN Harga ELSE NULL END) AS RB, SUM(CASE WHEN Harga > '300000' THEN Susut ELSE NULL END) AS Susut, SUM(Susut) as Total_Susut FROM Ref_Rek_Aset2 LEFT JOIN (SELECT *,dbo.penyusutan(2105,YEAR(Ta_Lainnya.Tgl_Perolehan), Ta_Lainnya.Masa_Manfaat,Ta_Lainnya.Harga) as Susut FROM Ta_Lainnya WHERE 1=1 $where AND $like) as Ta_Lainnya ON Ta_Lainnya.Kd_Aset1=Ref_Rek_Aset2.Kd_Aset1 AND Ta_Lainnya.Kd_Aset2=Ref_Rek_Aset2.Kd_Aset2 WHERE Ref_Rek_Aset2.Kd_Aset1=7 AND Ref_Rek_Aset2.Kd_Aset2=24 OR Ref_Rek_Aset2.Kd_Aset2=22 GROUP BY Ref_Rek_Aset2.Kd_Aset1,Ref_Rek_Aset2.Kd_Aset2,Nm_Aset2 ) Ta_Lainnya ORDER BY Kd_Aset2"; return $this->db->query($query); } /** * Total Rekap Kendaraan */ function total_neraca_kibb($bidang='',$unit='',$sub='',$upb='',$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $thn   =  $this->session->userdata('tahun_anggaran'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (Ta_Lainnya.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (Ta_Lainnya.Kd_Unit = $unit)"; } if($sub){$where .= "AND (Ta_Lainnya.Kd_Sub = $sub)"; } if($upb){$where .= "AND (Ta_Lainnya.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){if($bidang){$where = "AND (Ta_Lainnya.Kd_Bidang = $kb)"; } if($unit){$where .= "AND (Ta_Lainnya.Kd_Unit = $ku)"; } if($sub){$where .= "AND (Ta_Lainnya.Kd_Sub = $ks)"; } if($upb){$where .= "AND (Ta_Lainnya.Kd_UPB = $upb)"; } }else{if($bidang){$where = "AND (Ta_Lainnya.Kd_Bidang = $kb)"; } if($unit){$where .= "AND (Ta_Lainnya.Kd_Unit = $ku)"; } if($sub){$where .= "AND (Ta_Lainnya.Kd_Sub = $ks)"; } if($upb){$where .= "AND (Ta_Lainnya.Kd_UPB = $kupb)"; } } $query = "SELECT SUM(CASE WHEN Harga > '300000' THEN Harga ELSE NULL END) AS intra, SUM(CASE WHEN Harga <= '300000' THEN Harga ELSE NULL END) AS ekstra, SUM(CASE WHEN Harga > '300000' AND Kondisi = '3' THEN Harga ELSE NULL END) AS RB, SUM(CASE WHEN Harga > '300000' THEN Susut ELSE NULL END) AS Susut FROM Ref_Rek_Aset2 LEFT JOIN (SELECT *,dbo.penyusutan($thn,YEAR(Ta_Lainnya.Tgl_Perolehan), Ta_Lainnya.Masa_Manfaat,Ta_Lainnya.Harga) as Susut FROM Ta_Lainnya WHERE 1=1 $where AND $like) as Ta_Lainnya ON Ta_Lainnya.Kd_Aset1=Ref_Rek_Aset2.Kd_Aset1 AND Ta_Lainnya.Kd_Aset2=Ref_Rek_Aset2.Kd_Aset2 WHERE Ref_Rek_Aset2.Kd_Aset1=2"; return $this->db->query($query); } function rekap_neraca_nonop($bidang='',$unit='',$sub='',$upb='',$tahunawal,$tahunakhir,$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $thn   =  $this->session->userdata('tahun_anggaran'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; $where .= "AND (a.Kd_UPB = $kupb)"; } $thn 			= $this->session->userdata('tahun_anggaran'); $tgl_pembukuan 	= " AND Tgl_Pembukuan ".$like; $query = "SELECT SUM(Harga) as NB_Akhir FROM Ref_Rek_Aset2 LEFT JOIN (SELECT *, dbo.fn_KIB_LAINNYA_Susut(Kd_Prov,Kd_Kab_Kota,Kd_Bidang,Kd_Unit,Kd_Sub,Kd_UPB,Kd_Aset1,Kd_Aset2,Kd_Aset3,Kd_Aset4,Kd_Aset5,No_Register,Masa_Manfaat,Harga,YEAR(Tgl_Perolehan),$thn,$this->neraca_awal,2) as Akm_Susut, dbo.fn_KIB_LAINNYA_Susut(Kd_Prov,Kd_Kab_Kota,Kd_Bidang,Kd_Unit,Kd_Sub,Kd_UPB,Kd_Aset1,Kd_Aset2,Kd_Aset3,Kd_Aset4,Kd_Aset5,No_Register,Masa_Manfaat,Harga,YEAR(Tgl_Perolehan),$thn,$this->neraca_awal,4) as NB_Akhir FROM Ta_Lainnya a WHERE Kd_Aset1=7 AND Kd_Aset2=22 $where $tgl_pembukuan AND NOT EXISTS (SELECT 1 FROM   Ta_KILHapus d INNER JOIN Ta_Penghapusan e ON d.No_SK=e.No_SK WHERE a.Kd_Bidang=d.Kd_Bidang AND a.Kd_Unit=d.Kd_Unit AND a.Kd_Sub=d.Kd_Sub AND a.Kd_UPB=d.Kd_UPB AND a.Kd_Aset1=d.Kd_Aset1 AND a.Kd_Aset2=d.Kd_Aset2 AND a.Kd_Aset3=d.Kd_Aset3 AND a.Kd_Aset4=d.Kd_Aset4 AND a.Kd_Aset5=d.Kd_Aset5 AND a.No_Register=d.No_Register AND YEAR(e.Tgl_SK) <= '{$thn}') ) as a ON	a.Kd_Aset1=Ref_Rek_Aset2.Kd_Aset1 AND a.Kd_Aset2=Ref_Rek_Aset2.Kd_Aset2"; return $this->db->query($query); } function rekap_neraca($bidang='',$unit='',$sub='',$upb='',$tahunawal,$tahunakhir,$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $thn   =  $this->session->userdata('tahun_anggaran'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; $where .= "AND (a.Kd_UPB = $kupb)"; } $tgl_pembukuan = " AND Tgl_Pembukuan ".$like; $tgl_dokumen   = " AND Tgl_Dokumen <= '".$tahunakhir."'"; $thn           = $this->session->userdata('tahun_anggaran'); $query = "SELECT n.Kd_Aset1,n.Kd_Aset2,n.Nm_Aset2, SUM(Akm_Susut) as Akm_Susut, SUM(LastHarga) as NB_Akhir FROM Ref_Rek_Aset2 n LEFT JOIN (SELECT *, dbo.fn_KIB_LAINNYA_Susut(Kd_Prov,Kd_Kab_Kota,Kd_Bidang,Kd_Unit,Kd_Sub,Kd_UPB,Kd_Aset1,Kd_Aset2,Kd_Aset3,Kd_Aset4,Kd_Aset5,No_Register,Masa_Manfaat,HargaKoreksi,YEAR(Tgl_Perolehan),$thn,$this->neraca_awal,4) as NB_Akhir, dbo.fn_KIB_LAINNYA_Susut(Kd_Prov,Kd_Kab_Kota,Kd_Bidang,Kd_Unit,Kd_Sub,Kd_UPB,Kd_Aset1,Kd_Aset2,Kd_Aset3,Kd_Aset4,Kd_Aset5,No_Register,Masa_Manfaat,HargaKoreksi,YEAR(Tgl_Perolehan),$thn,$this->neraca_awal,2) as Akm_Susut FROM (SELECT *, ((Harga + ISNULL(Total_Koreksi, 0) ) - ISNULL(Koreksi_Kurang, 0) ) as HargaKoreksi, ((Harga + ISNULL(Koreksi_Tambah, 0) ) - ISNULL(Koreksi_Kurang, 0) ) as LastHarga FROM  (SELECT n.Nm_Aset5, a1.*, (CASE WHEN NewKondisi is null THEN Kondisi ELSE NewKondisi END) as lastKondisi, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KILER a2 WHERE a2.Kd_Riwayat = 21 AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Total_Koreksi, (SELECT SUM(Harga) as Rharga FROM Ta_KILER a2 WHERE a2.Kd_Riwayat = 2 AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Kapitalisasi, (SELECT SUM(Harga) as Rharga FROM Ta_KILER a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KILER a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_Lainnya a1 OUTER APPLY (SELECT TOP 1 b.Kondisi as NewKondisi FROM Ta_KILER b WHERE a1.Kd_Bidang=b.Kd_Bidang AND a1.Kd_Unit=b.Kd_Unit AND a1.Kd_Sub=b.Kd_Sub AND a1.Kd_UPB=b.Kd_UPB AND a1.Kd_Aset1=b.Kd_Aset1 AND a1.Kd_Aset2=b.Kd_Aset2 AND a1.Kd_Aset3=b.Kd_Aset3 AND a1.Kd_Aset4=b.Kd_Aset4 AND a1.Kd_Aset5=b.Kd_Aset5 AND a1.No_Register=b.No_Register AND Kd_Riwayat=1 AND YEAR(b.Tgl_Dokumen) <= '{$thn}'ORDER BY b.Tgl_Dokumen DESC) as b INNER JOIN Ref_Rek_Aset5 n ON a1.Kd_Aset1 = n.Kd_Aset1 AND a1.Kd_Aset2 = n.Kd_Aset2 AND a1.Kd_Aset3 = n.Kd_Aset3 AND a1.Kd_Aset4 = n.Kd_Aset4 AND a1.Kd_Aset5 = n.Kd_Aset5 WHERE NOT EXISTS (SELECT 1 FROM   Ta_KILHapus d INNER JOIN Ta_Penghapusan e ON d.No_SK=e.No_SK WHERE a1.Kd_Bidang=d.Kd_Bidang AND a1.Kd_Unit=d.Kd_Unit AND a1.Kd_Sub=d.Kd_Sub AND a1.Kd_UPB=d.Kd_UPB AND a1.Kd_Aset1=d.Kd_Aset1 AND a1.Kd_Aset2=d.Kd_Aset2 AND a1.Kd_Aset3=d.Kd_Aset3 AND a1.Kd_Aset4=d.Kd_Aset4 AND a1.Kd_Aset5=d.Kd_Aset5 AND a1.No_Register=d.No_Register AND YEAR(e.Tgl_SK) <= '{$thn}') AND NOT EXISTS (SELECT 1 FROM  Ta_KILER e WHERE a1.Kd_Bidang=e.Kd_Bidang AND a1.Kd_Unit=e.Kd_Unit AND a1.Kd_Sub=e.Kd_Sub AND a1.Kd_UPB=e.Kd_UPB AND a1.Kd_Aset1=e.Kd_Aset1 AND a1.Kd_Aset2=e.Kd_Aset2 AND a1.Kd_Aset3=e.Kd_Aset3 AND a1.Kd_Aset4=e.Kd_Aset4 AND a1.Kd_Aset5=e.Kd_Aset5 AND a1.No_Register=e.No_Register  AND Kd_Riwayat IN (3,19) AND YEAR(e.Tgl_Dokumen) <= '{$thn}') )as a2 ) as a WHERE 1=1 $where $tgl_pembukuan ) as a3 ON a3.Kd_Aset1=n.Kd_Aset1 AND a3.Kd_Aset2=n.Kd_Aset2 WHERE n.Kd_Aset1=7 AND n.Kd_Aset2=24 GROUP BY n.Kd_Aset1,n.Kd_Aset2,n.Nm_Aset2 ORDER BY Kd_Aset2"; return $this->db->query($query); } /** * Menampilkan semua data kib b */ function lainnya_inventaris($bidang='',$unit='',$sub='',$upb='',$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){if($bidang){$where = "AND (a.Kd_Bidang = $kb)"; } if($unit){$where .= "AND (a.Kd_Unit = $ku)"; } if($sub){$where .= "AND (a.Kd_Sub = $ks)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{if($bidang){$where = "AND (a.Kd_Bidang = $kb)"; } if($unit){$where .= "AND (a.Kd_Unit = $ku)"; } if($sub){$where .= "AND (a.Kd_Sub = $ks)"; } if($upb){$where .= "AND (a.Kd_UPB = $kupb)"; } } if($bidang == '' AND $unit =='' AND $sub =='' AND $upb ==''){$query = "SELECT   Ref_Rek_Aset5.Nm_Aset5,COUNT(a.No_register) as jumlah_register,MIN(a.No_register) as min_register, MAX(a.No_register) as max_register, a.Kd_Prov, a.Kd_Kab_Kota, a.Kd_Bidang, a.Kd_Unit, a.Kd_Sub, a.Kd_UPB, a.Kd_Aset1, a.Kd_Aset2, a.Kd_Aset3, a.Kd_Aset4, a.Kd_Aset5, a.Kd_Pemilik, a.Merk, a.Type, a.CC, a.Bahan, DATENAME(yyyy,a.Tgl_Perolehan) as Tahun,a.Nomor_Pabrik,a.Nomor_Rangka,a.Nomor_Mesin, a.Nomor_Polisi,a.Nomor_BPKB,a.Asal_usul,a.Kondisi,COUNT(*) as Jumlah, SUM(a.Harga) as Harga,Ref_UPB.Nm_UPB FROM  Ta_Lainnya a INNER JOIN Ref_Rek_Aset5 ON a.Kd_Aset1 = Ref_Rek_Aset5.Kd_Aset1 AND a.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND a.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND a.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND a.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 LEFT JOIN Ref_UPB ON a.Kd_Bidang=Ref_UPB.Kd_Bidang AND a.Kd_Unit=Ref_UPB.Kd_Unit AND a.Kd_Sub=Ref_UPB.Kd_Sub AND a.Kd_UPB=Ref_UPB.Kd_UPB WHERE 1=1 $where $like GROUP BY a.Kd_Prov, a.Kd_Kab_Kota, a.Kd_Bidang, a.Kd_Unit, a.Kd_Sub, a.Kd_UPB, a.Kd_Aset1, a.Kd_Aset2, a.Kd_Aset3, a.Kd_Aset4, a.Kd_Aset5, a.Kd_Pemilik, a.Merk, a.Type, a.CC, a.Bahan, a.Tgl_Perolehan,a.Nomor_Pabrik,a.Nomor_Rangka,a.Nomor_Mesin,a.Nomor_Polisi, a.Nomor_BPKB,a.Asal_usul,a.Kondisi,Ref_Rek_Aset5.Nm_Aset5,Ref_UPB.Nm_UPB ORDER BY Ref_Rek_Aset5.Nm_Aset5, MIN(a.No_register)"; }else{$query = "SELECT   Ref_Rek_Aset5.Nm_Aset5,COUNT(a.No_register) as jumlah_register,MIN(a.No_register) as min_register, MAX(a.No_register) as max_register, a.Kd_Prov, a.Kd_Kab_Kota, a.Kd_Bidang, a.Kd_Unit, a.Kd_Sub, a.Kd_UPB, a.Kd_Aset1, a.Kd_Aset2, a.Kd_Aset3, a.Kd_Aset4, a.Kd_Aset5, a.Kd_Pemilik, a.Merk, a.Type, a.CC, a.Bahan, DATENAME(yyyy,a.Tgl_Perolehan) as Tahun,a.Nomor_Pabrik,a.Nomor_Rangka,a.Nomor_Mesin, a.Nomor_Polisi,a.Nomor_BPKB,a.Asal_usul,a.Kondisi,COUNT(*) as Jumlah, SUM(a.Harga) as Harga,a.Keterangan FROM  Ta_Lainnya a INNER JOIN Ref_Rek_Aset5 ON a.Kd_Aset1 = Ref_Rek_Aset5.Kd_Aset1 AND a.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND a.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND a.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND a.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 WHERE 1=1 $where $like GROUP BY a.Kd_Prov, a.Kd_Kab_Kota, a.Kd_Bidang, a.Kd_Unit, a.Kd_Sub, a.Kd_UPB, a.Kd_Aset1, a.Kd_Aset2, a.Kd_Aset3, a.Kd_Aset4, a.Kd_Aset5, a.Kd_Pemilik, a.Merk, a.Type, a.CC, a.Bahan, a.Tgl_Perolehan,a.Nomor_Pabrik,a.Nomor_Rangka,a.Nomor_Mesin,a.Nomor_Polisi, a.Nomor_BPKB,a.Asal_usul,a.Kondisi,a.Keterangan,Ref_Rek_Aset5.Nm_Aset5 ORDER BY  Ref_Rek_Aset5.Nm_Aset5, MIN(a.No_register)"; } return $this->db->query($query); } /** * Menampilkan semua data kib b */ function total_lainnya_inventaris($bidang='',$unit='',$sub='',$upb='',$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){if($bidang){$where = "AND (a.Kd_Bidang = $kb)"; } if($unit){$where .= "AND (a.Kd_Unit = $ku)"; } if($sub){$where .= "AND (a.Kd_Sub = $ks)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{if($bidang){$where = "AND (a.Kd_Bidang = $kb)"; } if($unit){$where .= "AND (a.Kd_Unit = $ku)"; } if($sub){$where .= "AND (a.Kd_Sub = $ks)"; } if($upb){$where .= "AND (a.Kd_UPB = $kupb)"; } } $query = "SELECT COUNT(*) as Jumlah,SUM(Harga) as Harga FROM Ta_Lainnya a WHERE 1=1 $where $like"; return $this->db->query($query); } /** * Menampilkan semua data lainya rekap */ function rekap_inventaris($bidang='',$unit='',$sub='',$upb='',$tahunawal,$tahunakhir,$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $thn   =  $this->session->userdata('tahun_anggaran'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; $where .= "AND (a.Kd_UPB = $kupb)"; } $tgl_pembukuan 	= " AND Tgl_Pembukuan ".$like; $tgl_dokumen 	= " AND Tgl_Dokumen <= ".$tahunakhir; $query = "SELECT n.Kd_Aset1,n.Kd_Aset2,Nm_Aset2,COUNT(Harga) as Jumlah, SUM(LastHarga) as Harga FROM Ref_Rek_Aset2 n LEFT JOIN (SELECT * FROM (SELECT *,((Harga + ISNULL(Koreksi_Tambah, 0) ) - ISNULL(Koreksi_Kurang, 0) ) as LastHarga FROM (SELECT n.Nm_Aset5, a1.*, (CASE WHEN NewKondisi is null THEN Kondisi ELSE NewKondisi END) as lastKondisi, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBBR a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBBR a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_Lainnya a1 OUTER APPLY (SELECT TOP 1 b.Kondisi as NewKondisi FROM Ta_KILER b WHERE a1.Kd_Bidang=b.Kd_Bidang AND a1.Kd_Unit=b.Kd_Unit AND a1.Kd_Sub=b.Kd_Sub AND a1.Kd_UPB=b.Kd_UPB AND a1.Kd_Aset1=b.Kd_Aset1 AND a1.Kd_Aset2=b.Kd_Aset2 AND a1.Kd_Aset3=b.Kd_Aset3 AND a1.Kd_Aset4=b.Kd_Aset4 AND a1.Kd_Aset5=b.Kd_Aset5 AND a1.No_Register=b.No_Register AND Kd_Riwayat=1 AND b.Tgl_Dokumen < '{$tahunakhir}'ORDER BY b.Tgl_Dokumen DESC) as b INNER JOIN Ref_Rek_Aset5 n ON a1.Kd_Aset1 = n.Kd_Aset1 AND a1.Kd_Aset2 = n.Kd_Aset2 AND a1.Kd_Aset3 = n.Kd_Aset3 AND a1.Kd_Aset4 = n.Kd_Aset4 AND a1.Kd_Aset5 = n.Kd_Aset5 WHERE NOT EXISTS (SELECT 1 FROM   Ta_KILHapus d INNER JOIN Ta_Penghapusan e ON d.No_SK=e.No_SK WHERE a1.Kd_Bidang=d.Kd_Bidang AND a1.Kd_Unit=d.Kd_Unit AND a1.Kd_Sub=d.Kd_Sub AND a1.Kd_UPB=d.Kd_UPB AND a1.Kd_Aset1=d.Kd_Aset1 AND a1.Kd_Aset2=d.Kd_Aset2 AND a1.Kd_Aset3=d.Kd_Aset3 AND a1.Kd_Aset4=d.Kd_Aset4 AND a1.Kd_Aset5=d.Kd_Aset5 AND a1.No_Register=d.No_Register AND e.Tgl_SK < '{$tahunakhir}') AND NOT EXISTS (SELECT 1 FROM  Ta_KILER e WHERE a1.Kd_Bidang=e.Kd_Bidang AND a1.Kd_Unit=e.Kd_Unit AND a1.Kd_Sub=e.Kd_Sub AND a1.Kd_UPB=e.Kd_UPB AND a1.Kd_Aset1=e.Kd_Aset1 AND a1.Kd_Aset2=e.Kd_Aset2 AND a1.Kd_Aset3=e.Kd_Aset3 AND a1.Kd_Aset4=e.Kd_Aset4 AND a1.Kd_Aset5=e.Kd_Aset5 AND a1.No_Register=e.No_Register AND Kd_Riwayat IN (3,19) AND e.Tgl_Dokumen < '{$tahunakhir}') ) as x ) as a WHERE 1=1 $where $tgl_pembukuan ) as a1 ON a1.Kd_Aset1=n.Kd_Aset1 AND a1.Kd_Aset2=n.Kd_Aset2 WHERE n.Kd_Aset1=7 AND n.Kd_Aset2 IN (22,24) GROUP BY n.Kd_Aset1,n.Kd_Aset2,Nm_Aset2"; return $this->db->query($query); } function kib_kondisi($bidang='',$unit='',$sub='',$upb='',$tahunawal,$tahunakhir,$like,$kondisi) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $thn   =  $this->session->userdata('tahun_anggaran'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; $where .= "AND (a.Kd_UPB = $kupb)"; } $tgl_pembukuan 	= " AND Tgl_Pembukuan ".$like; $tgl_dokumen 	= " AND Tgl_Dokumen <= '".$tahunakhir."'"; $query = "SELECT a.Nm_Aset5,COUNT(a.No_register) as jumlah_register, MIN(a.No_register) as min_register, MAX(a.No_register) as max_register, a.Kd_Prov, a.Kd_Kab_Kota, a.Kd_Bidang, a.Kd_Unit, a.Kd_Sub, a.Kd_UPB, a.Kd_Aset1, a.Kd_Aset2, a.Kd_Aset3, a.Kd_Aset4, a.Kd_Aset5, a.Kd_Pemilik,DATENAME(yyyy,a.Tgl_Perolehan) as Tahun, a.Asal_usul,a.Judul,a.Pencipta,a.LastKondisi,COUNT(*) as Jumlah, SUM(LastHarga) as  Harga, a.Keterangan FROM (SELECT *,((Harga + ISNULL(Koreksi_Tambah, 0) ) - ISNULL(Koreksi_Kurang, 0) ) as LastHarga FROM (SELECT n.Nm_Aset5, a1.*, (CASE WHEN NewKondisi is null THEN Kondisi ELSE NewKondisi END) as lastKondisi, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBER a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KIBER a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_KIB_E a1 OUTER APPLY (SELECT TOP 1 b.Kondisi as NewKondisi FROM Ta_KIBER b WHERE a1.Kd_Bidang=b.Kd_Bidang AND a1.Kd_Unit=b.Kd_Unit AND a1.Kd_Sub=b.Kd_Sub AND a1.Kd_UPB=b.Kd_UPB AND a1.Kd_Aset1=b.Kd_Aset1 AND a1.Kd_Aset2=b.Kd_Aset2 AND a1.Kd_Aset3=b.Kd_Aset3 AND a1.Kd_Aset4=b.Kd_Aset4 AND a1.Kd_Aset5=b.Kd_Aset5 AND a1.No_Register=b.No_Register AND Kd_Riwayat=1 AND YEAR(b.Tgl_Dokumen) <= '{$thn}'ORDER BY b.Tgl_Dokumen DESC) as b INNER JOIN Ref_Rek_Aset5 n ON a1.Kd_Aset1 = n.Kd_Aset1 AND a1.Kd_Aset2 = n.Kd_Aset2 AND a1.Kd_Aset3 = n.Kd_Aset3 AND a1.Kd_Aset4 = n.Kd_Aset4 AND a1.Kd_Aset5 = n.Kd_Aset5 WHERE NOT EXISTS (SELECT 1 FROM   Ta_KIBEHapus d INNER JOIN Ta_Penghapusan e ON d.No_SK=e.No_SK WHERE a1.Kd_Bidang=d.Kd_Bidang AND a1.Kd_Unit=d.Kd_Unit AND a1.Kd_Sub=d.Kd_Sub AND a1.Kd_UPB=d.Kd_UPB AND a1.Kd_Aset1=d.Kd_Aset1 AND a1.Kd_Aset2=d.Kd_Aset2 AND a1.Kd_Aset3=d.Kd_Aset3 AND a1.Kd_Aset4=d.Kd_Aset4 AND a1.Kd_Aset5=d.Kd_Aset5 AND a1.No_Register=d.No_Register AND YEAR(e.Tgl_SK) <= '{$thn}') AND NOT EXISTS (SELECT 1 FROM   Ta_KIBER e WHERE a1.Kd_Bidang=e.Kd_Bidang AND a1.Kd_Unit=e.Kd_Unit AND a1.Kd_Sub=e.Kd_Sub AND a1.Kd_UPB=e.Kd_UPB AND a1.Kd_Aset1=e.Kd_Aset1 AND a1.Kd_Aset2=e.Kd_Aset2 AND a1.Kd_Aset3=e.Kd_Aset3 AND a1.Kd_Aset4=e.Kd_Aset4 AND a1.Kd_Aset5=e.Kd_Aset5 AND a1.No_Register=e.No_Register  AND Kd_Riwayat IN (3,19) AND YEAR(e.Tgl_Dokumen) <= '{$thn}') ) as x ) as a WHERE 1=1 $where $tgl_pembukuan $kondisi GROUP BY a.Kd_Prov, a.Kd_Kab_Kota, a.Kd_Bidang, a.Kd_Unit, a.Kd_Sub, a.Kd_UPB, a.Kd_Aset1, a.Kd_Aset2, a.Kd_Aset3, a.Kd_Aset4, a.Kd_Aset5, a.Kd_Pemilik, a.Kd_Pemilik,a.Tgl_Perolehan, a.Asal_usul,a.Judul,a.Pencipta,a.lastKondisi,a.Keterangan,a.Nm_Aset5,a.LastKondisi ORDER BY  a.Kd_Aset1, a.Kd_Aset2, a.Kd_Aset3,a.Kd_Aset4, a.Kd_Aset5"; return $this->db->query($query); } function get_riwayat_barang($kd_prov,$kd_kab,$kd_bidang,$kd_unit,$kd_sub,$kd_upb, $kd_aset1,$kd_aset2,$kd_aset3,$kd_aset4,$kd_aset5,$no_register){$where = ""; $where .= " AND Ta_KILER.Kd_Prov=".$kd_prov; $where .= " AND Ta_KILER.Kd_Kab_Kota=".$kd_kab; $where .= " AND Ta_KILER.Kd_Bidang=".$kd_bidang; $where .= " AND Ta_KILER.Kd_Unit=".$kd_unit; $where .= " AND Ta_KILER.Kd_Sub=".$kd_sub; $where .= " AND Ta_KILER.Kd_UPB=".$kd_upb; $where .= " AND Ta_KILER.Kd_Aset1=".$kd_aset1; $where .= " AND Ta_KILER.Kd_Aset2=".$kd_aset2; $where .= " AND Ta_KILER.Kd_Aset3=".$kd_aset3; $where .= " AND Ta_KILER.Kd_Aset4=".$kd_aset4; $where .= " AND Ta_KILER.Kd_Aset5=".$kd_aset5; $where .= " AND Ta_KILER.No_register=".$no_register; $where .= " AND YEAR(Ta_KILER.Tgl_Dokumen) <= '{$this->session->userdata('tahun_anggaran')}'"; $sql = "SELECT  * FROM  (SELECT  Ref_Rek_Aset5.Nm_Aset5, Ref_Riwayat.Nm_Riwayat,Ta_KILER.*, ROW_NUMBER() OVER (ORDER BY Ta_KILER.Log_entry DESC) AS halaman		FROM  Ta_KILER INNER JOIN Ref_Rek_Aset5 ON Ta_KILER.Kd_Aset1=Ref_Rek_Aset5.Kd_Aset1 AND Ta_KILER.Kd_Aset2 = Ref_Rek_Aset5.Kd_Aset2 AND Ta_KILER.Kd_Aset3 = Ref_Rek_Aset5.Kd_Aset3 AND Ta_KILER.Kd_Aset4 = Ref_Rek_Aset5.Kd_Aset4 AND Ta_KILER.Kd_Aset5 = Ref_Rek_Aset5.Kd_Aset5 LEFT JOIN Ref_Riwayat ON Ta_KILER.Kd_Riwayat=Ref_Riwayat.Kd_Riwayat WHERE 1=1 $where) AS Ta_KILER"; return $this->db->query($sql); } function kib_susut($bidang='',$unit='',$sub='',$upb='',$tahunawal,$tahunakhir,$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $thn   =  $this->session->userdata('tahun_anggaran'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; $where .= "AND (a.Kd_UPB = $kupb)"; } $tgl_pembukuan = " AND Tgl_Pembukuan ".$like; $tgl_dokumen   = " AND Tgl_Dokumen <= '".$tahunakhir."'"; $query = "SELECT Nm_Aset5,Kd_Prov, Kd_Kab_Kota, Kd_Bidang, Kd_Unit, Kd_Sub, Kd_UPB, Kd_Aset1, Kd_Aset2, Kd_Aset3, Kd_Aset4, Kd_Aset5,Masa_Manfaat, DATENAME(yyyy,Tgl_Perolehan) as Tahun, COUNT(*) as Jumlah, SUM(LastHarga) as Harga, SUM(Kapitalisasi) as Kapitalisasi, SUM(Susut) as Susut, SUM(Akm_Susut) as Akm_Susut, Sisa_Masa_Manfaat, SUM(NB) as NB, Keterangan FROM (SELECT *, dbo.fn_KIB_LAINNYA_Susut(Kd_Prov,Kd_Kab_Kota,Kd_Bidang,Kd_Unit,Kd_Sub,Kd_UPB,Kd_Aset1,Kd_Aset2,Kd_Aset3,Kd_Aset4,Kd_Aset5,No_Register,Masa_Manfaat,HargaKoreksi,YEAR(Tgl_Perolehan),$thn,$this->neraca_awal,1) as Susut, dbo.fn_KIB_LAINNYA_Susut(Kd_Prov,Kd_Kab_Kota,Kd_Bidang,Kd_Unit,Kd_Sub,Kd_UPB,Kd_Aset1,Kd_Aset2,Kd_Aset3,Kd_Aset4,Kd_Aset5,No_Register,Masa_Manfaat,HargaKoreksi,YEAR(Tgl_Perolehan),$thn,$this->neraca_awal,2) as Akm_Susut, dbo.fn_KIB_LAINNYA_Susut(Kd_Prov,Kd_Kab_Kota,Kd_Bidang,Kd_Unit,Kd_Sub,Kd_UPB,Kd_Aset1,Kd_Aset2,Kd_Aset3,Kd_Aset4,Kd_Aset5,No_Register,Masa_Manfaat,HargaKoreksi,YEAR(Tgl_Perolehan),$thn,$this->neraca_awal,3) as Sisa_Masa_Manfaat, dbo.fn_KIB_LAINNYA_Susut(Kd_Prov,Kd_Kab_Kota,Kd_Bidang,Kd_Unit,Kd_Sub,Kd_UPB,Kd_Aset1,Kd_Aset2,Kd_Aset3,Kd_Aset4,Kd_Aset5,No_Register,Masa_Manfaat,HargaKoreksi,YEAR(Tgl_Perolehan),$thn,$this->neraca_awal,4) as NB FROM (SELECT *, ((Harga + ISNULL(Total_Koreksi, 0) ) - ISNULL(Koreksi_Kurang, 0) ) as HargaKoreksi, ((Harga + ISNULL(Koreksi_Tambah, 0) ) - ISNULL(Koreksi_Kurang, 0) ) as LastHarga FROM  (SELECT n.Nm_Aset5, a1.*, (CASE WHEN NewKondisi is null THEN Kondisi ELSE NewKondisi END) as lastKondisi, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KILER a2 WHERE a2.Kd_Riwayat = 21 AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Total_Koreksi, (SELECT SUM(Harga) as Rharga FROM Ta_KILER a2 WHERE a2.Kd_Riwayat = 2 AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Kapitalisasi, (SELECT SUM(Harga) as Rharga FROM Ta_KILER a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KILER a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_Lainnya a1 OUTER APPLY (SELECT TOP 1 b.Kondisi as NewKondisi FROM Ta_KILER b WHERE a1.Kd_Bidang=b.Kd_Bidang AND a1.Kd_Unit=b.Kd_Unit AND a1.Kd_Sub=b.Kd_Sub AND a1.Kd_UPB=b.Kd_UPB AND a1.Kd_Aset1=b.Kd_Aset1 AND a1.Kd_Aset2=b.Kd_Aset2 AND a1.Kd_Aset3=b.Kd_Aset3 AND a1.Kd_Aset4=b.Kd_Aset4 AND a1.Kd_Aset5=b.Kd_Aset5 AND a1.No_Register=b.No_Register AND Kd_Riwayat=1 AND YEAR(b.Tgl_Dokumen) <= '{$thn}'ORDER BY b.Tgl_Dokumen DESC) as b INNER JOIN Ref_Rek_Aset5 n ON a1.Kd_Aset1 = n.Kd_Aset1 AND a1.Kd_Aset2 = n.Kd_Aset2 AND a1.Kd_Aset3 = n.Kd_Aset3 AND a1.Kd_Aset4 = n.Kd_Aset4 AND a1.Kd_Aset5 = n.Kd_Aset5 WHERE NOT EXISTS (SELECT 1 FROM   Ta_KILHapus d INNER JOIN Ta_Penghapusan e ON d.No_SK=e.No_SK WHERE a1.Kd_Bidang=d.Kd_Bidang AND a1.Kd_Unit=d.Kd_Unit AND a1.Kd_Sub=d.Kd_Sub AND a1.Kd_UPB=d.Kd_UPB AND a1.Kd_Aset1=d.Kd_Aset1 AND a1.Kd_Aset2=d.Kd_Aset2 AND a1.Kd_Aset3=d.Kd_Aset3 AND a1.Kd_Aset4=d.Kd_Aset4 AND a1.Kd_Aset5=d.Kd_Aset5 AND a1.No_Register=d.No_Register AND YEAR(e.Tgl_SK) <= '{$thn}') AND NOT EXISTS (SELECT 1 FROM   Ta_KILER e WHERE a1.Kd_Bidang=e.Kd_Bidang AND a1.Kd_Unit=e.Kd_Unit AND a1.Kd_Sub=e.Kd_Sub AND a1.Kd_UPB=e.Kd_UPB AND a1.Kd_Aset1=e.Kd_Aset1 AND a1.Kd_Aset2=e.Kd_Aset2 AND a1.Kd_Aset3=e.Kd_Aset3 AND a1.Kd_Aset4=e.Kd_Aset4 AND a1.Kd_Aset5=e.Kd_Aset5 AND a1.No_Register=e.No_Register  AND Kd_Riwayat IN (3,19) AND YEAR(e.Tgl_Dokumen) <= '{$thn}') )as a2 ) as a WHERE 1=1 AND a.Kd_Aset1=7 AND a.Kd_Aset2=24 $where $tgl_pembukuan  ) as a3 GROUP BY Nm_Aset5,Kd_Prov, Kd_Kab_Kota, Kd_Bidang, Kd_Unit, Kd_Sub, Kd_UPB, Kd_Aset1, Kd_Aset2, Kd_Aset3, Kd_Aset4, Kd_Aset5,Masa_Manfaat, DATENAME(yyyy,Tgl_Perolehan),Sisa_Masa_Manfaat,Keterangan"; return $this->db->query($query); } function rekap_susut($bidang='',$unit='',$sub='',$upb='',$tahunawal,$tahunakhir,$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $thn   =  $this->session->userdata('tahun_anggaran'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; $where .= "AND (a.Kd_UPB = $kupb)"; } $tgl_pembukuan = " AND Tgl_Pembukuan ".$like; $tgl_dokumen   = " AND Tgl_Dokumen <= '".$tahunakhir."'"; $thn           = $this->session->userdata('tahun_anggaran'); $query = "SELECT Ref_Rek_Aset2.Kd_Aset1,Ref_Rek_Aset2.Kd_Aset2,Nm_Aset2, SUM(Harga) as Harga, SUM(NB_Awal) as NB_Awal, SUM(NB_Akhir) as NB_Akhir, SUM(Akm_Susut) as Akm_Susut, SUM(Kapitalisasi) as Kapitalisasi FROM Ref_Rek_Aset2 LEFT JOIN (SELECT *, dbo.fn_KIB_LAINNYA_Susut(Kd_Prov,Kd_Kab_Kota,Kd_Bidang,Kd_Unit,Kd_Sub,Kd_UPB,Kd_Aset1,Kd_Aset2,Kd_Aset3,Kd_Aset4,Kd_Aset5,No_Register,Masa_Manfaat,HargaKoreksi,YEAR(Tgl_Perolehan),$thn,$this->neraca_awal,4) as NB_Awal, dbo.fn_KIB_LAINNYA_Susut(Kd_Prov,Kd_Kab_Kota,Kd_Bidang,Kd_Unit,Kd_Sub,Kd_UPB,Kd_Aset1,Kd_Aset2,Kd_Aset3,Kd_Aset4,Kd_Aset5,No_Register,Masa_Manfaat,HargaKoreksi,YEAR(Tgl_Perolehan),$thn,$this->neraca_awal,4) as NB_Akhir, dbo.fn_KIB_LAINNYA_Susut(Kd_Prov,Kd_Kab_Kota,Kd_Bidang,Kd_Unit,Kd_Sub,Kd_UPB,Kd_Aset1,Kd_Aset2,Kd_Aset3,Kd_Aset4,Kd_Aset5,No_Register,Masa_Manfaat,HargaKoreksi,YEAR(Tgl_Perolehan),$thn,$this->neraca_awal,2) as Akm_Susut FROM (SELECT *, ((Harga + ISNULL(Total_Koreksi, 0) ) - ISNULL(Koreksi_Kurang, 0) ) as HargaKoreksi, ((Harga + ISNULL(Koreksi_Tambah, 0) ) - ISNULL(Koreksi_Kurang, 0) ) as LastHarga FROM  (SELECT n.Nm_Aset5, a1.*, (CASE WHEN NewKondisi is null THEN Kondisi ELSE NewKondisi END) as lastKondisi, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KILER a2 WHERE a2.Kd_Riwayat = 21 AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Total_Koreksi, (SELECT SUM(Harga) as Rharga FROM Ta_KILER a2 WHERE a2.Kd_Riwayat = 2 AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Kapitalisasi, (SELECT SUM(Harga) as Rharga FROM Ta_KILER a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KILER a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_Lainnya a1 OUTER APPLY (SELECT TOP 1 b.Kondisi as NewKondisi FROM Ta_KILER b WHERE a1.Kd_Bidang=b.Kd_Bidang AND a1.Kd_Unit=b.Kd_Unit AND a1.Kd_Sub=b.Kd_Sub AND a1.Kd_UPB=b.Kd_UPB AND a1.Kd_Aset1=b.Kd_Aset1 AND a1.Kd_Aset2=b.Kd_Aset2 AND a1.Kd_Aset3=b.Kd_Aset3 AND a1.Kd_Aset4=b.Kd_Aset4 AND a1.Kd_Aset5=b.Kd_Aset5 AND a1.No_Register=b.No_Register AND Kd_Riwayat=1 AND YEAR(b.Tgl_Dokumen) <= '{$thn}'ORDER BY b.Tgl_Dokumen DESC) as b INNER JOIN Ref_Rek_Aset5 n ON a1.Kd_Aset1 = n.Kd_Aset1 AND a1.Kd_Aset2 = n.Kd_Aset2 AND a1.Kd_Aset3 = n.Kd_Aset3 AND a1.Kd_Aset4 = n.Kd_Aset4 AND a1.Kd_Aset5 = n.Kd_Aset5 WHERE NOT EXISTS (SELECT 1 FROM   Ta_KILHapus d INNER JOIN Ta_Penghapusan e ON d.No_SK=e.No_SK WHERE a1.Kd_Bidang=d.Kd_Bidang AND a1.Kd_Unit=d.Kd_Unit AND a1.Kd_Sub=d.Kd_Sub AND a1.Kd_UPB=d.Kd_UPB AND a1.Kd_Aset1=d.Kd_Aset1 AND a1.Kd_Aset2=d.Kd_Aset2 AND a1.Kd_Aset3=d.Kd_Aset3 AND a1.Kd_Aset4=d.Kd_Aset4 AND a1.Kd_Aset5=d.Kd_Aset5 AND a1.No_Register=d.No_Register AND YEAR(e.Tgl_SK) <= '{$thn}') AND NOT EXISTS (SELECT 1 FROM   Ta_KILER e WHERE a1.Kd_Bidang=e.Kd_Bidang AND a1.Kd_Unit=e.Kd_Unit AND a1.Kd_Sub=e.Kd_Sub AND a1.Kd_UPB=e.Kd_UPB AND a1.Kd_Aset1=e.Kd_Aset1 AND a1.Kd_Aset2=e.Kd_Aset2 AND a1.Kd_Aset3=e.Kd_Aset3 AND a1.Kd_Aset4=e.Kd_Aset4 AND a1.Kd_Aset5=e.Kd_Aset5 AND a1.No_Register=e.No_Register  AND Kd_Riwayat IN (3,19) AND YEAR(e.Tgl_Dokumen) <= '{$thn}') )as a2 ) as a WHERE 1=1 AND a.Kd_Aset1=7 AND a.Kd_Aset2=24 $where $tgl_pembukuan ) as a3 ON a3.Kd_Aset1=Ref_Rek_Aset2.Kd_Aset1 AND a3.Kd_Aset2=Ref_Rek_Aset2.Kd_Aset2 WHERE Ref_Rek_Aset2.Kd_Aset1=7 AND Ref_Rek_Aset2.Kd_Aset2=24 GROUP BY Ref_Rek_Aset2.Kd_Aset1,Ref_Rek_Aset2.Kd_Aset2,Nm_Aset2 ORDER BY Kd_Aset2"; return $this->db->query($query); } function kib_non_op($bidang='',$unit='',$sub='',$upb='',$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; $where .= "AND (a.Kd_UPB = $kupb)"; } $tgl_perolehan 	= " AND Tgl_Perolehan ".$like; $thn 	= $this->session->userdata('tahun_anggaran'); $query = "SELECT a.*,n.Nm_Aset5 FROM Ta_Lainnya a LEFT JOIN Ref_Rek_Aset5 n ON	a.Kd_Aset1=n.Kd_Aset1 AND a.Kd_Aset2=n.Kd_Aset2 AND a.Kd_Aset3=n.Kd_Aset3 AND a.Kd_Aset4=n.Kd_Aset4 AND a.Kd_Aset5=n.Kd_Aset5 WHERE a.Kd_Aset1=7 AND a.Kd_Aset2=22 $where $tgl_perolehan AND NOT EXISTS (SELECT 1 FROM   Ta_KILHapus d INNER JOIN Ta_Penghapusan e ON d.No_SK=e.No_SK WHERE a.Kd_Bidang=d.Kd_Bidang AND a.Kd_Unit=d.Kd_Unit AND a.Kd_Sub=d.Kd_Sub AND a.Kd_UPB=d.Kd_UPB AND a.Kd_Aset1=d.Kd_Aset1 AND a.Kd_Aset2=d.Kd_Aset2 AND a.Kd_Aset3=d.Kd_Aset3 AND a.Kd_Aset4=d.Kd_Aset4 AND a.Kd_Aset5=d.Kd_Aset5 AND a.No_Register=d.No_Register AND YEAR(e.Tgl_SK) <= '{$thn}')"; return $this->db->query($query); } function bi($bidang='',$unit='',$sub='',$upb='', $tahunawal, $tahunakhir,$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $thn   =  $this->session->userdata('tahun_anggaran'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; $where .= "AND (a.Kd_UPB = $kupb)"; } $tgl_pembukuan 	= " AND Tgl_Pembukuan ".$like; $tgl_dokumen 	= " AND Tgl_Dokumen <= '".$tahunakhir."'"; $query = "SELECT a.Nm_Aset5,COUNT(a.No_register) as jumlah_register, MIN(a.No_register) as min_register, MAX(a.No_register) as max_register, a.Kd_Prov, a.Kd_Kab_Kota, a.Kd_Bidang, a.Kd_Unit, a.Kd_Sub, a.Kd_UPB, a.Kd_Aset1, a.Kd_Aset2, a.Kd_Aset3, a.Kd_Aset4, a.Kd_Aset5, a.Kd_Pemilik,DATENAME(yyyy,a.Tgl_Perolehan) as Tahun, a.Asal_usul,a.Judul,a.Pencipta,a.LastKondisi,COUNT(*) as Jumlah, SUM(LastHarga) as  Harga, a.Keterangan FROM (SELECT *,((Harga + ISNULL(Koreksi_Tambah, 0) ) - ISNULL(Koreksi_Kurang, 0) ) as LastHarga FROM (SELECT n.Nm_Aset5, a1.*, (CASE WHEN NewKondisi is null THEN Kondisi ELSE NewKondisi END) as lastKondisi, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KILER a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KILER a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_Lainnya a1 OUTER APPLY (SELECT TOP 1 b.Kondisi as NewKondisi FROM Ta_KILER b WHERE a1.Kd_Bidang=b.Kd_Bidang AND a1.Kd_Unit=b.Kd_Unit AND a1.Kd_Sub=b.Kd_Sub AND a1.Kd_UPB=b.Kd_UPB AND a1.Kd_Aset1=b.Kd_Aset1 AND a1.Kd_Aset2=b.Kd_Aset2 AND a1.Kd_Aset3=b.Kd_Aset3 AND a1.Kd_Aset4=b.Kd_Aset4 AND a1.Kd_Aset5=b.Kd_Aset5 AND a1.No_Register=b.No_Register AND Kd_Riwayat=1 AND b.Tgl_Dokumen <= '{$tahunakhir}'ORDER BY b.Tgl_Dokumen DESC) as b INNER JOIN Ref_Rek_Aset5 n ON a1.Kd_Aset1 = n.Kd_Aset1 AND a1.Kd_Aset2 = n.Kd_Aset2 AND a1.Kd_Aset3 = n.Kd_Aset3 AND a1.Kd_Aset4 = n.Kd_Aset4 AND a1.Kd_Aset5 = n.Kd_Aset5 WHERE NOT EXISTS (SELECT 1 FROM   Ta_KILHapus d INNER JOIN Ta_Penghapusan e ON d.No_SK=e.No_SK WHERE a1.Kd_Bidang=d.Kd_Bidang AND a1.Kd_Unit=d.Kd_Unit AND a1.Kd_Sub=d.Kd_Sub AND a1.Kd_UPB=d.Kd_UPB AND a1.Kd_Aset1=d.Kd_Aset1 AND a1.Kd_Aset2=d.Kd_Aset2 AND a1.Kd_Aset3=d.Kd_Aset3 AND a1.Kd_Aset4=d.Kd_Aset4 AND a1.Kd_Aset5=d.Kd_Aset5 AND a1.No_Register=d.No_Register AND e.Tgl_SK <= '{$tahunakhir}') AND NOT EXISTS (SELECT 1 FROM   Ta_KILER e WHERE a1.Kd_Bidang=e.Kd_Bidang AND a1.Kd_Unit=e.Kd_Unit AND a1.Kd_Sub=e.Kd_Sub AND a1.Kd_UPB=e.Kd_UPB AND a1.Kd_Aset1=e.Kd_Aset1 AND a1.Kd_Aset2=e.Kd_Aset2 AND a1.Kd_Aset3=e.Kd_Aset3 AND a1.Kd_Aset4=e.Kd_Aset4 AND a1.Kd_Aset5=e.Kd_Aset5 AND a1.No_Register=e.No_Register AND Kd_Riwayat IN (3,19) AND e.Tgl_Dokumen <= '{$tahunakhir}') ) as x ) as a WHERE 1=1 AND a.Kd_Aset1=7 AND a.Kd_Aset2 IN (22,24) $where $tgl_pembukuan GROUP BY a.Kd_Prov, a.Kd_Kab_Kota, a.Kd_Bidang, a.Kd_Unit, a.Kd_Sub, a.Kd_UPB, a.Kd_Aset1, a.Kd_Aset2, a.Kd_Aset3, a.Kd_Aset4, a.Kd_Aset5, a.Kd_Pemilik, a.Kd_Pemilik,a.Tgl_Perolehan, a.Asal_usul,a.Judul,a.Pencipta,a.lastKondisi,a.Keterangan,a.Nm_Aset5,a.LastKondisi ORDER BY  a.Kd_Aset1, a.Kd_Aset2, a.Kd_Aset3,a.Kd_Aset4, a.Kd_Aset5"; return $this->db->query($query); } function kib_tdk_berwujud($bidang='',$unit='',$sub='',$upb='',$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){if($bidang){$where = "AND (a.Kd_Bidang = $kb)"; } if($unit){$where .= "AND (a.Kd_Unit = $ku)"; } if($sub){$where .= "AND (a.Kd_Sub = $ks)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{if($bidang){$where = "AND (a.Kd_Bidang = $kb)"; } if($unit){$where .= "AND (a.Kd_Unit = $ku)"; } if($sub){$where .= "AND (a.Kd_Sub = $ks)"; } if($upb){$where .= "AND (a.Kd_UPB = $kupb)"; } } $tgl_perolehan 	= " AND Tgl_Perolehan ".$like; $thn 	= $this->session->userdata('tahun_anggaran'); $query = "SELECT a.*,n.Nm_Aset5 FROM Ta_Lainnya a LEFT JOIN Ref_Rek_Aset5 n ON	a.Kd_Aset1=n.Kd_Aset1 AND a.Kd_Aset2=n.Kd_Aset2 AND a.Kd_Aset3=n.Kd_Aset3 AND a.Kd_Aset4=n.Kd_Aset4 AND a.Kd_Aset5=n.Kd_Aset5 WHERE a.Kd_Aset1=7 AND a.Kd_Aset2=24 $where $tgl_perolehan "; return $this->db->query($query); } function insert_usul_penghapusan($data){$sql = $this->db->insert("Ta_KILHapus", $data); if ($sql) return true; } function non_operasional($bidang='',$unit='',$sub='',$upb='', $tahunawal, $tahunakhir,$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $thn   =  $this->session->userdata('tahun_anggaran'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; $where .= "AND (a.Kd_UPB = $kupb)"; } $tgl_pembukuan 	= " AND Tgl_Pembukuan ".$like; $tgl_dokumen 	= " AND Tgl_Dokumen <= '".$tahunakhir."'"; $query = "SELECT a.Nm_Aset5,COUNT(a.No_register) as jumlah_register, MIN(a.No_register) as min_register, MAX(a.No_register) as max_register, a.Kd_Prov, a.Kd_Kab_Kota, a.Kd_Bidang, a.Kd_Unit, a.Kd_Sub, a.Kd_UPB, a.Kd_Aset1, a.Kd_Aset2, a.Kd_Aset3, a.Kd_Aset4, a.Kd_Aset5, a.Kd_Pemilik,DATENAME(yyyy,a.Tgl_Perolehan) as Tahun, a.Asal_usul,a.Judul,a.Pencipta,a.LastKondisi,COUNT(*) as Jumlah, SUM(LastHarga) as  Harga, a.Keterangan FROM (SELECT *,((Harga + ISNULL(Koreksi_Tambah, 0) ) - ISNULL(Koreksi_Kurang, 0) ) as LastHarga FROM (SELECT n.Nm_Aset5, a1.*, (CASE WHEN NewKondisi is null THEN Kondisi ELSE NewKondisi END) as lastKondisi, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KILER a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KILER a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_Lainnya a1 OUTER APPLY (SELECT TOP 1 b.Kondisi as NewKondisi FROM Ta_KILER b WHERE a1.Kd_Bidang=b.Kd_Bidang AND a1.Kd_Unit=b.Kd_Unit AND a1.Kd_Sub=b.Kd_Sub AND a1.Kd_UPB=b.Kd_UPB AND a1.Kd_Aset1=b.Kd_Aset1 AND a1.Kd_Aset2=b.Kd_Aset2 AND a1.Kd_Aset3=b.Kd_Aset3 AND a1.Kd_Aset4=b.Kd_Aset4 AND a1.Kd_Aset5=b.Kd_Aset5 AND a1.No_Register=b.No_Register AND Kd_Riwayat=1 AND b.Tgl_Dokumen <= '{$tahunakhir}'ORDER BY b.Tgl_Dokumen DESC) as b INNER JOIN Ref_Rek_Aset5 n ON a1.Kd_Aset1 = n.Kd_Aset1 AND a1.Kd_Aset2 = n.Kd_Aset2 AND a1.Kd_Aset3 = n.Kd_Aset3 AND a1.Kd_Aset4 = n.Kd_Aset4 AND a1.Kd_Aset5 = n.Kd_Aset5 WHERE NOT EXISTS (SELECT 1 FROM   Ta_KILHapus d INNER JOIN Ta_Penghapusan e ON d.No_SK=e.No_SK WHERE a1.Kd_Bidang=d.Kd_Bidang AND a1.Kd_Unit=d.Kd_Unit AND a1.Kd_Sub=d.Kd_Sub AND a1.Kd_UPB=d.Kd_UPB AND a1.Kd_Aset1=d.Kd_Aset1 AND a1.Kd_Aset2=d.Kd_Aset2 AND a1.Kd_Aset3=d.Kd_Aset3 AND a1.Kd_Aset4=d.Kd_Aset4 AND a1.Kd_Aset5=d.Kd_Aset5 AND a1.No_Register=d.No_Register AND e.Tgl_SK <= '{$tahunakhir}') AND NOT EXISTS (SELECT 1 FROM   Ta_KILER e WHERE a1.Kd_Bidang=e.Kd_Bidang AND a1.Kd_Unit=e.Kd_Unit AND a1.Kd_Sub=e.Kd_Sub AND a1.Kd_UPB=e.Kd_UPB AND a1.Kd_Aset1=e.Kd_Aset1 AND a1.Kd_Aset2=e.Kd_Aset2 AND a1.Kd_Aset3=e.Kd_Aset3 AND a1.Kd_Aset4=e.Kd_Aset4 AND a1.Kd_Aset5=e.Kd_Aset5 AND a1.No_Register=e.No_Register AND Kd_Riwayat IN (3,19) AND e.Tgl_Dokumen <= '{$tahunakhir}') ) as x ) as a WHERE 1=1 AND Kd_KA = 0 AND a.Kd_Aset1=7 AND a.Kd_Aset2 IN (22,24) $where $tgl_pembukuan GROUP BY a.Kd_Prov, a.Kd_Kab_Kota, a.Kd_Bidang, a.Kd_Unit, a.Kd_Sub, a.Kd_UPB, a.Kd_Aset1, a.Kd_Aset2, a.Kd_Aset3, a.Kd_Aset4, a.Kd_Aset5, a.Kd_Pemilik, a.Kd_Pemilik,a.Tgl_Perolehan, a.Asal_usul,a.Judul,a.Pencipta,a.lastKondisi,a.Keterangan,a.Nm_Aset5,a.LastKondisi ORDER BY  a.Kd_Aset1, a.Kd_Aset2, a.Kd_Aset3,a.Kd_Aset4, a.Kd_Aset5"; return $this->db->query($query); } function rincian_susut($bidang='',$unit='',$sub='',$upb='',$tahunawal,$tahunakhir,$like) {$kb    =  $this->session->userdata('kd_bidang'); $ku    =  $this->session->userdata('kd_unit'); $ks    =  $this->session->userdata('kd_sub_unit'); $kupb  =  $this->session->userdata('kd_upb'); $thn   =  $this->session->userdata('tahun_anggaran'); $where = ""; if ($this->session->userdata('lvl') == 01){if($bidang){$where = "AND (a.Kd_Bidang = $bidang)"; } if($unit){$where .= "AND (a.Kd_Unit = $unit)"; } if($sub){$where .= "AND (a.Kd_Sub = $sub)"; } if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }elseif ($this->session->userdata('lvl') == 02){$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; if($upb){$where .= "AND (a.Kd_UPB = $upb)"; } }else{$where = "AND (a.Kd_Bidang = $kb)"; $where .= "AND (a.Kd_Unit = $ku)"; $where .= "AND (a.Kd_Sub = $ks)"; $where .= "AND (a.Kd_UPB = $kupb)"; } $tgl_pembukuan = " AND Tgl_Pembukuan ".$like; $tgl_dokumen   = " AND Tgl_Dokumen <= '".$tahunakhir."'"; $kondisi       = " AND lastKondisi <> 3"; $set_non_op    = " AND Kd_KA <> 0"; $thn           = $this->session->userdata('tahun_anggaran'); $query = "SELECT d5.Kd_Bidang,d5.Kd_Unit,d5.Kd_Sub,d5.Kd_UPB, d5.Kd_Aset1,d5.Kd_Aset2,d5.Kd_Aset3,d5.Kd_Aset4,d5.Kd_Aset5, d2.Nm_Aset2,d3.Nm_Aset3,d4.Nm_Aset4,d5.Nm_Aset5, SUM(LastHarga) as NB_Awal, SUM(Susut) as Susut, SUM(Akm_Susut) as Akm_Susut, SUM(NB) as NB_Akhir FROM (SELECT *, dbo.fn_KIB_LAINNYA_Susut(Kd_Prov,Kd_Kab_Kota,Kd_Bidang,Kd_Unit,Kd_Sub,Kd_UPB,Kd_Aset1,Kd_Aset2,Kd_Aset3,Kd_Aset4,Kd_Aset5,No_Register,Masa_Manfaat,HargaKoreksi,YEAR(Tgl_Perolehan),$thn,$this->neraca_awal,1) as Susut, dbo.fn_KIB_LAINNYA_Susut(Kd_Prov,Kd_Kab_Kota,Kd_Bidang,Kd_Unit,Kd_Sub,Kd_UPB,Kd_Aset1,Kd_Aset2,Kd_Aset3,Kd_Aset4,Kd_Aset5,No_Register,Masa_Manfaat,HargaKoreksi,YEAR(Tgl_Perolehan),$thn,$this->neraca_awal,2) as Akm_Susut, dbo.fn_KIB_LAINNYA_Susut(Kd_Prov,Kd_Kab_Kota,Kd_Bidang,Kd_Unit,Kd_Sub,Kd_UPB,Kd_Aset1,Kd_Aset2,Kd_Aset3,Kd_Aset4,Kd_Aset5,No_Register,Masa_Manfaat,HargaKoreksi,YEAR(Tgl_Perolehan),$thn,$this->neraca_awal,3) as Sisa_Masa_Manfaat, dbo.fn_KIB_LAINNYA_Susut(Kd_Prov,Kd_Kab_Kota,Kd_Bidang,Kd_Unit,Kd_Sub,Kd_UPB,Kd_Aset1,Kd_Aset2,Kd_Aset3,Kd_Aset4,Kd_Aset5,No_Register,Masa_Manfaat,HargaKoreksi,YEAR(Tgl_Perolehan),$thn,$this->neraca_awal,4) as NB FROM (SELECT *, ((Harga + ISNULL(Total_Koreksi, 0) ) - ISNULL(Koreksi_Kurang, 0) ) as HargaKoreksi, ((Harga + ISNULL(Koreksi_Tambah, 0) ) - ISNULL(Koreksi_Kurang, 0) ) as LastHarga FROM  (SELECT n.Nm_Aset5, a1.*, (CASE WHEN NewKondisi is null THEN Kondisi ELSE NewKondisi END) as lastKondisi, /* ----------- jumlah Penambahan ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KILER a2 WHERE a2.Kd_Riwayat = 21 AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Total_Koreksi, (SELECT SUM(Harga) as Rharga FROM Ta_KILER a2 WHERE a2.Kd_Riwayat = 2 AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Kapitalisasi, (SELECT SUM(Harga) as Rharga FROM Ta_KILER a2 WHERE a2.Kd_Riwayat IN (2, 21) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Tambah, /* ----------- jumlah Berkurang ------------*/ (SELECT SUM(Harga) as Rharga FROM Ta_KILER a2 WHERE a2.Kd_Riwayat IN (7, 23) AND a1.Kd_Bidang = a2.Kd_Bidang AND a1.Kd_Unit = a2.Kd_Unit AND a1.Kd_Sub = a2.Kd_Sub AND a1.Kd_UPB = a2.Kd_UPB AND a1.Kd_Aset1 = a2.Kd_Aset1 AND a1.Kd_Aset2 = a2.Kd_Aset2 AND a1.Kd_Aset3 = a2.Kd_Aset3 AND a1.Kd_Aset4 = a2.Kd_Aset4 AND a1.Kd_Aset5 = a2.Kd_Aset5 AND a1.No_Register = a2.No_Register $tgl_dokumen ) AS Koreksi_Kurang FROM Ta_Lainnya a1 OUTER APPLY (SELECT TOP 1 b.Kondisi as NewKondisi FROM Ta_KILER b WHERE a1.Kd_Bidang=b.Kd_Bidang AND a1.Kd_Unit=b.Kd_Unit AND a1.Kd_Sub=b.Kd_Sub AND a1.Kd_UPB=b.Kd_UPB AND a1.Kd_Aset1=b.Kd_Aset1 AND a1.Kd_Aset2=b.Kd_Aset2 AND a1.Kd_Aset3=b.Kd_Aset3 AND a1.Kd_Aset4=b.Kd_Aset4 AND a1.Kd_Aset5=b.Kd_Aset5 AND a1.No_Register=b.No_Register AND Kd_Riwayat=1 AND b.Tgl_Dokumen <= '{$tahunakhir}'ORDER BY b.Tgl_Dokumen DESC) as b INNER JOIN Ref_Rek_Aset5 n ON a1.Kd_Aset1 = n.Kd_Aset1 AND a1.Kd_Aset2 = n.Kd_Aset2 AND a1.Kd_Aset3 = n.Kd_Aset3 AND a1.Kd_Aset4 = n.Kd_Aset4 AND a1.Kd_Aset5 = n.Kd_Aset5 WHERE NOT EXISTS (SELECT 1 FROM   Ta_KILHapus d INNER JOIN Ta_Penghapusan e ON d.No_SK=e.No_SK WHERE a1.Kd_Bidang=d.Kd_Bidang AND a1.Kd_Unit=d.Kd_Unit AND a1.Kd_Sub=d.Kd_Sub AND a1.Kd_UPB=d.Kd_UPB AND a1.Kd_Aset1=d.Kd_Aset1 AND a1.Kd_Aset2=d.Kd_Aset2 AND a1.Kd_Aset3=d.Kd_Aset3 AND a1.Kd_Aset4=d.Kd_Aset4 AND a1.Kd_Aset5=d.Kd_Aset5 AND a1.No_Register=d.No_Register AND e.Tgl_SK <= '{$tahunakhir}') AND NOT EXISTS (SELECT 1 FROM   Ta_KILER e WHERE a1.Kd_Bidang=e.Kd_Bidang AND a1.Kd_Unit=e.Kd_Unit AND a1.Kd_Sub=e.Kd_Sub AND a1.Kd_UPB=e.Kd_UPB AND a1.Kd_Aset1=e.Kd_Aset1 AND a1.Kd_Aset2=e.Kd_Aset2 AND a1.Kd_Aset3=e.Kd_Aset3 AND a1.Kd_Aset4=e.Kd_Aset4 AND a1.Kd_Aset5=e.Kd_Aset5 AND a1.No_Register=e.No_Register AND Kd_Riwayat IN (3,19) AND e.Tgl_Dokumen <= '{$tahunakhir}') )as a2 ) as a WHERE 1=1 AND a.Kd_Aset1=7 AND a.Kd_Aset2=24 $where $tgl_pembukuan) as d5 LEFT JOIN Ref_Rek_Aset4 d4 ON d5.Kd_Aset1=d4.Kd_Aset1 AND d5.Kd_Aset2=d4.Kd_Aset2 AND d5.Kd_Aset3=d4.Kd_Aset3 AND d5.Kd_Aset4=d4.Kd_Aset4 LEFT JOIN Ref_Rek_Aset3 d3 ON d5.Kd_Aset1=d3.Kd_Aset1 AND d5.Kd_Aset2=d3.Kd_Aset2 AND d5.Kd_Aset3=d3.Kd_Aset3 LEFT JOIN Ref_Rek_Aset2 d2 ON d5.Kd_Aset1=d2.Kd_Aset1 AND d5.Kd_Aset2=d2.Kd_Aset2 GROUP BY d5.Kd_Bidang,d5.Kd_Unit,d5.Kd_Sub,d5.Kd_UPB, d5.Kd_Aset1,d5.Kd_Aset2,d5.Kd_Aset3,d5.Kd_Aset4,d5.Kd_Aset5, d2.Nm_Aset2,d3.Nm_Aset3,d4.Nm_Aset4,d5.Nm_Aset5"; return $this->db->query($query); } } /* End of file Contoh_model.php */ /* Location: ./system/application/models/Contoh_model.php */